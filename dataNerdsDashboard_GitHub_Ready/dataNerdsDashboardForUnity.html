<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- ═══ SECURITY HEADERS ═══ -->
<!-- Block ALL outbound network — data cannot be exfiltrated even if tampered -->
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'unsafe-inline'; style-src 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-src 'none'; object-src 'none'; base-uri 'none'; form-action 'none'; worker-src 'none'; manifest-src 'none'; frame-ancestors 'none';">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta name="referrer" content="no-referrer">
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=(), usb=(), bluetooth=(), serial=(), hid=(), magnetometer=(), gyroscope=(), accelerometer=()">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dataNerdsDashboard For Unity</title>
<!-- No external resources — fully self-contained for maximum security -->
<style>
/* System font stack — no external font loading needed */
:root { --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif; --font-heading: 'Segoe UI', system-ui, -apple-system, sans-serif; --font-mono: 'Cascadia Code', 'Consolas', 'SF Mono', 'Monaco', monospace; }
/* ══════════════════════════════════════════════════════════
   UNITY REWARD TRACKER — CINEMATIC DARK v4
══════════════════════════════════════════════════════════ */

:root {
  /* ── DEFAULT = DARK MODE — muted, desaturated ── */
  --bg:        #1a1d27;
  --bg2:       #1e2130;
  --surface:   #242836;
  --surface2:  #2c3142;
  --surface3:  #353b4e;
  --border:    rgba(255,255,255,.08);
  --border2:   rgba(255,255,255,.14);
  --text:      #d4d8e3;
  --text2:     #8e95a8;
  --muted:     #5c6378;
  --shadow:    0 2px 12px rgba(0,0,0,.35);
  --shadow-md: 0 6px 28px rgba(0,0,0,.45);
  --glow-blue: none;
  --glow-grn:  none;

  --primary:    #6b8fc7;
  --unassigned: #7a8090;
  --up:   #5eaa8d;
  --down: #c97070;
  --accent: #6b8fc7;

  /* ── Standardized font sizes ── */
  --fs-xs:  .55rem;   /* micro labels, hex IDs */
  --fs-sm:  .65rem;   /* secondary text, badges */
  --fs-md:  .78rem;   /* body text, stats */
  --fs-lg:  .88rem;   /* titles, headings */
  --fs-xl:  1rem;     /* section headers */
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-main), system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 14px;
  min-height: 100vh;
  overflow-x: hidden;
}
h1, .hdr-brand h1, .upload-logo h1 { font-family: var(--font-heading), sans-serif; letter-spacing: -.03em; }
.kc-val, .gc-val, .month-total, .earn-val, .kc-sub { font-family: var(--font-mono), monospace; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg2); }
::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border2); }

/* ══════════════════════════════
   UPLOAD SCREEN
══════════════════════════════ */

/* Logo background colour sampled from image: #b6cdd8 → #96b8c8 */
#uploadScreen {
  position: fixed; inset: 0;
  background: #b2cad4;
  display: flex; align-items: stretch;
  overflow: hidden;
  z-index: 100;
}

/* Soft vignette from edges — keeps centre bright */
#uploadScreen::before {
  content:''; position:absolute; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 90% 90% at 50% 50%, transparent 55%, rgba(80,120,140,.18) 100%);
}

/* Dashed inset border — echoes the logo card style */
#uploadScreen::after {
  content:''; position:absolute; inset:10px; z-index:1; pointer-events:none;
  border: 2px dashed rgba(255,255,255,.4);
  border-radius: 22px;
}

/* ── LEFT PANEL: logo + integrity underneath ── */
.dn-left {
  position: relative; z-index: 2;
  flex: 0 0 42%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 2vh 1.5vw;
  overflow-y: auto;
}
.dn-logo-wrap {
  filter: drop-shadow(0 16px 36px rgba(0,0,0,.18));
  animation: dn-float 6s ease-in-out infinite;
}
@keyframes dn-float {
  0%,100% { transform: translateY(0) rotate(-.3deg); }
  50%      { transform: translateY(-10px) rotate(.3deg); }
}
.dn-logo-img {
  height: 52vh; max-height: 420px;
  width: auto; display: block;
  border-radius: 18px;
  object-fit: cover;
  transform: scale(0);
  opacity: 0;
}
.dn-logo-anim-wrap {
  position: relative;
  display: inline-block;
}
.dn-math-particles {
  position: absolute;
  inset: -40%;
  pointer-events: none;
  z-index: 10;
  overflow: visible;
}
.math-p {
  position: absolute;
  font-weight: 800;
  opacity: 0;
  animation: mathBurst forwards;
  pointer-events: none;
  white-space: nowrap;
}
@keyframes mathBurst {
  0%   { opacity: 0; transform: translate(0,0) rotate(0deg) scale(0.3); }
  15%  { opacity: 1; transform: translate(0,0) rotate(0deg) scale(1.2); }
  40%  { opacity: 1; }
  100% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(0); }
}
@keyframes logoEnter {
  0%   { transform: scale(0) rotateY(0deg); opacity: 0; }
  25%  { transform: scale(1.15) rotateY(180deg); opacity: 1; }
  40%  { transform: scale(0.95) rotateY(360deg); opacity: 1; }
  55%  { transform: scale(1.05) rotateY(540deg); opacity: 1; }
  70%  { transform: scale(0.98) rotateY(680deg); opacity: 1; }
  85%  { transform: scale(1.01) rotateY(715deg); opacity: 1; }
  100% { transform: scale(1) rotateY(720deg); opacity: 1; }
}

/* ── DIVIDER ── */
.dn-divider {
  position: relative; z-index: 2; flex-shrink: 0;
  width: 1px; margin: 3vh 0;
  background: linear-gradient(to bottom,
    transparent 0%, rgba(255,255,255,.55) 25%,
    rgba(255,255,255,.55) 75%, transparent 100%);
}

/* ── RIGHT PANEL: all controls, centred, no scroll ── */
.dn-right {
  position: relative; z-index: 2;
  flex: 1;
  display: flex; flex-direction: column;
  justify-content: center;
  padding: 1.5rem 5vw 1.5rem 3vw;
  overflow-y: auto;
  gap: .45rem;
}

/* Brand heading */
.dn-brand-text { line-height: 1; }
.dn-brand-text h1 {
  font-family: var(--font-heading), sans-serif;
  font-size: clamp(1.6rem, 3vw, 2.4rem);
  font-weight: 900; letter-spacing: -.05em;
  color: #1a2c38; margin: 0 0 .15rem;
}
.dn-brand-text h1 .accent { color: #c0392b; }
.dn-brand-text .sub {
  font-size: clamp(.72rem, 1.1vw, .88rem);
  color: #3d5866; font-weight: 600; margin-bottom: .12rem;
}
.dn-brand-text .tagline {
  font-size: clamp(.58rem, .85vw, .7rem);
  color: rgba(26,44,56,.45); font-style: italic;
}

/* ── STATS BAR ── */

/* ── UPLOAD GRID ── */
.upload-grid {
  display: grid; grid-template-columns: 1fr 1.12fr 1fr;
  gap: .55rem; width: 100%;
}
.upload-area {
  background: rgba(255,255,255,.32);
  border: 1.5px dashed rgba(26,44,56,.22);
  border-radius: 14px; padding: .9rem .85rem .75rem;
  cursor: pointer; transition: all .2s;
  display: flex; flex-direction: column; align-items: center;
  text-align: center; position: relative; overflow: hidden;
}
.upload-area .upload-desc { flex: 1; }
.upload-area:hover, .upload-area.drag-over {
  background: rgba(255,255,255,.6);
  border-color: rgba(26,44,56,.4);
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
}
.upload-area-primary {
  background: rgba(59,130,246,.13) !important;
  border: 1.5px dashed rgba(59,130,246,.5) !important;
}
.upload-area-primary:hover {
  background: rgba(59,130,246,.22) !important;
  border-color: rgba(59,130,246,.7) !important;
  box-shadow: 0 8px 24px rgba(59,130,246,.18) !important;
}
.upload-zone-glow {
  position:absolute; inset:0; border-radius:inherit;
  background:radial-gradient(circle at 50% 20%, var(--zgc,#3b82f6) 0%, transparent 70%);
  opacity:0; transition:opacity .3s; pointer-events:none;
}
.upload-area:hover .upload-zone-glow { opacity:.07; }
.upload-icon {
  width: 38px; height: 38px; border-radius: 11px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: .5rem; transition: transform .2s; flex-shrink: 0;
}
.upload-area:hover .upload-icon { transform: scale(1.1) rotate(-4deg); }
.upload-zone-badge {
  font-size:.5rem; font-weight:700; letter-spacing:.08em; text-transform:uppercase;
  padding:.12rem .42rem; border-radius:20px; border:1px solid; margin-bottom:.4rem;
}
.upload-title {
  font-family:var(--font-heading),sans-serif; font-size:.78rem; font-weight:700;
  color:#1a2c38; margin-bottom:.22rem;
}
.upload-desc  { color:#3d5866; font-size:.62rem; line-height:1.55; margin-bottom:.55rem; flex:1; }
.upload-desc strong { color:#1a2c38; }
.upload-btn {
  display:inline-flex; align-items:center; gap:.32rem;
  background:linear-gradient(135deg,#3b82f6,#6366f1);
  color:#fff; border:none; border-radius:8px;
  padding:.38rem .85rem; font-size:.67rem; font-weight:700;
  cursor:pointer; font-family:inherit; transition:all .18s;
  box-shadow:0 3px 10px rgba(59,130,246,.35);
}
.upload-btn:hover { transform:translateY(-2px); box-shadow:0 6px 18px rgba(59,130,246,.5); }
.upload-chip {
  display:inline-flex; align-items:center; gap:.3rem;
  font-size:.62rem; font-weight:600; padding:.3rem .65rem;
  border-radius:7px; border:1px solid; cursor:pointer;
  transition:all .15s; margin-top:auto;
}
.upload-chip:hover { opacity:.75; transform:translateY(-1px); }
.upload-status {
  margin-top:.35rem; font-size:.58rem; color:#3d5866;
  min-height:.8rem; line-height:1.4; text-align:center;
}

/* ── FILE SLOTS ── */
.upload-slots {
  display:flex; flex-wrap:wrap; gap:.3rem; width:100%;
}
.slot {
  background:rgba(255,255,255,.32); border:1px solid rgba(26,44,56,.15);
  border-radius:6px; padding:.18rem .55rem;
  font-size:.58rem; color:#3d5866;
  display:flex; align-items:center; gap:.3rem;
}
.slot-dot { width:5px; height:5px; border-radius:50%; background:rgba(26,44,56,.2); }
.slot.loaded { border-color:rgba(59,130,246,.45); color:#1a2c38; }
.slot.loaded .slot-dot { background:#3b82f6; box-shadow:0 0 6px #3b82f6; }

/* ── CUTOFF ── */
.upload-cutoff {
  display:flex; align-items:center; gap:.38rem;
  font-size:.6rem; color:rgba(26,44,56,.42);
}
.upload-cutoff strong { color:rgba(26,44,56,.65); }

/* ── BUILD BUTTON ── */
.load-btn {
  display:none; align-items:center; gap:.5rem;
  align-self: flex-start;
  background:linear-gradient(135deg,#3b82f6 0%,#6366f1 50%,#8b5cf6 100%);
  background-size:200% 200%;
  animation:lbgrad 3s ease infinite;
  color:#fff; border:none; border-radius:12px;
  padding:.75rem 2rem; font-size:.9rem; font-weight:700;
  cursor:pointer; font-family:var(--font-heading),sans-serif; letter-spacing:-.015em;
  box-shadow:0 5px 22px rgba(99,102,241,.42);
  transition:transform .18s, box-shadow .18s;
}
@keyframes lbgrad {
  0%,100% { background-position:0% 50%; }
  50%      { background-position:100% 50%; }
}
.load-btn:hover { transform:translateY(-2px) scale(1.02); box-shadow:0 10px 30px rgba(99,102,241,.6); }
.load-btn.visible { display:inline-flex; }
@keyframes pulse-btn {
  0%,100% { box-shadow:0 5px 22px rgba(99,102,241,.42); transform:translateY(0); }
  50%      { box-shadow:0 5px 36px rgba(99,102,241,.75), 0 0 0 8px rgba(99,102,241,.1); transform:translateY(-4px); }
}
.load-btn.visible { animation:lbgrad 3s ease infinite, pulse-btn 1.8s ease infinite; }


/* ══════════════════════════════
   DASHBOARD
══════════════════════════════ */
#dashboard { display: none; padding: 6.4rem 2rem 6rem; max-width: 1600px; margin: 0 auto; }
body.easy-mode .adv-only { display: none !important; }
body:not(.easy-mode) .easy-only { display: none !important; }
body.easy-mode .nav-tab[data-page="earnings"],
body.easy-mode .nav-tab[data-page="distribution"],
body.easy-mode .nav-tab[data-page="performance"],
body.easy-mode .nav-tab[data-page="archive"],
body.easy-mode .nav-tab[data-page="editor"],
body.easy-mode .nav-tab[data-page="tools"] { display: none !important; }
body.easy-mode #grossBtn,
body.easy-mode #grossIndicator,
body.easy-mode .reset-btn,
body.easy-mode .live-badge,
body.easy-mode #legendRow { display: none !important; }
body.easy-mode .adv-overview-only { display: none !important; }

/* ── HEADER ── */
.hdr {
  display: flex; justify-content: space-between; align-items: center;
  flex-wrap: nowrap; gap: .6rem;
  padding: .55rem 1.4rem;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  overflow: hidden;
  position: relative;
  max-height: 72px;
}
.hdr::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ef4444, #f59e0b, #10b981, #3b82f6);
  background-size: 200% 100%;
  animation: shimmer-bar 4s linear infinite;
}
@keyframes shimmer-bar { 0%{background-position:0%} 100%{background-position:200%} }

.hdr-brand { display: flex; align-items: center; gap: .75rem; }
.hdr-logo {
  width: 38px; height: 38px;
  background: linear-gradient(135deg, #3b82f6, #7c3aed);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 0 4px rgba(59,130,246,.15);
}
.hdr-brand h1 { font-size: 1.1rem; font-weight: 700; letter-spacing: -.025em; }
.hdr-brand p { font-size: .65rem; color: var(--muted); margin-top: .1rem; }
.hdr-right { display: flex; align-items: center; gap: .4rem; flex-wrap: wrap; flex-shrink: 1; overflow: hidden; max-height: 56px; }

.live-badge {
  background: rgba(16,185,129,.12); color: #10b981;
  font-size: .58rem; font-weight: 700; padding: .22rem .7rem;
  border-radius: 20px; letter-spacing: .1em;
  border: 1px solid rgba(74,222,128,.25);
  animation: blink 2.5s ease infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.5} }

.reset-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--muted); border-radius: 7px; padding: .35rem .9rem;
  font-family: inherit; font-size: .7rem; font-weight: 600;
  cursor: pointer; transition: all .15s;
}
.reset-btn:hover { border-color: var(--down); color: var(--down); }

/* dark-mode toggle */
.theme-btn {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--text2); border-radius: 7px; padding: .35rem .75rem;
  font-family: inherit; font-size: .72rem; cursor: pointer;
  transition: all .15s;
}
.theme-btn:hover { border-color: var(--border2); color: var(--text); }

.legend { display: flex; gap: .4rem; flex-wrap: nowrap; align-items: center; overflow: hidden; }
.leg { display: flex; align-items: center; gap: .3rem; font-size: .65rem; font-weight: 600; color: var(--text2); }
.leg-swatch { width: 12px; height: 8px; border-radius: 2px; flex-shrink: 0; }

/* ── KPI CARDS ── */
.kpi-row { display: grid; grid-template-columns: repeat(4,1fr); gap: .85rem; margin-bottom: .85rem; }
.kc {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px; padding: 1.1rem 1.25rem;
  box-shadow: var(--shadow);
  animation: fadeUp .4s ease both;
  transition: transform .2s, box-shadow .2s;
  position: relative; overflow: hidden;
  cursor: default;
}
.kc::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--kc-col,#3b82f6), transparent);
}
.kc::after {
  content: '';
  position: absolute; top: -60px; right: -60px;
  width: 140px; height: 140px;
  background: radial-gradient(circle, var(--kc-col,#3b82f6) 0%, transparent 70%);
  opacity: .04; pointer-events: none;
}
.kc:hover { transform: translateY(-3px); box-shadow: 0 8px 28px rgba(0,0,0,.13), 0 0 0 1px var(--border2); }
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:none} }
.kc-label {
  font-size: .63rem; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: .07em; margin-bottom: .5rem;
  display: flex; align-items: center; gap: .4rem;
}
.kc-val {
  font-size: 1.9rem; font-weight: 700; letter-spacing: -.04em;
  line-height: 1; margin-bottom: .22rem;
  /* Dark mode: soft muted gradient */
  background: linear-gradient(160deg, #d4d8e3 0%, #8bacc7 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.kc-val.big-num { font-size: 1.65rem; }
.kc-sub { font-size: .65rem; color: var(--muted); font-weight: 500; }
.pos { color: var(--up) !important; -webkit-text-fill-color: var(--up) !important; }
.neg { color: var(--down) !important; -webkit-text-fill-color: var(--down) !important; }

/* ── GROUP CARDS ── */
.grp-row { display: grid; grid-template-columns: repeat(6,1fr); gap: .75rem; margin-bottom: 1.4rem; }
.gc {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px; padding: .9rem 1rem;
  box-shadow: var(--shadow);
  border-top: 3px solid var(--gc-col,#3b82f6);
  animation: fadeUp .4s ease both;
  position: relative; overflow: hidden;
  transition: transform .2s, box-shadow .2s;
}
.gc::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 60%;
  background: linear-gradient(0deg, var(--gc-bg,rgba(77,166,255,.05)) 0%, transparent 100%);
  pointer-events: none;
}
.gc:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.12); }
.gc-lbl { font-size: .6rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .08em; margin-bottom: .3rem; }
.gc-val { font-size: 1.3rem; font-weight: 700; color: var(--gc-col); letter-spacing: -.02em; line-height: 1; margin-bottom: .18rem; }
.gc-sub { font-size: .62rem; color: var(--muted); }

/* ── SECTION CARD ── */
.sc {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px; padding: 1.25rem 1.4rem;
  box-shadow: var(--shadow); margin-bottom: .9rem;
  animation: fadeUp .4s ease both;
  transition: box-shadow .2s;
}
.sc:hover { box-shadow: var(--shadow-md); }
.sc-title {
  font-size: .92rem; font-weight: 700; margin-bottom: .18rem;
  display: flex; align-items: center; gap: .45rem;
  color: var(--text);
  font-family: var(--font-heading), sans-serif; letter-spacing: -.02em;
}
.sc-sub { font-size: .67rem; color: var(--muted); margin-bottom: .95rem; line-height: 1.5; }

/* ── PAGE-LEVEL ARCHIVE BANNER ── */
#archiveBanner {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-left: 4px solid #3b82f6;
  border-radius: 12px;
  padding: .85rem 1.1rem;
  margin-bottom: 1.1rem;
  animation: fadeUp .3s ease both;
}
.arc-banner-inner {
  display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
}
.arc-banner-info { flex: 1; min-width: 180px; }
.arc-banner-title {
  font-size: .78rem; font-weight: 800; color: var(--text);
  display: flex; align-items: center; gap: .4rem; margin-bottom: .2rem;
}
.arc-banner-sub { font-size: .65rem; color: var(--muted); line-height: 1.5; }
.arc-month-pills { display: flex; gap: .35rem; flex-wrap: wrap; align-items: center; margin-top: .5rem; }
.arc-pill {
  font-size: .62rem; font-weight: 700; padding: .18rem .55rem;
  border-radius: 20px; border: 1px solid; cursor: pointer;
  transition: all .15s; white-space: nowrap;
}
.arc-pill:hover { filter: brightness(1.1); transform: translateY(-1px); }
.arc-pill-done  { background: rgba(16,185,129,.1);  color: #10b981; border-color: rgba(16,185,129,.3); }
.arc-pill-now   { background: rgba(59,130,246,.12); color: #3b82f6; border-color: rgba(59,130,246,.35);
                  box-shadow: 0 0 0 2px rgba(59,130,246,.15); }
.arc-pill-save  { background: rgba(245,158,11,.1);  color: #d97706; border-color: rgba(245,158,11,.3); }
.arc-banner-btns { display: flex; gap: .5rem; flex-shrink: 0; flex-wrap: wrap; }
.arc-btn {
  font-size: .68rem; font-weight: 700; padding: .42rem .9rem;
  border-radius: 8px; border: none; cursor: pointer; white-space: nowrap;
  transition: all .15s;
}
.arc-btn-primary {
  background: linear-gradient(135deg,#3b82f6,#2563eb);
  color: #fff; box-shadow: 0 2px 8px rgba(59,130,246,.3);
}
.arc-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(59,130,246,.4); }
.arc-btn-sec {
  background: var(--surface2); color: var(--text);
  border: 1px solid var(--border);
}
.arc-btn-sec:hover { background: var(--border); }
.arc-progress-bar {
  height: 4px; border-radius: 3px; background: var(--border);
  overflow: hidden; margin-top: .45rem;
}
.arc-progress-fill {
  height: 100%; border-radius: 3px;
  background: linear-gradient(90deg,#3b82f6,#8b5cf6);
  transition: width .5s ease;
}

/* ── ANALYTICS SECTION HEADERS ── */
.an-section-hdr {
  display: flex; align-items: center; gap: .5rem;
  font-size: .7rem; font-weight: 800;
  text-transform: uppercase; letter-spacing: .1em;
  color: var(--muted);
  padding: .3rem 0 .6rem;
  border-bottom: 2px solid var(--border);
  margin-bottom: .75rem;
}
.an-section-hdr svg { opacity: .6; flex-shrink: 0; }

/* ── PARTICIPATION ── */
.part-scroll { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 4px; }
.pt {
  flex-shrink: 0; width: 62px; border-radius: 10px;
  padding: .5rem .25rem; text-align: center;
  font-weight: 700; cursor: default;
  transition: transform .15s, box-shadow .15s;
  position: relative; overflow: hidden;
}
.pt:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 4px 14px rgba(0,0,0,.12); }
.pt-num { font-size: 1.15rem; line-height: 1; display: block; }
.pt-total { font-size: .55rem; opacity: .85; display: block; margin-top: 1px; }
.pt-date { font-size: .5rem; opacity: .75; display: block; margin-top: 2px; }
.part-key { display: flex; gap: .6rem; margin-top: .5rem; align-items: center; font-size: .62rem; color: var(--muted); flex-wrap: wrap; }
.part-key-item { display: flex; align-items: center; gap: .28rem; }
.part-key-dot { width: 9px; height: 9px; border-radius: 2px; }

/* participation colors */
.lvl5 { background: linear-gradient(135deg,#16a34a,#10b981); color: #fff; box-shadow: 0 2px 12px rgba(74,222,128,.3); }
.lvl3 { background: linear-gradient(135deg,#b45309,#f59e0b); color: #fff; box-shadow: 0 2px 12px rgba(251,191,36,.25); }
.lvl1 { background: linear-gradient(135deg,#991b1b,#ef4444); color: #fff; box-shadow: 0 2px 12px rgba(248,113,113,.3); }

/* ── CHART CONTROLS ── */
.ctrl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: .9rem; flex-wrap: wrap; gap: .6rem; }
.ctrl-btns { display: flex; gap: .35rem; flex-wrap: wrap; }
.cbtn {
  font-family: inherit; font-size: .68rem; font-weight: 600;
  padding: .28rem .85rem; border-radius: 7px; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--muted); transition: all .15s;
}
.cbtn:hover { border-color: var(--primary); color: var(--primary); }
.cbtn.on {
  background: linear-gradient(135deg,#2563eb,#7c3aed);
  border-color: transparent; color: #fff;
  box-shadow: 0 2px 14px rgba(37,99,235,.45);
}
.chart-stats { display: flex; gap: 1.2rem; flex-wrap: wrap; }
.cstat-lbl { font-size: .56rem; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .07em; }
.cstat-val { font-size: .88rem; font-weight: 700; color: var(--text); }

/* ── TWO COL ── */
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: .9rem; margin-bottom: .9rem; }

/* ── TOP/BOTTOM BARS ── */
.bar-row { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; cursor: pointer; }
.bar-idx { width: 14px; text-align: right; font-size: .6rem; color: var(--muted); font-weight: 700; flex-shrink: 0; }
.bar-track { flex: 1; height: 18px; background: var(--surface2); border-radius: 5px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 5px; transition: width .4s cubic-bezier(.4,0,.2,1); }
.bar-val { width: 58px; text-align: right; font-size: .63rem; font-weight: 700; flex-shrink: 0; }

/* ── LEASE TABLE ── */
.lease-sc {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 14px; padding: 1.25rem 1.4rem; box-shadow: var(--shadow);
  margin-top: .9rem;
}
.sbtn {
  font-family: inherit; font-size: .66rem; font-weight: 600;
  padding: .25rem .7rem; border-radius: 6px; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--muted); transition: all .15s; white-space: nowrap;
}
.sbtn:hover { border-color: var(--primary); color: var(--primary); }
.sbtn.active {
  background: linear-gradient(135deg,#2563eb,#7c3aed);
  border-color: transparent; color: #fff;
  box-shadow: 0 2px 10px rgba(37,99,235,.4);
}
.lease-table { width: 100%; border-collapse: collapse; font-size: .78rem; }
.lease-table th {
  text-align: left; font-size: .6rem; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: .07em;
  padding: .5rem .75rem; border-bottom: 1px solid var(--border);
  white-space: nowrap; cursor: pointer; user-select: none;
  background: var(--surface2);
}
.lease-table th:hover { color: var(--primary); }
.lease-table td { padding: .5rem .75rem; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text); }
.lease-table tr:hover td { background: var(--surface2); }
.grp-badge {
  display: inline-flex; align-items: center;
  font-size: .6rem; font-weight: 700; padding: .18rem .5rem;
  border-radius: 6px; white-space: nowrap;
}
.earn-bar-wrap { display: flex; align-items: center; gap: .4rem; }
.earn-bar-bg { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; min-width: 60px; }
.earn-val { font-weight: 700; font-size: .74rem; min-width: 58px; text-align: right; font-family: var(--font-mono), monospace; }

/* ── TOOLTIP ── */
.htip {
  position: fixed;
  background: #ffffff;
  color: #1a2c38;
  border: 1px solid rgba(26,44,56,.15);
  border-left: 3px solid var(--primary);
  border-radius: 10px;
  padding: .65rem 1rem; font-size: .72rem;
  pointer-events: none; z-index: 999999; display: none;
  box-shadow: 0 4px 20px rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.10);
  white-space: nowrap;
}
.htip-name { font-weight: 700; font-size: .8rem; margin-bottom: .25rem; color: #1a2c38; }
.htip-row { opacity: 1; display: flex; gap: .9rem; justify-content: space-between; color: #3d5866; }

/* ── ANALYSIS BLOCK ── */
.analysis-block {
  background: linear-gradient(135deg, rgba(77,166,255,.06) 0%, rgba(192,132,252,.06) 100%);
  border: 1px solid rgba(77,166,255,.15);
  border-left: 3px solid #3b82f6;
  border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: .9rem;
}
.analysis-title {
  font-size: .68rem; font-weight: 700; color: #3b82f6;
  text-transform: uppercase; letter-spacing: .08em; margin-bottom: .65rem;
  display: flex; align-items: center; gap: .4rem;
}
.insight-list { display: flex; flex-direction: column; gap: .5rem; }
.insight { display: flex; align-items: flex-start; gap: .6rem; font-size: .78rem; color: var(--text2); line-height: 1.6; }
.insight-icon { width: 22px; height: 22px; border-radius: 6px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: .75rem; margin-top: .06rem; }

/* ── MONTHLY CHART ── */
.month-bar-wrap { display: flex; align-items: flex-end; gap: 14px; padding: .5rem 0 .75rem; overflow-x: auto; min-height: 200px; }
.month-col { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; min-width: 80px; }
.month-bar-outer { width: 100%; display: flex; flex-direction: column; justify-content: flex-end; gap: 1px; }
.month-bar-seg {
  width: 100%; border-radius: 4px; min-height: 3px;
  transition: opacity .18s, filter .18s; cursor: default;
}
.month-bar-seg:hover { filter: brightness(1.2); }
.month-lbl { font-size: .66rem; font-weight: 600; color: var(--muted); text-align: center; }
.month-total { font-size: .7rem; font-weight: 700; color: var(--text2); font-family: var(--font-mono), monospace; }

/* ── TOAST NOTIFICATIONS ── */
#toastContainer {
  position: fixed; top: 1.2rem; right: 1.2rem;
  z-index: 99999; display: flex; flex-direction: column; gap: .5rem;
  pointer-events: none;
}
.toast {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px; padding: .75rem 1.1rem;
  display: flex; align-items: center; gap: .65rem;
  font-size: .78rem; min-width: 260px; max-width: 340px;
  box-shadow: 0 12px 40px rgba(0,0,0,.5);
  animation: toastIn .4s cubic-bezier(.34,1.56,.64,1) both;
  pointer-events: auto;
  backdrop-filter: blur(12px);
}
.toast.out { animation: toastOut .3s ease both; }
@keyframes toastIn { from{opacity:0;transform:translateX(100%)} to{opacity:1;transform:none} }
@keyframes toastOut { to{opacity:0;transform:translateX(110%)} }
.toast-icon { font-size: 1.2rem; flex-shrink: 0; }
.toast-text { flex: 1; font-weight: 600; color: var(--text); }
.toast-sub { font-size: .65rem; color: var(--muted); margin-top: .1rem; }

/* ── UNSAVED NOTES BANNER ── */
#unsavedNotesBanner {
  position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%);
  z-index: 99998; display: none;
  background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(109,40,217,.95));
  color: #fff; border-radius: 12px; padding: .6rem 1rem;
  box-shadow: 0 8px 32px rgba(109,40,217,.4), 0 2px 8px rgba(0,0,0,.2);
  backdrop-filter: blur(12px);
  font-size: .75rem; font-weight: 600;
  display: none; align-items: center; gap: .75rem;
  max-width: 520px; width: calc(100% - 2rem);
  animation: unsBannerIn .4s cubic-bezier(.34,1.56,.64,1) both;
}
#unsavedNotesBanner.hiding { animation: unsBannerOut .3s ease both; }
@keyframes unsBannerIn { from{opacity:0;transform:translateX(-50%) translateY(120%)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
@keyframes unsBannerOut { to{opacity:0;transform:translateX(-50%) translateY(120%)} }
#unsavedNotesBanner .uns-icon { font-size: 1.1rem; flex-shrink: 0; }
#unsavedNotesBanner .uns-text { flex: 1; line-height: 1.4; }
#unsavedNotesBanner .uns-text small { display: block; font-size: .62rem; font-weight: 400; opacity: .85; margin-top: .1rem; }
#unsavedNotesBanner .uns-btn {
  padding: .35rem .75rem; border-radius: 7px; border: none; cursor: pointer;
  font-size: .68rem; font-weight: 700; white-space: nowrap; flex-shrink: 0;
}
#unsavedNotesBanner .uns-export { background: #fff; color: #7c3aed; }
#unsavedNotesBanner .uns-export:hover { background: #f3f0ff; }
#unsavedNotesBanner .uns-dismiss { background: rgba(255,255,255,.18); color: #fff; }
#unsavedNotesBanner .uns-dismiss:hover { background: rgba(255,255,255,.28); }

/* ── MILESTONE BANNER ── */
/* ══════════════════════════════════════
   PAGE NAV TABS
══════════════════════════════════════ */
#pageNav {
  display: flex;
  align-items: center; gap: .25rem;
  padding: .3rem 1.4rem;
  border-top: 1px solid var(--border);
  border-bottom: 2px solid var(--border);
  background: var(--surface);
  flex-wrap: nowrap;
  overflow-x: auto;
}
.nav-tab {
  display: flex; align-items: center; gap: .42rem;
  padding: .5rem 1.1rem;
  border: 1.5px solid transparent;
  border-radius: 8px;
  font-size: .76rem; font-weight: 700;
  font-family: var(--font-heading), sans-serif;
  cursor: pointer; transition: all .16s ease;
  color: var(--text2); background: none;
  letter-spacing: .02em;
  white-space: nowrap;
  user-select: none;
}
.nav-tab:hover {
  background: var(--surface2);
  color: var(--text);
  border-color: var(--border);
  transform: translateY(-1px);
}
.nav-tab.active {
  background: var(--primary);
  color: #fff;
  border-color: transparent;
  box-shadow: 0 3px 10px rgba(37,99,235,.35);
}
.nav-tab:active { transform: translateY(0); }
.nav-tab svg { opacity: .7; flex-shrink: 0; }
.nav-tab.active svg { opacity: 1; }
.page-section { display: none; }
.page-section.active { display: block; animation: pageFadeIn .22s ease both; }
@keyframes pageFadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.page-section > *:first-child { margin-top: 0; }

/* ══════════════════════════════════════
   FIXED TOP BAR
══════════════════════════════════════ */
#topBar {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 210;
  background: var(--surface);
  box-shadow: 0 3px 18px rgba(0,0,0,.12);
}

/* ── TICKER ── */
#earningsTicker {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface); border-top: 1px solid var(--border);
  padding: .4rem 0; overflow: hidden; z-index: 100;
  display: none;
}
.ticker-track {
  display: flex; gap: 2rem; white-space: nowrap;
  animation: ticker-scroll 30s linear infinite;
}
.ticker-item { font-size: .68rem; color: var(--text2); font-family: var(--font-mono), monospace; }
.ticker-item .ti-val { color: #10b981; font-weight: 600; }
.ticker-item .ti-name { color: var(--accent); }
@keyframes ticker-scroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }

/* ── SPARKLINE ── */
.sparkline-wrap { display: flex; align-items: center; gap: .5rem; margin-top: .3rem; }

/* ── RESPONSIVE ── */
@media(max-width:1100px) {
  .kpi-row { grid-template-columns: repeat(2,1fr); }
  .grp-row { grid-template-columns: repeat(3,1fr); }
}
@media(max-width:700px) {
  .kpi-row { grid-template-columns: 1fr 1fr; }
  .grp-row { grid-template-columns: repeat(2,1fr); }
  .two-col { grid-template-columns: 1fr; }
  #dashboard { padding: .6rem .6rem 5rem; }
  .hdr { padding: .4rem .7rem; max-height: 60px; gap: .3rem; }
  .hdr-brand h1 { font-size: .85rem !important; }
  .hdr-brand p { font-size: .5rem; }
  .hdr-brand img { width: 32px !important; height: 32px !important; }
  .hdr-right { gap: .25rem; max-height: 44px; }
  .hdr-right .theme-btn, .hdr-right .reset-btn { font-size: .52rem; padding: .2rem .4rem; }
  .hdr-right .legend { display: none; }
  #pageNav { gap: 0; padding: .3rem .4rem; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .nav-tab { font-size: .55rem; padding: .35rem .5rem; white-space: nowrap; min-width: 0; }
  .nav-tab svg { display: none; }
  .sc { padding: .6rem .7rem; border-radius: 8px; }
  .sc-title { font-size: .75rem; }
  .sc-sub { font-size: .6rem; }
  .kc { padding: .5rem .6rem; border-radius: 8px; }
  .kc-val { font-size: 1.3rem; }
  .kc-label { font-size: .48rem; }
  .kc-sub { font-size: .52rem; }
  .upload-grid { grid-template-columns: 1fr !important; }
  .ne-layout { grid-template-columns: 1fr; }
  .ne-gc-head { flex-wrap: wrap; gap: .3rem; }
  .ne-pill { font-size: .58rem; }
  #healthScoreContainer { flex-direction: column; align-items: stretch; }
  #healthScoreContainer > div:first-child { width: 100%; display: flex; justify-content: center; }
}
@media(max-width:480px) {
  .kpi-row { grid-template-columns: 1fr; }
  .grp-row { grid-template-columns: 1fr; }
  .hdr-brand h1 { font-size: .75rem !important; }
  .hdr-brand h1 span[style*="font-size:.7em"] { display: none; }
  #verBadge2 { display: none; }
  .nav-tab { font-size: .5rem; padding: .3rem .4rem; }
  .kc-val { font-size: 1.1rem; }
  #dashboard { padding: .4rem .4rem 5rem; }
  #easyChartsGrid { grid-template-columns: 1fr !important; }
}

/* ── COUNTER ANIMATION ── */
@keyframes countUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
.count-anim { animation: countUp .6s ease both; }

/* ── GLOW EFFECTS ── */
.glow-blue { box-shadow: 0 0 20px rgba(77,166,255,.2) !important; }
.glow-green { box-shadow: 0 0 20px rgba(74,222,128,.2) !important; }
.glow-purple { box-shadow: 0 0 20px rgba(192,132,252,.2) !important; }

/* ── UPLOAD ZONE NEW ELEMENTS ── */
#particleCanvas { position:fixed; inset:0; pointer-events:none; z-index:0; }
.upload-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.85rem; width:100%; max-width:960px; position:relative; z-index:1; }
.upload-area { position:relative; overflow:hidden; padding:1.6rem 1.3rem; }
.upload-area-primary { border-color:rgba(77,166,255,.35) !important; }
.upload-zone-glow {
  position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(ellipse at 50% 0%, var(--zgc,#3b82f6) 0%, transparent 70%);
  opacity:.06; transition: opacity .25s;
}
.upload-area:hover .upload-zone-glow { opacity:.14; }
.upload-zone-badge {
  display:inline-block; font-size:.58rem; font-weight:700;
  padding:.12rem .5rem; border-radius:20px; border:1px solid;
  margin-bottom:.6rem; text-transform:uppercase; letter-spacing:.07em;
}
.upload-chip {
  display:inline-flex; align-items:center; gap:.3rem;
  font-size:.7rem; font-weight:600; padding:.3rem .8rem;
  border-radius:7px; border:1px solid; cursor:pointer;
  transition:opacity .15s;
}
.upload-chip:hover { opacity:.8; }
.upload-status { margin-top:.65rem; font-size:.67rem; color:var(--muted); min-height:1rem; }
.upload-cutoff {
  display:flex; align-items:center; gap:.4rem;
  font-size:.67rem; color:var(--muted); margin-top:.6rem;
  position:relative; z-index:1;
}
.upload-cutoff strong { color:var(--text2); }

/* ── LIGHT THEME — steel-blue, matches upload screen ── */
body.light {
  --bg:#c8dde6; --bg2:#bcd3de;
  --surface:rgba(255,255,255,.75); --surface2:rgba(255,255,255,.55); --surface3:rgba(255,255,255,.38);
  --border:rgba(26,44,56,.12); --border2:rgba(26,44,56,.22);
  --text:#1a2c38; --text2:#3d5866; --muted:#6a8898;
  --shadow:0 1px 8px rgba(0,0,0,.10); --shadow-md:0 4px 24px rgba(0,0,0,.14);
  --up:#059669; --down:#dc2626;
}
body.light { background: linear-gradient(145deg, #cddfe8 0%, #b8cfda 45%, #a8c4d2 100%) !important; }
body.light #dashboard { background: transparent; }
body.light .kc-val {
  background: linear-gradient(160deg, #1a2c38 0%, #2563eb 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
body.light .pos { -webkit-text-fill-color:var(--up) !important; }
body.light .neg { -webkit-text-fill-color:var(--down) !important; }

/* ── CONFETTI ── */
/* ══════════════════════════════
   PREMIUM EXTRAS
══════════════════════════════ */

/* Noise texture overlay on dashboard */
#dashboard::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  opacity: .018;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  background-size: 200px 200px;
}
#dashboard > * { position: relative; z-index: 1; }

/* KPI cards — glow accent on top border */
.kc:nth-child(1) { --kc-col: #3b82f6; }
.kc:nth-child(2) { --kc-col: #8b5cf6; }
.kc:nth-child(3) { --kc-col: #10b981; }
.kc:nth-child(4) { --kc-col: #f59e0b; }

/* KPI value — bigger, Syne font */
.kc-val {
  font-size: 2.1rem !important;
  font-family: var(--font-heading), sans-serif !important;
  letter-spacing: -.04em !important;
}
.kc-val.big-num { font-size: 1.7rem !important; }

/* Group card value — Syne */
.gc-val { font-family: var(--font-heading), sans-serif !important; }

/* Header h1 — larger Syne */
.hdr-brand h1 { font-size: 1.35rem !important; }

/* Upload logo h1 — bigger */
.upload-logo h1 { font-size: 2.2rem !important; }

/* Lease table — JetBrains mono for numbers */
.lease-table td:first-child { font-family: var(--font-main), sans-serif; font-weight: 600; font-size: .79rem; }

/* Month bar — rounded tops */
.month-bar-outer > .month-bar-seg:last-child { border-radius: 4px 4px 0 0; }
.month-bar-outer > .month-bar-seg:first-child { border-radius: 0 0 4px 4px; }

/* Participation tiles — bigger numbers */
.pt-num { font-family: var(--font-heading), sans-serif !important; font-size: 1.25rem !important; }

/* Live badge pulse ring */
.live-badge {
  position: relative;
}
.live-badge::before {
  content: '';
  position: absolute; inset: -3px;
  border-radius: 20px;
  border: 1px solid rgba(110,231,183,.3);
  animation: ring-pulse 2.5s ease infinite;
}
@keyframes ring-pulse {
  0%,100% { opacity: 0; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.08); }
}

/* Analysis block insights — dark glass */
.insight {
  background: var(--surface2);
  border-radius: 10px;
  padding: .7rem .9rem;
  border: 1px solid var(--border);
  transition: border-color .2s;
}
.insight:hover { border-color: var(--border2); }
.insight-icon { background: var(--surface3) !important; }

/* Upload zone — animated dashed border on hover */
.upload-area {
  background-image: none !important;
  position: relative;
}
.upload-area::after {
  content: '';
  position: absolute; inset: -1px;
  border-radius: 17px;
  background: linear-gradient(135deg, var(--border2), transparent, var(--border2));
  opacity: 0; pointer-events: none;
  transition: opacity .3s;
}
.upload-area:hover::after { opacity: 1; }


button:focus-visible, input:focus-visible {
  outline: 2px solid var(--primary);
  outline-offset: 2px;
}

/* Bottom ticker — gradient fade edges */
#earningsTicker::before,
#earningsTicker::after {
  content: '';
  position: absolute; top: 0; bottom: 0; width: 60px; z-index: 2;
  pointer-events: none;
}
#earningsTicker::before { left: 0; background: linear-gradient(90deg, var(--surface), transparent); }
#earningsTicker::after  { right: 0; background: linear-gradient(-90deg, var(--surface), transparent); }
#earningsTicker { position: relative; }

/* Withdrawal card — green glow */
#withdrawCard {
  box-shadow: var(--shadow), 0 0 30px rgba(110,231,183,.06) !important;
}

/* Light mode: solid dark values, readable on steel-blue bg */
body.light .kc-val {
  background: linear-gradient(160deg, #1a2c38 0%, #2563eb 100%) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
}
body.light .kc-val.pos { -webkit-text-fill-color: #059669 !important; color: #059669 !important; }
body.light .kc-val.neg { -webkit-text-fill-color: #dc2626 !important; color: #dc2626 !important; }
body.light .gc-val     { -webkit-text-fill-color: unset !important; }
/* Upload screen: light themed — no overrides needed */

/* ══════════════════════════════
   NEW INSIGHT COMPONENTS CSS
══════════════════════════════ */

/* ── Projector / stat rows ── */
.proj-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: .55rem 0; border-bottom: 1px solid var(--border);
}
.proj-row:last-child { border-bottom: none; }
.proj-lbl { font-size: .72rem; color: var(--text2); }
.proj-val { font-family: var(--font-mono), monospace; font-size: .9rem; font-weight: 600; color: var(--text); }
.proj-val.accent { color: var(--primary); }
.proj-val.up { color: var(--up); }
.proj-val.down { color: var(--down); }

/* ── Node vs Node ── */
.nvn-grid {
  display: grid; grid-template-columns: 1fr auto 1fr; gap: .5rem;
  align-items: center; margin-top: .5rem;
}
.nvn-col { display: flex; flex-direction: column; gap: .5rem; }
.nvn-col.right { text-align: right; }
.nvn-sep { display: flex; flex-direction: column; align-items: center; gap: .3rem; }
.nvn-metric {
  background: var(--surface2); border-radius: 8px; padding: .5rem .75rem;
  display: flex; flex-direction: column; gap: .12rem;
}
.nvn-metric-lbl { font-size: .58rem; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; }
.nvn-metric-val { font-size: .95rem; font-weight: 700; font-family: var(--font-mono), monospace; }
.nvn-bar-wrap { height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; margin-top: .2rem; }
.nvn-bar { height: 100%; border-radius: 3px; transition: width .6s ease; }
.nvn-winner { font-size: .58rem; color: var(--up); font-weight: 700; text-transform: uppercase; letter-spacing: .07em; margin-top: .1rem; }

/* ── Gone Dark ── */
.dark-lease {
  display: flex; align-items: center; justify-content: space-between;
  padding: .4rem 0; border-bottom: 1px solid var(--border);
}
.dark-lease:last-child { border-bottom: none; }
.dark-badge {
  font-size: .6rem; font-weight: 700; padding: .15rem .45rem;
  border-radius: 20px; background: rgba(239,68,68,.15); color: #ef4444;
  border: 1px solid rgba(239,68,68,.25);
}

/* ── Streak rows ── */
.streak-row {
  display: flex; align-items: center; gap: .5rem;
  padding: .38rem 0; border-bottom: 1px solid var(--border);
}
.streak-row:last-child { border-bottom: none; }
.streak-flame { font-size: .9rem; flex-shrink: 0; }
.streak-name { font-size: .78rem; font-weight: 600; flex: 1; }
.streak-days {
  font-size: .7rem; font-weight: 700; font-family: var(--font-mono), monospace;
  color: var(--up);
}
.streak-bar { flex: 1; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; min-width: 40px; }
.streak-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, #f59e0b, #10b981); }

/* ── Day of Week bars ── */
.dow-row {
  display: flex; align-items: center; gap: .6rem; margin-bottom: .45rem;
}
.dow-lbl { font-size: .72rem; font-weight: 600; width: 32px; flex-shrink: 0; }
.dow-bar-bg { flex: 1; height: 22px; background: var(--surface2); border-radius: 5px; overflow: hidden; position: relative; }
.dow-bar-fill { height: 100%; border-radius: 5px; display: flex; align-items: center; padding-left: .4rem; transition: width .5s ease; }
.dow-bar-val { font-size: .65rem; font-weight: 700; color: #fff; font-family: var(--font-mono), monospace; white-space: nowrap; }
.dow-count { font-size: .62rem; color: var(--muted); width: 48px; text-align: right; flex-shrink: 0; }

/* ── Consistency ── */
.cons-row {
  display: flex; align-items: center; gap: .55rem;
  padding: .32rem 0; border-bottom: 1px solid var(--border);
}
.cons-row:last-child { border-bottom: none; }
.cons-score {
  width: 36px; height: 36px; border-radius: 50%; display: flex;
  align-items: center; justify-content: center;
  font-size: .75rem; font-weight: 700; flex-shrink: 0;
  font-family: var(--font-mono), monospace;
}
.cons-name { font-size: .76rem; font-weight: 600; flex: 1; }
.cons-detail { font-size: .62rem; color: var(--muted); }

/* ── Outliers ── */
.outlier-row {
  display: flex; align-items: center; gap: .5rem;
  padding: .4rem 0; border-bottom: 1px solid var(--border);
}
.outlier-row:last-child { border-bottom: none; }
.outlier-mult {
  font-size: .7rem; font-weight: 700; padding: .12rem .4rem;
  border-radius: 6px; background: rgba(245,158,11,.15);
  color: #f59e0b; border: 1px solid rgba(245,158,11,.25);
  font-family: var(--font-mono), monospace; flex-shrink: 0;
}
.outlier-info { flex: 1; }
.outlier-name { font-size: .76rem; font-weight: 600; }
.outlier-date { font-size: .62rem; color: var(--muted); }
.outlier-val { font-family: var(--font-mono), monospace; font-size: .82rem; font-weight: 700; color: var(--up); }

/* ── New leases ── */
.newlease-row {
  display: flex; align-items: center; gap: .5rem;
  padding: .38rem 0; border-bottom: 1px solid var(--border);
}
.newlease-row:last-child { border-bottom: none; }
.new-badge {
  font-size: .58rem; font-weight: 700; padding: .12rem .4rem;
  border-radius: 20px; border: 1px solid; flex-shrink: 0;
}

/* ── Group efficiency bars ── */
.grp-eff-row {
  display: flex; align-items: center; gap: .6rem; margin-bottom: .55rem;
}
.grp-eff-lbl { font-size: .72rem; font-weight: 700; width: 72px; flex-shrink: 0; }
.grp-eff-bg { flex: 1; height: 24px; background: var(--surface2); border-radius: 6px; overflow: hidden; position: relative; }
.grp-eff-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; padding: 0 .5rem; gap: .4rem; transition: width .6s ease; }
.grp-eff-val { font-size: .68rem; font-weight: 700; color: #fff; font-family: var(--font-mono), monospace; }
.grp-eff-count { font-size: .6rem; color: rgba(255,255,255,.7); }

/* ── Withdrawal intel ── */
.with-intel-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin-bottom: .65rem;
}
.with-intel-card {
  background: var(--surface2); border-radius: 10px;
  padding: .6rem .8rem; border: 1px solid var(--border);
}
.with-intel-lbl { font-size: .58rem; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .2rem; }
.with-intel-val { font-size: 1.05rem; font-weight: 700; font-family: var(--font-mono), monospace; color: var(--text); }

/* ── Participation alert ── */
.part-alert {
  background: linear-gradient(135deg, rgba(239,68,68,.08), rgba(245,158,11,.06));
  border: 1px solid rgba(239,68,68,.25);
  border-left: 3px solid #ef4444;
  border-radius: 12px; padding: 1rem 1.25rem;
  display: flex; align-items: flex-start; gap: .75rem;
}
.part-alert-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: .1rem; }
.part-alert-title { font-size: .88rem; font-weight: 700; color: #ef4444; margin-bottom: .2rem; font-family: var(--font-heading), sans-serif; }
.part-alert-body { font-size: .78rem; color: var(--text2); line-height: 1.55; }

/* ── Scroll hint for long lists ── */
.list-scroll { max-height: 260px; overflow-y: auto; padding-right: .25rem; }
.list-scroll::-webkit-scrollbar { width: 4px; }
.list-scroll::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 2px; }

/* ══════════════════════════════
   LEASE DETAIL PAGE
══════════════════════════════ */
#leaseDetail {
  position: fixed; inset: 0; background: var(--bg);
  z-index: 1000; overflow-y: auto;
  animation: ldSlideIn .22s cubic-bezier(.25,.8,.25,1) both;
}
@keyframes ldSlideIn {
  from { opacity:0; transform: translateX(40px); }
  to   { opacity:1; transform: none; }
}

.ld-header {
  position: sticky; top: 0; z-index: 10;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: .85rem 1.6rem;
  display: flex; align-items: center; gap: 1.2rem;
  backdrop-filter: blur(12px);
}
.ld-back {
  display: flex; align-items: center; gap: .4rem;
  font-family: inherit; font-size: .78rem; font-weight: 600;
  color: var(--primary); background: rgba(59,130,246,.1);
  border: 1px solid rgba(59,130,246,.25); border-radius: 8px;
  padding: .45rem .9rem; cursor: pointer; transition: all .15s;
  white-space: nowrap; flex-shrink: 0;
}
.ld-back:hover { background: rgba(59,130,246,.2); transform: translateX(-2px); }

.ld-title-block { flex: 1; min-width: 0; }
.ld-name {
  font-family: var(--font-heading), sans-serif; font-size: 1.5rem;
  font-weight: 700; letter-spacing: -.03em; line-height: 1.1;
}
.ld-meta { font-size: .72rem; color: var(--muted); margin-top: .15rem; }
.ld-badges { display: flex; gap: .4rem; flex-shrink: 0; flex-wrap: wrap; align-items: center; }
.ld-badge {
  font-size: .65rem; font-weight: 700; padding: .2rem .55rem;
  border-radius: 20px; border: 1px solid; white-space: nowrap;
}

.ld-body { padding: 1.4rem 1.6rem 3rem; max-width: 1400px; margin: 0 auto; }

/* KPI strip */
.ld-kpi-strip {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
  gap: .6rem; margin-bottom: 1rem;
}
.ld-kpi {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: .75rem 1rem;
  border-top: 3px solid var(--kc-col, #3b82f6);
  transition: transform .15s, box-shadow .15s;
}
.ld-kpi:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
.ld-kpi-lbl { font-size: .58rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .3rem; }
.ld-kpi-val {
  font-family: var(--font-heading), sans-serif; font-size: 1.4rem; font-weight: 700;
  letter-spacing: -.03em; line-height: 1;
  background: linear-gradient(160deg, #fff 0%, #b0c4ee 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
body.light .ld-kpi-val { background: none; -webkit-text-fill-color: #111; }
.ld-kpi-sub { font-size: .62rem; color: var(--muted); margin-top: .25rem; }

.ld-two-col {
  display: grid; grid-template-columns: 1fr 1fr; gap: .9rem;
}
@media(max-width:760px) { .ld-two-col { grid-template-columns: 1fr; } }

/* Transaction log rows */
#ldTxnBody tr { cursor: default; }
#ldTxnBody tr:hover td { background: var(--surface2); }
.txn-badge {
  display: inline-block; font-size: .58rem; font-weight: 700;
  padding: .1rem .38rem; border-radius: 4px; margin-left: .35rem;
}

/* Click cursor on lease table rows */
.lease-table tbody tr { cursor: pointer; }
.lease-table tbody tr:hover td { background: var(--surface2); }
.lease-table tbody tr:hover td:first-child { color: var(--primary); }

/* Consistency ring */
.cons-ring-wrap {
  display: flex; align-items: center; gap: 1rem;
  padding: .6rem 0; border-bottom: 1px solid var(--border);
}

/* ══════════════════════════════
   HEATMAP CALENDAR
══════════════════════════════ */
.heatmap-wrap { display: flex; gap: .7rem; align-items: flex-start; }
.heatmap-months { display: flex; flex-direction: column; }
.hm-week { display: flex; flex-direction: column; gap: 2px; }
.hm-grid { display: flex; gap: 2px; }
.hm-cell {
  width: 13px; height: 13px; border-radius: 2px;
  cursor: pointer; transition: transform .1s;
  flex-shrink: 0;
}
.hm-cell:hover { transform: scale(1.4); z-index: 2; }
.hm-dow-labels { display: flex; flex-direction: column; gap: 2px; margin-right: 4px; }
.hm-dow-lbl { height: 13px; font-size: 8px; color: var(--muted); line-height: 13px; text-align: right; width: 20px; }
.hm-month-labels { display: flex; margin-bottom: 3px; }
.hm-month-lbl { font-size: 9px; color: var(--muted); }
.hm-tip {
  position: fixed; background: #ffffff; color: #1a2c38;
  border: 1px solid rgba(26,44,56,.15); border-radius: 9px;
  padding: .5rem .8rem; font-size: .7rem; pointer-events: none;
  z-index: 999999; box-shadow: 0 4px 20px rgba(0,0,0,.18), 0 1px 4px rgba(0,0,0,.10); display: none;
  border-left: 3px solid #10b981;
}

/* ══════════════════════════════
   WEEK OVER WEEK
══════════════════════════════ */
.wow-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
  gap: .6rem; margin-top: .5rem;
}
.wow-card {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: .65rem .85rem;
}
.wow-lbl { font-size: .58rem; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: .25rem; }
.wow-val { font-family: var(--font-mono), monospace; font-size: .95rem; font-weight: 700; }
.wow-delta { font-size: .68rem; font-weight: 600; margin-top: .2rem; }
.wow-bar-wrap { height: 4px; background: var(--surface3); border-radius: 2px; margin-top: .4rem; overflow: hidden; }
.wow-bar { height: 100%; border-radius: 2px; }

/* ══════════════════════════════
   NOTES / ANNOTATIONS
══════════════════════════════ */
.note-dot {
  position: absolute; width: 7px; height: 7px; border-radius: 50%;
  background: #f59e0b; border: 1.5px solid var(--bg);
  cursor: pointer; transform: translate(-50%, -50%);
  transition: transform .15s;
}
.note-dot:hover { transform: translate(-50%,-50%) scale(1.6); }
#noteModal {
  position: fixed; inset: 0; background: rgba(0,0,0,.55);
  z-index: 10000; display: none; align-items: center; justify-content: center;
}
#noteModal.open { display: flex; }
.note-modal-inner {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 16px; padding: 1.4rem; width: 380px; max-width: 95vw;
  box-shadow: var(--shadow-md);
}
.note-modal-title { font-family: var(--font-heading), sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: .85rem; }
.note-textarea {
  width: 100%; box-sizing: border-box;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 8px; color: var(--text); font-family: inherit;
  font-size: .82rem; padding: .6rem .8rem; resize: vertical; min-height: 80px;
  outline: none;
}
.note-textarea:focus { border-color: var(--primary); }
.note-btns { display: flex; gap: .5rem; margin-top: .75rem; justify-content: flex-end; }
.note-btn {
  font-family: inherit; font-size: .75rem; font-weight: 600;
  padding: .4rem .9rem; border-radius: 7px; cursor: pointer; border: none;
}
.note-btn.save { background: var(--primary); color: #fff; }
.note-btn.del  { background: rgba(239,68,68,.15); color: #ef4444; }
.note-btn.cancel { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }

/* ══════════════════════════════
   PRINT STYLES
══════════════════════════════ */
@media print {
  body { background: #fff !important; color: #111 !important; }
  #uploadScreen, #leaseDetail, .earnings-ticker,
  .hdr-btn, .reset-btn, .theme-btn, .ctrl-btns,
  #noteModal, .note-dot, #pageNav, #unsavedNotesBanner { display: none !important; }
  #topBar { position: static !important; box-shadow: none !important; }
  .hdr { border-bottom: 1px solid #ddd !important; }
  #dashboard { display: block !important; padding: 0 !important; }
  .sc { break-inside: avoid; box-shadow: none !important;
    border: 1px solid #ddd !important; background: #fff !important; }
  canvas { max-width: 100% !important; }
  .kc { background: #f9fafb !important; border: 1px solid #e5e7eb !important; }
  .gc { background: #f9fafb !important; border: 1px solid #e5e7eb !important; }
  a { color: #111 !important; }
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}

/* ══════════════════════════════
   COLLAPSIBLE / CLOSEABLE CARDS
══════════════════════════════ */

.card-controls {
  display: flex; gap: .3rem; align-items: center;
  position: absolute; top: .85rem; right: .9rem; z-index: 5;
  opacity: 0; transition: opacity .18s;
}
.sc:hover .card-controls { opacity: 1; }

.cc-btn {
  width: 22px; height: 22px; border-radius: 5px;
  border: 1px solid var(--border2); background: var(--surface2);
  color: var(--muted); font-size: 11px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all .12s; line-height: 1;
  font-family: inherit; flex-shrink: 0;
}
.cc-btn:hover { background: var(--surface3); color: var(--text); transform: scale(1.1); }
.cc-btn.close-btn:hover { background: rgba(239,68,68,.15); color: #ef4444; border-color: rgba(239,68,68,.3); }
.cc-btn.min-btn:hover { background: rgba(59,130,246,.12); color: #3b82f6; border-color: rgba(59,130,246,.25); }

.sc.minimized .sc-body { display: none !important; }
.sc.minimized { padding-bottom: .85rem; }
.sc.minimized .cc-btn.min-btn { background: rgba(59,130,246,.15); color: #3b82f6; border-color: rgba(59,130,246,.3); }

/* Restore tray */
#restoreTray {
  position: fixed; bottom: 1.2rem; right: 1.2rem;
  display: flex; flex-direction: column; gap: .4rem;
  z-index: 500; align-items: flex-end;
}
.restore-chip {
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 20px; padding: .35rem .75rem .35rem .55rem;
  display: flex; align-items: center; gap: .45rem;
  font-size: .68rem; font-weight: 600; color: var(--text2);
  cursor: pointer; box-shadow: var(--shadow-md);
  transition: all .15s; animation: chipIn .2s ease both;
  max-width: 220px;
}
.restore-chip:hover {
  background: var(--surface2); color: var(--primary);
  border-color: rgba(59,130,246,.35); transform: translateX(-3px);
}
.restore-chip-icon { font-size: .8rem; flex-shrink: 0; }
.restore-chip-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
@keyframes chipIn {
  from { opacity:0; transform: translateX(20px); }
  to   { opacity:1; transform: none; }
}

/* Transition for card body collapse */
.sc-body {
  transition: opacity .2s;
}
.sc.minimized .sc-body { opacity: 0; }
.ne-layout{display:grid;grid-template-columns:340px 1fr;gap:1rem;min-height:400px}
@media(max-width:768px){.ne-layout{grid-template-columns:1fr}}
.ne-left,.ne-right{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.8rem;overflow-y:auto;max-height:70vh}
.ne-pill{display:flex;align-items:center;gap:.5rem;padding:.45rem .7rem;background:var(--surface2);border:1px solid var(--border);border-radius:7px;cursor:grab;font-size:.78rem;margin-bottom:.35rem}
.ne-pill.ne-selected{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35)}
.ne-pill .ne-sel-box{cursor:pointer;font-size:.85rem;line-height:1;user-select:none;flex-shrink:0;opacity:.5}
.ne-pill.ne-selected .ne-sel-box{opacity:1;color:var(--primary)}
.ne-pill.dragging{opacity:.35}
.ne-pill .ne-hex{font-family:var(--font-mono);font-size:.72rem;color:var(--accent);background:rgba(59,130,246,.1);padding:.12rem .4rem;border-radius:4px;min-width:38px;text-align:center;font-weight:600}
.ne-pill .ne-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:text;font-weight:600}
.ne-pill .ne-rm{background:none;border:none;color:var(--muted);cursor:pointer;padding:0 3px;font-size:.85rem;opacity:.4}
.ne-pill .ne-rm:hover{opacity:1;color:#ef4444}
.ne-input{padding:.3rem .5rem;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.66rem;font-family:inherit;outline:none}
.ne-input:focus{border-color:var(--accent)}
.ne-gc{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:.7rem}
.ne-gc.drag-over{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.12)}
.ne-gc-head{display:flex;align-items:center;gap:.5rem;padding:.6rem .85rem;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap}

/* UNO/ULO Split Slider — matches Unity style */
.split-slider-wrap{display:flex;flex-direction:column;gap:.15rem;flex-shrink:0;min-width:140px}
.split-slider-labels{display:flex;justify-content:space-between;font-size:.48rem;font-weight:700}
.split-slider-labels .uno-lbl{color:#3b82f6}
.split-slider-labels .ulo-lbl{color:#8b5cf6}
.split-slider-track{position:relative;height:16px;display:flex;align-items:center}
.split-slider-track input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;border-radius:2px;outline:none;cursor:pointer;margin:0}
.split-slider-track input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #3b82f6;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.25);margin-top:0}
.split-slider-track input[type=range]::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #3b82f6;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.25)}
.split-slider-track input[type=range]::-webkit-slider-runnable-track{height:4px;border-radius:2px}
.split-slider-track input[type=range]::-moz-range-track{height:4px;border-radius:2px}
.ne-gc-swatch{width:20px;height:20px;border-radius:5px;border:2px solid rgba(255,255,255,.12);cursor:pointer;flex-shrink:0;position:relative}
.ne-gc-swatch input[type="color"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.ne-gc-name{flex:1;background:transparent;border:none;color:var(--text);font-size:.88rem;font-weight:700;font-family:inherit;outline:none}
.ne-gc-cnt{font-size:.68rem;color:var(--muted);font-weight:600}
.ne-gc-body{min-height:40px;padding:.5rem;position:relative}
.ne-gc-body.empty::after{content:'Drag leases here';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.72rem;font-style:italic;pointer-events:none}
.ne-add-group{border:2px dashed var(--border);border-radius:10px;padding:.75rem;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:.7rem}
.ne-add-group:hover{border-color:var(--accent);color:var(--accent)}
.ne-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center}
.ne-modal.on{display:flex}
.ne-modal-box{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.2rem;max-width:520px;width:90%}
</style>
</head>
<body>

<!-- ══════════════════════════════════════════════
     UPLOAD SCREEN
══════════════════════════════════════════════ -->
<div id="uploadScreen">

  <!-- LEFT: Logo fills panel height, slightly above centre -->
  <div class="dn-left">
    <div class="dn-logo-wrap">
      <div class="dn-logo-anim-wrap" id="logoAnimWrap">
        <div class="dn-math-particles" id="mathParticles"></div>
        <img src="data:image/jpeg;base64,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" alt="dataNerds Dashboard for Unity" class="dn-logo-img" id="logoImg"/>
      </div>
    </div>
    <!-- Integrity & Disclaimer under logo -->
    <div style="width:90%;max-width:340px;margin-top:.5rem">
      <div style="font-size:.52rem;font-weight:700;color:rgba(26,44,56,.45);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.25rem">File Integrity Check</div>
      <div style="display:flex;gap:.25rem;align-items:center">
        <input type="text" id="hashInput" placeholder="Paste SHA-256 hash to verify" style="flex:1;font-family:var(--font-mono);font-size:.5rem;padding:.3rem .45rem;border:1px solid rgba(26,44,56,.2);border-radius:5px;background:rgba(255,255,255,.5);color:#1a2c38;outline:none" spellcheck="false">
        <button onclick="verifyFileIntegrity()" style="padding:.3rem .55rem;font-size:.52rem;font-weight:700;border:1px solid rgba(26,44,56,.2);border-radius:5px;background:rgba(255,255,255,.5);color:#1a2c38;cursor:pointer;white-space:nowrap">Verify</button>
      </div>
      <div id="integrityBadge" style="margin-top:.25rem;display:flex;align-items:center;gap:.35rem;padding:.22rem .5rem;border-radius:5px;border:1px solid rgba(0,0,0,.06);background:rgba(255,255,255,.3);font-size:.5rem;color:rgba(26,44,56,.5)">
        <span id="integrityIcon">ℹ️</span>
        <span id="integrityText">Paste your release hash above and click Verify — get the hash from <strong>@datanerdsdash</strong> on X</span>
      </div>
      <div style="margin-top:.4rem;padding:.4rem .6rem;background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:6px;font-size:.48rem;color:#92400e;line-height:1.5">
        <strong>⚠️ Disclaimer:</strong> All data and projections depend on files you upload. Figures are approximations only. Verify with your official Unity account.
      </div>
      <div style="margin-top:.35rem;padding:.4rem .6rem;background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.18);border-radius:6px;font-size:.48rem;color:#065f46;line-height:1.6">
        <strong>🔐 File Verification Hash</strong><br>
        Get the official SHA-256 hash for each release from <strong><a href="https://x.com/datanerdsdash" target="_blank" rel="noopener" style="color:#059669;text-decoration:underline">@datanerdsdash</a></strong> on X (Twitter). Paste it above to confirm your file is an unmodified release.
      </div>
    </div>
  </div>

  <!-- DIVIDER -->
  <div class="dn-divider"></div>

  <!-- RIGHT: All controls, no scroll -->
  <div class="dn-right">

    <div class="dn-brand-text">
      <h1>data<span class="accent">Nerds</span></h1>
      <div class="sub">dataNerd Dashboard for Unity <span id="verBadge1" style="font-size:.75em;opacity:.5;font-weight:400">v4.20</span></div>
      <div class="tagline">All processing is local &nbsp;·&nbsp; nothing leaves your browser</div>
    </div>

    <!-- Mode Toggle -->
    <div style="display:flex;align-items:center;justify-content:center;gap:.6rem;margin-bottom:.4rem;max-width:960px;width:100%">
      <span id="modeLabelEasy" style="font-size:.68rem;font-weight:700;color:#3b82f6">Easy</span>
      <label style="position:relative;display:inline-block;width:44px;height:24px;cursor:pointer">
        <input type="checkbox" id="modeToggle" onchange="toggleDashboardMode()" style="opacity:0;width:0;height:0">
        <span style="position:absolute;inset:0;background:#3b82f6;border-radius:24px;transition:.3s"></span>
        <span id="modeKnob" style="position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.2)"></span>
      </label>
      <span id="modeLabelAdv" style="font-size:.68rem;font-weight:600;color:var(--muted)">Advanced</span>
    </div>

    <!-- Mode Explanation -->
    <div id="modeExplainEasy" style="max-width:520px;width:100%;margin:0 auto .7rem;background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.15);border-radius:10px;padding:.5rem .8rem;text-align:center">
      <div style="font-size:.82rem;font-weight:700;color:#3b82f6;margin-bottom:.2rem">Easy Mode</div>
      <div style="font-size:.72rem;color:var(--text2);line-height:1.5">
        Upload your earnings file and go. You'll get a clean dashboard with your KPIs, trend chart, scatter plot, earnings calendar, a lease table, and a health score. Perfect for a quick check on how your nodes are doing.
      </div>
    </div>
    <div id="modeExplainAdv" style="display:none;max-width:520px;width:100%;margin:0 auto .7rem;background:rgba(139,92,246,.05);border:1px solid rgba(139,92,246,.15);border-radius:10px;padding:.5rem .8rem;text-align:center">
      <div style="font-size:.82rem;font-weight:700;color:#8b5cf6;margin-bottom:.2rem">Advanced Mode</div>
      <div style="font-size:.72rem;color:var(--text2);line-height:1.5">
        Full analytics suite — 7 pages of charts, insights, and tools. Group your leases, name your nodes, track split percentages, compare time periods, archive your data, export reports, set lease expiry alerts, and more. Built for operators who want to squeeze every insight out of their earnings data.
      </div>
    </div>

    <!-- Unified Upload -->
    <div id="dropZoneAll" class="easy-only" onclick="document.getElementById('fileInputAll').click()" style="max-width:960px;width:100%;margin:0 auto .7rem;border:2px dashed rgba(59,130,246,.55);border-radius:12px;padding:.7rem 1.2rem;cursor:pointer;background:rgba(59,130,246,.09);transition:all .2s">
      <div style="display:flex;align-items:center;justify-content:center;gap:.7rem;flex-wrap:wrap">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <div style="font-size:.78rem;font-weight:800;color:#1a2c38">📂 Upload All Files At Once</div>
        <div style="font-size:.6rem;color:#6a8898" id="uploadDesc">Naming, earnings, withdrawals — auto-sorted</div>
        <button class="upload-btn" onclick="event.stopPropagation();document.getElementById('fileInputAll').click()" style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:.4rem .9rem;font-size:.68rem">⬆ Choose Files</button>
        <input type="file" id="fileInputAll" multiple accept=".txt,.json" style="display:none">
      </div>
      <div id="allUploadStatus" style="font-size:.6rem;color:var(--muted);text-align:center;margin-top:.25rem"></div>
    </div>

    <div class="upload-grid adv-only">

      <div class="upload-area" id="dropZoneNames" onclick="document.getElementById('fileInputNames').click()">
        <div class="upload-zone-glow" style="--zgc:#8b5cf6"></div>
        <div class="upload-icon" style="background:rgba(139,92,246,.14);box-shadow:0 0 0 5px rgba(139,92,246,.06)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linecap="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
        </div>
        <div class="upload-zone-badge" style="background:rgba(139,92,246,.12);color:#7c3aed;border-color:rgba(139,92,246,.28)">optional</div>
        <div class="upload-title">Lease Names</div>
        <div class="upload-desc">Your <strong>lease_names.txt</strong> — maps IDs to groups &amp; nodes.</div>
        <div class="upload-chip" style="background:rgba(139,92,246,.1);color:#7c3aed;border-color:rgba(139,92,246,.28)">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Choose .txt
        </div>
        <div id="namesStatus" class="upload-status"></div>
        <input type="file" id="fileInputNames" accept=".txt" style="display:none">
      </div>

      <div class="upload-area upload-area-primary" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="upload-zone-glow" style="--zgc:#3b82f6"></div>
        <div class="upload-icon" style="background:rgba(59,130,246,.16);box-shadow:0 0 0 6px rgba(59,130,246,.07)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
        </div>
        <div class="upload-zone-badge" style="background:rgba(220,38,38,.1);color:#dc2626;border-color:rgba(220,38,38,.28)">required</div>
        <div class="upload-title">Earnings Files</div>
        <div class="upload-desc"><strong>export1.txt · export2.txt</strong><br>Multiple OK — dupes auto-removed.</div>
        <button class="upload-btn" onclick="event.stopPropagation();document.getElementById('fileInput').click()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Choose Files
        </button>
        <input type="file" id="fileInput" multiple accept=".txt,.json" style="display:none">
      </div>

      <div class="upload-area" id="dropZoneWith" onclick="document.getElementById('fileInputWith').click()">
        <div class="upload-zone-glow" style="--zgc:#10b981"></div>
        <div class="upload-icon" style="background:rgba(16,185,129,.12);box-shadow:0 0 0 5px rgba(16,185,129,.05)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round">
            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
        </div>
        <div class="upload-zone-badge" style="background:rgba(16,185,129,.1);color:#059669;border-color:rgba(16,185,129,.28)">optional</div>
        <div class="upload-title">Withdrawals</div>
        <div class="upload-desc">Withdrawal JSON files — unlocks balance &amp; crypto tracking.</div>
        <div class="upload-chip" style="background:rgba(16,185,129,.1);color:#059669;border-color:rgba(16,185,129,.28)">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Choose Files
        </div>
        <div id="withStatus" class="upload-status"></div>
        <input type="file" id="fileInputWith" multiple accept=".txt,.json" style="display:none">
      </div>

    </div>


    <div class="upload-slots adv-only" id="fileSlots" style="margin-top:.25rem">
      <div class="slot"><div class="slot-dot"></div>Waiting for earnings files…</div>
    </div>

    <div class="upload-cutoff adv-only" style="flex-direction:row;align-items:center;gap:.5rem;flex-wrap:wrap;margin-top:.2rem">
      <div style="display:flex;align-items:center;gap:.3rem;font-size:.55rem;color:rgba(26,44,56,.5)">
        <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
        <span>Start: <strong id="startDateDisplay">auto</strong></span>
      </div>
      <div style="display:flex;align-items:center;gap:.35rem">
        <label style="font-size:.55rem;color:rgba(26,44,56,.5)">Override:</label>
        <input type="date" id="startDatePicker" style="font-size:.55rem;padding:.15rem .3rem;border:1px solid rgba(26,44,56,.2);border-radius:5px;background:#fff;color:#1a2c38;cursor:pointer" oninput="onStartDateChange(this.value)"/>
        <button onclick="clearStartDate()" style="font-size:.52rem;background:none;border:1px solid rgba(26,44,56,.18);border-radius:4px;padding:.12rem .4rem;color:#6a8898;cursor:pointer">Auto</button>
      </div>
    </div>
    <div id="startDateHint" class="adv-only" style="font-size:.5rem;color:rgba(26,44,56,.35);line-height:1.3;max-width:420px;margin-top:.1rem">
      💡 If charts look mismatched across multiple files, set a start date you know all files share.
    </div>

    <button class="load-btn" id="loadBtn" onclick="buildDashboard()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      Build Dashboard
    </button>


  </div>

</div>

<!-- ════════════════════════════════════════
     FIXED TOP BAR (header + page nav)  
════════════════════════════════════════ -->
<div id="topBar">
  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-brand">
      <div class="hdr-logo" style="background:none;padding:0;width:auto;height:auto">
        <img src="data:image/png;base64,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" alt="dataNerds" style="width:44px;height:44px;border-radius:50%;display:block;border:2px solid rgba(26,44,56,.15);box-shadow:0 2px 8px rgba(0,0,0,.15);object-fit:cover"/>
      </div>
      <div>
        <h1><span style="color:#1a2c38;font-weight:900">data</span><span style="color:#c0392b;font-weight:900">Nerd</span> <span style="color:var(--primary)">Dashboard</span> <span style="font-size:.7em;font-weight:400;color:var(--muted)">for Unity</span> <span id="verBadge2" style="font-size:.5em;font-weight:600;color:var(--muted);opacity:.5">v4.20</span></h1>
        <p id="hdrSub">—</p>
      </div>
    </div>
    <div class="hdr-right">
      <div class="legend" id="legendRow"></div>
      <span class="live-badge">● LIVE</span>
      <span id="grossIndicator" style="display:none;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:#fff;font-size:.52rem;font-weight:800;padding:.2rem .5rem;border-radius:6px;letter-spacing:.03em;cursor:help" title="You are viewing combined UNO + ULO earnings. This is calculated data, not actual received. Click the UNO + ULO button to switch back.">UNO + ULO VIEW</span>
      <a id="switchModeLink" href="#" onclick="event.preventDefault();switchModeFromHeader()" style="display:none;font-size:.58rem;font-weight:700;color:#3b82f6;text-decoration:none;padding:.3rem .6rem;border:1px solid rgba(59,130,246,.3);border-radius:6px;white-space:nowrap">Switch to Advanced →</a>
      <button class="theme-btn" onclick="toggleGrossView()" id="grossBtn" style="display:none" title="Switch between UNO earnings and combined UNO + ULO earnings view">💰 UNO Earnings</button>
      <button class="theme-btn" onclick="toggleCompactView()" id="compactBtn" style="display:none" title="Quick daily summary">📊 Quick</button>
      <button class="theme-btn" onclick="generateShareSnapshot()" id="shareBtn" style="display:none" title="Generate a shareable stats summary">📸 Share</button>
      <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">🌙 Dark</button>
      <button class="reset-btn" onclick="resetDashboard()">↺ Reset</button>
    </div>
  </div>
  <div id="pageNav">
    <button class="nav-tab active" data-page="overview" onclick="showPage('overview')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Overview
    </button>
    <button class="nav-tab" data-page="earnings" onclick="showPage('earnings')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
      Earnings
    </button>
    <button class="nav-tab" data-page="distribution" onclick="showPage('distribution')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="8" cy="12" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="12" cy="17" r="2"/><circle cx="18" cy="16" r="2"/><circle cx="6" cy="7" r="2"/></svg>
      Distribution
    </button>
    <button class="nav-tab" data-page="performance" onclick="showPage('performance')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      Insights
    </button>
    <button class="nav-tab" data-page="leases" onclick="showPage('leases')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      Leases
    </button>
    <button class="nav-tab" data-page="archive" onclick="showPage('archive')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="10" y1="14" x2="14" y2="14"/></svg>
      Archive
    </button>
    <button class="nav-tab" data-page="editor" onclick="showPage('editor')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Names
    </button>
    <button class="nav-tab" data-page="tools" onclick="showPage('tools')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.32 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Tools <span id="healthBadge" style="display:none;background:#ef4444;color:#fff;font-size:.5rem;font-weight:800;border-radius:50%;width:15px;height:15px;line-height:15px;text-align:center;margin-left:2px;vertical-align:top"></span>
    </button>
    <button class="nav-tab" data-page="donate" onclick="showPage('donate')">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      Donate
    </button>
  </div>
</div><!-- /topBar -->

<!-- ══════════════════════════════════════════════
     DASHBOARD
══════════════════════════════════════════════ -->
<div id="dashboard">

  <!-- ═══ PAGE: OVERVIEW ═══ -->
  <div class="page-section active" id="page-overview">

  <!-- Search / Filter Bar -->
  <div id="overviewFilter" class="adv-overview-only" style="display:none;margin-bottom:.85rem;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:.5rem .8rem;display:none;align-items:center;gap:.6rem;flex-wrap:wrap">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <input id="overviewSearch" type="text" placeholder="Filter by lease name, hex, group, or node…" style="flex:1;min-width:180px;padding:.3rem .5rem;font-size:.72rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);outline:none" oninput="applyOverviewFilter()">
    <select id="overviewNodeFilter" style="padding:.3rem .5rem;font-size:.68rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)" onchange="applyOverviewFilter()">
      <option value="all">All Nodes</option>
    </select>
    <select id="overviewGroupFilter" style="padding:.3rem .5rem;font-size:.68rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)" onchange="applyOverviewFilter()">
      <option value="all">All Groups</option>
    </select>
    <span id="overviewFilterStatus" style="font-size:.6rem;color:var(--muted)"></span>
    <button class="cbtn" style="padding:.2rem .5rem;font-size:.58rem" onclick="clearOverviewFilter()">✕ Clear</button>
  </div>

  <!-- Silent Lease Alerts Banner -->
  <div id="silentLeaseBanner" class="adv-overview-only" style="display:none;margin-bottom:.85rem;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:10px;padding:.6rem .9rem">
    <div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem">
      <span style="font-size:.9rem">🔇</span>
      <span style="font-size:.72rem;font-weight:700;color:#ef4444" id="silentLeaseTitle">Silent Leases Detected</span>
      <button class="cbtn" style="margin-left:auto;padding:.15rem .4rem;font-size:.52rem" onclick="document.getElementById('silentLeaseBanner').style.display='none'">Dismiss</button>
    </div>
    <div id="silentLeaseList" style="font-size:.65rem;color:var(--text2);line-height:1.6"></div>
  </div>

  <div id="expiryAlertBanner" class="adv-overview-only" style="display:none;margin-bottom:.85rem;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:10px;padding:.6rem .9rem">
    <div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem">
      <span style="font-size:.9rem">⏰</span>
      <span style="font-size:.72rem;font-weight:700;color:#d97706" id="expiryAlertTitle">Lease Expirations</span>
      <button class="cbtn" style="margin-left:auto;padding:.15rem .4rem;font-size:.52rem" onclick="document.getElementById('expiryAlertBanner').style.display='none'">Dismiss</button>
    </div>
    <div id="expiryAlertList" style="font-size:.65rem;color:var(--text2);line-height:1.6"></div>
  </div>

  <!-- KPIs -->
  <div class="kpi-row" id="kpiRow"></div>
  <div class="kpi-row" id="kpiRow2" style="margin-bottom:1.4rem"></div>

  <!-- Easy Mode Charts (hidden in advanced) -->
  <div id="easyModeCharts" style="display:none">
    <div class="sc" style="margin-bottom:.9rem">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/></svg>
        Daily Earnings Trend
      </div>
      <div id="easyTrendWrap" style="width:100%;min-height:220px">
        <canvas id="easyTrendCanvas" style="width:100%;display:block" height="220"></canvas>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.9rem;margin-bottom:.9rem" id="easyChartsGrid">
      <div class="sc" style="margin-bottom:0">
        <div class="sc-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
          Revenue Trend
        </div>
        <div style="display:flex;gap:.3rem;flex-wrap:wrap;margin-bottom:.4rem">
          <div class="ctrl-btns" id="easyTrendPeriodBtns" style="display:flex;gap:.3rem">
            <button class="cbtn on" onclick="setTrendPeriod('day',this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Day</button>
            <button class="cbtn" onclick="setTrendPeriod('week',this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Week</button>
            <button class="cbtn" onclick="setTrendPeriod('month',this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Month</button>
          </div>
          <div class="ctrl-btns" id="easyTrendViewBtns" style="display:flex;gap:.3rem">
            <button class="cbtn on" onclick="setTrend(0,this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Total</button>
            <button class="cbtn" onclick="setTrend(1,this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Max</button>
            <button class="cbtn" onclick="setTrend(2,this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Avg</button>
            <button class="cbtn" onclick="setTrend(3,this,'easyRevTrendCanvas')" style="padding:.15rem .45rem;font-size:.55rem">Active</button>
          </div>
        </div>
        <div id="easyRevTrendWrap" style="width:100%;min-height:240px">
          <canvas id="easyRevTrendCanvas" style="width:100%;display:block" height="240"></canvas>
        </div>
      </div>
    </div>
    <div style="display:flex;gap:.85rem;margin-bottom:.9rem;flex-wrap:wrap">
      <div class="sc" style="margin-bottom:0;flex:2;min-width:320px">
        <div class="sc-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="8" cy="12" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="12" cy="17" r="2"/></svg>
          License Earning Distribution
        </div>
        <div class="sc-sub">One dot per lease per day · color = group · hover for lease name &amp; amount</div>
        <div id="easyDistWrap" style="width:100%;overflow:hidden">
          <canvas id="easyDistCanvas" style="width:100%;display:block" height="280"></canvas>
        </div>
      </div>
      <div class="sc" style="margin-bottom:0;flex:1;min-width:180px">
        <div class="sc-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
          Earnings Calendar
        </div>
        <div id="easyHeatmapChart" style="overflow-x:auto;padding-bottom:.5rem"></div>
      </div>
    </div>
  </div>

  <!-- Group cards -->
  <div class="grp-row adv-overview-only" id="grpRow"></div>

  <!-- Portfolio Health Score -->
  <div class="sc" style="margin-bottom:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      Portfolio Health Score
    </div>
    <div class="sc-sub">Composite grade from 6 performance signals</div>
    <div id="healthScoreContainer" style="display:flex;align-items:center;gap:1.5rem;flex-wrap:wrap;padding:.4rem 0"></div>
  </div>

  <!-- Participation -->
  <div class="sc adv-overview-only">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Daily License Participation
    </div>
    <div class="sc-sub">Active leases vs total known · <strong style="color:#ef4444">red &lt;70%</strong> · <strong style="color:#f59e0b">amber 70–85%</strong> · <strong style="color:#10b981">green ≥85%</strong></div>
    <div class="part-scroll" id="partRow"></div>
    <div class="part-key">
      <span>Key:</span>
      <div class="part-key-item"><div class="part-key-dot" style="background:#10b981"></div>≥85% strong</div>
      <div class="part-key-item"><div class="part-key-dot" style="background:#f59e0b"></div>70–85% moderate</div>
      <div class="part-key-item"><div class="part-key-dot" style="background:#ef4444"></div>&lt;70% low</div>
    </div>
  </div>

  <!-- Analysis -->
  <div class="analysis-block adv-overview-only" id="analysisBlock">
    <div class="analysis-title">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>
      AI Data Analysis &amp; Trends
    </div>
    <div class="insight-list" id="insightList">
      <div class="insight"><div class="insight-icon">⏳</div><span>Loading analysis…</span></div>
    </div>
  </div>

  </div><!-- /page-overview -->

  <!-- ═══ PAGE: EARNINGS ═══ -->
  <div class="page-section" id="page-earnings">

  <!-- Withdrawal Summary -->
  <div class="sc" id="withdrawCard" style="display:none;border-left:3px solid #10b981">
    <div class="sc-title" style="color:#10b981">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Withdrawal Summary
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin-top:.65rem" id="withdrawGrid"></div>
    <div style="margin-top:.5rem;padding:.35rem .6rem;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:6px;font-size:.54rem;color:#92400e;line-height:1.5">
      ⚠️ If your earnings files don't cover the full withdrawal period, the net balance may appear lower than actual. Upload all available earnings exports for the most accurate view.
    </div>
    <div style="margin-top:.8rem" id="withdrawList"></div>
  </div>

  <!-- Monthly chart -->
  <div class="sc" style="animation-delay:.4s">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      Monthly Earnings Breakdown
    </div>
    <div class="sc-sub">Stacked by group · highest earner anchored at bottom · upload monthly + year-end files to grow this over time</div>
    <div class="ctrl-row" style="margin-bottom:.6rem">
      <div class="ctrl-btns">
        <button class="cbtn on" onclick="setMonthView('stacked',this)">Stacked</button>
        <button class="cbtn" onclick="setMonthView('total',this)">Total</button>
        <button class="cbtn" onclick="setMonthView('group',this)">By Group</button>
      </div>
      <div id="monthStats" style="font-size:.7rem;color:var(--muted);font-weight:500"></div>
    </div>
    <div id="monthChart"></div>
  </div>

  <!-- Daily Earnings Bar Chart -->
  <div class="sc" style="margin-top:.9rem">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem">
      <div>
        <div class="sc-title">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          <span id="barChartTitle">Daily Earnings — Bar Chart</span>
        </div>
        <div class="sc-sub">Total rewards earned each <span id="barPeriodLabel">day</span> · hover a bar for exact amount · color = period vs rolling average · <strong>📝 click any bar to add a note</strong> (notes save to your naming file when exported)</div>
      </div>
      <div class="ctrl-btns" id="barPeriodBtns">
        <button class="cbtn on" onclick="setBarPeriod('day',this)">Day</button>
        <button class="cbtn" onclick="setBarPeriod('week',this)">Week</button>
        <button class="cbtn" onclick="setBarPeriod('month',this)">Month</button>
      </div>
    </div>
    <canvas id="dailyBarCanvas" style="width:100%;display:block;cursor:crosshair" height="220"></canvas>
    <div id="dailyBarTip" style="display:none !important;position:fixed;background:#1a2c38;color:#f0f4f8;border:1px solid rgba(255,255,255,.12);border-left:3px solid var(--primary);border-radius:10px;padding:.6rem .9rem;font-size:.72rem;pointer-events:none;z-index:99999;box-shadow:0 8px 32px rgba(0,0,0,.45)"></div>
  </div>

  <!-- Analysis moved to Overview -->

  <!-- ── FINANCIAL INSIGHTS ROW ── -->
  <div class="two-col" id="financialRow" style="margin-top:.9rem">
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        Monthly Earnings Projector
      </div>
      <div class="sc-sub">Current pace, trend, and confidence range</div>
      <div id="projectorContent"></div>
    </div>
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Pending Withdrawal Balance
      </div>
      <div class="sc-sub">Earnings since your last withdrawal</div>
      <div id="pendingWithdrawal"></div>
    </div>
  </div>

  <!-- Withdrawal Intelligence -->
  <div class="sc" style="margin-top:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
      Withdrawal Intelligence
    </div>
    <div class="sc-sub">Avg ADA rate, withdrawal frequency &amp; timing patterns</div>
    <div id="withdrawIntel"></div>
  </div>

  </div><!-- /page-earnings -->

  <!-- ═══ PAGE: DISTRIBUTION ═══ -->
  <div class="page-section" id="page-distribution">

  <!-- Distribution -->
  <div class="sc">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
      License Earning Distribution
    </div>
    <div class="sc-sub">One dot per lease per day · daily earnings total · color = group · <strong>● N1</strong> · <strong>◆ N2</strong> · <strong>▲ N3</strong> · <strong>■ N4</strong> · hover for lease name &amp; amount</div>
    <div class="ctrl-row">
      <div style="display:flex;gap:.75rem;flex-wrap:wrap;align-items:center">
        <div class="ctrl-btns" id="distWindowBtns">
          <button class="cbtn" onclick="setDistWindow(5,this)">5 Days</button>
          <button class="cbtn on" onclick="setDistWindow(7,this)">7 Days</button>
          <button class="cbtn" onclick="setDistWindow(14,this)">14 Days</button>
          <button class="cbtn" onclick="setDistWindow(999,this)">All</button>
        </div>
      </div>
      <div class="chart-stats" id="distStats"></div>
    </div>
    <canvas id="distCanvas" style="width:100%;display:block;cursor:crosshair" height="280"></canvas>
  </div>


  <!-- Earnings Heatmap Calendar -->
  <div class="sc" style="margin-top:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Earnings Heatmap Calendar
    </div>
    <div class="sc-sub">GitHub-style · darker = more earned · hover for exact amount · red = offline</div>
    <div id="heatmapChart" style="overflow-x:auto;padding-bottom:.5rem"></div>
  </div>

  <!-- Group Performance Radar -->
  <div class="sc" style="margin-top:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5"/><line x1="12" y1="2" x2="12" y2="22"/><line x1="2" y1="8.5" x2="22" y2="8.5"/><line x1="2" y1="15.5" x2="22" y2="15.5"/></svg>
      Group Performance Radar
    </div>
    <div class="sc-sub">Each group scored across 5 dimensions · hover a shape for details</div>
    <canvas id="radarCanvas" style="width:100%;display:block;cursor:crosshair;max-height:340px" height="340"></canvas>
  </div>

  </div><!-- /page-distribution -->

  <!-- ═══ PAGE: PERFORMANCE ═══ -->
  <div class="page-section" id="page-performance">

  <!-- Trend + Top/Bottom -->
  <div class="two-col">
    <div class="sc" style="margin-bottom:0">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:.5rem;margin-bottom:.2rem">
        <div>
          <div class="sc-title">Revenue Trend</div>
          <div class="sc-sub" id="trendSub" style="margin-bottom:.7rem">Daily Total</div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center">
          <div class="ctrl-btns" id="trendPeriodBtns">
            <button class="cbtn on" onclick="setTrendPeriod('day',this)">Day</button>
            <button class="cbtn" onclick="setTrendPeriod('week',this)">Week</button>
            <button class="cbtn" onclick="setTrendPeriod('month',this)">Month</button>
          </div>
          <div class="ctrl-btns">
            <button class="cbtn on" onclick="setTrend(0,this)">Total</button>
            <button class="cbtn" onclick="setTrend(1,this)">Max</button>
            <button class="cbtn" onclick="setTrend(2,this)">Avg</button>
            <button class="cbtn" onclick="setTrend(3,this)">Active</button>
          </div>
        </div>
      </div>
      <canvas id="trendCanvas" style="width:100%;display:block" height="210"></canvas>
    </div>
    <div class="sc" style="margin-bottom:0">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem;flex-wrap:wrap;gap:.5rem">
        <div>
          <div class="sc-title">🏆 Lease Leaderboard</div>
          <div class="sc-sub" id="tbDateLbl" style="margin-bottom:0">—</div>
        </div>
        <div style="display:flex;gap:.4rem;align-items:center">
          <button onclick="changeDay(-1)" class="cbtn" style="padding:.26rem .6rem">← Prev</button>
          <span id="tbPos" style="font-size:.65rem;color:var(--muted);min-width:36px;text-align:center"></span>
          <button onclick="changeDay(1)" class="cbtn" style="padding:.26rem .6rem">Next →</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div>
          <div style="font-size:.58rem;font-weight:700;color:var(--up);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.45rem">🏆 Top 10 — MVPs</div>
          <div id="top10"></div>
        </div>
        <div>
          <div style="font-size:.58rem;font-weight:700;color:var(--down);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.45rem">🦥 Bottom 10 — Quiet Quitters</div>
          <div id="bot10"></div>
        </div>
      </div>
      <div style="font-size:.58rem;color:var(--muted);margin-top:.65rem;font-style:italic">● solid = N1 · ◆ diamond stripe = N2 · ▲ triangle dot = N3 · ■ square crosshatch = N4</div>
    </div>
  </div>

  <!-- ── NODE HEAD-TO-HEAD ── -->
  <div class="sc" style="margin-top:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="9" height="18" rx="2"/><rect x="13" y="3" width="9" height="18" rx="2"/></svg>
      Node Comparison — Head to Head
    </div>
    <div class="sc-sub">Direct comparison across all nodes and metrics</div>
    <div id="nodeVsNode"></div>
  </div>

  <!-- ────────────────────────────────────────────
       SECTION 2 — PERFORMANCE TRENDS
  ──────────────────────────────────────────── -->
  <div class="an-section-hdr" style="margin-top:1.6rem">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
    Performance Trends
  </div>

  <!-- Week-over-Week -->
  <div class="sc" style="margin-bottom:.75rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Week-over-Week Summary
    </div>
    <div class="sc-sub">This week vs last week across all key metrics</div>
    <div id="wowContent"></div>
  </div>

  <!-- Day of Week + Group Efficiency -->
  <div class="two-col">
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
        Best Day of the Week
      </div>
      <div class="sc-sub">Average daily earnings by weekday — find your best &amp; worst days</div>
      <div id="dowChart"></div>
    </div>
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Group Efficiency — Per Lease Per Day
      </div>
      <div class="sc-sub">Average earnings per active lease per day · true efficiency metric</div>
      <div id="groupEfficiency"></div>
    </div>
  </div>

  <!-- ────────────────────────────────────────────
       SECTION 3 — LEASE HEALTH
  ──────────────────────────────────────────── -->
  <div class="an-section-hdr" style="margin-top:1.6rem">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    Lease Health
  </div>

  <div class="two-col">
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Consistency Scores
      </div>
      <div class="sc-sub">% of days active — how reliably each lease earns · top 20 shown</div>
      <div id="consistencyContent"></div>
    </div>
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        Earning Streaks
      </div>
      <div class="sc-sub">Consecutive days earning without a single miss · top 15 shown</div>
      <div id="streakContent"></div>
    </div>
  </div>

  <div class="two-col" style="margin-top:.75rem">
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        Gone Dark — Inactive Leases
      </div>
      <div class="sc-sub">Leases with no earnings in the last 3+ days</div>
      <div id="goneDark"></div>
    </div>
    <div class="sc" style="margin-bottom:0">
      <div class="sc-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        New &amp; Returning Leases
      </div>
      <div class="sc-sub">First appearances and leases that re-activated in the last 4 days</div>
      <div id="newLeasesContent"></div>
    </div>
  </div>

  <!-- ────────────────────────────────────────────
       SECTION 4 — SIGNALS & ANOMALIES
  ──────────────────────────────────────────── -->
  <div class="an-section-hdr" style="margin-top:1.6rem">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    Signals &amp; Anomalies
  </div>

  <div class="sc">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      Outlier Rewards
    </div>
    <div class="sc-sub">Transactions more than 2.5× the average — anomalies worth knowing</div>
    <div id="outlierContent"></div>
  </div>

  <!-- ── PARTICIPATION ALERT ── -->
  <div id="participationAlertCard" style="display:none;margin-top:.75rem"></div>

  <!-- ── COMPARE PERIODS ── -->
  <div class="sc" style="margin-top:.9rem;border-left:3px solid #8b5cf6">
    <div class="sc-title" style="color:#8b5cf6">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      Compare Periods
    </div>
    <div class="sc-sub">Select two date ranges to see the delta across every metric</div>
    <div style="display:flex;gap:.8rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:.6rem">
      <div>
        <div style="font-size:.58rem;font-weight:700;color:#ec4899;text-transform:uppercase;margin-bottom:.2rem">Period A</div>
        <div style="display:flex;gap:.3rem;align-items:center">
          <input type="date" id="cpAStart" style="padding:.2rem .4rem;font-size:.62rem;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--text)">
          <span style="font-size:.55rem;color:var(--muted)">→</span>
          <input type="date" id="cpAEnd" style="padding:.2rem .4rem;font-size:.62rem;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--text)">
        </div>
      </div>
      <div>
        <div style="font-size:.58rem;font-weight:700;color:#8b5cf6;text-transform:uppercase;margin-bottom:.2rem">Period B</div>
        <div style="display:flex;gap:.3rem;align-items:center">
          <input type="date" id="cpBStart" style="padding:.2rem .4rem;font-size:.62rem;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--text)">
          <span style="font-size:.55rem;color:var(--muted)">→</span>
          <input type="date" id="cpBEnd" style="padding:.2rem .4rem;font-size:.62rem;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--text)">
        </div>
      </div>
      <div style="display:flex;gap:.3rem">
        <button class="cbtn" style="padding:.25rem .5rem;font-size:.58rem" onclick="cpPreset('week')">This vs Last Week</button>
        <button class="cbtn" style="padding:.25rem .5rem;font-size:.58rem" onclick="cpPreset('month')">This vs Last Month</button>
        <button class="cbtn on" style="padding:.3rem .7rem;font-size:.62rem" onclick="runComparePeriods()">⚡ Compare</button>
      </div>
    </div>
    <div id="comparePeriodResult"><div style="color:var(--muted);font-size:.72rem">Pick two periods or use a preset, then click Compare.</div></div>
  </div>

  </div><!-- /page-performance -->


  <!-- ═══ PAGE: ARCHIVE ═══ -->
  <div class="page-section" id="page-archive">

  <!-- Export toolbar -->
  <div style="display:flex;align-items:center;justify-content:flex-end;gap:.5rem;margin-bottom:1rem;padding-top:.8rem">
    <span style="font-size:.62rem;color:var(--muted);font-weight:600;margin-right:.3rem">EXPORT</span>
    <button class="cbtn" onclick="exportCSV()" style="font-size:.64rem;padding:.24rem .7rem">⬇ CSV</button>
    <button class="cbtn" onclick="printReport()" style="font-size:.64rem;padding:.24rem .7rem">🖨 PDF</button>
  </div>

  <!-- ── DETAILED HOW-TO GUIDE ── -->
  <div class="sc" style="border-left:4px solid #6366f1;margin-bottom:.9rem">
    <div class="sc-title" style="color:#6366f1">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      How Archiving Works — Step by Step
    </div>
    <div class="sc-sub" style="margin-bottom:.5rem">Unity caps exports at <strong>1,000 records</strong>. The more licenses you run, the fewer days that covers. Export <strong>daily</strong> to be safe.</div>

    <!-- Dynamic estimate based on loaded data -->
    <div id="archiveEstimateBox" style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:.65rem .9rem;margin-bottom:.6rem;display:none">
      <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
        <span style="font-size:1.1rem">⏰</span>
        <span id="archiveEstimateText" style="font-size:.74rem;font-weight:700;color:#ef4444"></span>
      </div>
    </div>

    <div style="font-size:.73rem;color:var(--text);line-height:1.75">

      <div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:.7rem .9rem;margin-bottom:.6rem">
        <div style="font-weight:800;color:#ef4444;margin-bottom:.3rem">⚠️ Why This Matters</div>
        Unity's transaction export is capped at <strong>1,000 rows</strong>. Each active license generates ~1 transaction per day. The more licenses you have, the faster old data falls off:
        <div style="margin-top:.4rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.3rem .6rem;font-size:.65rem">
          <div><strong>50 licenses</strong> → ~20 days</div>
          <div><strong>100 licenses</strong> → ~10 days</div>
          <div><strong>200 licenses</strong> → ~5 days</div>
          <div><strong>300 licenses</strong> → ~3 days</div>
          <div><strong>500 licenses</strong> → ~2 days</div>
          <div><strong>1,000 licenses</strong> → ~1 day</div>
        </div>
        <div style="margin-top:.4rem">For most setups, <strong>daily exporting</strong> is the safest approach. Set a reminder!</div>
      </div>

      <div class="inner-card">
        <div style="font-weight:800;color:#3b82f6;margin-bottom:.3rem">📥 Step 1 — Export from Unity (daily!)</div>
        Open the Unity app → go to your earnings/transactions section → export your data as a <code>.txt</code> file. Make this part of your <strong>daily routine</strong> — it takes 10 seconds and protects weeks of earnings history. Save the file somewhere safe on your computer (e.g. a <code>Unity Exports/</code> folder).
      </div>

      <div class="inner-card">
        <div style="font-weight:800;color:#3b82f6;margin-bottom:.3rem">📊 Step 2 — Upload &amp; Build the Dashboard</div>
        Drag your Unity <code>.txt</code> export into the dashboard's upload zone (the "Earnings Data" zone on the start screen). If you already have an archive file from a previous session, drop that in too — the dashboard accepts <strong>multiple files</strong>. Add your naming file and withdrawal file if you have them. Click <strong>Build Dashboard</strong>.
      </div>

      <div class="inner-card">
        <div style="font-weight:800;color:#d97706;margin-bottom:.3rem">💾 Step 3 — Save Individual Periods</div>
        On this Archive page, you'll see each month that's in your loaded data under <strong>"Months in Loaded Data"</strong> below. Click a month's <strong>Save</strong> button to download that month's transactions as a standalone <code>.txt</code> file. These are your individual backups.
      </div>

      <div class="inner-card">
        <div style="font-weight:800;color:#8b5cf6;margin-bottom:.3rem">📦 Step 4 — Save the Full Archive (most important!)</div>
        Click the purple <strong>"Save Earnings Archive"</strong> button at the bottom of this page. This merges ALL loaded earnings transactions into a single deduplicated <code>_archive.txt</code> file. This is your <strong>master file</strong> — it contains every export you've ever loaded. Each time you do this, it grows. If you have withdrawal data loaded, also click <strong>"Save Withdrawal Archive"</strong> to save those separately. Save both files alongside your other files.
      </div>

      <div class="inner-card">
        <div style="font-weight:800;color:#10b981;margin-bottom:.3rem">🔄 Step 5 — Next Export (the magic part)</div>
        When you export from Unity again (ideally the next day), load <strong>two files</strong> on the upload screen: your <code>_archive.txt</code> (all past data) + the new Unity export (latest data). Click Build — the dashboard <strong>automatically deduplicates</strong> overlapping records and merges everything seamlessly. You'll see your full history plus the new data. Then repeat Steps 3–4 to save the updated archive.
      </div>

      <div style="background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.18);border-radius:8px;padding:.7rem .9rem;margin-bottom:.6rem">
        <div style="font-weight:800;color:#6366f1;margin-bottom:.3rem">💡 Quick Summary</div>
        Every day (or as often as you can): <strong>Export Unity → Upload (archive + new) → Build → Save archive → Done.</strong>
        Your archive file grows with each export, and overlapping records are automatically deduplicated. Over time you'll build a complete earnings history that Unity itself doesn't keep.
      </div>

      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.7rem .9rem">
        <div style="font-weight:800;color:var(--muted);margin-bottom:.3rem">📁 Recommended File Organization</div>
        <div style="font-family:var(--font-mono);font-size:.62rem;line-height:1.8;color:var(--text2)">
          Unity Exports/<br>
          ├── raw/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--muted)"># original exports from Unity</span><br>
          │&nbsp;&nbsp; ├── unity_YYYY-MM-01.txt<br>
          │&nbsp;&nbsp; ├── unity_YYYY-MM-15.txt<br>
          │&nbsp;&nbsp; └── unity_YYYY-MM-28.txt<br>
          ├── months/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--muted)"># monthly saves from archive page</span><br>
          │&nbsp;&nbsp; ├── YYYY-01.txt<br>
          │&nbsp;&nbsp; └── YYYY-02.txt<br>
          └── my_archive.txt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:var(--muted)"># master file (always keep latest)</span>
        </div>
      </div>

    </div>
  </div>

  <!-- Current month status + progress -->
  <div class="sc" id="arcStatusCard" style="margin-bottom:.9rem">
    <div class="sc-title">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Archive Overview
    </div>
    <div id="arcStatusContent"><div style="color:var(--muted);font-size:.78rem">Load data to see archive status.</div></div>
  </div>

  <!-- Per-month breakdown + save buttons -->
  <div class="sc" style="margin-bottom:.9rem;border-left:4px solid #8b5cf6">
    <div class="sc-title" style="color:#8b5cf6">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Earnings — Months in Loaded Data
    </div>
    <div class="sc-sub">Click any month to save its earnings as a reloadable file</div>
    <div id="arcMonthGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:.6rem;margin-top:.3rem">
      <div style="color:var(--muted);font-size:.78rem">Load data to see months.</div>
    </div>
  </div>

  <!-- Full archive save -->
  <div class="sc" style="border-left:4px solid #8b5cf6">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.7rem">
      <div>
        <div class="sc-title" style="color:#8b5cf6">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Save Earnings Archive
        </div>
        <div class="sc-sub" style="margin-bottom:0" id="arcFullSummary">All loaded earnings transactions combined into one deduplicated file</div>
      </div>
      <button onclick="saveFullArchive()" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#fff;border:none;border-radius:10px;padding:.65rem 1.4rem;font-size:.78rem;font-weight:800;cursor:pointer;box-shadow:0 3px 12px rgba(139,92,246,.35);white-space:nowrap;flex-shrink:0">
        📦 Save Earnings Archive
      </button>
    </div>
  </div>

  <!-- Withdrawal months breakdown -->
  <div class="sc" style="margin-bottom:.9rem;border-left:4px solid #10b981;display:none" id="arcWithMonthsCard">
    <div class="sc-title" style="color:#10b981">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      Withdrawals — Months in Loaded Data
    </div>
    <div class="sc-sub">Click any month to save its withdrawals as a standalone file</div>
    <div id="arcWithMonthGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:.6rem;margin-top:.3rem">
      <div style="color:var(--muted);font-size:.78rem">Load withdrawal data to see months.</div>
    </div>
  </div>

  <!-- Withdrawal archive save -->
  <div class="sc" style="border-left:4px solid #10b981">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.7rem">
      <div>
        <div class="sc-title" style="color:#10b981">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Save Withdrawal Archive
        </div>
        <div class="sc-sub" style="margin-bottom:0" id="arcWithSummary">All loaded withdrawal records combined into one deduplicated file</div>
      </div>
      <button id="btnSaveWithArchive" onclick="saveWithdrawalArchive()" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:10px;padding:.65rem 1.4rem;font-size:.78rem;font-weight:800;cursor:pointer;box-shadow:0 3px 12px rgba(16,185,129,.35);white-space:nowrap;flex-shrink:0">
        📦 Save Withdrawal Archive
      </button>
    </div>
  </div>

  </div><!-- /page-archive -->

  <!-- ═══ PAGE: LEASES ═══ -->
  <div class="page-section" id="page-leases">

  <!-- Lease Table -->
  <div class="lease-sc">
    <div class="sc-title" style="margin-bottom:.2rem">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      All Leases — Sortable
    </div>
    <div style="font-size:.67rem;color:var(--muted);margin-bottom:.8rem">By Group = grouped with headers · All Mixed = intermixed · sort by earnings or latest day · bars: <strong>solid</strong> N1 · <strong>stripe ╱</strong> N2 · <strong>horiz ═</strong> N3 · <strong>cross ╳</strong> N4</div>
    <div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.85rem;padding:.7rem 1rem;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:.3rem">
        <span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase">View:</span>
        <button class="sbtn active" id="btn-view-group" onclick="sortBy('view','group')">By Group</button>
        <button class="sbtn" id="btn-view-all" onclick="sortBy('view','all')">All Mixed</button>
      </div>
      <div style="width:1px;height:18px;background:var(--border)"></div>
      <div style="display:flex;align-items:center;gap:.3rem">
        <span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase">Earnings:</span>
        <button class="sbtn active" id="btn-earn-desc" onclick="sortBy('earn','desc')">High ↓</button>
        <button class="sbtn" id="btn-earn-asc" onclick="sortBy('earn','asc')">Low ↑</button>
      </div>
      <div style="width:1px;height:18px;background:var(--border)"></div>
      <div style="display:flex;align-items:center;gap:.3rem">
        <span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase">Latest Day:</span>
        <button class="sbtn" id="btn-today-desc" onclick="sortBy('today','desc')">High ↓</button>
        <button class="sbtn" id="btn-today-asc" onclick="sortBy('today','asc')">Low ↑</button>
      </div>
      <div style="margin-left:auto;font-size:.6rem;color:var(--muted);font-style:italic" id="sortStatus"></div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.85rem;padding:.5rem 1rem;background:var(--surface2);border-radius:10px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:.3rem">
        <span style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase">Date Range:</span>
        <input type="date" id="dateFrom" style="font-size:.65rem;padding:.2rem .4rem;border:1px solid var(--border);border-radius:5px;background:var(--surface);color:var(--text);font-family:var(--font-mono)">
        <span style="font-size:.6rem;color:var(--muted)">→</span>
        <input type="date" id="dateTo" style="font-size:.65rem;padding:.2rem .4rem;border:1px solid var(--border);border-radius:5px;background:var(--surface);color:var(--text);font-family:var(--font-mono)">
        <button class="sbtn" onclick="applyDateRange()">Apply</button>
        <button class="sbtn" onclick="clearDateRange()">Reset</button>
      </div>
      <div style="margin-left:auto">
        <button class="cbtn" style="padding:.2rem .6rem;font-size:.58rem" onclick="exportLeaseCSV()">📥 CSV Export</button>
      </div>
    </div>
    <div style="overflow-x:auto">
      <table class="lease-table">
        <thead><tr>
          <th style="width:28px;padding:0"></th><th>Lease</th><th>Group</th>
          <th onclick="sortBy('earn','toggle')" style="min-width:200px;cursor:pointer">All-Time Earnings <span id="th-earn-arr" style="color:var(--primary)">↓</span></th>
          <th onclick="sortBy('today','toggle')" style="cursor:pointer">Latest Day <span id="th-today-arr" style="color:var(--primary)"></span></th>
          <th style="width:55px">Trend</th>
          <th>Txns</th><th>Node</th>
        </tr></thead>
        <tbody id="leaseBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- /page-leases -->

  <!-- ═══ PAGE: NAMES EDITOR ═══ -->
  <div class="page-section" id="page-editor">

    <!-- Node Names Section -->
    <div class="sc" style="border-left:4px solid #f59e0b;margin-bottom:.9rem">
      <div class="sc-title" style="color:#f59e0b">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5"><rect x="2" y="2" width="20" height="20" rx="3"/><path d="M9 12h6M12 9v6"/></svg>
        Node Names
      </div>
      <div class="sc-sub">Name and reorder your nodes. Use ▲▼ to set which node is N1, N2, etc. Names and order are saved in your exported naming file.</div>
      <div style="display:flex;gap:.4rem;margin-top:.3rem;margin-bottom:.3rem">
        <button class="cbtn" style="padding:.2rem .5rem;font-size:.58rem" onclick="document.querySelectorAll('.node-card-body').forEach(b=>b.style.display='none');document.querySelectorAll('.node-collapse-btn').forEach(b=>b.textContent='▶')">▶ Collapse All</button>
        <button class="cbtn" style="padding:.2rem .5rem;font-size:.58rem" onclick="document.querySelectorAll('.node-card-body').forEach(b=>b.style.display='');document.querySelectorAll('.node-collapse-btn').forEach(b=>b.textContent='▼')">▼ Expand All</button>
      </div>
      <div id="nodeNamesContainer" style="margin-top:.3rem">
        <div style="color:var(--muted);font-size:.78rem">Load earnings data to see your nodes.</div>
      </div>
    </div>

    <div class="sc" style="margin-bottom:.9rem">
      <div class="sc-title" style="justify-content:space-between;flex-wrap:wrap;gap:.5rem">
        <span>✏️ Lease Names Editor</span>
        <div style="display:flex;gap:.4rem"><button class="cbtn" onclick="neShowImportModal()">📥 Import</button><button class="cbtn" onclick="neLeases=[];neGroups=[];neNL=1;neNG=1;nePopulate();">🔄 Reload</button><button class="cbtn on" onclick="neExportFile()">💾 Export</button></div>
      </div>
      <div class="sc-sub">Click names to rename · drag leases into groups · click group color swatch to change · nodes auto-detected from data · <strong>📝 daily notes from Earnings page are included in export</strong></div>
    </div>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:.8rem;font-size:.68rem;color:var(--muted)">
      <span>Groups: <strong id="neSGroups" style="color:var(--text)">0</strong></span>
      <span>Total: <strong id="neSTotal" style="color:var(--text)">0</strong></span>
      <span>Assigned: <strong id="neSAssigned" style="color:var(--text)">0</strong></span>
      <span>Unassigned: <strong id="neSUnassigned" style="color:var(--text)">0</strong></span>
    </div>
    <div class="ne-layout">
      <div class="ne-left" id="neLeftPanel">
        <div id="neBulkBar" style="display:none;margin-bottom:.5rem;padding:.4rem .6rem;background:var(--primary-bg,rgba(59,130,246,.08));border:1px solid rgba(59,130,246,.2);border-radius:8px;font-size:.62rem"></div>
        <div style="margin-bottom:.45rem">
          <input type="text" id="neSearchBox" placeholder="🔍 Search by hex or name…" oninput="neRender()" style="width:100%;padding:.3rem .5rem;font-size:.6rem;border:1px solid var(--border);border-radius:7px;background:var(--surface2);color:var(--text);outline:none;box-sizing:border-box">
        </div>
        <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:.5rem">Unassigned <span id="neUnassignedCount" style="background:var(--surface2);padding:.1rem .4rem;border-radius:12px;font-size:.6rem">0</span>  <span style="font-size:.52rem;font-weight:400;text-transform:none;letter-spacing:0;color:var(--muted)">☐ click checkboxes to bulk-select</span></div>
        <div id="neUnassignedList"></div>
        <div style="margin-top:.6rem;display:flex;gap:.3rem">
          <input type="text" id="neAddName" placeholder="Name" class="ne-input" style="flex:1">
          <input type="text" id="neAddHex" placeholder="last 4" class="ne-input" maxlength="4" style="width:55px;font-family:var(--font-mono)">
          <button class="cbtn on" style="padding:.25rem .55rem" onclick="neAddManual()">Add</button>
        </div>
        <div style="font-size:.56rem;color:var(--muted);margin-top:.25rem">Last 4 hex of lease ID</div>
        <div style="margin-top:.6rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:.5rem">
          <div style="font-size:.65rem;font-weight:700;color:var(--muted);margin-bottom:.3rem">Preview</div>
          <pre id="nePreview" style="font-family:var(--font-mono);font-size:.58rem;color:#10b981;line-height:1.7;white-space:pre-wrap;max-height:200px;overflow-y:auto;margin:0"># Add groups and leases</pre>
        </div>
      </div>
      <div class="ne-right" id="neRightPanel">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.6rem">
          <span style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase">Groups</span>
          <button class="cbtn on" style="padding:.22rem .55rem;font-size:.62rem" onclick="neAddGroup()">+ New Group</button>
          <button class="cbtn" style="padding:.22rem .55rem;font-size:.58rem" onclick="neCollapseAll()">▶ Collapse All</button>
          <button class="cbtn" style="padding:.22rem .55rem;font-size:.58rem" onclick="neExpandAll()">▼ Expand All</button>
        </div>
        <div id="neGroupsContainer"></div>
        <div class="ne-add-group" onclick="neAddGroup()">+ Add another group</div>
      </div>
    </div>
    <div class="ne-modal" id="neImportModal">
      <div class="ne-modal-box">
        <h3 style="font-size:.85rem;margin-bottom:.5rem">Import Naming File</h3>
        <textarea id="neImportText" class="ne-input" style="width:100%;height:180px;font-family:var(--font-mono);font-size:.62rem;resize:vertical" placeholder="# GroupName — #color&#10;LeaseName  a1b2&#10;LeaseName  c3d4  n2"></textarea>
        <div style="margin-top:.4rem;text-align:center"><label class="cbtn" style="cursor:pointer;font-size:.62rem">📂 Choose file <input type="file" accept=".txt" style="display:none" onchange="neLoadFile(this)"></label></div>
        <div style="display:flex;gap:.4rem;margin-top:.6rem;justify-content:flex-end"><button class="cbtn" onclick="neCloseImport()">Cancel</button><button class="cbtn on" onclick="neDoImport()">Import</button></div>
      </div>
    </div>
  </div><!-- /page-editor -->

  <!-- ═══ PAGE: TOOLS ═══ -->
  <div class="page-section" id="page-tools">

  <!-- Data Health Check - always visible at top -->
  <div class="sc" style="border-left:4px solid #ef4444">
    <div class="sc-title" style="color:#ef4444">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      Data Health Check
      <span style="font-size:.55rem;font-weight:400;color:var(--muted);margin-left:.5rem">runs automatically on data load</span>
    </div>
    <div id="healthCheckContent"><div style="color:var(--muted);font-size:.78rem">Load data to run health check.</div></div>
  </div>

  <!-- ── TRACKING section ── -->
  <div style="margin-top:.3rem;margin-bottom:.3rem;font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:.4rem 0">📈 Tracking &amp; Goals</div>

  <!-- Goal Tracker -->
  <div class="sc" style="border-left:4px solid #8b5cf6">
    <div class="sc-title" style="color:#8b5cf6;cursor:pointer" onclick="toggleToolSection('goalSection')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
      Monthly Goal Tracker
      <span style="margin-left:auto;font-size:.6rem;color:var(--muted)" id="goalSectionToggle">▼</span>
    </div>
    <div id="goalSection">
      <div class="sc-sub">Set a monthly earning target and track your progress</div>
      <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.7rem;flex-wrap:wrap">
        <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Monthly target: $</label>
        <input id="goalInput" type="number" step="1" min="0" placeholder="e.g. 200" style="width:100px;padding:.3rem .5rem;font-size:.75rem;border:1px solid var(--border);border-radius:6px;background:var(--surface2);color:var(--text);font-family:var(--font-mono),monospace" oninput="updateGoalTracker()">
        <button class="cbtn on" style="padding:.25rem .6rem;font-size:.62rem" onclick="saveGoal()">💾 Save Goal</button>
      </div>
      <div id="goalTrackerContent"><div style="color:var(--muted);font-size:.78rem">Enter a monthly target to see projections.</div></div>
    </div>
  </div>

  <!-- Earning Alerts -->
  <div class="sc" style="border-left:4px solid #f59e0b">
    <div class="sc-title" style="color:#f59e0b;cursor:pointer" onclick="toggleToolSection('alertSection')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Earning Alerts
      <span style="margin-left:auto;font-size:.6rem;color:var(--muted)" id="alertSectionToggle">▼</span>
    </div>
    <div id="alertSection">
      <div class="sc-sub">Set minimum thresholds — any lease or day below the limit gets flagged</div>
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:.7rem;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:.3rem">
          <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Min $/lease/day: $</label>
          <input id="alertLeaseMin" type="number" step="0.01" min="0" placeholder="e.g. 0.05" style="width:80px;padding:.3rem .5rem;font-size:.75rem;border:1px solid var(--border);border-radius:6px;background:var(--surface2);color:var(--text);font-family:var(--font-mono),monospace">
        </div>
        <div style="display:flex;align-items:center;gap:.3rem">
          <label style="font-size:.68rem;font-weight:700;color:var(--muted)">Min $/day total: $</label>
          <input id="alertDayMin" type="number" step="0.5" min="0" placeholder="e.g. 5.00" style="width:80px;padding:.3rem .5rem;font-size:.75rem;border:1px solid var(--border);border-radius:6px;background:var(--surface2);color:var(--text);font-family:var(--font-mono),monospace">
        </div>
        <button class="cbtn on" style="padding:.25rem .6rem;font-size:.62rem" onclick="runEarningAlerts()">🔔 Check Alerts</button>
      </div>
      <div id="alertsContent"><div style="color:var(--muted);font-size:.78rem">Set thresholds and click Check Alerts.</div></div>
    </div>
  </div>

  <!-- ── NODE HEALTH section ── -->
  <div style="margin-top:.3rem;margin-bottom:.3rem;font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:.4rem 0">🖥️ Node Health</div>

  <!-- Node Map Visualization -->
  <div class="sc" style="border-left:4px solid #8b5cf6">
    <div class="sc-title" style="color:#8b5cf6;cursor:pointer" onclick="toggleToolSection('nodeMapSection')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
      Node Map
      <span style="margin-left:auto;font-size:.6rem;color:var(--muted)" id="nodeMapSectionToggle">▼</span>
    </div>
    <div id="nodeMapSection">
      <div class="sc-sub">Visual overview of lease distribution across nodes (200 lease capacity each)</div>
      <div id="nodeMapContent"><div style="color:var(--muted);font-size:.78rem">Load data to see node map.</div></div>
    </div>
  </div>

  <!-- Node Health Dashboard -->
  <div class="sc" style="border-left:4px solid #3b82f6">
    <div class="sc-title" style="color:#3b82f6;cursor:pointer" onclick="toggleToolSection('nodeHealthSection')">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Node Health Dashboard
      <span style="margin-left:auto;font-size:.6rem;color:var(--muted)" id="nodeHealthSectionToggle">▼</span>
    </div>
    <div id="nodeHealthSection">
      <div class="sc-sub">Per-node uptime patterns, earnings efficiency, and underperforming leases</div>
      <div id="nodeHealthContent"><div style="color:var(--muted);font-size:.78rem">Load data to see node health.</div></div>
    </div>
  </div>

  <!-- ── EXPORT section ── -->
  <div style="margin-top:.3rem;margin-bottom:.3rem;font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:.4rem 0">📤 Export</div>

  <!-- PDF Export -->
  <div class="sc" style="border-left:4px solid #06b6d4">
    <div class="sc-title" style="color:#06b6d4">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Export PDF Report
    </div>
    <div class="sc-sub">Generate a clean printable summary of your earnings, nodes, and withdrawals</div>
    <button onclick="exportPDFReport()" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;border:none;border-radius:10px;padding:.65rem 1.4rem;font-size:.78rem;font-weight:800;cursor:pointer;box-shadow:0 3px 12px rgba(6,182,212,.35)">
      📄 Generate PDF Report
    </button>
    <div id="pdfStatus" style="margin-top:.5rem"></div>
  </div>

  <!-- Printable One-Page Summary -->
  <div class="sc" style="border-left:4px solid #10b981">
    <div class="sc-title" style="color:#10b981">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2.5"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
      Printable Summary
    </div>
    <div class="sc-sub">One-page report card — top KPIs, node breakdown, and best/worst performers</div>
    <button onclick="printSummary()" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:10px;padding:.65rem 1.4rem;font-size:.78rem;font-weight:800;cursor:pointer;box-shadow:0 3px 12px rgba(16,185,129,.35)">
      🖨️ Print Summary
    </button>
  </div>

  <!-- Comparison Snapshot -->
  <div class="sc" style="border-left:4px solid #f59e0b">
    <div class="sc-title" style="color:#f59e0b">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      Week vs Week Comparison
    </div>
    <div class="sc-sub">Compare this week's performance against last week</div>
    <div id="comparisonContent"><div style="color:var(--muted);font-size:.78rem">Load data to see comparison.</div></div>
  </div>

  <!-- ── HELP section ── -->
  <div style="margin-top:.3rem;margin-bottom:.3rem;font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:.4rem 0">❓ Help</div>

  <div class="sc" style="border-left:4px solid #6b7280">
    <div class="sc-title" style="color:#6b7280">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Dashboard Tour
    </div>
    <div class="sc-sub">New here? Take a quick guided tour of the dashboard features</div>
    <button onclick="startTour()" style="background:linear-gradient(135deg,#6b7280,#4b5563);color:#fff;border:none;border-radius:10px;padding:.55rem 1.2rem;font-size:.72rem;font-weight:700;cursor:pointer">
      🎓 Start Tour
    </button>
  </div>

  </div><!-- /page-tools -->

  <!-- Compact View Overlay -->
  <div id="compactOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:9999;display:none;align-items:center;justify-content:center">
    <div style="background:var(--bg);border-radius:16px;padding:1.2rem 1.5rem;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);border:1px solid var(--border);position:relative">
      <button onclick="toggleCompactView()" style="position:absolute;top:.6rem;right:.8rem;background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--muted)">✕</button>
      <div style="font-size:.9rem;font-weight:800;color:var(--text);margin-bottom:.6rem">📊 Quick Daily Summary</div>
      <div id="compactViewContent"><div style="color:var(--muted);font-size:.78rem">Load data to see compact summary.</div></div>
    </div>
  </div>

  <!-- ═══ PAGE: DONATE ═══ -->
  <div class="page-section" id="page-donate">
    <div class="sc" style="text-align:center;padding:2rem 1.5rem;max-width:600px;margin:0 auto">
      <div style="font-size:2.5rem;margin-bottom:.5rem">❤️</div>
      <h2 style="font-size:1.3rem;font-weight:900;color:var(--text);margin:0 0 .4rem">Thank You!</h2>
      <p style="font-size:.82rem;color:var(--text2);line-height:1.7;margin:0 0 1.2rem">
        Thank you for using the <strong>dataNerds Dashboard</strong>. This tool is built with care and provided free to the Unity community. If it's helped you track your earnings, optimize your leases, or just made your life a little easier — consider supporting continued development with a small donation.
      </p>
      <p style="font-size:.75rem;color:var(--muted);margin:0 0 1.5rem">
        Every contribution — no matter how small — helps keep this project alive and improving. 🙏
      </p>

      <div style="display:grid;gap:1rem;text-align:left">
        <!-- ADA -->
        <div style="padding:1rem 1.2rem;background:rgba(59,130,246,.05);border:1px solid rgba(59,130,246,.15);border-radius:10px">
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <span style="font-size:1.1rem">₳</span>
            <span style="font-size:.78rem;font-weight:800;color:var(--text)">ADA (Cardano)</span>
          </div>
          <div id="adaWallet" style="font-family:var(--font-mono);font-size:.52rem;word-break:break-all;color:var(--text2);background:var(--surface2);padding:.45rem .6rem;border-radius:6px;border:1px solid var(--border);cursor:pointer;transition:border-color .2s" onclick="copyDonateAddr(this)" title="Click to copy">addr1qyd4743tmklahpxkj807qems77k5m49fupl9caudsfcrluf7tdx48cklv9yx0z8heerv5kv69jdkpup0xydcqze9dyrsqrswnr</div>
          <button onclick="copyDonateAddr(document.getElementById('adaWallet'))" style="margin-top:.4rem;padding:.3rem .7rem;font-size:.6rem;font-weight:700;background:rgba(59,130,246,.1);color:#3b82f6;border:1px solid rgba(59,130,246,.2);border-radius:6px;cursor:pointer">📋 Copy ADA Address</button>
        </div>

        <!-- BTC -->
        <div style="padding:1rem 1.2rem;background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:10px">
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
            <span style="font-size:1.1rem">₿</span>
            <span style="font-size:.78rem;font-weight:800;color:var(--text)">BTC (Bitcoin)</span>
          </div>
          <div id="btcWallet" style="font-family:var(--font-mono);font-size:.58rem;word-break:break-all;color:var(--text2);background:var(--surface2);padding:.45rem .6rem;border-radius:6px;border:1px solid var(--border);cursor:pointer;transition:border-color .2s" onclick="copyDonateAddr(this)" title="Click to copy">bc1qhvyc7ecx2djd03yjz8zk22tggyrx5fhxy8thqw</div>
          <button onclick="copyDonateAddr(document.getElementById('btcWallet'))" style="margin-top:.4rem;padding:.3rem .7rem;font-size:.6rem;font-weight:700;background:rgba(245,158,11,.1);color:#d97706;border:1px solid rgba(245,158,11,.2);border-radius:6px;cursor:pointer">📋 Copy BTC Address</button>
        </div>
      </div>

      <p style="font-size:.65rem;color:var(--muted);margin:1.2rem 0 0;line-height:1.6">
        Click any address to copy it to your clipboard. Donations are completely voluntary and go directly to the developer. Thank you for being part of the dataNerds community!
      </p>
    </div>
  </div><!-- /page-donate -->

  <!-- Disclaimer -->
  <div style="margin-top:2rem;padding:1rem 1.2rem;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.18);border-radius:10px;text-align:center;font-size:.68rem;color:#92400e;line-height:1.7">
    <strong style="font-size:.72rem">⚠️ Disclaimer</strong><br>
    All data, calculations, earnings estimates, and projections displayed in this dashboard are entirely dependent on the data files you upload. All figures are approximations only. Always verify with your official Unity account and site data. This dashboard performs no external network requests and is not affiliated with Unity.
  </div>
</div>

<script>
/* ── Logo math particle entrance animation ── */
(function() {
  function initLogoAnim() {
    var wrap = document.getElementById('logoAnimWrap');
    var particles = document.getElementById('mathParticles');
    var img = document.getElementById('logoImg');
    if (!wrap || !particles || !img) return;

    var symbols = ['\u2211','\u222B','\u03C0','\u221E','\u221A','\u0394','\u03B8','\u03BB','\u03BC','\u03C3',
      '\u00F7','\u00D7','\u00B1','\u2248','\u2260','\u2202','\u03C6','\u03A9','\u03B5','\u03B1','\u03B2','\u03B3',
      'E=mc\u00B2','y=mx+b','f(x)','\u2207','\u2295','\u2297','\u2208','\u2200','\u2203','\u211D','\u2192','\u21D2',
      'x\u00B2','n!','log','sin','cos','dx','dy','\u222E','\u2124','42','01','{}','</>','\u2265','\u221D','\u2205'];
    var colors = ['#1a5ff5','#c0392b','#10b981','#8b5cf6','#f59e0b','#3b82f6','#ef4444','#06b6d4','#ec4899'];

    for (var i = 0; i < 35; i++) {
      var el = document.createElement('span');
      el.className = 'math-p';
      el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
      el.style.color = colors[Math.floor(Math.random() * colors.length)];
      el.style.left = (Math.random() * 100) + '%';
      el.style.top = (Math.random() * 100) + '%';
      el.style.fontSize = (0.5 + Math.random() * 1.2) + 'rem';
      el.style.animationDelay = (Math.random() * 0.8) + 's';
      el.style.animationDuration = (2.5 + Math.random() * 2) + 's';
      el.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px');
      el.style.setProperty('--ty', (Math.random() * 200 - 100) + 'px');
      el.style.setProperty('--rot', (Math.random() * 720 - 360) + 'deg');
      particles.appendChild(el);
    }

    img.style.animation = 'logoEnter 1.6s cubic-bezier(.17,.67,.29,1.02) forwards';

    setTimeout(function() {
      particles.style.transition = 'opacity 0.8s';
      particles.style.opacity = '0';
      setTimeout(function() { particles.innerHTML = ''; }, 800);
    }, 4500);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initLogoAnim);
  } else {
    setTimeout(initLogoAnim, 50);
  }
})();
/* ═══════════════════════════════════════════════════════
   SECURITY LAYER
   1.  Frame-busting       — prevents iframe clickjacking
   2.  Prototype pollution  — guards JSON.parse against __proto__
   3.  sanitizeText()       — strips HTML tags from any user string
   4.  sanitizeFilename()   — cleans filenames before display
   5.  File size guard      — rejects files > 50MB
   6.  File type guard      — only accepts .json / .txt / .csv
   7.  JSON depth limit     — prevents deeply nested JSON bombs
   8.  Rate limiter         — throttles rapid file drops
═══════════════════════════════════════════════════════ */

// ── 1. FRAME-BUSTING ──
(function frameBust() {
  try {
    if (window.self !== window.top) {
      document.documentElement.style.display = 'none';
      window.top.location = window.self.location;
    }
  } catch(e) {
    document.documentElement.style.display = 'none';
    document.addEventListener('DOMContentLoaded', () => {
      document.documentElement.style.display = '';
      const warn = document.createElement('div');
      warn.style.cssText = 'position:fixed;inset:0;z-index:999999;background:#dc2626;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;text-align:center;padding:2rem';
      warn.textContent = '⛔ This page cannot be displayed inside an iframe. Open it directly in your browser.';
      document.body.appendChild(warn);
    });
  }
})();

// ── 2. PROTOTYPE POLLUTION GUARD (no Object.freeze — breaks charts) ──
(function guardPrototype() {
  try {
    const _parse = JSON.parse;
    JSON.parse = function(text, reviver) {
      if (typeof text === 'string' &&
          (text.includes('"__proto__"') ||
           text.includes('"constructor"') ||
           text.includes('"prototype"'))) {
        text = text.replace(/"(__proto__|constructor|prototype)"\s*:/g, '"_blocked_":');
      }
      return _parse.call(this, text, reviver);
    };
  } catch(e) { /* guard failed */ }
})();

// ── 3. HTML SANITIZER ──
function sanitizeText(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;')
    .replace(/\//g, '&#x2F;')
    .substring(0, 256);
}

/**
 * safeHTML — the ONLY recommended way to set innerHTML.
 * Accepts an element (or ID string) and HTML content.
 * Strips <script>, <iframe>, on* attributes, javascript: URIs, and data: URIs
 * from the final HTML before inserting it.
 * This acts as a safety net — individual variables should STILL use sanitizeText()
 * but this catches anything that slips through.
 */
function safeHTML(elOrId, html) {
  const el = typeof elOrId === 'string' ? document.getElementById(elOrId) : elOrId;
  if (!el) return;
  // Strip dangerous tags entirely
  let clean = String(html)
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    .replace(/<iframe\b[^>]*>.*?<\/iframe>/gi, '')
    .replace(/<object\b[^>]*>.*?<\/object>/gi, '')
    .replace(/<embed\b[^>]*>/gi, '')
    .replace(/<link\b[^>]*>/gi, '');
  // Strip event handlers (on*="...") from all tags
  clean = clean.replace(/\s+on\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s>]*)/gi, '');
  // Strip javascript: and data: URIs in href/src attributes
  clean = clean.replace(/(href|src)\s*=\s*(?:"javascript:[^"]*"|'javascript:[^']*')/gi, '$1=""');
  clean = clean.replace(/(href|src)\s*=\s*(?:"data:[^"]*"|'data:[^']*')/gi, '$1=""');
  el.innerHTML = clean;
}

/**
 * appendSafeHTML — same sanitization but appends instead of replacing.
 */
function appendSafeHTML(elOrId, html) {
  const el = typeof elOrId === 'string' ? document.getElementById(elOrId) : elOrId;
  if (!el) return;
  const temp = document.createElement('div');
  safeHTML(temp, html);
  el.innerHTML += temp.innerHTML;
}

function stripTags(str) {
  if (!str) return '';
  return String(str).replace(/<[^>]*>/g, '').substring(0, 256);
}

// ── 4. FILENAME SANITIZER ──
function sanitizeFilename(name) {
  if (!name) return 'unknown';
  return String(name)
    .replace(/[^a-zA-Z0-9._\-\s]/g, '')
    .replace(/\.{2,}/g, '.')
    .substring(0, 80);
}

// ── 5 & 6. FILE VALIDATION ──
const MAX_FILE_MB = 50;
const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;
const ALLOWED_EXTENSIONS = new Set(['.json', '.txt', '.csv']);

function validateFile(file) {
  const errors = [];
  if (file.size > MAX_FILE_BYTES) {
    errors.push('File too large: ' + (file.size/1024/1024).toFixed(1) + 'MB (max ' + MAX_FILE_MB + 'MB)');
  }
  if (file.size < 2) {
    errors.push('File appears empty');
  }
  const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(ext)) {
    errors.push('Invalid file type: ' + sanitizeText(ext) + '. Only .json, .txt, .csv allowed');
  }
  return errors;
}

// ── 7. JSON DEPTH LIMITER ──
function checkJsonDepth(obj, max, depth) {
  max = max || 20; depth = depth || 0;
  if (depth > max) throw new Error('JSON structure too deeply nested (possible JSON bomb)');
  if (obj && typeof obj === 'object') {
    for (var k of Object.keys(obj)) {
      checkJsonDepth(obj[k], max, depth + 1);
    }
  }
}

// ── 8. RATE LIMITER ──
var _rateLimits = {};
function rateLimit(key, limitMs) {
  limitMs = limitMs || 2000;
  var now = Date.now();
  if (_rateLimits[key] && now - _rateLimits[key] < limitMs) return false;
  _rateLimits[key] = now;
  return true;
}

// ── 9. PASTE/CLIPBOARD SANITIZER — strip HTML from pasted content in inputs ──
document.addEventListener('paste', function(e) {
  var target = e.target;
  if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA')) {
    e.preventDefault();
    var text = (e.clipboardData || window.clipboardData).getData('text/plain');
    // Strip any HTML/script tags from pasted content
    text = text.replace(/<[^>]*>/g, '').replace(/javascript:/gi, '');
    document.execCommand('insertText', false, text);
  }
});

// ── 10. FREEZE CRITICAL SECURITY FUNCTIONS — prevent tampering ──
try {
  Object.freeze(sanitizeText);
  Object.freeze(sanitizeFilename);
  Object.freeze(stripTags);
  Object.freeze(validateFile);
  Object.freeze(checkJsonDepth);
} catch(e) { /* older browsers */ }

// ── 11. AUTO-CLEAR ON PAGE HIDE — wipe sensitive data from memory when leaving ──
document.addEventListener('visibilitychange', function() {
  // Don't clear — just a placeholder if we want to add wipe-on-hide later
  // Users need data to persist across tab switches
});
window.addEventListener('beforeunload', function() {
  // Clear any sensitive data references on page close
  try {
    if (typeof allData !== 'undefined') allData = null;
    if (typeof loadedFiles !== 'undefined') loadedFiles = null;
    if (typeof withdrawFiles !== 'undefined') withdrawFiles = null;
  } catch(e) {}
});

// ── 12. BLOCK DEVTOOLS COPY of raw data objects (light deterrent) ──
// Prevents casual console.log(allData) copy but not determined access
Object.defineProperty(window, '__rawData', { get: function() { return '⛔ Direct data access blocked'; }, configurable: false });

// ── VERSION + INTEGRITY ──
const DASHBOARD_VERSION = '4.20';

const DEBUG = false;  // set true to enable console logging

// roundRect polyfill for browsers that don't support it
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r) {
    r = Math.min(r, w/2, h/2);
    this.moveTo(x+r,y); this.lineTo(x+w-r,y);
    this.quadraticCurveTo(x+w,y,x+w,y+r);
    this.lineTo(x+w,y+h-r); this.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
    this.lineTo(x+r,y+h); this.quadraticCurveTo(x,y+h,x,y+h-r);
    this.lineTo(x,y+r); this.quadraticCurveTo(x,y,x+r,y);
    this.closePath(); return this;
  };
}
/* ═══════════════════════════════════════════════════════
   DATA START DATE — auto-detected from uploaded files.
   Set to the earliest date common to all uploaded files.
   Can be overridden by the user via the date picker.
═══════════════════════════════════════════════════════ */
let DATA_START = '1970-01-01'; // open — will be set dynamically before build
let USER_START_DATE = null; // set when user overrides via date picker

function onStartDateChange(val) {
  USER_START_DATE = val || null;
  const disp = document.getElementById('startDateDisplay');
  if (disp) disp.textContent = val || 'auto';
}

function clearStartDate() {
  USER_START_DATE = null;
  const picker = document.getElementById('startDatePicker');
  if (picker) picker.value = '';
  const disp = document.getElementById('startDateDisplay');
  if (disp) disp.textContent = 'auto';
}

function autoDetectStartDate(files) {
  // Find the earliest date that appears in ALL files
  // so charts line up perfectly when multiple files are loaded
  const fileNames = Object.keys(files);
  if (!fileNames.length) return '1970-01-01';

  const fileDates = fileNames.map(fname => {
    const dates = files[fname].map(r => r.completedAt.slice(0,10)).sort();
    return { earliest: dates[0], latest: dates[dates.length-1] };
  });

  // Latest of all earliest-dates = first date all files share
  const commonStart = fileDates.map(f => f.earliest).sort().pop();
  return commonStart || '1970-01-01';
}

/* ═══════════════════════════════════════════════════════
   LEASE MAP — populated from uploaded naming file
   No hardcoded lease data. Upload a naming .txt file
   to assign names, groups, and node numbers.
═══════════════════════════════════════════════════════ */
const LEASE_MAP = {};

/* ═══════════════════════════════════════════════════════
   SPLIT / GROSS VIEW SYSTEM
   2-tier: Group default → Individual override (locked)
   Each group has its own split %. Default 50%.
   Individual leases can be locked to a custom % that
   won't change when the group slider moves.
═══════════════════════════════════════════════════════ */
let splitGroups = {};           // groupName → split %  (default 50 if not set)
// Individual splits stored on lease objects: lease.split = number | undefined
// Lock stored as: lease.splitLocked = true/false
let viewMode = 'received';      // 'received' or 'gross'

/**
 * Get effective split % for a lease (last4 hex) on a given date.
 * Checks splitHistory for date-based overrides first.
 * Falls back: individual locked → group → default 50%.
 */
function getSplit(last4, dateStr) {
  const lMap = window._activeLeaseMap || LEASE_MAP;
  const info = lMap[last4];

  // Check splitHistory first (date-based overrides)
  if (info && info.splitHistory && info.splitHistory.length > 0 && dateStr) {
    // splitHistory is sorted by "from" date ascending
    // Find the latest entry whose "from" date is <= dateStr
    let match = null;
    for (let i = info.splitHistory.length - 1; i >= 0; i--) {
      if (info.splitHistory[i].from <= dateStr) {
        match = info.splitHistory[i];
        break;
      }
    }
    if (match) return match.uno;
  }

  // Individual locked override (legacy single-value)
  if (info && info.splitLocked && typeof info.split === 'number') return info.split;

  // Group split
  if (info && info.group && typeof splitGroups[info.group] === 'number') return splitGroups[info.group];

  // Default
  return 50;
}

/**
 * Get the group split for a group name (default 50).
 */
function getGroupSplit(groupName) {
  return typeof splitGroups[groupName] === 'number' ? splitGroups[groupName] : 50;
}

/**
 * Adjust an earning value based on the lease's split at a given date.
 * In 'received' mode: returns raw value.
 * In 'gross' mode: returns raw / (split% / 100) to show true lease output.
 */
function adjEarn(rawMicros, last4, dateStr) {
  const val = rawMicros / 1e6;
  if (viewMode === 'received') return val;
  const pct = getSplit(last4, dateStr);
  return pct > 0 ? val / (pct / 100) : val;
}

/**
 * Toggle between received and gross view, re-render everything.
 */
function toggleGrossView() {
  viewMode = viewMode === 'received' ? 'gross' : 'received';
  const btn = document.getElementById('grossBtn');
  if (btn) {
    btn.classList.toggle('on', viewMode === 'gross');
    btn.textContent = viewMode === 'gross' ? '📊 UNO + ULO' : '💰 UNO Earnings';
  }
  const indicator = document.getElementById('grossIndicator');
  if (indicator) indicator.style.display = viewMode === 'gross' ? '' : 'none';
  const liveBadge = document.querySelector('.live-badge');
  if (liveBadge) liveBadge.style.display = viewMode === 'gross' ? 'none' : '';
  const hdr = document.querySelector('.hdr');
  if (hdr) {
    if (viewMode === 'gross') {
      hdr.style.background = 'rgba(239,68,68,.25)';
      hdr.style.borderBottomColor = '#ef4444';
    } else {
      hdr.style.background = '';
      hdr.style.borderBottomColor = '';
    }
  }
  if (typeof buildDashboard === 'function' && allData && allData.length) {
    rebuildWithCurrentData();
  }
}

/**
 * Load split settings from naming file data.
 */
function loadSplitSettings(map) {
  if (!map) return;
  if (map._splitGroups && typeof map._splitGroups === 'object') splitGroups = {...map._splitGroups};
}

/**
 * Save split settings into the lease map for export.
 */
function saveSplitSettings(map) {
  if (!map) return;
  map._splitGroups = {...splitGroups};
}

/* Set of node-2 last4 values for quick lookup */


/* Get node number from last4 */
function getNode(last4, map) {
  if (!map || !(last4 in map)) return 1;
  return map[last4].node || 1;
}

/* ═══════════════════════════════════════════════════════
   DYNAMIC GROUP SYSTEM
   Colors, icons, and order come entirely from whatever
   groups appear in the user's uploaded lease names file.
   Nothing is hardcoded — any group name works.
═══════════════════════════════════════════════════════ */

const _GP = [  // rotating palette — index assigned per group
  { col:'#ef4444', bg:'rgba(239,68,68,.1)',   icon:'📡' },
  { col:'#f59e0b', bg:'rgba(245,158,11,.1)',  icon:'🛰'  },
  { col:'#3b82f6', bg:'rgba(59,130,246,.1)',  icon:'🌐'  },
  { col:'#10b981', bg:'rgba(16,185,129,.1)',  icon:'📱'  },
  { col:'#8b5cf6', bg:'rgba(139,92,246,.1)',  icon:'💜'  },
  { col:'#ec4899', bg:'rgba(236,72,153,.1)',  icon:'🔷'  },
  { col:'#14b8a6', bg:'rgba(20,184,166,.1)',  icon:'🔶'  },
  { col:'#f97316', bg:'rgba(249,115,22,.1)',  icon:'⚡'  },
  { col:'#a855f7', bg:'rgba(168,85,247,.1)',  icon:'🌟'  },
  { col:'#06b6d4', bg:'rgba(6,182,212,.1)',   icon:'🔵'  },
];
const _UNK = { col:'#6b7280', bg:'rgba(107,114,128,.07)', icon:'❓' };

// Populated by buildGroupSystem() at the start of every buildDashboard()
let GC          = {};  // g → color hex
let GCbg        = {};  // g → rgba bg
let GICON       = {};  // g → emoji
let GROUP_ORDER = {};  // g → sort index
let ACTIVE_GROUPS = [];

function buildGroupSystem(lMap) {
  const hasMap = Object.keys(lMap).length > 0;

  if (!hasMap) {
    // ── NO NAMING FILE: single generic green group for everything ──
    ACTIVE_GROUPS = ['All Leases'];
    GC          = { 'All Leases': '#16a34a' };
    GCbg        = { 'All Leases': 'rgba(22,163,74,.12)' };
    GICON       = { 'All Leases': '📋' };
    GROUP_ORDER = { 'All Leases': 0 };
    return;
  }

  // ── NAMING FILE UPLOADED: use groups from the file ──
  const seen = new Set();
  Object.values(lMap).forEach(v => { if (v && v.group) seen.add(v.group); });
  seen.add('Unassigned');

  // Alphabetical, Unassigned always last
  const sorted = [...seen].filter(g => g !== 'Unassigned').sort((a,b) => a.localeCompare(b));
  sorted.push('Unassigned');
  ACTIVE_GROUPS = sorted;

  const fileColors = lMap.__groupColors || {};
  GC = {}; GCbg = {}; GICON = {}; GROUP_ORDER = {};
  sorted.forEach((g, i) => {
    const s = (g === 'Unassigned') ? _UNK : _GP[i % _GP.length];
    const col = fileColors[g] || s.col;
    // Derive bg from color: add alpha
    const bg  = fileColors[g]
      ? fileColors[g] + '1a'   // hex color + 10% alpha
      : s.bg;
    GC[g]          = col;
    GCbg[g]        = bg;
    GICON[g]       = s.icon;
    GROUP_ORDER[g] = i;
  });
}

// Safe accessors — fall back to unknown style for any group not in the map
function grpCol(g)   { var c = GC[g] || _UNK.col; return /^#[0-9a-fA-F]{3,6}$/.test(c) ? c : '#888888'; }

/** Desaturate a hex color for muted dark mode charts */
function muteHex(hex, amount) {
  if (document.body.classList.contains('light')) return hex;
  var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  var avg = (r + g + b) / 3;
  var f = amount || 0.35;
  r = Math.round(r + (avg - r) * f); g = Math.round(g + (avg - g) * f); b = Math.round(b + (avg - b) * f);
  return '#' + ((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}
function grpBg(g)    { var b = GCbg[g] || _UNK.bg; return /^rgba?\([\d,.\s]+\)$/.test(b) ? b : 'rgba(136,136,136,.06)'; }
function grpIcon(g)  { return GICON[g] || _UNK.icon; }
function grpLabel(g) { return sanitizeText(g || 'Unknown'); }

// Per-node bar background patterns
function nodeBarBg(node, col, opacity) {
  const a = opacity || 'ee';
  switch(node) {
    case 1: return col;  // solid
    case 2: return `repeating-linear-gradient(45deg,${col}${a} 0px,${col}${a} 4px,rgba(255,255,255,.38) 4px,rgba(255,255,255,.38) 6px)`;  // diagonal stripe
    case 3: return `repeating-linear-gradient(0deg,${col}${a} 0px,${col}${a} 3px,rgba(255,255,255,.38) 3px,rgba(255,255,255,.38) 5px)`;  // horizontal stripe
    case 4: return `repeating-linear-gradient(45deg,${col}${a} 0px,${col}${a} 3px,rgba(255,255,255,.38) 3px,rgba(255,255,255,.38) 5px),repeating-linear-gradient(-45deg,${col}${a} 0px,${col}${a} 3px,rgba(255,255,255,.38) 3px,rgba(255,255,255,.38) 5px)`;  // crosshatch
    default: return `repeating-linear-gradient(90deg,${col}${a} 0px,${col}${a} 5px,rgba(255,255,255,.38) 5px,rgba(255,255,255,.38) 8px)`;  // vertical stripe
  }
}

// Draw per-node dot shape on canvas
function drawNodeDot(c, node, px, y, col, alpha) {
  c.globalAlpha = alpha || 0.7;
  switch(node) {
    case 1: // filled circle
      c.beginPath(); c.arc(px, y, 4.5, 0, Math.PI*2);
      c.fillStyle = col; c.fill(); break;
    case 2: // hollow diamond
      var s = 6;
      c.beginPath(); c.moveTo(px, y-s); c.lineTo(px+s, y); c.lineTo(px, y+s); c.lineTo(px-s, y); c.closePath();
      c.strokeStyle = col; c.lineWidth = 1.8; c.stroke(); break;
    case 3: // hollow triangle
      var t = 6.5;
      c.beginPath(); c.moveTo(px, y-t); c.lineTo(px+t, y+t*0.7); c.lineTo(px-t, y+t*0.7); c.closePath();
      c.strokeStyle = col; c.lineWidth = 1.8; c.stroke(); break;
    case 4: // hollow square
      var sq = 5;
      c.strokeStyle = col; c.lineWidth = 1.8; c.strokeRect(px-sq, y-sq, sq*2, sq*2); break;
    default: // cross
      var cr = 5;
      c.beginPath(); c.moveTo(px-cr, y-cr); c.lineTo(px+cr, y+cr); c.moveTo(px+cr, y-cr); c.lineTo(px-cr, y+cr);
      c.strokeStyle = col; c.lineWidth = 2; c.stroke(); break;
  }
  c.globalAlpha = 1;
}

/* Historical group resolution — per date, using built-in LEASE_MAP */
function getGroup(last4, dateStr) {
  return getGroupDynamic(last4, dateStr, LEASE_MAP);
}
function getLeaseName(last4) {
  return getLeaseNameDynamic(last4, LEASE_MAP);
}

/* Dynamic group lookup — purely from the map, no hardcoded date overrides.
   No naming file → everything is 'All Leases' (single green group).
   Naming file uploaded → use whatever group the lease is assigned to. */
function getGroupDynamic(last4, dateStr, map) {
  if (!map || Object.keys(map).length === 0) return 'All Leases';
  if (last4 in map) return map[last4].group || 'Unassigned';
  return 'Unassigned';
}
function getLeaseNameDynamic(last4, map) {
  if (!map || Object.keys(map).length === 0) return last4.toUpperCase();
  if (last4 in map) {
    return map[last4].name;
  }
  return last4.toUpperCase();
}

/* ═══════════════════════════════════════════════════════
   FILE UPLOAD — DATA FILES + OPTIONAL NAMING FILE
═══════════════════════════════════════════════════════ */
let loadedFiles     = {};   // name → parsed JSON array  (earnings)
let withdrawFiles   = {};   // name → parsed JSON array  (withdrawals)
let namingFileRaw   = null;
let dynamicLeaseMap = {};

const dropZone   = document.getElementById('dropZone');
// Keep the start date label in sync with the DATA_START constant
document.getElementById('startDateDisplay').textContent = 'auto';
const fileInput  = document.getElementById('fileInput');
const namesInput = document.getElementById('fileInputNames');
const withInput  = document.getElementById('fileInputWith');

/* ── Earnings drop zone ── */
dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleDataFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e => handleDataFiles(e.target.files));

/* ── Naming file drop zone ── */
const dropZoneNames = document.getElementById('dropZoneNames');
dropZoneNames.addEventListener('dragover',  e => { e.preventDefault(); dropZoneNames.classList.add('drag-over'); });
dropZoneNames.addEventListener('dragleave', () => dropZoneNames.classList.remove('drag-over'));
dropZoneNames.addEventListener('drop', e => { e.preventDefault(); dropZoneNames.classList.remove('drag-over'); handleNamingFile(e.dataTransfer.files[0]); });
namesInput.addEventListener('change', e => { if (e.target.files[0]) handleNamingFile(e.target.files[0]); });

/* ── Withdrawal drop zone ── */
const dropZoneWith = document.getElementById('dropZoneWith');
dropZoneWith.addEventListener('dragover',  e => { e.preventDefault(); dropZoneWith.classList.add('drag-over'); });
dropZoneWith.addEventListener('dragleave', () => dropZoneWith.classList.remove('drag-over'));
dropZoneWith.addEventListener('drop', e => { e.preventDefault(); dropZoneWith.classList.remove('drag-over'); handleWithdrawFiles(e.dataTransfer.files); });
withInput.addEventListener('change', e => handleWithdrawFiles(e.target.files));

/* ── Unified Upload All zone ── */
const dropZoneAll = document.getElementById('dropZoneAll');
const fileInputAll = document.getElementById('fileInputAll');
if (dropZoneAll) {
  dropZoneAll.addEventListener('dragover', e => { e.preventDefault(); dropZoneAll.classList.add('drag-over'); });
  dropZoneAll.addEventListener('dragleave', () => dropZoneAll.classList.remove('drag-over'));
  dropZoneAll.addEventListener('drop', e => { e.preventDefault(); dropZoneAll.classList.remove('drag-over'); autoSortFiles(e.dataTransfer.files); });
}
if (fileInputAll) fileInputAll.addEventListener('change', e => autoSortFiles(e.target.files));

function autoSortFiles(files) {
  if (!files || !files.length) return;
  const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
  const naming = [];
  const earnings = [];
  const withdrawals = [];
  const statusEl = document.getElementById('allUploadStatus');

  // Filter out oversized files
  const validFiles = Array.from(files).filter(f => {
    if (f.size > MAX_FILE_SIZE) {
      console.warn('[Upload] File too large, skipping: ' + f.name + ' (' + (f.size/1024/1024).toFixed(1) + 'MB)');
      if (statusEl) statusEl.innerHTML = '<span style="color:#dc2626;font-weight:700">⚠ File "' + sanitizeText(f.name) + '" exceeds 50MB limit</span>';
      return false;
    }
    return true;
  });
  if (!validFiles.length) return;
  let pending = validFiles.length;

  validFiles.forEach(file => {
    const reader = new FileReader();
    reader.onerror = () => { console.warn('[Upload] Failed to read: ' + file.name); if (--pending === 0) { if (naming.length) handleNamingFile(naming[0]); if (earnings.length) handleDataFiles(earnings); if (withdrawals.length) handleWithdrawFiles(withdrawals); } };
    reader.onload = ev => {
      const raw = ev.target.result.trim();
      const type = detectFileType(raw, file.name);
      if (type === 'naming') naming.push(file);
      else if (type === 'withdrawal') withdrawals.push(file);
      else earnings.push(file);

      if (--pending === 0) {
        // Route to existing handlers
        if (naming.length) handleNamingFile(naming[0]); // only one naming file
        if (earnings.length) handleDataFiles(earnings);
        if (withdrawals.length) handleWithdrawFiles(withdrawals);
        // Status
        const parts = [];
        if (naming.length) parts.push(naming.length + ' naming');
        if (earnings.length) parts.push(earnings.length + ' earnings');
        if (withdrawals.length) parts.push(withdrawals.length + ' withdrawal');
        if (statusEl) statusEl.innerHTML = '<span style="color:#10b981;font-weight:700">✓ Auto-sorted: ' + parts.join(' · ') + '</span>';
        dropZoneAll.style.borderColor = '#10b981';
      }
    };
    reader.readAsText(file);
  });
}

function detectFileType(raw, filename) {
  // Naming file: has our header or group/lease patterns
  if (raw.includes('# dataNerds Unity') || raw.includes('# Lease Names') ||
      /^[A-Za-z0-9][A-Za-z0-9_\-\.]*\s+[0-9a-fA-F]{4}\s+n\d{1,2}/m.test(raw)) {
    return 'naming';
  }
  // Try JSON parse
  try {
    const parsed = JSON.parse(raw);
    const arr = Array.isArray(parsed) ? parsed : [parsed];
    if (arr.length > 0 && arr[0]) {
      // Withdrawal: has cryptoAmount or chain field
      if ('cryptoAmount' in arr[0] || 'chain' in arr[0] || ('amountMicros' in arr[0] && !('licenseId' in arr[0]))) {
        return 'withdrawal';
      }
      // Earnings: has licenseId
      if ('licenseId' in arr[0] || 'completedAt' in arr[0]) {
        return 'earnings';
      }
    }
  } catch(e) {
    // Not JSON — if it has lease patterns, naming; otherwise treat as earnings attempt
    if (/^[A-Za-z0-9][A-Za-z0-9_\-\.]*\s+[0-9a-fA-F]{4}/m.test(raw)) return 'naming';
  }
  return 'earnings'; // default fallback
}

/* ── Check if filename contains a number (valid earnings file) ── */

function handleNamingFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onerror = () => { console.warn('[Upload] Failed to read naming file'); };
  reader.onload = ev => {
    namingFileRaw = ev.target.result;
    const parsed = parseNamingFile(namingFileRaw);
    dynamicLeaseMap = parsed;
    const count = Object.keys(parsed).length;
    document.getElementById('namesStatus').innerHTML = `<span style="color:#10b981">✓ ${count} leases mapped</span>`;
    dropZoneNames.style.borderColor = '#10b981';
  };
  reader.readAsText(file);
}

function parseNamingFile(text) {
  const result = {};
  const groupRanges = [];
  const groupColors = {};   // group name → hex color from file
  const parsedNotes = {};   // date → note text
  const parsedNodeNames = {};  // nodeId → { name, order }
  let currentGroup = 'Unassigned';

  const lines = text.split(/\r?\n/);

  lines.forEach(line => {
    const stripped = line.trim();

    // ── Split setting lines (group only)
    const splitMatch = stripped.match(/^split:group:(.+?)\s+(\d+)\s*$/i);
    if (splitMatch) {
      const val = parseInt(splitMatch[2],10);
      if (val >= 1 && val <= 100) splitGroups[splitMatch[1].trim()] = val;
      return;
    }
    // Legacy: skip old global/node split lines
    if (/^split:(global|node:)/i.test(stripped)) return;

    // ── Node name line: "nodename:NODEID  Name  n#"
    const nodeMatch = stripped.match(/^nodename:(\S+)\s+(.+?)\s+(n\d{1,2})\s*$/i);
    if (nodeMatch) {
      parsedNodeNames[nodeMatch[1]] = { name: nodeMatch[2].trim(), order: parseInt(nodeMatch[3].slice(1,10)) };
      return;
    }

    // ── Note line: "note:YYYY-MM-DD  text" or "note:lease:XXXX  text"
    const noteMatch = stripped.match(/^note:([\w:\-]+)\s+(.+)$/i);
    if (noteMatch) {
      parsedNotes[noteMatch[1]] = noteMatch[2].trim();
      return;
    }

    // ── Settings line: "setting:key  value"
    const settingMatch = stripped.match(/^setting:(\w+)\s+(.+)$/i);
    if (settingMatch) {
      const sKey = settingMatch[1], sVal = settingMatch[2].trim();
      try {
        if (sKey === 'monthlyGoal') { var gi = document.getElementById('goalInput'); if (gi) gi.value = sVal; try { localStorage.setItem('dnd_monthlyGoal', sVal); } catch(e){} }
        if (sKey === 'alertLeaseMin') { var ali = document.getElementById('alertLeaseMin'); if (ali) ali.value = sVal; }
        if (sKey === 'alertDayMin') { var adi = document.getElementById('alertDayMin'); if (adi) adi.value = sVal; }
        if (sKey === 'favorites') { try { favLeases = new Set(sVal.split(',').filter(function(x){return /^[0-9a-f]{4}$/.test(x);})); saveFavorites(); } catch(e){} }
      } catch(e) {}
      return;
    }

    // ── Group directive comment: "# GroupName" or "# GroupName — node 1" or "# GroupName — #rrggbb"
    const groupDir = stripped.match(/^#\s*(?:group:?\s*)?([\w][\w\s\-\.&]+?)(?:\s*[\u2014\u2013—-]{1,2}\s*(?:node\s*\d[^#]*)?(?:#([0-9a-fA-F]{3,6}))?)?$/i);
    if (groupDir) {
      const candidate = groupDir[1].trim();
      const colorHint = groupDir[2] ? '#' + groupDir[2] : null;
      if (!/^format|^note|^use with|^Nodes$/i.test(candidate) && candidate.length >= 2 && candidate.length <= 40) {
        currentGroup = candidate;
        if (colorHint) groupColors[candidate] = colorHint;
      }
      return;
    }

    // ── Old-style header range: "lease names 001-100 are in group MyGroup..."
    const headerRe = /^lease names?\s+(L?[\w]+)[-\u2013](L?[\w]+)\s+are in (?:lease only |group\s+)?(\w[\w\s]*?)(?:\s+and\b|\s+node\b|$)/i;
    const hm = stripped.match(headerRe);
    if (hm) {
      const fromRaw = hm[1], toRaw = hm[2], rawGroup = hm[3].trim();
      const from = parseInt(fromRaw.replace(/L/i,''), 10);
      const to   = parseInt(toRaw.replace(/[A-Za-z]/g,''), 10);
      // Strip accidental leading "group " word if regex captured it
      const cleanGroup = rawGroup.replace(/^group\s+/i, '').trim();
      groupRanges.push({from, to, group: cleanGroup});
      return;
    }

    // ── Lease row: name  hex4  [n1-n6 or legacy y]  [s50 = split % | sh:date=val,date=val]
    const rowRe = /^([A-Za-z0-9][A-Za-z0-9_\-\.]*)\s+([0-9a-fA-F]{4})\s*(y|n\d{1,2})?\s*(s\d{1,3}|sh:[^\s]+)?\s*(exp:\d{4}-\d{2}-\d{2})?\s*$/i;
    const rm = stripped.match(rowRe);
    if (!rm) return;

    const nameRaw = rm[1].trim();
    const last4   = rm[2].toLowerCase();
    const nodeFlag = (rm[3]||'').toLowerCase();
    const splitFlag = (rm[4]||'');
    const expiryFlag = (rm[5]||'');
    let node = 1;
    if (nodeFlag === 'n1') node = 1;
    else if (nodeFlag === 'y' || nodeFlag === 'n2') node = 2;
    else if (nodeFlag === 'n3') node = 3;
    else if (nodeFlag === 'n4') node = 4;
    else if (nodeFlag === 'n5') node = 5;
    else if (nodeFlag === 'n6') node = 6;

    let individualSplit = undefined;
    let splitHistory = undefined;
    if (splitFlag.toLowerCase().startsWith('sh:')) {
      // Parse split history: sh:2026-01-01=50,2026-02-01=30
      const parts = splitFlag.slice(3).split(',');
      splitHistory = [];
      parts.forEach(function(p) {
        const eq = p.split('=');
        if (eq.length === 2) {
          var d = eq[0].trim();
          var v = parseInt(eq[1],10);
          if (/^\d{4}-\d{2}-\d{2}$/.test(d) && v >= 0 && v <= 100) {
            splitHistory.push({ from: d, uno: v });
          }
        }
      });
      if (splitHistory.length > 0) {
        splitHistory.sort(function(a,b){ return a.from.localeCompare(b.from); });
        individualSplit = splitHistory[splitHistory.length - 1].uno;
      } else {
        splitHistory = undefined;
      }
    } else if (splitFlag) {
      const sv = parseInt(splitFlag.slice(1,10));
      if (sv >= 1 && sv <= 100) individualSplit = sv;
    }

    const num = parseInt(nameRaw.replace(/[A-Za-z_\-\.]/g,''), 10);

    // Group resolution: old-style range first, then comment-directive currentGroup
    let group = currentGroup;
    if (groupRanges.length > 0) {
      for (const r of groupRanges) {
        if (!isNaN(num) && num >= r.from && num <= r.to) {
          group = r.group; break;
        }
      }
    }

    const entry = { name: nameRaw, group, node };
    if (expiryFlag) {
      const expDate = expiryFlag.slice(4); // remove 'exp:'
      if (/^\d{4}-\d{2}-\d{2}$/.test(expDate)) entry.expiry = expDate;
    }
    if (splitHistory) {
      entry.splitHistory = splitHistory;
      entry.split = individualSplit;
      entry.splitLocked = true;
    } else if (individualSplit !== undefined) {
      entry.split = individualSplit;
      entry.splitLocked = true;
    }
    result[last4] = entry;
  });

  // Attach group colors as a special key so buildGroupSystem can read them
  result.__groupColors = groupColors;
  // Attach notes so they load into dynamicLeaseMap
  if (Object.keys(parsedNotes).length > 0) result.__notes = parsedNotes;
  // Attach node names so they can be applied to nodeMap
  if (Object.keys(parsedNodeNames).length > 0) result.__nodeNames = parsedNodeNames;
  return result;
}

function handleDataFiles(files) {
  const MAX_FILE_SIZE = 50 * 1024 * 1024;
  const fileArr = Array.from(files).filter(f => f.size <= MAX_FILE_SIZE);
  if (!fileArr.length) return;
  let pending = fileArr.length;
  const results = [];

  fileArr.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      let parsed = null, error = null;
      const raw = ev.target.result.trim();

      // Only reject if it looks like a naming file or withdrawal file
      if (raw.toLowerCase().includes('lease names') && !raw.startsWith('[')) {
        error = `"${file.name}" looks like a lease naming file — drop it in the LEFT zone.`;
      } else {
        try {
          parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) { error = 'Not a JSON array. Expected [{...},...]'; parsed = null; }
        } catch(e) { error = `JSON parse failed: ${e.message}`; }
      }

      results.push({ name: file.name, data: parsed, error });
      if (--pending === 0) {
        results.forEach(r => { if (r.data) loadedFiles[r.name] = r.data; });
        updateSlots(results.filter(r => r.error));
      }
    };
    reader.onerror = () => {
      results.push({ name: file.name, data: null, error: 'Could not read file.' });
      if (--pending === 0) { updateSlots(results.filter(r => r.error)); }
    };
    reader.readAsText(file);
  });
}

function handleWithdrawFiles(files) {
  const MAX_FILE_SIZE = 50 * 1024 * 1024;
  const fileArr = Array.from(files).filter(f => f.size <= MAX_FILE_SIZE);
  if (!fileArr.length) return;
  let pending = fileArr.length;
  const results = [];

  fileArr.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      let parsed = null, error = null;
      try {
        parsed = JSON.parse(ev.target.result.trim());
        if (!Array.isArray(parsed)) parsed = [parsed]; // single object → wrap
      } catch(e) { error = `JSON parse failed: ${e.message}`; }
      results.push({ name: file.name, data: parsed, error });
      if (--pending === 0) {
        results.forEach(r => { if (r.data) withdrawFiles[r.name] = r.data; });
        const total = Object.values(withdrawFiles).flat().length;
        const withEl = document.getElementById('withStatus');
        if (withEl) withEl.innerHTML = `<span style="color:#10b981">✓ ${Object.keys(withdrawFiles).length} file(s) · ${total} entries</span>`;
        dropZoneWith.style.borderColor = '#16a34a';
        const errs = results.filter(r => r.error);
        if (errs.length && DEBUG) errs.forEach(e => console.warn('[UNITY] Withdrawal parse error:', e.name, e.error));
      }
    };
    reader.onerror = () => { results.push({ name: file.name, data: null, error: 'Read failed' }); if (--pending === 0) {} };
    reader.readAsText(file);
  });
}

function updateSlots(errors) {
  const slotsEl = document.getElementById('fileSlots');
  slotsEl.innerHTML = '';
  const names = Object.keys(loadedFiles);

  if (errors && errors.length > 0) {
    errors.forEach(e => {
      appendSafeHTML(slotsEl, `<div class="slot" style="border-color:#991b1b;color:#fca5a5;max-width:920px;width:100%">
        <div class="slot-dot" style="background:#991b1b"></div><strong>${sanitizeText(e.name)}</strong>: ${sanitizeText(e.error)}
      </div>`);
    });
  }

  if (names.length === 0) {
    appendSafeHTML(slotsEl, '<div class="slot" style="color:#4a5568;border-style:dashed"><div class="slot-dot"></div>Waiting for earnings files…</div>');
    document.getElementById('loadBtn').classList.remove('visible');
    return;
  }

  const totalTxns = Object.values(loadedFiles).reduce((s,a) => s+a.length, 0);
  names.forEach(name => {
    const count = loadedFiles[name].length;
    appendSafeHTML(slotsEl, `<div class="slot loaded"><div class="slot-dot"></div>${sanitizeText(name)} <span style="opacity:.65">(${count.toLocaleString()} txns)</span></div>`);
  });
  if (names.length > 1) {
    appendSafeHTML(slotsEl, `<div class="slot" style="border-color:#1a5ff5;color:#7aadff;font-weight:600"><div class="slot-dot"></div>${names.length} files · ${totalTxns.toLocaleString()} raw txns · duplicates removed on build</div>`);
  }
  document.getElementById('loadBtn').classList.add('visible');
}

/* ═══════════════════════════════════════════════════════
   RESET
═══════════════════════════════════════════════════════ */
function resetDashboard() {
  loadedFiles = {}; withdrawFiles = {}; namingFileRaw = null; dynamicLeaseMap = {};
  fileInput.value = ''; namesInput.value = ''; withInput.value = '';
  document.getElementById('namesStatus').textContent = '';
  document.getElementById('withStatus').textContent = '';
  document.getElementById('dropZoneNames').style.borderColor = '';
  document.getElementById('dropZoneWith').style.borderColor = '';
  updateSlots([]);
  document.getElementById('topBar').style.display = 'none';

  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('uploadScreen').style.display = 'flex';
  distDots = []; distIdx = 0; trendIdx = 0; tbIdx = 0; monthView = 'stacked'; monthlyData = {};
}

/* helper */
function resolveLeaseMap() {
  // If user uploaded a naming file → use it
  // If no file → return EMPTY map so hardcoded groups never appear
  // All leases fall to generic "All Leases" group with green coloring
  return (dynamicLeaseMap && Object.keys(dynamicLeaseMap).length > 0) ? dynamicLeaseMap : {};
}


/* ═══════════════════════════════════════════════════════
   MONTHLY CHART
═══════════════════════════════════════════════════════ */
/* ═══════════════════════════════════════════════════════
   WITHDRAWAL RENDERING
═══════════════════════════════════════════════════════ */
function renderWithdrawals(allTimeTotal) {
  const card = document.getElementById('withdrawCard');
  const allWith = Object.values(withdrawFiles).flat();
  if (!allWith.length) { card.style.display = 'none'; return; }
  card.style.display = '';

  // Parse Unity withdrawal structure: amountMicros at top level = USD amount
  // request.quote.exchangeFeeMicros = exchange fee
  // settlement.assetAmount = ADA received, settlement.status = success/failed
  function parseWith(w) {
    const usd   = (w.amountMicros || 0) / 1e6;
    const fee   = (w.request?.quote?.exchangeFeeMicros || 0) / 1e6;
    const ada   = parseFloat(w.settlement?.assetAmount || w.request?.quote?.assetAmount || 0);
    const chain = (w.request?.chain || w.settlement?.asset || '').toUpperCase();
    const status = w.settlement?.status || w.status || 'success';
    const date  = (w.completedAt || w.createdAt || '').slice(0,10);
    const failed = !!w.failedAt;
    return { id: w.id, usd, fee, ada, chain, status, date, failed };
  }

  // Deduplicate by ID — show ALL withdrawals regardless of DATA_START
  const seen = new Set();
  const deduped = [];
  allWith.forEach(w => {
    const key = w.id || JSON.stringify(w);
    if (!seen.has(key)) { seen.add(key); deduped.push(parseWith(w)); }
  });

  const successful = deduped.filter(w => !w.failed && (w.status === 'success' || w.status === 'completed'));
  const totalWithdrawn = successful.reduce((s,w) => s + w.usd, 0);
  const totalFees      = successful.reduce((s,w) => s + w.fee, 0);
  const totalADA       = successful.reduce((s,w) => s + w.ada, 0);
  const count          = successful.length;
  const pending        = deduped.filter(w => w.status !== 'success' && w.status !== 'completed' && !w.failed).length;

  // Net Balance = earnings strictly AFTER the last withdrawal date (matches Pending Withdrawal card)
  const lastSuccessful = successful.sort((a,b) => b.date.localeCompare(a.date))[0];
  const lastWithDate   = lastSuccessful ? lastSuccessful.date : null;
  const netBalance     = lastWithDate
    ? allData.reduce((s,r) => r.completedAt.slice(0,10) > lastWithDate ? s + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)) : s, 0)
    : allTimeTotal - totalWithdrawn;

  const grid = document.getElementById('withdrawGrid');
  const netColor = netBalance >= 0 ? '#15803d' : '#b91c1c';
  const netBg    = netBalance >= 0 ? 'rgba(22,163,74,.07)' : 'rgba(185,28,28,.07)';
  const netNote  = netBalance < 0
    ? `<div style="font-size:.58rem;color:#b91c1c;margin-top:.25rem;line-height:1.3">You've withdrawn more than loaded since ${DATA_START}. Upload more earnings files to cover the full period.</div>`
    : '';

  // Group crypto totals by chain (ADA, ETH, etc.)
  const byChain = {};
  successful.forEach(w => {
    const ch = w.chain || 'CRYPTO';
    if (!byChain[ch]) byChain[ch] = { ada: 0, usd: 0 };
    byChain[ch].ada += w.ada;
    byChain[ch].usd += w.usd;
  });
  const cryptoSymbols = { CARDANO:'₳', ADA:'₳', ETH:'Ξ', BTC:'₿', SOL:'◎' };
  const chainKeys = Object.keys(byChain);
  const cryptoTiles = chainKeys.map(ch => {
    const sym = cryptoSymbols[ch] || ch;
    const col = ch==='CARDANO'||ch==='ADA' ? '#7c3aed' : ch==='ETH' ? '#627eea' : ch==='BTC' ? '#f59e0b' : '#10b981';
    return `<div style="background:var(--surface2);border-radius:8px;padding:.75rem .9rem;border:1px solid var(--border)">
      <div style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.3rem">Total ${ch} Received</div>
      <div style="font-size:1.2rem;font-weight:700;color:${col};font-family:var(--font-mono), monospace">${sym}${byChain[ch].ada.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:3})}</div>
      <div style="font-size:.6rem;color:var(--muted);margin-top:.15rem">≈ $${byChain[ch].usd.toFixed(2)} USD withdrawn</div>
    </div>`;
  }).join('');

  grid.innerHTML = `
    <div style="background:var(--surface2);border-radius:8px;padding:.75rem .9rem;border:1px solid var(--border)">
      <div style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.3rem">Total Withdrawn (USD)</div>
      <div style="font-size:1.2rem;font-weight:700;color:#991b1b;font-family:var(--font-mono), monospace">$${totalWithdrawn.toFixed(4)}</div>
      <div style="font-size:.6rem;color:var(--muted);margin-top:.15rem">${count} withdrawal${count!==1?'s':''} · fees $${totalFees.toFixed(4)}</div>
    </div>
    ${cryptoTiles}`;

  // Withdrawal rows
  const sorted = [...deduped].sort((a,b) => b.date.localeCompare(a.date));
  const listEl = document.getElementById('withdrawList');
  const rows = sorted.map(w => {
    const ok  = w.status === 'success' || w.status === 'completed';
    const sc  = ok ? '#15803d' : w.failed ? '#b91c1c' : '#ca8a04';
    const st  = ok ? '&#10003;' : w.failed ? '&#10007; failed' : w.status;
    const cryptoSym2 = { CARDANO:'₳', ADA:'₳', ETH:'Ξ', BTC:'₿', SOL:'◎' };
    const sym2 = cryptoSym2[w.chain] || w.chain || '';
    const cryptoCol2 = w.chain==='CARDANO'||w.chain==='ADA' ? '#7c3aed' : w.chain==='ETH' ? '#627eea' : w.chain==='BTC' ? '#f59e0b' : '#10b981';
    return `<div style="display:flex;align-items:center;gap:.7rem;padding:.45rem .7rem;font-size:.68rem;border-bottom:1px solid var(--border)">
      <span style="color:${sc};font-weight:700;flex-shrink:0;width:14px;text-align:center">${st}</span>
      <span style="color:var(--muted);flex-shrink:0;width:78px;font-family:var(--font-mono),monospace">${w.date}</span>
      <span style="font-weight:700;color:#1a5ff5;font-family:var(--font-mono),monospace;flex-shrink:0;min-width:72px">$${w.usd.toFixed(4)}</span>
      <span style="font-weight:700;color:${cryptoCol2};font-family:var(--font-mono),monospace;flex-shrink:0;min-width:100px">${sym2}${w.ada.toLocaleString('en-US',{minimumFractionDigits:3,maximumFractionDigits:6})}</span>
      <span style="color:var(--muted);font-size:.62rem;flex-shrink:0">fee $${w.fee.toFixed(4)}</span>
    </div>`;
  }).join('');
  listEl.innerHTML = `
    <div style="font-size:.62rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:.35rem;margin-top:.9rem">Transaction History</div>
    <div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;background:var(--surface)">
      <div style="display:flex;gap:.7rem;padding:.35rem .7rem;font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;border-bottom:2px solid var(--border);background:var(--surface2)">
        <span style="width:14px;flex-shrink:0"></span>
        <span style="width:78px;flex-shrink:0">Date</span>
        <span style="min-width:72px;flex-shrink:0">USD</span>
        <span style="min-width:100px;flex-shrink:0">Crypto</span>
        <span>Fee</span>
      </div>
      ${rows}
    </div>`;
}
function setMonthView(v, b) {
  monthView = v;
  b.closest('.ctrl-btns').querySelectorAll('.cbtn').forEach(x => x.classList.remove('on'));
  b.classList.add('on');
  renderMonthChart();
}

function renderMonthChart() {
  const el = document.getElementById('monthChart');
  const months = Object.keys(monthlyData).sort();
  if (!months.length) { el.innerHTML = '<p style="color:var(--muted);padding:.5rem">No monthly data yet.</p>'; return; }

  const maxTotal = Math.max(1, ...months.map(m => monthlyData[m].total));
  const BAR_H = 180;
  const statsEl = document.getElementById('monthStats');
  const grandTotal = months.reduce((s,m) => s + monthlyData[m].total, 0);
  statsEl.textContent = `${months.length} month${months.length!==1?'s':''} · $${grandTotal.toFixed(2)} total`;

  if (monthView === 'stacked' || monthView === 'total') {
    const cols = months.map(m => {
      const d = monthlyData[m];
      let segments = '';
      if (monthView === 'stacked') {
        // Sort groups by value DESC so highest earner is on BOTTOM of the stack
        const grpsWithData = getGroupsAll().filter(g => d.byGroup[g] > 0)
          .sort((a,b) => d.byGroup[b] - d.byGroup[a]); // highest first = rendered last = bottom
        // Reverse so we append highest LAST (CSS flex-direction column = top to bottom, so we want lowest on top)
        // flex-direction: column with justify-content: flex-end means last child is at bottom
        // So: render lowest earners first (they sit near top), highest earner last (sits at bottom)
        const grpsSorted = [...grpsWithData].reverse(); // lowest first → top of stack
        grpsSorted.forEach(g => {
          const sh = Math.max(3, (d.byGroup[g] / maxTotal) * BAR_H);
          segments += `<div class="month-bar-seg" style="height:${sh}px;background:${grpCol(g)}" title="${sanitizeText(grpLabel(g))}: $${d.byGroup[g].toFixed(2)}"></div>`;
        });
      } else {
        const h = Math.max(4, (d.total / maxTotal) * BAR_H);
        segments = `<div class="month-bar-seg" style="height:${h}px;background:var(--primary)" title="$${d.total.toFixed(2)}"></div>`;
      }
      return `<div class="month-col">
        <div class="month-total">$${d.total.toFixed(2)}</div>
        <div class="month-bar-outer" style="min-height:${BAR_H}px">${segments}</div>
        <div class="month-lbl">${fmtMo(m)}</div>
        <div style="font-size:.58rem;color:var(--muted)">${d.txns.toLocaleString()} txns</div>
      </div>`;
    });
    el.innerHTML = `<div class="month-bar-wrap">${cols.join('')}</div>`;

    // Color key for stacked view — no white stripe, just solid swatch
    if (monthView === 'stacked') {
      const usedGroups = getGroupsAll().filter(g => months.some(m => monthlyData[m].byGroup[g] > 0));
      el.innerHTML += `<div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-top:.5rem;font-size:.65rem;color:var(--muted)">
        ${usedGroups.map(g=>`<div style="display:flex;align-items:center;gap:.3rem">
          <div style="width:10px;height:10px;border-radius:2px;background:${grpCol(g)}"></div>
          ${grpLabel(g)}
        </div>`).join('')}
        <span style="font-size:.6rem;font-style:italic;margin-left:.5rem">largest earner at bottom</span>
      </div>`;
    }

  } else {
    // By group: horizontal bars per month per group — no white stripes
    const usedGroups = getGroupsAll().filter(g => months.some(m => monthlyData[m].byGroup[g] > 0));
    const rows = usedGroups.map(g => {
      const vals = months.map(m => monthlyData[m].byGroup[g]||0);
      const mx = Math.max(...vals, 0.001);
      const bars = vals.map((v,i) => `
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:3px">
          <div style="font-size:.6rem;color:var(--muted);width:60px;flex-shrink:0">${fmtMo(months[i])}</div>
          <div style="flex:1;height:16px;background:var(--surface2);border-radius:3px;overflow:hidden;max-width:220px">
            <div style="height:100%;width:${v?((v/mx)*100).toFixed(1):0}%;background:${grpCol(g)};border-radius:3px"></div>
          </div>
          <div style="font-size:.62rem;font-weight:700;color:${grpCol(g)};width:54px;font-family:var(--font-mono), monospace">$${v.toFixed(2)}</div>
        </div>`).join('');
      return `<div style="margin-bottom:.9rem">
        <div style="font-size:.65rem;font-weight:700;color:${grpCol(g)};text-transform:uppercase;letter-spacing:.07em;margin-bottom:.35rem">${grpLabel(g)}</div>
        ${bars}
      </div>`;
    });
    el.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:.9rem;margin-top:.25rem">${rows.join('')}</div>`;
  }
}

/* ═══════════════════════════════════════════════════════
   AI ANALYSIS ENGINE
═══════════════════════════════════════════════════════ */
function buildAnalysis(grpToday, grpAll) {
  const dDates = Object.keys(distData).sort();
  const topCounts = {}, botCounts = {};

  dDates.forEach(day => {
    const arr = [...distData[day]].sort((a,b) => b.v - a.v);
    arr.slice(0, 10).forEach(x => { topCounts[x.n] = (topCounts[x.n]||0) + 1; });
    arr.slice(-10).forEach(x => { botCounts[x.n] = (botCounts[x.n]||0) + 1; });
  });

  const topRank = Object.entries(topCounts).sort((a,b) => b[1]-a[1]);
  const botRank = Object.entries(botCounts).sort((a,b) => b[1]-a[1]);
  const n = dDates.length;

  // Lease all-time totals
  const leaseTotals = {};
  allData.forEach(r => {
    const nm = getLeaseName(r.licenseId.slice(-4));
    leaseTotals[nm] = (leaseTotals[nm]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
  });
  const topLeases = Object.entries(leaseTotals).sort((a,b) => b[1]-a[1]);

  // Recent vs earlier trend
  const daily = trendData.map(t => t.total);
  const splitAt = Math.floor(daily.length/2);
  const earlyAvg = daily.slice(0,splitAt).reduce((a,b)=>a+b,0)/splitAt||1;
  const lateAvg  = daily.slice(splitAt).reduce((a,b)=>a+b,0)/(daily.length-splitAt)||1;
  const revTrend = ((lateAvg-earlyAvg)/earlyAvg*100).toFixed(0);

  // License participation trend
  const actList = datesSorted.map(d => new Set(byDate[d].map(r=>r.licenseId)).size);
  const earlyAct = actList.slice(0,splitAt).reduce((a,b)=>a+b,0)/splitAt||1;
  const lateAct  = actList.slice(splitAt).reduce((a,b)=>a+b,0)/(actList.length-splitAt)||1;
  const actTrend = ((lateAct-earlyAct)/earlyAct*100).toFixed(0);

  // Volatile leases (in both top and bottom 10)
  const volatile = topRank.filter(([nm,tc]) => botCounts[nm]>=2 && tc>=2).map(([nm])=>nm);

  // Group dominance
  const totalEarned = Object.values(grpAll).reduce((a,b)=>a+b,0)||1;
  const topGroup = Object.entries(grpAll).sort((a,b)=>b[1]-a[1])[0];

  const insights = [];

  // 1. Revenue trend
  if (parseFloat(revTrend) > 10)
    insights.push({icon:'📈',bg:'#dcfce7',col:'#16a34a',txt:`<strong>Upward momentum:</strong> Recent daily average of <strong>$${lateAvg.toFixed(2)}</strong> is up <strong>+${revTrend}%</strong> vs the earlier period average of $${earlyAvg.toFixed(2)}. Earnings are accelerating.`});
  else if (parseFloat(revTrend) < -10)
    insights.push({icon:'📉',bg:'#fee2e2',col:'#991b1b',txt:`<strong>Revenue declining:</strong> Recent daily average of <strong>$${lateAvg.toFixed(2)}</strong> is down <strong>${Math.abs(revTrend)}%</strong> vs earlier average of $${earlyAvg.toFixed(2)}. Worth investigating.`});
  else
    insights.push({icon:'📊',bg:'#eff4ff',col:'#2563eb',txt:`<strong>Stable earnings:</strong> Revenue has been consistent — recent daily average <strong>$${lateAvg.toFixed(2)}</strong> vs earlier $${earlyAvg.toFixed(2)} (${parseFloat(revTrend)>0?'+':''}${revTrend}%). No major swings.`});

  // 2. Dominant earner
  if (topRank[0]) {
    const pct = Math.round(topRank[0][1]/n*100);
    const atEarnings = (leaseTotals[topRank[0][0]]||0).toFixed(4);
    insights.push({icon:'🏆',bg:'#fef9c3',col:'#854d0e',txt:`<strong>${sanitizeText(topRank[0][0])}</strong> is the most consistent high earner — in the daily Top 10 on <strong>${topRank[0][1]} of ${n} days (${pct}%)</strong> with <strong>$${atEarnings}</strong> all-time earnings.`});
  }

  // 3. Persistent underperformer
  if (botRank[0]) {
    const pct = Math.round(botRank[0][1]/n*100);
    const also = botRank.slice(1,3).map(x=>x[0]).join(', ');
    insights.push({icon:'⚠️',bg:'#fff7ed',col:'#c2410c',txt:`<strong>${sanitizeText(botRank[0][0])}</strong> appears in the Bottom 10 on <strong>${botRank[0][1]} of ${n} days (${pct}%)</strong> — the most consistently low earner. Also frequently low: <em>${sanitizeText(also||'none')}</em>.`});
  }

  // 4. Volatility
  if (volatile.length > 0)
    insights.push({icon:'🎲',bg:'#fdf4ff',col:'#7e22ce',txt:`<strong>High volatility detected:</strong> <strong>${volatile.slice(0,3).map(sanitizeText).join(', ')}</strong> appear in <em>both</em> Top 10 and Bottom 10 on different days — inconsistent earners that swing between extremes.`});
  else
    insights.push({icon:'✅',bg:'#f0fdf4',col:'#15803d',txt:`<strong>No high-volatility leases:</strong> Top earners stay high and low earners stay low — no leases are swinging wildly between top and bottom 10. Predictable, stable network behavior.`});

  // 5. License participation
  if (parseFloat(actTrend) > 5)
    insights.push({icon:'🔌',bg:'#eff4ff',col:'#2563eb',txt:`<strong>Growing participation:</strong> Active license count increased from an early average of <strong>${earlyAct.toFixed(0)}</strong> to <strong>${lateAct.toFixed(0)}</strong> recently (+${actTrend}%). More leases are joining over time.`});
  else if (parseFloat(actTrend) < -5)
    insights.push({icon:'🔌',bg:'#fff0f0',col:'#991b1b',txt:`<strong>Participation declining:</strong> Active license count dropped from <strong>${earlyAct.toFixed(0)}</strong> early to <strong>${lateAct.toFixed(0)}</strong> recently (${actTrend}%). Some leases may have gone offline.`});
  else
    insights.push({icon:'🔌',bg:'#f0fdf4',col:'#15803d',txt:`<strong>Stable participation:</strong> Active license count held steady (early avg ${earlyAct.toFixed(0)}, recent avg ${lateAct.toFixed(0)}). Good network stability — no major dropouts or surges.`});

  // 6. Group share
  if (topGroup) {
    const share = (topGroup[1]/totalEarned*100).toFixed(0);
    const g = topGroup[0];
    insights.push({icon:'🌐',bg:'#f8f9fc',col:'#374151',txt:`<strong>Group earnings:</strong> <strong>${sanitizeText(grpLabel(g)||g)}</strong> accounts for <strong>${share}% of all-time earnings</strong> ($${topGroup[1].toFixed(2)}). ${parseFloat(share)>70?'Heavy concentration — diversification could improve long-term resilience.':'Earnings are reasonably spread across groups.'}`});
  }

  // ═══ NODE-LEVEL INSIGHTS ═══

  // 7. Node performance comparison (per-lease efficiency)
  const nodeIds = Object.keys(nodeMap);
  if (nodeIds.length >= 2) {
    const nodeEff = {};
    nodeIds.forEach((nid, i) => {
      const nm = nodeMap[nid];
      if (nm.leaseCount > 0) nodeEff[i+1] = { name: nm.name, perLease: nm.earnings / nm.leaseCount, total: nm.earnings, count: nm.leaseCount };
    });
    const effArr = Object.entries(nodeEff).sort((a,b) => b[1].perLease - a[1].perLease);
    if (effArr.length >= 2) {
      const best = effArr[0][1], worst = effArr[effArr.length-1][1];
      const pctDiff = worst.perLease > 0 ? ((best.perLease - worst.perLease) / worst.perLease * 100).toFixed(0) : '∞';
      insights.push({icon:'⚡',bg:'#eff4ff',col:'#1d4ed8',txt:`<strong>Node efficiency:</strong> <strong>${sanitizeText(best.name)}</strong> earns <strong>$${best.perLease.toFixed(4)}/lease</strong> vs <strong>${sanitizeText(worst.name)}</strong> at $${worst.perLease.toFixed(4)}/lease — <strong>${pctDiff}% more efficient</strong> per lease.`});
    }
  }

  // 8. Node consistency (std deviation of daily earnings)
  if (nodeIds.length >= 2) {
    const nodeDailyMap = {};
    nodeIds.forEach((nid, i) => { nodeDailyMap[i+1] = {}; });
    allData.forEach(r => {
      const last4 = r.licenseId.slice(-4);
      let node = 1;
      if (window._licenseNodeMap && window._licenseNodeMap[last4]) {
        const nid = window._licenseNodeMap[last4];
        const idx = nodeIds.indexOf(nid);
        if (idx >= 0) node = idx + 1;
      }
      const d = r.completedAt.slice(0,10);
      if (!nodeDailyMap[node]) nodeDailyMap[node] = {};
      nodeDailyMap[node][d] = (nodeDailyMap[node][d]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    });
    const nodeConsist = {};
    Object.entries(nodeDailyMap).forEach(([nd, daily]) => {
      const vals = Object.values(daily);
      if (vals.length < 3) return;
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      const variance = vals.reduce((s,v)=>s+(v-avg)*(v-avg),0)/vals.length;
      const stdDev = Math.sqrt(variance);
      const cv = avg > 0 ? (stdDev/avg*100) : 0;
      nodeConsist[nd] = { cv, avg, stdDev, name: nodeMap[nodeIds[nd-1]]?.name || 'Node '+nd };
    });
    const consistArr = Object.entries(nodeConsist).sort((a,b) => a[1].cv - b[1].cv);
    if (consistArr.length >= 2) {
      const most = consistArr[0][1], least = consistArr[consistArr.length-1][1];
      insights.push({icon:'🎯',bg:'#fef9c3',col:'#92400e',txt:`<strong>Node consistency:</strong> <strong>${sanitizeText(most.name)}</strong> is most stable (±${most.cv.toFixed(1)}% daily variation) while <strong>${sanitizeText(least.name)}</strong> fluctuates more (±${least.cv.toFixed(1)}%). ${least.cv > 25 ? 'High variance may indicate connectivity issues.' : 'Both are within normal range.'}`});
    }
  }

  // 9. Node recent trend (which node improved/declined most)
  if (nodeIds.length >= 2 && datesSorted.length >= 6) {
    const half = Math.floor(datesSorted.length / 2);
    const earlyDates = datesSorted.slice(0, half);
    const lateDates = datesSorted.slice(half);
    const nodeTrends = {};
    nodeIds.forEach((nid, i) => { nodeTrends[i+1] = { early:0, late:0, earlyDays:0, lateDays:0 }; });
    allData.forEach(r => {
      const last4 = r.licenseId.slice(-4);
      let node = 1;
      if (window._licenseNodeMap && window._licenseNodeMap[last4]) {
        const nidx = nodeIds.indexOf(window._licenseNodeMap[last4]);
        if (nidx >= 0) node = nidx + 1;
      }
      const d = r.completedAt.slice(0,10);
      if (!nodeTrends[node]) return;
      if (earlyDates.includes(d)) { nodeTrends[node].early += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); }
      else if (lateDates.includes(d)) { nodeTrends[node].late += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); }
    });
    let bestNode = null, bestPct = -999, worstNode = null, worstPct = 999;
    Object.entries(nodeTrends).forEach(([nd, t]) => {
      const earlyAvg2 = t.early / Math.max(1, half);
      const lateAvg2 = t.late / Math.max(1, lateDates.length);
      const pct2 = earlyAvg2 > 0 ? ((lateAvg2 - earlyAvg2) / earlyAvg2 * 100) : 0;
      const nm = nodeMap[nodeIds[nd-1]]?.name || 'Node '+nd;
      if (pct2 > bestPct) { bestPct = pct2; bestNode = nm; }
      if (pct2 < worstPct) { worstPct = pct2; worstNode = nm; }
    });
    if (bestNode && Math.abs(bestPct) > 3) {
      const improving = bestPct > 0;
      insights.push({icon: improving ? '🚀' : '📉', bg: improving ? '#dcfce7' : '#fee2e2', col: improving ? '#16a34a' : '#991b1b',
        txt:`<strong>Node trend:</strong> <strong>${sanitizeText(bestNode)}</strong> ${improving ? 'improved' : 'declined'} the most — daily average shifted <strong>${bestPct > 0 ? '+' : ''}${bestPct.toFixed(1)}%</strong> recently. ${worstNode !== bestNode ? sanitizeText(worstNode) + ' moved ' + (worstPct > 0 ? '+' : '') + worstPct.toFixed(1) + '%.' : ''}`});
    }
  }

  // ═══ GROUP-LEVEL INSIGHTS ═══

  // 10. Best/worst group by avg per lease
  const groupAvgs = {};
  Object.entries(grpAll).forEach(([g, total]) => {
    const count = leaseData.filter(l => l.group === g).length;
    if (count > 0) groupAvgs[g] = { avg: total / count, count, total };
  });
  const grpAvgArr = Object.entries(groupAvgs).sort((a,b) => b[1].avg - a[1].avg);
  if (grpAvgArr.length >= 2) {
    const best = grpAvgArr[0], worst = grpAvgArr[grpAvgArr.length-1];
    insights.push({icon:'📊',bg:'#eff6ff',col:'#1e40af',txt:`<strong>Group efficiency:</strong> <strong>${sanitizeText(grpLabel(best[0]))}</strong> averages <strong>$${best[1].avg.toFixed(4)}/lease</strong> (${best[1].count} leases) — highest. <strong>${sanitizeText(grpLabel(worst[0]))}</strong> averages $${worst[1].avg.toFixed(4)}/lease (${worst[1].count} leases) — lowest.`});
  }

  // 11. Group earning trend (rising/falling)
  if (datesSorted.length >= 6) {
    const half2 = Math.floor(datesSorted.length / 2);
    const grpTrend = {};
    allData.forEach(r => {
      const last4 = r.licenseId.slice(-4);
      const g = getGroup(last4) || 'Unassigned';
      const d = r.completedAt.slice(0,10);
      if (!grpTrend[g]) grpTrend[g] = { early:0, late:0 };
      if (datesSorted.indexOf(d) < half2) grpTrend[g].early += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
      else grpTrend[g].late += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    });
    let fastestGrp = null, fastestPct = 0, slowestGrp = null, slowestPct = 0;
    Object.entries(grpTrend).forEach(([g, t]) => {
      if (t.early < 0.01) return;
      const pctG = ((t.late - t.early) / t.early * 100);
      if (pctG > fastestPct) { fastestPct = pctG; fastestGrp = g; }
      if (pctG < slowestPct) { slowestPct = pctG; slowestGrp = g; }
    });
    if (fastestGrp && Math.abs(fastestPct) > 5) {
      insights.push({icon:'📈',bg:'#dcfce7',col:'#15803d',txt:`<strong>Group trend:</strong> <strong>${sanitizeText(grpLabel(fastestGrp))}</strong> grew the most (<strong>+${fastestPct.toFixed(0)}%</strong> recent vs earlier).${slowestGrp && slowestPct < -5 ? ' <strong>' + sanitizeText(grpLabel(slowestGrp)) + '</strong> declined the most (' + slowestPct.toFixed(0) + '%).' : ''}`});
    }
  }

  // ═══ TIME-BASED PATTERNS ═══

  // 12. Best/worst day of the week
  const dowTotals = [0,0,0,0,0,0,0], dowCounts = [0,0,0,0,0,0,0];
  const DOW_NAMES = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  datesSorted.forEach(d => {
    const dow = new Date(d+'T12:00:00').getDay();
    const dayTotal = (byDate[d]||[]).reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
    dowTotals[dow] += dayTotal;
    dowCounts[dow]++;
  });
  const dowAvgs = dowTotals.map((t,i) => ({ day: DOW_NAMES[i], avg: dowCounts[i] > 0 ? t/dowCounts[i] : 0 }));
  const bestDow = dowAvgs.reduce((a,b) => b.avg > a.avg ? b : a);
  const worstDow = dowAvgs.reduce((a,b) => b.avg < a.avg && b.avg > 0 ? b : a);
  if (bestDow.avg > 0 && worstDow.avg > 0) {
    const dowDiff = ((bestDow.avg - worstDow.avg) / worstDow.avg * 100).toFixed(0);
    insights.push({icon:'📅',bg:'#fef3c7',col:'#92400e',txt:`<strong>Best earning day:</strong> <strong>${bestDow.day}</strong> averages <strong>$${bestDow.avg.toFixed(4)}</strong>/day — <strong>${dowDiff}% more</strong> than ${worstDow.day} ($${worstDow.avg.toFixed(4)}).`});
  }

  // 13. Weekend vs weekday
  const wkdayAvg = dowAvgs.slice(1,6).reduce((s,d)=>s+d.avg,0)/5;
  const wkendAvg = (dowAvgs[0].avg + dowAvgs[6].avg)/2;
  if (wkdayAvg > 0 && wkendAvg > 0) {
    const wkPct = ((wkendAvg - wkdayAvg) / wkdayAvg * 100).toFixed(0);
    const better = parseFloat(wkPct) > 0 ? 'weekends' : 'weekdays';
    insights.push({icon:'🗓️',bg:'#f0fdf4',col:'#166534',txt:`<strong>Weekend vs weekday:</strong> Weekday avg <strong>$${wkdayAvg.toFixed(4)}</strong>/day vs weekend avg <strong>$${wkendAvg.toFixed(4)}</strong>/day. <strong>${better.charAt(0).toUpperCase()+better.slice(1)} earn ${Math.abs(wkPct)}% more</strong>.`});
  }

  // 14. Streak detection
  if (datesSorted.length >= 5) {
    const overallDailyAvg = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0) / datesSorted.length;
    let curStreak = 0, maxAbove = 0, maxBelow = 0, curType = null;
    datesSorted.forEach(d => {
      const dayT = (byDate[d]||[]).reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
      const isAbove = dayT >= overallDailyAvg;
      if (curType === null) { curType = isAbove; curStreak = 1; }
      else if (isAbove === curType) { curStreak++; }
      else { curType = isAbove; curStreak = 1; }
      if (isAbove && curStreak > maxAbove) maxAbove = curStreak;
      if (!isAbove && curStreak > maxBelow) maxBelow = curStreak;
    });
    if (maxAbove >= 3 || maxBelow >= 3) {
      const streakType = maxAbove >= maxBelow ? 'above' : 'below';
      const streakLen = Math.max(maxAbove, maxBelow);
      insights.push({icon: streakType === 'above' ? '🔥' : '❄️', bg: streakType === 'above' ? '#dcfce7' : '#fee2e2', col: streakType === 'above' ? '#16a34a' : '#991b1b',
        txt:`<strong>Streak detected:</strong> Longest run of <strong>${streakLen} consecutive days ${streakType} average</strong> ($${overallDailyAvg.toFixed(4)}/day). ${streakType === 'above' ? 'Hot streak — strong earning momentum.' : 'Cold spell — may indicate temporary network issues.'}`});
    }
  }

  // ═══ LEASE HEALTH ═══

  // 15. Silent leases (earned before but not recently)
  if (datesSorted.length >= 5) {
    const recentDates = datesSorted.slice(-3);
    const allLeaseHexes = new Set(allData.map(r => r.licenseId.slice(-4)));
    const recentActive = new Set();
    allData.forEach(r => { if (recentDates.includes(r.completedAt.slice(0,10))) recentActive.add(r.licenseId.slice(-4)); });
    const silent = [...allLeaseHexes].filter(h => !recentActive.has(h));
    if (silent.length > 0) {
      const names = silent.slice(0,4).map(h => sanitizeText(getLeaseName(h))).join(', ');
      insights.push({icon:'🔇',bg:'#fef2f2',col:'#b91c1c',txt:`<strong>${silent.length} lease${silent.length>1?'s':''} went silent:</strong> <strong>${names}</strong>${silent.length>4?' + '+(silent.length-4)+' more':''} earned previously but had <strong>no activity in the last 3 days</strong>. May need attention.`});
    }
  }

  // 16. New leases (first appeared in recent days)
  if (datesSorted.length >= 5) {
    const earlyDates3 = datesSorted.slice(0, Math.floor(datesSorted.length/2));
    const lateDates3 = datesSorted.slice(Math.floor(datesSorted.length/2));
    const earlyLeases = new Set();
    const lateOnly = new Set();
    allData.forEach(r => {
      const h = r.licenseId.slice(-4);
      const d = r.completedAt.slice(0,10);
      if (earlyDates3.includes(d)) earlyLeases.add(h);
    });
    allData.forEach(r => {
      const h = r.licenseId.slice(-4);
      const d = r.completedAt.slice(0,10);
      if (lateDates3.includes(d) && !earlyLeases.has(h)) lateOnly.add(h);
    });
    if (lateOnly.size > 0) {
      const names = [...lateOnly].slice(0,4).map(h => sanitizeText(getLeaseName(h))).join(', ');
      insights.push({icon:'🆕',bg:'#eff6ff',col:'#1d4ed8',txt:`<strong>${lateOnly.size} new lease${lateOnly.size>1?'s':''} detected:</strong> <strong>${names}</strong>${lateOnly.size>4?' + '+(lateOnly.size-4)+' more':''} appeared only in the recent period — not seen in earlier data.`});
    }
  }

  // 17. Leases earning significantly above/below node average
  if (nodeIds.length >= 1 && leaseData.length >= 5) {
    const nodeAvgEarn = {};
    nodeIds.forEach((nid, i) => {
      if (nodeMap[nid].leaseCount > 0) nodeAvgEarn[i+1] = nodeMap[nid].earnings / nodeMap[nid].leaseCount;
    });
    const outlierHigh = [], outlierLow = [];
    leaseData.forEach(l => {
      const avg = nodeAvgEarn[l.node];
      if (!avg || avg === 0) return;
      const ratio = l.alltime / avg;
      if (ratio > 1.5) outlierHigh.push({ name: l.name, ratio, node: l.node });
      else if (ratio < 0.5) outlierLow.push({ name: l.name, ratio, node: l.node });
    });
    if (outlierHigh.length > 0) {
      outlierHigh.sort((a,b) => b.ratio - a.ratio);
      const names = outlierHigh.slice(0,3).map(o => sanitizeText(o.name) + ' (' + (o.ratio).toFixed(1) + '×)').join(', ');
      insights.push({icon:'⭐',bg:'#fef9c3',col:'#854d0e',txt:`<strong>Star performers:</strong> ${names} — earning significantly <strong>above their node average</strong>. These leases are carrying extra weight.`});
    }
    if (outlierLow.length > 0) {
      outlierLow.sort((a,b) => a.ratio - b.ratio);
      const names = outlierLow.slice(0,3).map(o => sanitizeText(o.name) + ' (' + (o.ratio).toFixed(1) + '×)').join(', ');
      insights.push({icon:'🐌',bg:'#fff7ed',col:'#c2410c',txt:`<strong>Underperforming leases:</strong> ${names} — earning significantly <strong>below their node average</strong>. May need troubleshooting.`});
    }
  }

  // ═══ WITHDRAWAL INSIGHTS ═══

  // 18-20. Withdrawal analysis (frequency, timing, rate)
  try {
    const allWith = Object.values(withdrawFiles).flat();
    if (allWith && allWith.length >= 2) {
      const wDates = allWith.map(w => w.completedAt || w.createdAt || '').filter(d => d).map(d => d.slice(0,10)).sort();
      const uniqueWDates = [...new Set(wDates)].sort();

      // Frequency: avg days between withdrawals
      if (uniqueWDates.length >= 2) {
        const gaps = [];
        for (let i = 1; i < uniqueWDates.length; i++) {
          const d1 = new Date(uniqueWDates[i-1]);
          const d2 = new Date(uniqueWDates[i]);
          gaps.push((d2 - d1) / 86400000);
        }
        const avgGap = gaps.reduce((a,b)=>a+b,0) / gaps.length;
        const minGap = Math.min(...gaps), maxGap = Math.max(...gaps);
        insights.push({icon:'💸',bg:'#f0fdf4',col:'#166534',txt:`<strong>Withdrawal frequency:</strong> Average <strong>${avgGap.toFixed(1)} days</strong> between withdrawals (range: ${minGap}–${maxGap} days). ${avgGap < 7 ? 'Very frequent — you withdraw weekly or more.' : avgGap < 14 ? 'Roughly bi-weekly pattern.' : 'You tend to let earnings build up before withdrawing.'}`});
      }

      // Best/worst exchange rate
      const wParsed = allWith.map(w => {
        const usd = (w.amountMicros||0)/1e6;
        const ada = parseFloat(w.settlement?.assetAmount || w.request?.quote?.assetAmount || 0);
        const chain = (w.request?.chain || w.settlement?.asset || '').toUpperCase();
        return { usd, ada, chain, date: (w.completedAt||w.createdAt||'').slice(0,10) };
      }).filter(w => w.ada > 0 && w.usd > 0);

      // Group by chain for rate analysis
      const chainGroups = {};
      wParsed.forEach(w => {
        if (!chainGroups[w.chain]) chainGroups[w.chain] = [];
        chainGroups[w.chain].push(w);
      });
      Object.entries(chainGroups).forEach(([chain, ws]) => {
        if (ws.length < 2) return;
        const rates = ws.filter(w => w.usd > 0).map(w => ({ rate: w.ada / w.usd, date: w.date }));
        if (rates.length < 2) return;
        const bestRate = rates.reduce((a,b) => b.rate > a.rate ? b : a);
        const worstRate = rates.reduce((a,b) => b.rate < a.rate ? b : a);
        const pctDiff = worstRate.rate > 0 ? ((bestRate.rate - worstRate.rate) / worstRate.rate * 100).toFixed(0) : '0';
        const cryptoSymbols = { CARDANO:'₳', ADA:'₳', ETH:'Ξ', BTC:'₿', SOL:'◎' };
        const sym = cryptoSymbols[chain] || chain;
        insights.push({icon:'💱',bg:'#fdf4ff',col:'#7e22ce',txt:`<strong>${chain} rate spread:</strong> Best rate was <strong>${sym}${bestRate.rate.toFixed(4)}/$1</strong> (${bestRate.date}) vs worst <strong>${sym}${worstRate.rate.toFixed(4)}/$1</strong> (${worstRate.date}) — <strong>${pctDiff}% spread</strong>. ${parseFloat(pctDiff) > 15 ? 'Significant volatility — timing withdrawals could save money.' : 'Fairly stable rates.'}`});
      });
    }
  } catch(e) { /* withdrawal insights are optional */ }

  safeHTML('insightList', insights.map(ins =>
    `<div class="insight">
      <div class="insight-icon" style="background:${ins.bg};color:${ins.col}">${ins.icon}</div>
      <span>${ins.txt}</span>
    </div>`
  ).join(''));
}
let allData = [];
let nodeMap = {}; // nodeId → { id, name, leaseCount, totalEarnings }
let byDate = {};
let datesSorted = [];
let leaseData = [];
let distData = {};
let trendData = [];
let distDots = [];
let distIdx = 0;
let trendIdx = 0;
let tbIdx = 0;
let monthlyData = {};
let monthView = 'stacked';

// Returns the active groups for the current session.
// No naming file → ['All Leases']
// Naming file uploaded → alphabetical groups from that file
function getGroupsAll() { return ACTIVE_GROUPS.length ? ACTIVE_GROUPS : ['All Leases']; }

function fmtMo(ym) {
  const [y,m] = ym.split('-');
  const n=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return n[parseInt(m,10)-1] + ' ' + y;
}

/**
 * Re-render all charts without re-parsing files.
 * Called when toggling gross/received view.
 */
function rebuildWithCurrentData() {
  if (!allData || !allData.length) return;
  buildDashboard();
}

function buildDashboard() {
 try {
  // Use dynamic lease map from naming file if uploaded, otherwise built-in
  const lMap = resolveLeaseMap();

  // Load split settings from naming file
  loadSplitSettings(lMap);

  // Build the group color/label/icon system from whatever groups are in lMap
  buildGroupSystem(lMap);

  // Update getGroup + getLeaseName to use current map
  window._activeLeaseMap = lMap;

  // ── Auto-detect or use user-supplied start date ──
  if (USER_START_DATE) {
    DATA_START = USER_START_DATE;
  } else {
    DATA_START = autoDetectStartDate(loadedFiles);
  }
  // Update the display
  const dispEl = document.getElementById('startDateDisplay');
  if (dispEl) dispEl.textContent = DATA_START;
  const pickerEl = document.getElementById('startDatePicker');
  if (pickerEl && !USER_START_DATE) pickerEl.value = DATA_START;

  // Merge all files + deduplicate by transaction id
  // Only include records on or after DATA_START
  const seen = new Set();
  allData = [];
  const fileNames = Object.keys(loadedFiles);
  let skippedBefore = 0;
  if (DEBUG) console.log(`[UNITY] Building dashboard from ${fileNames.length} file(s):`, fileNames, `(start: ${DATA_START})`);
  Object.entries(loadedFiles).forEach(([fname, records]) => {
    let added = 0, dupes = 0, before = 0;
    records.forEach(r => {
      if (r.completedAt.slice(0,10) < DATA_START) { before++; skippedBefore++; return; }
      if (!seen.has(r.id)) { seen.add(r.id); allData.push(r); added++; }
      else dupes++;
    });
    if (DEBUG) console.log(`[UNITY]   ${fname}: ${records.length} records → ${added} added, ${dupes} dupes, ${before} before ${DATA_START}`);
  });
  if (DEBUG) console.log(`[UNITY]   Total unique transactions from ${DATA_START}+: ${allData.length} (${skippedBefore} pre-cutoff skipped)`);
  allData.sort((a,b) => a.completedAt < b.completedAt ? -1 : 1);

  // Extract unique nodes from data
  nodeMap = {};
  allData.forEach(r => {
    const nid = r.nodeId;
    if (!nid) return;
    if (!nodeMap[nid]) {
      // Try to load saved name from localStorage
      nodeMap[nid] = { id: nid, name: 'Node ' + (Object.keys(nodeMap).length + 1), licenses: new Set(), earnings: 0 };
    }
    nodeMap[nid].licenses.add(r.licenseId);
    nodeMap[nid].earnings += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
  });
  // Convert sets to counts
  Object.values(nodeMap).forEach(n => { n.leaseCount = n.licenses.size; delete n.licenses; });
  if (DEBUG) console.log(`[UNITY]   Found ${Object.keys(nodeMap).length} unique node(s):`, Object.entries(nodeMap).map(([k,v]) => `${v.name} (${v.leaseCount} licenses)`));

  // Build license→node mapping for auto-association
  window._licenseNodeMap = {};
  allData.forEach(r => {
    if (r.nodeId && r.licenseId) {
      window._licenseNodeMap[r.licenseId] = r.nodeId;
      window._licenseNodeMap[r.licenseId.slice(-4)] = r.nodeId; // also by last4
    }
  });

  // Apply saved node names and order from naming file
  applyNodeNamesFromFile();

  renderNodeNames();

  // Dynamic archive estimate
  const totalLicenses = new Set(allData.map(r => r.licenseId)).size;
  const estDays = Math.floor(1000 / totalLicenses);
  const estBox = document.getElementById('archiveEstimateBox');
  const estText = document.getElementById('archiveEstimateText');
  if (estBox && estText) {
    let urgency, advice;
    if (estDays <= 1) { urgency = 'CRITICAL'; advice = 'You MUST export daily — data is lost within hours!'; }
    else if (estDays <= 3) { urgency = 'HIGH'; advice = 'Export daily to avoid data loss.'; }
    else if (estDays <= 7) { urgency = 'MODERATE'; advice = 'Export at least every few days.'; }
    else if (estDays <= 14) { urgency = 'LOW'; advice = 'Export at least weekly to be safe.'; }
    else { urgency = 'OK'; advice = 'Weekly exports should be sufficient, but daily is always safest.'; }
    estText.innerHTML = `With your <strong>${totalLicenses} active licenses</strong>, Unity's 1,000-row export covers roughly <strong>${estDays} day${estDays !== 1 ? 's' : ''}</strong> of history. ${advice}`;
    estBox.style.display = '';
    if (estDays <= 3) estBox.style.background = 'rgba(239,68,68,.12)';
    else if (estDays <= 7) estBox.style.background = 'rgba(245,158,11,.1)';
    else estBox.style.background = 'rgba(59,130,246,.08)';
  }
  if (allData.length === 0) {
    alert('No valid transaction data found on or after ' + DATA_START + '. Check your files.');
    return;
  }

  // Group by date
  byDate = {};
  allData.forEach(r => {
    const d = r.completedAt.slice(0,10);
    if (!byDate[d]) byDate[d] = [];
    byDate[d].push(r);
  });
  datesSorted = Object.keys(byDate).sort();
  window._datesSorted = datesSorted;
  window._byDate = byDate;
  const today = datesSorted[datesSorted.length - 1];
  const yesterday = datesSorted.length > 1 ? datesSorted[datesSorted.length - 2] : today;

  // Compute dist data — ONE dot per license per day (daily total aggregated)
  distData = {};
  window._distDateLookup = {}; // MM-DD → YYYY-MM-DD for correct year in charts
  datesSorted.forEach(d => {
    const mo = d.slice(5); // "02-18"
    window._distDateLookup[mo] = d; // latest full date for this MM-DD key
    // Aggregate all transactions for each license into a single daily total
    const byLease = {};
    byDate[d].forEach(r => {
      const last4 = r.licenseId.slice(-4);
      if (!byLease[last4]) {
        byLease[last4] = {
          v: 0,
          g: getGroupDynamic(last4, d, lMap),
          n: getLeaseNameDynamic(last4, lMap),
          nd: getNode(last4, lMap),
          last4
        };
      }
      byLease[last4].v += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    });
    // Round to 6dp and convert to array
    distData[mo] = Object.values(byLease).map(e => ({...e, v: +e.v.toFixed(6)}));
  });

  const distDates = Object.keys(distData).sort();
  const todayKey = today.replace(/\d{4}-0?/,''); // not used directly; use datesSorted
  const todayMo = today.slice(5);

  // Trend data
  trendData = datesSorted.map(d => {
    const mo = d.slice(5);
    const vals = (distData[mo]||[]).map(x=>x.v);
    return {
      date: mo,
      total: +(vals.reduce((a,b)=>a+b,0)).toFixed(4),
      avg: vals.length ? +(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(6) : 0,
      max: vals.length ? +(Math.max(...vals)).toFixed(6) : 0,
      active: vals.length
    };
  });

  // Lease summary
  const leaseAlltime = {}, leaseToday = {}, leaseTxns = {};
  allData.forEach(r => {
    const last4 = r.licenseId.slice(-4);
    const id = r.licenseId.slice(-8);
    const key = last4;
    const val = adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    leaseTxns[key] = (leaseTxns[key]||0) + 1;
    if (!leaseAlltime[key]) leaseAlltime[key] = {id, last4, val:0};
    leaseAlltime[key].val += val;
    if (r.completedAt.slice(0,10) === today) {
      leaseToday[key] = (leaseToday[key]||0) + val;
    }
  });

  leaseData = Object.entries(leaseAlltime).map(([last4, info]) => {
    const mapped = lMap[last4];
    const group = getGroupDynamic(last4, today, lMap);
    const rawName = mapped ? mapped.name : null;
    const name = rawName || ('UNK-' + last4.toUpperCase());
    const num = rawName ? parseInt(rawName.replace(/[A-Za-z_\-\.]/g,''), 10) : 9999;
    return {
      id: info.id, last4, name, group,
      node: mapped ? (mapped.node || 1) : 1,
      alltime: +info.val.toFixed(6),
      today: +(leaseToday[last4]||0).toFixed(6),
      txns: leaseTxns[last4],
      num
    };
  }).sort((a,b) => b.alltime - a.alltime);

  // Total known leases — needed for KPI cards AND participation section
  const totalKnownLeases = new Set(allData.map(r => r.licenseId)).size;
  window._totalKnownLeases = totalKnownLeases;

  // KPIs
  const todayTotal = trendData[trendData.length-1]?.total || 0;
  const yesterdayTotal = trendData[trendData.length-2]?.total || 0;
  const allTotal = +allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0).toFixed(4);
  const last7Dates = datesSorted.slice(-7);
  const last7Total = +last7Dates.reduce((s,d)=>s+(byDate[d]||[]).reduce((ss,r)=>ss+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0),0).toFixed(4);
  const todayTxns = (byDate[today]||[]);
  const maxAll = +(Math.max(...allData.map(r=>adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10))))).toFixed(4);
  const maxToday = todayTxns.length ? +(Math.max(...todayTxns.map(r=>adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10))))).toFixed(4) : 0;
  const activeToday = new Set(todayTxns.map(r=>r.licenseId)).size;
  const peakActive = Math.max(...datesSorted.map(d=>new Set(byDate[d].map(r=>r.licenseId)).size));
  const tvsy = yesterdayTotal > 0 ? +((todayTotal-yesterdayTotal)/yesterdayTotal*100).toFixed(1) : 0;
  const avg7 = datesSorted.length >= 8
    ? +(datesSorted.slice(-8,-1).reduce((s,d)=>s+(byDate[d]||[]).reduce((ss,r)=>ss+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0),0)/7).toFixed(4)
    : 0;
  const tvs7 = avg7 > 0 ? +((todayTotal-avg7)/avg7*100).toFixed(1) : 0;

  const firstDate = datesSorted[0];
  const lastDate  = datesSorted[datesSorted.length-1];
  const fmtD = d => {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[parseInt(d.slice(5,7),10)-1] + ' ' + parseInt(d.slice(8,10),10);
  };

  // Group totals today & alltime — use dynamic map
  const grpToday = {}, grpAll = {};
  allData.forEach(r => {
    const last4 = r.licenseId.slice(-4);
    const g = getGroupDynamic(last4, r.completedAt.slice(0,10), lMap);
    grpAll[g] = (grpAll[g]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    if (r.completedAt.slice(0,10) === today)
      grpToday[g] = (grpToday[g]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
  });

  /* ── Render header ── */
  const rawNames = Object.keys(loadedFiles).map(n=>n.replace(/\.(txt|json)$/,''));
  const shortNames = rawNames.map(n => n.length > 30 ? n.slice(0,27) + '…' : n).join(' + ');
  safeHTML('hdrSub',
    `<span style="white-space:nowrap">${allData.length.toLocaleString()} txns · ${fmtD(firstDate+'T')} – ${fmtD(lastDate+'T')}</span>` +
    `<span style="color:var(--muted);margin:0 .3rem">·</span>` +
    `<span style="opacity:.5;white-space:nowrap" title="${rawNames.join(', ')}">${shortNames}</span>`);
  document.getElementById('hdrSub').style.cssText = 'display:flex;align-items:center;flex-wrap:wrap;gap:.1rem;font-size:.58rem;color:var(--text2);margin:.1rem 0 0;line-height:1.3';

  /* ── Legend ── */
  const legendRow = document.getElementById('legendRow');
  legendRow.innerHTML = '';
  getGroupsAll().forEach(g => {
    const col = grpCol(g);
    legendRow.innerHTML += `<div class="leg">
      <div class="leg-swatch" style="background:${col}"></div>
      ${grpLabel(g)}
    </div>`;
  });

  /* ── KPI Row 1 ── */
  // KPI icons
  const KPI_ICONS = {
    'Rewards (All Data)':       '🏦',
    'Rewards (Last 7 Days)':    '📅',
    'Earnings Today':            '⚡',
    'Active Licenses Today':     '🔌',
    'Max Reward (All Time)':    '🏆',
    'Max Reward (Today)':       '💫',
    'Today vs Yesterday':        '📈',
    'Today vs 7D Avg':           '📊',
  };
  function kc(label, val, sub, delay, cls='', colorN) {
    const icon = KPI_ICONS[label] || '💰';
    const isNum = /^[\$\+\-]?[\d,\.]+%?$/.test(val.toString().trim());
    const isBig = val.toString().length > 8;
    return `<div class="kc" style="animation-delay:${delay}s">
      <div class="kc-label"><span style="margin-right:.3rem">${icon}</span>${label}</div>
      <div class="kc-val ${cls}${isBig?' big-num':''}">${val}</div>
      <div class="kc-sub">${sub}</div>
    </div>`;
  }
  safeHTML('kpiRow',
    kc('Rewards (All Data)',      '$'+allTotal.toFixed(4),    `${fmtD(firstDate+'T')} – ${fmtD(lastDate+'T')} · ${allData.length.toLocaleString()} txns`, .04) +
    kc('Rewards (Last 7 Days)',   '$'+last7Total.toFixed(4),  last7Dates.slice(0,1).map(fmtD)+'… '+fmtD(lastDate+'T'), .08) +
    kc('Earnings Today',          '$'+todayTotal.toFixed(4),  `${fmtD(lastDate+'T')} · ${(byDate[today]||[]).length} txns`, .12) +
    kc('Active Licenses Today',   activeToday,  `Peak ${peakActive} · ${fmtD(lastDate+'T')}`, .16));

  // Tag key KPI values for filter updates
  const kpiVals = document.getElementById('kpiRow').querySelectorAll('.kc-val');
  if (kpiVals[0]) kpiVals[0].id = 'kpiAllTime';
  if (kpiVals[2]) kpiVals[2].id = 'kpiToday';
  if (kpiVals[3]) kpiVals[3].id = 'kpiActive';

  safeHTML('kpiRow2',
    kc('Max Reward (All Time)',  '$'+maxAll.toFixed(4),       'Highest single transaction', .2) +
    kc('Max Reward (Today)',     '$'+maxToday.toFixed(4),     'Highest single txn today', .24) +
    kc('Today vs Yesterday',     (tvsy>=0?'+':'')+tvsy+'%',   `$${todayTotal.toFixed(4)} vs $${yesterdayTotal.toFixed(4)}`, .28, tvsy>=0?'pos':'neg') +
    kc('Today vs 7D Avg',        (tvs7>=0?'+':'')+tvs7+'%',   `7-day avg $${avg7.toFixed(4)}`, .32, tvs7>=0?'pos':'neg'));

  /* ── Group cards — built from whatever groups exist in uploaded data ── */
  const grpRow = document.getElementById('grpRow');
  const totalAllTime = Object.values(grpAll).reduce((s,v)=>s+v,0)||1;
  grpRow.innerHTML = '';

  // Show all groups that have any earnings, plus always show every group in lMap
  const allGroupsInData = new Set(allData.map(r => getGroupDynamic(r.licenseId.slice(-4), r.completedAt.slice(0,10), lMap)));
  const groupsToShow = ACTIVE_GROUPS.filter(g => g !== 'Unassigned' || allGroupsInData.has('Unassigned'));

  groupsToShow.forEach((g, i) => {
    const col = grpCol(g), bg = grpBg(g);
    const td  = (grpToday[g]||0).toFixed(4);
    const at  = (grpAll[g]||0);
    const pct = (at/totalAllTime*100).toFixed(1);
    grpRow.innerHTML += `<div class="gc" style="--gc-col:${col};--gc-bg:${bg};animation-delay:${.35+i*.06}s">
      <div class="gc-lbl"><span style="margin-right:.3rem">${grpIcon(g)}</span>${grpLabel(g)}</div>
      <div class="gc-val">$${td}</div>
      <div class="gc-sub">$${at.toFixed(2)} all-time · ${pct}%</div>
      <div style="margin-top:.55rem;height:3px;background:var(--surface2);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${Math.min(100,parseFloat(pct))}%;background:${col};border-radius:2px;transition:width .8s ease;opacity:.8"></div>
      </div>
    </div>`;
  });


  /* ── Monthly rollup ── */
  monthlyData = {};
  allData.forEach(r => {
    const ym = r.completedAt.slice(0,7);
    const l4 = r.licenseId.slice(-4);
    const g = getGroupDynamic(l4, r.completedAt.slice(0,10), lMap);
    const v = adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    if (!monthlyData[ym]) monthlyData[ym] = {total:0, txns:0, byGroup:{}};
    monthlyData[ym].total += v;
    monthlyData[ym].txns++;
    monthlyData[ym].byGroup[g] = (monthlyData[ym].byGroup[g]||0) + v;
  });

  /* ── Participation ── */
  const partRow = document.getElementById('partRow');
  partRow.innerHTML = '';
  // Total KNOWN leases = all unique licenseIds ever seen across all loaded data
  // (already computed above as totalKnownLeases)
  window._totalKnownLeases = totalKnownLeases; // expose for analysis

  // ── Uptime baseline: median of top-10% txns-per-day across all leases/days
  // Use this as "100% uptime" benchmark to estimate uptime % per lease per day
  const txnsPerLeaseDayArr = [];
  datesSorted.forEach(d => {
    const dayMap = {};
    (byDate[d]||[]).forEach(r => {
      const l4 = r.licenseId.slice(-4);
      dayMap[l4] = (dayMap[l4]||0) + 1;
    });
    Object.values(dayMap).forEach(n => txnsPerLeaseDayArr.push(n));
  });
  txnsPerLeaseDayArr.sort((a,b)=>a-b);
  const top10pct = txnsPerLeaseDayArr.slice(Math.floor(txnsPerLeaseDayArr.length*0.90));
  const uptimeBaseline = top10pct.length
    ? Math.round(top10pct.reduce((a,b)=>a+b,0)/top10pct.length)
    : 1;
  window._uptimeBaseline = uptimeBaseline;

  datesSorted.forEach(d => {
    const active = new Set(byDate[d].map(r => r.licenseId)).size;
    const pct = active / totalKnownLeases;
    // Red < 70%, Yellow 70-85%, Green ≥ 85%
    const cls = pct >= .85 ? 'lvl5' : pct >= .70 ? 'lvl3' : 'lvl1';
    const pctStr = Math.round(pct * 100) + '%';
    const dayNum = parseInt(d.slice(8,10));
    const monName = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(d.slice(5,7),10)-1];
    partRow.innerHTML += `<div class="pt ${cls}" title="${active} of ${totalKnownLeases} leases (${pctStr})">
      <span class="pt-num">${active}</span>
      <span class="pt-total">of ${totalKnownLeases}</span>
      <span class="pt-date">${pctStr}</span>
      <span class="pt-date">${monName} ${dayNum}</span>
    </div>`;
  });

  /* ── AI Analysis ── */
  buildAnalysis(grpToday, grpAll);

  /* ── All new insight modules ── */
  const _allWithRaw = Object.values(withdrawFiles).flat();
  const _withSeen = new Set();
  const parsedWithdrawals = [];
  _allWithRaw.forEach(w => {
    const key = w.id || JSON.stringify(w);
    const date = (w.completedAt || w.createdAt || '').slice(0,10);
    if (!_withSeen.has(key) && date >= DATA_START) {
      _withSeen.add(key);
      const usd = (w.amountMicros||0)/1e6;
      const fee = (w.request?.quote?.exchangeFeeMicros||0)/1e6;
      const ada = parseFloat(w.settlement?.assetAmount||w.request?.quote?.assetAmount||0);
      const status = w.settlement?.status||w.status||'success';
      const failed = !!w.failedAt;
      parsedWithdrawals.push({ id:w.id, usd, fee, ada, status, date, failed });
    }
  });
  buildAllInsights(allData, byDate, datesSorted, leaseData, parsedWithdrawals, lMap);

  /* ── Switch to dashboard ── */
  document.getElementById('uploadScreen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('topBar').style.display = 'block';

  /* ── Render charts ── */
  tbIdx = Object.keys(distData).sort().length - 1;
  monthView = 'stacked';
  renderMonthChart();
  renderWithdrawals(allTotal);
  buildArchiveBanner();
  renderDailyBar();
  renderHeatmap();
  renderRadar(); initRadarHover();
  renderWoW();
  loadNotes();
  renderDist();
  renderTrend();
  renderTB();
  renderLeaseTable();
  buildHealthCheck();
  loadGoal(); updateGoalTracker();
  buildCompactView();
  var compBtn = document.getElementById('compactBtn');
  if (compBtn) compBtn.style.display = '';
  var gBtn = document.getElementById('grossBtn');
  if (gBtn) gBtn.style.display = '';
  var sBtn = document.getElementById('shareBtn');
  if (sBtn) sBtn.style.display = '';
  let _resizeTimer;
  window.addEventListener('resize', () => { clearTimeout(_resizeTimer); _resizeTimer = setTimeout(() => { syncTopBarPadding(); renderDailyBar(); renderHeatmap(); renderRadar(); initRadarHover(); renderDist(); try{renderDist('easyDistCanvas')}catch(e){} renderTrend(); renderMonthChart(); if(typeof buildDOWChart==='function') buildDOWChart(allData,datesSorted); }, 150); });
 } catch(err) {
  console.error('[buildDashboard] Error:', err);
  showToast('⚠️', 'Dashboard Error', 'Something went wrong — check console for details', '#ef4444');
 }
}

/* ═══════════════════════════════════════════════════════
   DISTRIBUTION CHART
═══════════════════════════════════════════════════════ */
const distViews = [
  {key:'dots', color:null},
  {key:'max',  color:'#d97706'},
  {key:'avg',  color:'#2563eb'},
  {key:'act',  color:'#16a34a'},
];

function setDistWindow(n, btn) {
  distWindow = n;
  document.querySelectorAll('#distWindowBtns .cbtn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  renderDist();
}

function setDist(i, b) {
  distIdx = i;
  b.closest('.ctrl-btns').querySelectorAll('.cbtn').forEach(x=>x.classList.remove('on'));
  b.classList.add('on');
  renderDist();
}

/* ── DIST WINDOW SIZE (days to show) ── */
let distWindow = 7; // show last N days — change via buttons

function renderDist(targetId) {
  const cv = document.getElementById(targetId || 'distCanvas');
  if (!cv) return;
  const W = cv.parentElement.clientWidth || 900;
  const H = parseInt(cv.getAttribute('height'), 10) || 360;
  cv.width = W * (window.devicePixelRatio||1);
  cv.height = H * (window.devicePixelRatio||1);
  cv.style.width = W + 'px';
  cv.style.height = H + 'px';
  const c = cv.getContext('2d');
  c.scale(window.devicePixelRatio||1, window.devicePixelRatio||1);
  c.clearRect(0, 0, W, H);

  // Limit to last distWindow days
  const allDates = Object.keys(distData).sort();
  const dates = allDates.slice(-distWindow);
  if (!dates.length) return;

  const pad = {l:70, r:20, t:22, b: dates.length > 14 ? 58 : 48};
  const iW = W - pad.l - pad.r;
  const iH = H - pad.t - pad.b;
  const cw = iW / dates.length;   // wide columns — more breathing room
  distDots = [];

  // Theme-aware colors
  const isDark = !document.body.classList.contains('light');
  const gridCol  = isDark ? 'rgba(255,255,255,.07)' : 'rgba(0,0,0,.07)';
  const labelCol = isDark ? '#6b7585' : '#9ca3af';
  const avgLineCol = isDark ? 'rgba(107,143,199,.5)' : 'rgba(37,99,235,.45)';
  const avgTextCol = isDark ? '#6b8fc7' : '#2563eb';
  const dateCol  = isDark ? '#5c6378' : '#6b7280';
  const fontFace = "Inter,sans-serif";

  if (distIdx === 0) {
    // ── DISTRIBUTION VIEW ──
    const allV = dates.flatMap(d => distData[d].map(x=>x.v));
    if (!allV.length) return;
    const mx = Math.max(...allV) * 1.08;

    // Grid lines
    for (let i = 0; i <= 5; i++) {
      const y = pad.t + (iH/5)*i;
      const v = mx - (mx/5)*i;
      c.strokeStyle = gridCol; c.lineWidth = 1;
      c.beginPath(); c.moveTo(pad.l, y); c.lineTo(W-pad.r, y); c.stroke();
      c.fillStyle = labelCol; c.font = `500 10px ${fontFace}`;
      c.textAlign = 'right';
      c.fillText('$'+v.toFixed(3), pad.l-6, y+4);
    }

    // Avg line
    const avg = allV.reduce((a,b)=>a+b,0)/allV.length;
    const avgY = pad.t + iH - (avg/mx)*iH;
    c.strokeStyle = avgLineCol; c.lineWidth = 1.5; c.setLineDash([5,4]);
    c.beginPath(); c.moveTo(pad.l, avgY); c.lineTo(W-pad.r, avgY); c.stroke();
    c.setLineDash([]);
    c.fillStyle = avgTextCol; c.font = `600 10px ${fontFace}`; c.textAlign='left';
    c.fillText('avg $'+avg.toFixed(4), pad.l+6, avgY-5);

    // Column background bands (alternating subtle)
    dates.forEach((date, di) => {
      if (di % 2 === 0) {
        c.fillStyle = isDark ? 'rgba(255,255,255,.015)' : 'rgba(0,0,0,.018)';
        c.fillRect(pad.l + di*cw, pad.t, cw, iH);
      }
    });

    // Dots — with smart jitter that avoids overlap
    dates.forEach((date, di) => {
      const colCX = pad.l + di*cw + cw/2;
      const dotR  = 4.5;    // slightly larger dots
      const maxJitter = cw * 0.38;  // generous spread within column

      // Sort by value so we can detect vertical clusters
      const sorted = [...distData[date]].sort((a,b) => a.v - b.v);

      // Use a deterministic seeded RNG per column for consistent jitter
      let seed = di * 31337;
      const rng = () => { seed = (seed*1664525+1013904223)>>>0; return seed/0xffffffff; };

      sorted.forEach((d, si) => {
        const y = pad.t + iH - (d.v/mx)*iH;
        const col = grpCol(d.g);

        // Spread jitter: use full column width, distributed evenly per group
        const jitter = (rng() - 0.5) * 2 * maxJitter;
        const px = Math.max(pad.l+dotR, Math.min(W-pad.r-dotR, colCX + jitter));

        drawNodeDot(c, d.nd || 1, px, y, col, 0.7);
        const hitR = d.nd === 1 ? dotR : 6;
        distDots.push({x:px, y, r:hitR, d});
      });
    });

    // Date labels — smart skip when too many days
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // Calculate how many labels we can fit without overlap
    const labelWidth = 42; // approx width of "Feb 18" at 10px
    const maxLabels = Math.floor(iW / labelWidth);
    const step = Math.max(1, Math.ceil(dates.length / maxLabels));

    dates.forEach((date, di) => {
      // Always show first and last; otherwise show every Nth
      const isFirst = di === 0;
      const isLast  = di === dates.length - 1;
      const isStep  = di % step === 0;
      if (!isFirst && !isLast && !isStep) return;

      const cx = pad.l + di*cw + cw/2;
      const parts = date.split('-');
      const mo = parseInt(parts[0],10), dy = parseInt(parts[1],10);
      const dateObj = new Date(parseInt((window._distDateLookup && window._distDateLookup[date] || datesSorted[0] || '2026').slice(0,4), 10), mo-1, dy);
      const dow = DOW[dateObj.getDay()];

      if (dates.length <= 14) {
        // Enough room — show full label + day-of-week
        c.fillStyle = dateCol;
        c.font = `700 10px ${fontFace}`;
        c.textAlign = 'center';
        c.fillText(months[mo-1]+' '+dy, cx, H-22);
        c.font = `500 8px ${fontFace}`;
        c.fillStyle = isDark ? '#4a5568' : '#b0b8c8';
        c.fillText(dow, cx, H-11);
      } else {
        // Rotated labels for many days
        c.save();
        c.translate(cx, H-10);
        c.rotate(-Math.PI/4);
        c.fillStyle = dateCol;
        c.font = `600 9px ${fontFace}`;
        c.textAlign = 'right';
        c.fillText(months[mo-1]+' '+dy, 0, 0);
        c.restore();
      }
    });

    const mxV = Math.max(...allV);
    const totalDots = allV.length;
    safeHTML('distStats', `
      <div><div class="cstat-lbl">SHOWING</div><div class="cstat-val">${dates.length} days</div></div>
      <div><div class="cstat-lbl">DOTS</div><div class="cstat-val">${totalDots}</div></div>
      <div><div class="cstat-lbl">GLOBAL AVG</div><div class="cstat-val">$${avg.toFixed(4)}</div></div>
      <div><div class="cstat-lbl">GLOBAL MAX</div><div class="cstat-val">$${mxV.toFixed(4)}</div></div>`);

  } else {
    // ── LINE VIEWS (Max / Avg Total / Avg Active) ──
    const view = distViews[distIdx];
    const vals = dates.map(d => {
      const day = distData[d];
      if (view.key==='max') return day.length ? Math.max(...day.map(x=>x.v)) : 0;
      if (view.key==='avg') return day.length ? day.reduce((a,b)=>a+b.v,0)/day.length : 0;
      return day.length;
    });
    const mx = Math.max(...vals)*1.1 || 1;
    const isUSD = view.key !== 'act';

    for (let i=0; i<=5; i++) {
      const y = pad.t+(iH/5)*i; const v = mx-(mx/5)*i;
      c.strokeStyle=gridCol; c.lineWidth=1;
      c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
      c.fillStyle=labelCol; c.font=`500 10px ${fontFace}`; c.textAlign='right';
      c.fillText((isUSD?'$':'')+v.toFixed(isUSD?3:0), pad.l-6, y+4);
    }
    const pts = vals.map((v,i) => [pad.l+i*cw+cw/2, pad.t+iH-(v/mx)*iH]);
    c.beginPath(); c.moveTo(pts[0][0], pad.t+iH);
    pts.forEach(p=>c.lineTo(p[0],p[1]));
    c.lineTo(pts[pts.length-1][0], pad.t+iH); c.closePath();
    const g2 = c.createLinearGradient(0,pad.t,0,pad.t+iH);
    g2.addColorStop(0, view.color+'50'); g2.addColorStop(1, view.color+'05');
    c.fillStyle=g2; c.fill();
    c.beginPath(); pts.forEach((p,i)=>i===0?c.moveTo(p[0],p[1]):c.lineTo(p[0],p[1]));
    c.strokeStyle=view.color; c.lineWidth=2.5; c.lineJoin='round'; c.stroke();
    pts.forEach((p,i) => {
      c.beginPath(); c.arc(p[0],p[1],dates.length>30?3:5,0,Math.PI*2);
      c.fillStyle=view.color; c.fill();
      c.strokeStyle= isDark ? '#242836' : '#fff';
      c.lineWidth=dates.length>30?1.5:2.5; c.stroke();
    });
    // Date labels — smart skip
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const lnLabelW = 42;
    const lnMaxLabels = Math.floor(iW / lnLabelW);
    const lnStep = Math.max(1, Math.ceil(dates.length / lnMaxLabels));
    dates.forEach((d2, i) => {
      const isFirst = i === 0, isLast = i === dates.length - 1, isStep = i % lnStep === 0;
      if (!isFirst && !isLast && !isStep) return;
      const parts = d2.split('-');
      const lbl = months[parseInt(parts[0],10)-1]+' '+parseInt(parts[1],10);
      if (dates.length <= 14) {
        c.fillStyle=dateCol; c.font=`700 10px ${fontFace}`; c.textAlign='center';
        c.fillText(lbl, pts[i][0], H-12);
      } else {
        c.save();
        c.translate(pts[i][0], H-10);
        c.rotate(-Math.PI/4);
        c.fillStyle=dateCol; c.font=`600 9px ${fontFace}`; c.textAlign='right';
        c.fillText(lbl, 0, 0);
        c.restore();
      }
    });
    const avg2 = vals.reduce((a,b)=>a+b,0)/vals.length;
    safeHTML('distStats', `
      <div><div class="cstat-lbl">SHOWING</div><div class="cstat-val">${dates.length} days</div></div>
      <div><div class="cstat-lbl">PEAK</div><div class="cstat-val" style="color:${view.color}">${isUSD?'$':''}${Math.max(...vals).toFixed(isUSD?4:0)}</div></div>
      <div><div class="cstat-lbl">AVG</div><div class="cstat-val" style="color:${view.color}">${isUSD?'$':''}${avg2.toFixed(isUSD?4:1)}</div></div>
      <div><div class="cstat-lbl">MIN</div><div class="cstat-val" style="color:${view.color}">${isUSD?'$':''}${Math.min(...vals).toFixed(isUSD?4:0)}</div></div>`);
  }
}

// Dist hover — native browser title tooltip
document.getElementById('distCanvas').addEventListener('mousemove', function(e) {
  if (distIdx !== 0) { this.title = ''; return; }
  const rect = this.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;
  let found = null;
  for (let i=distDots.length-1; i>=0; i--) {
    const d = distDots[i];
    if (Math.hypot(cx-d.x, cy-d.y) <= d.r+8) { found=d.d; break; }
  }
  if (found) {
    const dispName = found.n && found.n !== found.last4 ? found.n : (found.last4 ? found.last4.toUpperCase() : '—');
    const nodeStr = ' · Node ' + (found.nd || 1);
    const grp = grpLabel(found.g) || 'Unassigned';
    this.title = dispName + '  ·  $' + found.v.toFixed(4) + '\n' + grp + nodeStr;
  } else {
    this.title = '';
  }
});
document.getElementById('distCanvas').addEventListener('mouseleave', function() { this.title = ''; });

// Easy mode dist canvas hover
(function() {
  var edc = document.getElementById('easyDistCanvas');
  if (!edc) return;
  edc.style.cursor = 'crosshair';
  edc.addEventListener('mousemove', function(e) {
    if (distIdx !== 0) { this.title = ''; return; }
    var rect = this.getBoundingClientRect();
    var cx = e.clientX - rect.left, cy = e.clientY - rect.top;
    var found = null;
    for (var i = distDots.length-1; i >= 0; i--) {
      var d = distDots[i];
      if (Math.hypot(cx-d.x, cy-d.y) <= d.r+8) { found = d.d; break; }
    }
    if (found) {
      var dispName = found.n && found.n !== found.last4 ? found.n : (found.last4 ? found.last4.toUpperCase() : '—');
      this.title = dispName + '  ·  $' + found.v.toFixed(4) + '\n' + (grpLabel(found.g)||'Unassigned') + ' · Node ' + (found.nd||1);
    } else { this.title = ''; }
  });
  edc.addEventListener('mouseleave', function() { this.title = ''; });
})();

function moveTip(e) {
  const tip = document.getElementById('htip');
  const tw = tip.offsetWidth || 180;
  const th = tip.offsetHeight || 60;
  let lx = e.clientX + 16;
  let ly = e.clientY - Math.floor(th/2);
  if (lx + tw > window.innerWidth - 12) lx = e.clientX - tw - 16;
  if (ly + th > window.innerHeight - 12) ly = window.innerHeight - th - 12;
  if (ly < 8) ly = 8;
  tip.style.left = lx + 'px';
  tip.style.top  = ly + 'px';
}

/* ═══════════════════════════════════════════════════════
   TREND CHART
═══════════════════════════════════════════════════════ */
const trendViews = [
  {key:'total',  label:'Daily Total Revenue',    color:'#2563eb', fmt:v=>'$'+v.toFixed(4)},
  {key:'max',    label:'Max Single Transaction', color:'#d97706', fmt:v=>'$'+v.toFixed(4)},
  {key:'avg',    label:'Avg Per Transaction',    color:'#16a34a', fmt:v=>'$'+v.toFixed(6)},
  {key:'active', label:'Active Licenses',        color:'#7c3aed', fmt:v=>String(v)},
];

let trendPeriod = 'day'; // 'day', 'week', 'month'

function setTrendPeriod(period, btn, targetId) {
  trendPeriod = period;
  if (btn) {
    btn.closest('.ctrl-btns').querySelectorAll('.cbtn').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
  }
  renderTrend(targetId);
}

function aggregateTrendByPeriod(period) {
  if (!trendData || !trendData.length) return { data: [], labels: [] };
  if (period === 'day') return { data: trendData, labels: datesSorted };

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const buckets = {};

  trendData.forEach((d, i) => {
    let key;
    const ds = datesSorted[i];
    if (period === 'week') {
      const dt = new Date(ds + 'T12:00:00');
      const dow = dt.getDay();
      const monday = new Date(dt);
      monday.setDate(dt.getDate() - ((dow + 6) % 7));
      key = monday.toISOString().slice(0,10);
    } else {
      key = ds.slice(0,7);
    }
    if (!buckets[key]) buckets[key] = { total:0, max:0, avg:0, active:0, count:0 };
    buckets[key].total += d.total;
    buckets[key].max = Math.max(buckets[key].max, d.max);
    buckets[key].avg += d.avg;
    buckets[key].active += d.active;
    buckets[key].count++;
  });

  const keys = Object.keys(buckets).sort();
  const data = keys.map(k => ({
    total: buckets[k].total,
    max: buckets[k].max,
    avg: buckets[k].count > 0 ? buckets[k].avg / buckets[k].count : 0,
    active: Math.round(buckets[k].active / buckets[k].count)
  }));
  const labels = keys.map(k => {
    const p = k.split('-');
    if (period === 'week') return MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10);
    return MON[parseInt(p[1],10)-1] + ' ' + p[0].slice(2);
  });
  return { data, labels };
}

function setTrend(i, b, targetId) {
  trendIdx = i;
  b.closest('.ctrl-btns').querySelectorAll('.cbtn').forEach(x=>x.classList.remove('on'));
  b.classList.add('on'); renderTrend(targetId);
}

function renderTrend(targetId) {
  const cv = document.getElementById(targetId || 'trendCanvas');
  if (!cv) return;
  const W = cv.parentElement.clientWidth-48 || 380;
  const H = parseInt(cv.getAttribute('height'), 10) || 210;
  cv.width=W; cv.height=H;
  const c = cv.getContext('2d'); c.clearRect(0,0,W,H);
  if (!trendData.length) return;
  const view = trendViews[trendIdx];
  const periodLabels = {day:'Daily',week:'Weekly',month:'Monthly'};
  document.getElementById('trendSub').textContent = (periodLabels[trendPeriod]||'Daily') + ' ' + view.label.replace(/^Daily\s*/,'');

  // Aggregate by period
  const agg = aggregateTrendByPeriod(trendPeriod);
  const aggData = agg.data;
  const aggLabels = agg.labels;
  if (!aggData.length) return;

  const vals = aggData.map(d=>d[view.key]);
  const mx = Math.max(...vals)*1.12 || 1;
  const pad = {l:54,r:10,t:12,b:34};
  const iW=W-pad.l-pad.r, iH=H-pad.t-pad.b;
  const xs = iW/(aggData.length-1||1);

  // Theme-aware colors
  const isDark = !document.body.classList.contains('light');
  const gridCol  = isDark ? 'rgba(255,255,255,.06)' : 'rgba(0,0,0,.07)';
  const labelCol = isDark ? '#6b7585' : '#9ca3af';
  const dotStroke = isDark ? '#2c3142' : '#fff';
  const dateLblCol = isDark ? '#5c6378' : '#6b7280';

  for (let i=0; i<=4; i++) {
    const y=pad.t+(iH/4)*i; const v=mx-(mx/4)*i;
    c.strokeStyle=gridCol; c.lineWidth=1;
    c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
    c.fillStyle=labelCol; c.font='500 9px Inter,sans-serif'; c.textAlign='right';
    c.fillText(view.fmt(v).slice(0,7), pad.l-4, y+3);
  }
  const pts = aggData.map((d,i)=>[pad.l+i*xs, pad.t+iH-(d[view.key]/mx)*iH]);

  // Red highlight columns for zero-value periods
  aggData.forEach((d,i) => {
    if (d[view.key] === 0) {
      const px = pad.l+i*xs;
      c.fillStyle = 'rgba(239,68,68,.13)';
      c.fillRect(px-3, pad.t, 6, iH);
      c.fillStyle = 'rgba(239,68,68,.45)';
      c.fillRect(px-3, pad.t+iH-2, 6, 2);
    }
  });

  // Area fill
  c.beginPath(); c.moveTo(pts[0][0], pad.t+iH);
  pts.forEach(p=>c.lineTo(p[0],p[1]));
  c.lineTo(pts[pts.length-1][0], pad.t+iH); c.closePath();
  const g=c.createLinearGradient(0,pad.t,0,pad.t+iH);
  g.addColorStop(0,view.color+'32'); g.addColorStop(1,view.color+'05');
  c.fillStyle=g; c.fill();

  // Line
  c.beginPath(); pts.forEach((p,i)=>i===0?c.moveTo(p[0],p[1]):c.lineTo(p[0],p[1]));
  c.strokeStyle=view.color; c.lineWidth=2.5; c.lineJoin='round'; c.stroke();

  // Low-start warning
  if ((view.key==='total'||view.key==='avg') && aggData.length>0) {
    const firstV = aggData[0][view.key];
    const avgV = vals.reduce((a,b)=>a+b,0)/vals.length;
    if (firstV < avgV * 0.2) {
      c.strokeStyle='#cc0000'; c.lineWidth=1.5; c.setLineDash([4,3]);
      c.beginPath(); c.moveTo(pts[0][0],pts[0][1]); c.lineTo(pts[0][0],pad.t+iH); c.stroke(); c.setLineDash([]);
      c.fillStyle='#cc0000'; c.font='bold 9px sans-serif'; c.textAlign='left';
      c.fillText('⚠', pts[0][0]+3, pts[0][1]-3);
    }
  }

  // Dots
  pts.forEach((p,i) => {
    const isZero = aggData[i][view.key] === 0;
    c.beginPath(); c.arc(p[0],p[1], aggData.length > 30 ? 2.5 : 3.5, 0,Math.PI*2);
    if (isZero) {
      c.fillStyle='#ef4444'; c.fill();
      c.strokeStyle='#ef4444'; c.lineWidth=1.5; c.stroke();
    } else {
      c.fillStyle=view.color; c.fill();
      c.strokeStyle=dotStroke; c.lineWidth=1.5; c.stroke();
    }
  });

  // Date labels
  const tLabelW = 38;
  const tMaxLabels = Math.floor(iW / tLabelW);
  const tStep = Math.max(1, Math.ceil(aggData.length / tMaxLabels));
  pts.forEach((p,i) => {
    const isFirst = i === 0, isLast = i === aggData.length - 1;
    if (!isFirst && !isLast && i % tStep !== 0) return;
    c.fillStyle=dateLblCol; c.font='600 9px Inter,sans-serif'; c.textAlign='center';
    c.fillText(aggLabels[i] || '', p[0], H-6);
  });
}

/* ═══════════════════════════════════════════════════════
   TOP/BOTTOM
═══════════════════════════════════════════════════════ */
function changeDay(d) {
  const dates = Object.keys(distData).sort();
  tbIdx = Math.max(0, Math.min(dates.length-1, tbIdx+d));
  renderTB();
}

function renderTB() {
  const dates = Object.keys(distData).sort();
  if (!dates.length) return;
  const day = dates[tbIdx];
  // Format the date properly from the key (format: MM-DD)
  const [tbMo, tbDy] = day.split('-').map(Number);
  const tbMonths = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const tbYear = new Date().getFullYear();
  document.getElementById('tbDateLbl').textContent = tbMonths[tbMo-1]+' '+tbDy+', '+tbYear;
  document.getElementById('tbPos').textContent = (tbIdx+1)+'/'+dates.length;
  const arr = [...distData[day]].sort((a,b)=>b.v-a.v);
  const top10 = arr.slice(0,10), bot10 = arr.slice(-10).reverse();

  ['top10','bot10'].forEach((id, isBot) => {
    const items = isBot?bot10:top10;
    const refMax = items[0]?.v || 1;
    const el = document.getElementById(id);
    el.innerHTML = '';
    items.forEach((item, i) => {
      const pct   = (item.v/refMax)*100;
      const col   = grpCol(item.g);
      const vs    = item.v < 0.0001 ? item.v.toExponential(2) : '$'+item.v.toFixed(4);
      const nm    = item.n||'Unknown';
      const grpLbl = grpLabel(item.g);
      const isN2  = item.nd >= 2;
      const nodeTag = isN2
        ? `<span style="font-size:.5rem;font-weight:700;background:rgba(0,0,0,.18);color:#fff;border-radius:3px;padding:.05rem .28rem;margin-left:3px;vertical-align:middle">N${item.nd}</span>`
        : '';

      // Per-node bar pattern
      const barBg = nodeBarBg(item.nd || 1, col, isBot ? 'c8' : 'ee');

      const hasNote = notesData && notesData['lease:' + (item.last4||'')];
      const noteBtn = hasNote ? `<span class="note-icon" onclick="event.stopPropagation();showLeaseNotePopup('${item.last4||''}',event)" style="font-size:.55rem;cursor:pointer;margin-left:3px" title="View note">📝</span>` : '';

      const div = document.createElement('div');
      div.className = 'bar-row';
      // Show lease name inside bar if it fits, otherwise show on hover only
      div.innerHTML = `
        <div class="bar-idx">${i+1}</div>
        <div class="bar-track">
          <div style="height:100%;width:${pct}%;background:${barBg};border-radius:4px;opacity:${isBot?.82:1};min-width:4px"></div>
        </div>
        <div class="bar-val" style="color:${col}">${vs}${nodeTag}${noteBtn}</div>`;
      div.addEventListener('mouseenter', e => {
        const tip = document.getElementById('htip');
        const barName = nm && nm !== 'Unknown' ? nm : (item.last4 ? item.last4.toUpperCase() : '—');
        document.getElementById('htip-name').textContent = barName;
        document.getElementById('htip-grp').textContent = (grpLbl || 'Unassigned') + ' · Node ' + (item.nd || 1);
        document.getElementById('htip-val').textContent = 'Daily total: ' + vs;
        tip.style.borderLeftColor = col;
        // Position immediately with stored coords before display:block measurement
        const cx = e.clientX, cy = e.clientY;
        tip.style.left = (cx + 16) + 'px';
        tip.style.top  = (cy - 30) + 'px';
        tip.style.display = 'block';
        // Recalculate position after layout
        requestAnimationFrame(() => {
          const tw = tip.offsetWidth  || 200;
          const th = tip.offsetHeight || 60;
          let lx = cx + 16;
          let ly = cy - Math.floor(th / 2);
          if (lx + tw > window.innerWidth  - 12) lx = cx - tw - 16;
          if (ly + th > window.innerHeight - 12) ly = window.innerHeight - th - 12;
          if (ly < 8) ly = 8;
          tip.style.left = lx + 'px';
          tip.style.top  = ly + 'px';
        });
      });
      div.addEventListener('mousemove', e => {
        const tip = document.getElementById('htip');
        if (tip.style.display === 'block') moveTip(e);
      });
      div.addEventListener('mouseleave', () => {
        document.getElementById('htip').style.display = 'none';
      });
      el.appendChild(div);
    });
  });
}

/* ═══════════════════════════════════════════════════════
   LEASE TABLE
═══════════════════════════════════════════════════════ */
let sortState = {
  view: 'group',      // 'group' = separated by group, 'all' = intermixed
  earnDir: 'desc',    // 'asc' | 'desc'
  todayDir: null,     // null = not sorting by today, 'asc' | 'desc'
  primarySort: 'earn' // 'earn' | 'today'
};

// ── Favorites / pinned leases ──
let favLeases = new Set();
function loadFavorites() { try { const v = localStorage.getItem('dnd_favLeases'); if (v) favLeases = new Set(JSON.parse(v)); } catch(e) { favLeases = new Set(); } }
function saveFavorites() { try { localStorage.setItem('dnd_favLeases', JSON.stringify([...favLeases])); } catch(e) {} }
function toggleFav(last4, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }
  if (favLeases.has(last4)) favLeases.delete(last4); else favLeases.add(last4);
  saveFavorites(); renderLeaseTable();
}
loadFavorites();

/* ═══════════════════════════════════════════════════════
   ONBOARDING TOUR
═══════════════════════════════════════════════════════ */
const TOUR_STEPS = [
  { icon:'👋', title:'Welcome to dataNerd Dashboard!', body:'This quick tour will show you the key features. You can always replay it from the Tools page.', target:null },
  { icon:'📊', title:'Dashboard Overview', body:'Your KPIs, charts, and health score are all here. In Easy mode you see the essentials; switch to Advanced for the full picture.', target:'page-overview' },
  { icon:'📋', title:'Lease Table', body:'Every lease with earnings, sparkline trends, and group colors. ⭐ Star your favorites to pin them to the top. Click any row to drill into full details.', target:'page-leases' },
  { icon:'📅', title:'Date Range & CSV', body:'Filter all earnings to a specific date range with the date picker. Export the full table as CSV for your own analysis.', target:'page-leases' },
  { icon:'🔍', title:'Insights & Charts', body:'Streaks, consistency, outliers, dark leases, and more. The Earnings and Distribution pages give you daily trends and per-lease scatter plots.', target:'page-analytics' },
  { icon:'💾', title:'Your Naming File', body:'Everything saves to your naming file — lease names, groups, notes, splits, goals, and favorites. Export it regularly and upload next time to keep all your data.', target:'page-names' }
];
let _tourIdx = 0;
function startTour() {
  _tourIdx = 0;
  document.getElementById('onboardOverlay').style.display = 'block';
  renderTourStep();
}
function endTour() {
  document.getElementById('onboardOverlay').style.display = 'none';
  try { localStorage.setItem('dnd_tourDone', '1'); } catch(e) {}
}
function tourStep(d) {
  _tourIdx += d;
  if (_tourIdx >= TOUR_STEPS.length) { endTour(); return; }
  if (_tourIdx < 0) _tourIdx = 0;
  renderTourStep();
}
function renderTourStep() {
  const s = TOUR_STEPS[_tourIdx];
  document.getElementById('onboardStep').textContent = 'Step ' + (_tourIdx+1) + ' of ' + TOUR_STEPS.length;
  document.getElementById('onboardIcon').textContent = s.icon;
  document.getElementById('onboardTitle').textContent = s.title;
  document.getElementById('onboardBody').textContent = s.body;
  document.getElementById('onboardPrev').style.display = _tourIdx === 0 ? 'none' : '';
  document.getElementById('onboardNext').textContent = _tourIdx === TOUR_STEPS.length-1 ? 'Done ✓' : 'Next →';
  // Dots
  const dots = document.getElementById('onboardDots');
  dots.innerHTML = TOUR_STEPS.map((_,i) => `<div style="width:7px;height:7px;border-radius:50%;background:${i===_tourIdx?'var(--primary)':'var(--border2)'};transition:background .2s"></div>`).join('');
  // Center the card
  const card = document.getElementById('onboardCard');
  card.style.top = '50%'; card.style.left = '50%'; card.style.transform = 'translate(-50%,-50%)';
}

/* ═══════════════════════════════════════════════════════
   NODE MAP VISUALIZATION
═══════════════════════════════════════════════════════ */
function buildNodeMap() {
  const el = document.getElementById('nodeMapContent');
  if (!el || !leaseData || !leaseData.length) return;
  const nodes = {};
  leaseData.forEach(l => {
    const n = l.node || 1;
    if (!nodes[n]) nodes[n] = { id:n, name:(nodeMap && Object.values(nodeMap).find(nm=>nm.name==='Node '+n))? Object.values(nodeMap)[n-1]?.name||'Node '+n : 'Node '+n, leases:[], total:0 };
    nodes[n].leases.push(l);
    nodes[n].total += l.alltime;
  });
  const html = Object.values(nodes).sort((a,b)=>a.id-b.id).map(n => {
    const capacity = 200;
    const pct = Math.min(100, (n.leases.length / capacity) * 100);
    const barCol = pct >= 90 ? '#ef4444' : pct >= 70 ? '#f59e0b' : '#10b981';
    const leaseChips = n.leases.sort((a,b)=>b.alltime-a.alltime).slice(0,12).map(l => {
      const col = grpCol(l.group);
      return `<div title="${sanitizeText(l.name)} · $${l.alltime.toFixed(4)}" style="width:18px;height:18px;border-radius:4px;background:${col};opacity:.75;cursor:default;font-size:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${l.last4.slice(0,2)}</div>`;
    }).join('');
    const moreCount = n.leases.length > 12 ? `<span style="font-size:.55rem;color:var(--muted)">+${n.leases.length-12} more</span>` : '';
    return `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.85rem 1rem;min-width:220px;flex:1">
      <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
        <div style="width:10px;height:10px;border-radius:50%;background:${barCol}"></div>
        <span style="font-size:.78rem;font-weight:700">${sanitizeText(n.name)}</span>
        <span style="font-size:.6rem;color:var(--muted);margin-left:auto">${n.leases.length}/${capacity}</span>
      </div>
      <div style="height:6px;border-radius:4px;background:var(--surface2);margin-bottom:.5rem;overflow:hidden">
        <div style="height:100%;width:${pct}%;background:${barCol};border-radius:4px;transition:width .4s"></div>
      </div>
      <div style="font-size:.65rem;color:var(--text2);margin-bottom:.4rem">$${n.total.toFixed(4)} total · $${(n.total/Math.max(n.leases.length,1)).toFixed(4)}/lease</div>
      <div style="display:flex;flex-wrap:wrap;gap:3px">${leaseChips}${moreCount}</div>
    </div>`;
  }).join('');
  el.innerHTML = `<div style="display:flex;gap:.85rem;flex-wrap:wrap">${html}</div>`;
}

/* ═══════════════════════════════════════════════════════
   ANIMATED EASY/ADVANCED TRANSITION
═══════════════════════════════════════════════════════ */

// Add CSS transition class for mode switching
(function(){
  var style = document.createElement('style');
  style.textContent = '.mode-fade{animation:modeFade .35s ease}@keyframes modeFade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}';
  document.head.appendChild(style);
})();
// Patch setDashboardMode to add animation
var _origSetMode = typeof setDashboardMode === 'function' ? setDashboardMode : null;

/* ═══════════════════════════════════════════════════════
   PRINTABLE ONE-PAGE SUMMARY
═══════════════════════════════════════════════════════ */
function printSummary() {
  if (!leaseData || !leaseData.length) { showToast('⚠️','No Data','Load data first','#f59e0b'); return; }
  const top5 = [...leaseData].sort((a,b)=>b.alltime-a.alltime).slice(0,5);
  const bot5 = [...leaseData].sort((a,b)=>a.alltime-b.alltime).slice(0,5);
  const totalEarn = leaseData.reduce((s,l)=>s+l.alltime,0);
  const totalTxns = leaseData.reduce((s,l)=>s+l.txns,0);
  const nodeBreak = {};
  leaseData.forEach(l => { var n=l.node||1; nodeBreak[n]=(nodeBreak[n]||{count:0,earn:0}); nodeBreak[n].count++; nodeBreak[n].earn+=l.alltime; });
  const dateRange = datesSorted && datesSorted.length ? datesSorted[0]+' → '+datesSorted[datesSorted.length-1] : 'N/A';

  var w = window.open('','_blank','width=800,height=600');
  w.document.write(`<html><head><title>Unity Node Summary</title><style>
    body{font-family:Arial,sans-serif;margin:2rem;color:#1a2c38;font-size:13px}
    h1{font-size:20px;margin-bottom:4px} .sub{color:#6b7280;font-size:11px;margin-bottom:16px}
    table{border-collapse:collapse;width:100%;margin:8px 0} th,td{border:1px solid #ddd;padding:6px 10px;text-align:left;font-size:12px}
    th{background:#f3f4f6;font-weight:700} .kpi{display:inline-block;background:#f0f7ff;border:1px solid #dbeafe;border-radius:8px;padding:10px 16px;margin:4px;text-align:center}
    .kpi .v{font-size:18px;font-weight:700;color:#1d4ed8} .kpi .l{font-size:10px;color:#6b7280;text-transform:uppercase}
    h2{font-size:14px;margin:16px 0 6px;border-bottom:1px solid #e5e7eb;padding-bottom:4px}
  </style></head><body>
    <h1>dataNerd Dashboard — Unity Node Summary</h1>
    <div class="sub">${dateRange} · ${leaseData.length} leases · Generated ${new Date().toLocaleDateString()}</div>
    <div>
      <div class="kpi"><div class="l">Total Earnings</div><div class="v">$${totalEarn.toFixed(4)}</div></div>
      <div class="kpi"><div class="l">Total Txns</div><div class="v">${totalTxns.toLocaleString()}</div></div>
      <div class="kpi"><div class="l">Active Leases</div><div class="v">${leaseData.length}</div></div>
      <div class="kpi"><div class="l">Avg/Lease</div><div class="v">$${(totalEarn/leaseData.length).toFixed(4)}</div></div>
    </div>
    <h2>Node Breakdown</h2>
    <table><tr><th>Node</th><th>Leases</th><th>Capacity</th><th>Earnings</th><th>$/Lease</th></tr>
    ${Object.entries(nodeBreak).sort((a,b)=>a[0]-b[0]).map(([n,d])=>`<tr><td>Node ${n}</td><td>${d.count}</td><td>${(d.count/200*100).toFixed(0)}%</td><td>$${d.earn.toFixed(4)}</td><td>$${(d.earn/d.count).toFixed(4)}</td></tr>`).join('')}
    </table>
    <h2>Top 5 Performers</h2>
    <table><tr><th>#</th><th>Lease</th><th>Group</th><th>Earnings</th></tr>
    ${top5.map((l,i)=>`<tr><td>${i+1}</td><td>${sanitizeText(l.name)}</td><td>${sanitizeText(l.group||'Unassigned')}</td><td>$${l.alltime.toFixed(4)}</td></tr>`).join('')}
    </table>
    <h2>Bottom 5 Performers</h2>
    <table><tr><th>#</th><th>Lease</th><th>Group</th><th>Earnings</th></tr>
    ${bot5.map((l,i)=>`<tr><td>${i+1}</td><td>${sanitizeText(l.name)}</td><td>${sanitizeText(l.group||'Unassigned')}</td><td>$${l.alltime.toFixed(4)}</td></tr>`).join('')}
    </table>
    <div style="margin-top:20px;font-size:10px;color:#9ca3af">dataNerd Dashboard v4.20 · datanerdsdash on X</div>
  </body></html>`);
  w.document.close();
  setTimeout(function(){ w.print(); }, 400);
}

/* ═══════════════════════════════════════════════════════
   WEEK vs WEEK COMPARISON SNAPSHOT
═══════════════════════════════════════════════════════ */
function buildComparison() {
  var el = document.getElementById('comparisonContent');
  if (!el || !datesSorted || datesSorted.length < 8 || !byDate) return;
  var today = datesSorted[datesSorted.length - 1];
  var td = new Date(today);
  var thisWeek = [], lastWeek = [];
  for (var i = 0; i < 7; i++) {
    var d1 = new Date(td); d1.setDate(td.getDate() - i);
    var d2 = new Date(td); d2.setDate(td.getDate() - 7 - i);
    var iso1 = d1.toISOString().slice(0,10), iso2 = d2.toISOString().slice(0,10);
    thisWeek.push(iso1); lastWeek.push(iso2);
  }
  var thisTotal = 0, lastTotal = 0, thisTxns = 0, lastTxns = 0;
  thisWeek.forEach(function(d) { (byDate[d]||[]).forEach(function(r) { thisTotal += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),d); thisTxns++; }); });
  lastWeek.forEach(function(d) { (byDate[d]||[]).forEach(function(r) { lastTotal += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),d); lastTxns++; }); });
  var earnDiff = lastTotal > 0 ? ((thisTotal - lastTotal)/lastTotal*100) : 0;
  var txnDiff = lastTxns > 0 ? ((thisTxns - lastTxns)/lastTxns*100) : 0;
  var earnCol = earnDiff >= 0 ? 'var(--up)' : 'var(--down)';
  var txnCol = txnDiff >= 0 ? 'var(--up)' : 'var(--down)';

  el.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:.85rem;margin-top:.5rem">
    <div style="background:var(--surface2);border-radius:10px;padding:.75rem 1rem;border:1px solid var(--border)">
      <div style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:.3rem">This Week</div>
      <div style="font-size:1.1rem;font-weight:700;font-family:var(--font-mono),monospace">$${thisTotal.toFixed(4)}</div>
      <div style="font-size:.65rem;color:var(--muted)">${thisTxns} txns</div>
    </div>
    <div style="background:var(--surface2);border-radius:10px;padding:.75rem 1rem;border:1px solid var(--border)">
      <div style="font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:.3rem">Last Week</div>
      <div style="font-size:1.1rem;font-weight:700;font-family:var(--font-mono),monospace">$${lastTotal.toFixed(4)}</div>
      <div style="font-size:.65rem;color:var(--muted)">${lastTxns} txns</div>
    </div>
  </div>
  <div style="margin-top:.6rem;display:flex;gap:1rem;font-size:.75rem">
    <span>Earnings: <strong style="color:${earnCol}">${earnDiff>=0?'+':''}${earnDiff.toFixed(1)}%</strong></span>
    <span>Txns: <strong style="color:${txnCol}">${txnDiff>=0?'+':''}${txnDiff.toFixed(1)}%</strong></span>
  </div>`;
}

// ── Mini sparkline SVG for lease table ──
function leaseSparkSVG(last4, w, h) {
  if (!byDate || !datesSorted || datesSorted.length < 2) return '';
  const days = datesSorted.slice(-7);
  const vals = days.map(d => (byDate[d]||[]).filter(r => r.licenseId.slice(-4) === last4)
    .reduce((s,r) => s + adjEarn(r.amountMicros, last4, d), 0));
  const mx = Math.max(...vals, 0.0001);
  const pts = vals.map((v, i) => `${(i/(vals.length-1))*w},${h - (v/mx)*(h-2) - 1}`).join(' ');
  const trend = vals[vals.length-1] >= vals[0];
  const col = trend ? 'var(--up)' : 'var(--down)';
  return `<svg width="${w}" height="${h}" style="display:block"><polyline points="${pts}" fill="none" stroke="${col}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

function sortBy(field, dir) {
  if (field === 'view') {
    sortState.view = dir;
  } else if (field === 'earn') {
    sortState.primarySort = 'earn';
    sortState.todayDir = null;
    if (dir === 'toggle') sortState.earnDir = sortState.earnDir==='asc'?'desc':'asc';
    else sortState.earnDir = dir;
  } else if (field === 'today') {
    sortState.primarySort = 'today';
    if (dir === 'toggle') sortState.todayDir = sortState.todayDir==='asc'?'desc':'asc';
    else sortState.todayDir = dir || 'desc';
  }
  renderLeaseTable();
}

function leaseSortVal(l) {
  return sortState.primarySort === 'today' ? l.today : l.alltime;
}

// ── Date range filter ──
let _dateRangeFilter = null; // { from, to }
function applyDateRange() {
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  if (!from && !to) { clearDateRange(); return; }
  _dateRangeFilter = { from: from || '2000-01-01', to: to || '2099-12-31' };
  recalcLeaseData();
  renderLeaseTable();
  showToast('📅', 'Date Range Applied', (from||'start') + ' → ' + (to||'end'), '#3b82f6');
}
function clearDateRange() {
  _dateRangeFilter = null;
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  recalcLeaseData();
  renderLeaseTable();
}
function recalcLeaseData() {
  if (!allData || !allData.length) return;
  const data = _dateRangeFilter
    ? allData.filter(r => { const d = r.completedAt.slice(0,10); return d >= _dateRangeFilter.from && d <= _dateRangeFilter.to; })
    : allData;
  const lMap = window._activeLeaseMap || LEASE_MAP;
  const leaseMap = {};
  data.forEach(r => {
    const h = r.licenseId.slice(-4);
    if (!leaseMap[h]) leaseMap[h] = { last4:h, name:'', group:'', alltime:0, today:0, txns:0, node:1 };
    leaseMap[h].alltime += adjEarn(r.amountMicros, h, r.completedAt.slice(0,10));
    leaseMap[h].txns++;
  });
  // Preserve names/groups/nodes from existing leaseData
  leaseData.forEach(l => {
    if (leaseMap[l.last4]) {
      leaseMap[l.last4].name = l.name;
      leaseMap[l.last4].group = l.group;
      leaseMap[l.last4].node = l.node;
      leaseMap[l.last4].today = _dateRangeFilter ? 0 : l.today;
    }
  });
  // Only update alltime/txns, keep everything else
  Object.values(leaseMap).forEach(lm => {
    const existing = leaseData.find(l => l.last4 === lm.last4);
    if (existing) { existing.alltime = lm.alltime; existing.txns = lm.txns; if (_dateRangeFilter) existing.today = lm.today; }
  });
}

// ── CSV export ──
function exportLeaseCSV() {
  if (!leaseData || !leaseData.length) return;
  const range = _dateRangeFilter ? ` (${_dateRangeFilter.from} to ${_dateRangeFilter.to})` : '';
  const header = 'Name,Last4,Group,Node,All-Time Earnings,Latest Day,Txns,Favorited\n';
  const rows = leaseData.map(l =>
    `"${(l.name||'').replace(/"/g,'""')}",${l.last4},` +
    `"${(l.group||'Unassigned').replace(/"/g,'""')}",N${l.node},` +
    `${l.alltime.toFixed(6)},${l.today.toFixed(6)},${l.txns},${favLeases.has(l.last4)?'Yes':'No'}`
  ).join('\n');
  const csv = header + rows;
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Lease_Export_UnityNodes_' + new Date().toISOString().slice(0,10) + range.replace(/\s/g,'') + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('📥', 'CSV Exported', leaseData.length + ' leases', '#10b981');
}

function renderLeaseTable() {
  const {view, earnDir, todayDir, primarySort} = sortState;
  const sortDir = primarySort === 'today' ? (todayDir||'desc') : earnDir;
  const maxEarn = Math.max(...leaseData.map(l=>l.alltime), 1);
  const tbody = document.getElementById('leaseBody');
  tbody.innerHTML = '';

  function makeLeaseRow(l, grp) {
    const col = grpCol(grp), bg = grpBg(grp), lbl = grpLabel(grp);
    const pct = (l.alltime/maxEarn)*100;
    const isN2 = l.node >= 2;
    const isUnk = l.name.startsWith('UNK-');
    const todayStr = l.today>0 ? '$'+l.today.toFixed(4) : '<span style="color:#bbb">—</span>';
    const nameEl = isUnk
      ? `<span style="font-family:var(--font-mono), monospace;font-size:.68rem;color:var(--muted)">${sanitizeText(l.name)}</span>`
      : `<strong>${sanitizeText(l.name)}</strong>`;
    const hasNote = notesData && notesData['lease:'+l.last4];
    const noteIcon = hasNote ? ` <span class="note-icon" title="Has note — click to view" onclick="event.stopPropagation();showLeaseNotePopup('${l.last4}',event)" style="font-size:.6rem;cursor:pointer;opacity:.85">📝</span>` : '';
    const nodeCell = l.node >= 2
      ? `<span style="font-size:.68rem;font-weight:700;color:${col};background:${bg};border:1.5px solid ${col}55;border-radius:4px;padding:.1rem .35rem">N${l.node}</span>`
      : `<span style="font-size:.68rem;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:.1rem .35rem">N1</span>`;
    const barBg = nodeBarBg(l.node || 1, col);
    const barStyle = `width:${pct.toFixed(1)}%;background:${barBg};`;
    const isFav = favLeases.has(l.last4);
    const starBtn = `<span onclick="toggleFav('${l.last4}',event)" style="cursor:pointer;font-size:.75rem;opacity:${isFav?1:.3}" title="${isFav?'Unpin':'Pin'} lease">${isFav?'⭐':'☆'}</span>`;
    const spark = leaseSparkSVG(l.last4, 48, 18);
    return `<tr onclick="openLeasePage('${l.last4}')" title="Click to view full details for ${nameEl.replace(/<[^>]+>/g,'')}">
      <td style="padding:0 .3rem;text-align:center">${starBtn}</td>
      <td style="padding-left:${view==='group'?'1.2rem':'.75rem'}">${nameEl}${noteIcon}</td>
      <td><span class="grp-badge" style="background:${bg};color:${col};border:1px solid ${col}22">${lbl}</span></td>
      <td><div class="earn-bar-wrap">
        <div class="earn-bar-bg"><div style="${barStyle}height:100%;border-radius:4px"></div></div>
        <div class="earn-val" style="color:${col}">$${l.alltime.toFixed(4)}</div>
      </div></td>
      <td style="font-size:.72rem;font-weight:600;color:var(--text2)">${todayStr}</td>
      <td style="padding:.2rem .3rem">${spark}</td>
      <td style="font-size:.7rem;color:var(--muted)">${l.txns}</td>
      <td>${nodeCell}</td>
    </tr>`;
  }

  if (view === 'all') {
    // All leases intermixed, favorites first, then sorted by primarySort field
    const sorted = [...leaseData].sort((a,b) => {
      const fa = favLeases.has(a.last4)?1:0, fb = favLeases.has(b.last4)?1:0;
      if (fa !== fb) return fb - fa;
      return sortDir==='asc' ? leaseSortVal(a)-leaseSortVal(b) : leaseSortVal(b)-leaseSortVal(a);
    });
    sorted.forEach(l => { tbody.innerHTML += makeLeaseRow(l, l.group); });

  } else {
    // Group view — separated by group, each group sorted internally
    const grouped = {};
    leaseData.forEach(l => {
      if (!grouped[l.group]) grouped[l.group] = [];
      grouped[l.group].push({...l});
    });
    const groupTotals = {};
    leaseData.forEach(l => { groupTotals[l.group]=(groupTotals[l.group]||0)+l.alltime; });
    const groupsSorted = Object.keys(grouped).sort((a,b) => groupTotals[b]-groupTotals[a]);

    groupsSorted.forEach(grp => {
      const col=grpCol(grp), bg=grpBg(grp), lbl=grpLabel(grp);
      const gt=groupTotals[grp]||0, gc=grouped[grp].length;
      tbody.innerHTML += `<tr><td colspan="8" style="background:${bg};padding:.42rem .85rem;border-top:2px solid ${col};border-bottom:1px solid ${col}22">
        <div style="display:flex;align-items:center;gap:.7rem">
          <div style="width:12px;height:12px;border-radius:3px;background:${col}"></div>
          <span style="font-size:.7rem;font-weight:700;color:${col};text-transform:uppercase;letter-spacing:.1em">${lbl}</span>
          <span style="font-size:.63rem;color:${col};opacity:.65;font-weight:600">${gc} lease${gc!==1?'s':''}</span>
          <span style="margin-left:auto;font-size:.7rem;font-weight:700;color:${col};font-family:var(--font-mono), monospace">$${gt.toFixed(4)} total</span>
        </div></td></tr>`;
      grouped[grp]
        .sort((a,b) => sortDir==='asc' ? leaseSortVal(a)-leaseSortVal(b) : leaseSortVal(b)-leaseSortVal(a))
        .forEach(l => { tbody.innerHTML += makeLeaseRow(l, grp); });
    });
  }

  // Update button states
  document.querySelectorAll('.sbtn').forEach(b => b.classList.remove('active'));
  const btns = {
    'btn-view-group': view==='group',
    'btn-view-all': view==='all',
    'btn-earn-desc': primarySort==='earn'&&earnDir==='desc',
    'btn-earn-asc': primarySort==='earn'&&earnDir==='asc',
    'btn-today-desc': primarySort==='today'&&todayDir==='desc',
    'btn-today-asc': primarySort==='today'&&todayDir==='asc',
  };
  Object.entries(btns).forEach(([id,on]) => { const el=document.getElementById(id); if(el&&on)el.classList.add('active'); });
  document.getElementById('th-earn-arr').textContent = primarySort==='earn'?(earnDir==='asc'?'↑':'↓'):'';
  document.getElementById('th-today-arr').textContent = primarySort==='today'?((todayDir||'desc')==='asc'?'↑':'↓'):'';
  const modeLabel = view==='group'?'By Group':'All Mixed';
  const sortLabel = primarySort==='today'?`Latest Day ${(todayDir||'desc')==='asc'?'↑ Low→High':'↓ High→Low'}`:`Earnings ${earnDir==='asc'?'↑ Low→High':'↓ High→Low'}`;
  document.getElementById('sortStatus').textContent = `${modeLabel} · ${sortLabel}`;
}

/* ═══════════════════════════════════════════════════════
   DAILY EARNINGS BAR CHART
═══════════════════════════════════════════════════════ */
let dailyBarDots = []; // hit areas for hover
let barPeriod = 'day'; // 'day', 'week', 'month'

function setBarPeriod(period, btn) {
  barPeriod = period;
  if (btn) {
    document.querySelectorAll('#barPeriodBtns .cbtn').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
  }
  const titles = { day: 'Daily Earnings — Bar Chart', week: 'Weekly Earnings — Bar Chart', month: 'Monthly Earnings — Bar Chart' };
  const labels = { day: 'day', week: 'week', month: 'month' };
  const tEl = document.getElementById('barChartTitle');
  const lEl = document.getElementById('barPeriodLabel');
  if (tEl) tEl.textContent = titles[period];
  if (lEl) lEl.textContent = labels[period];
  renderDailyBar();
}

/**
 * Aggregate datesSorted/byDate into weekly or monthly buckets.
 * Returns { labels: string[], totals: number[], avgWindow: number }
 */
function aggregateByPeriod(period) {
  if (!datesSorted || !datesSorted.length) return { labels: [], totals: [], avgWindow: 7 };

  if (period === 'day') {
    const totals = datesSorted.map(d => (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0));
    return { labels: datesSorted, totals, avgWindow: 7 };
  }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const buckets = {};

  if (period === 'week') {
    datesSorted.forEach(d => {
      const dt = new Date(d + 'T12:00:00');
      const dayOfWeek = dt.getDay();
      const monday = new Date(dt);
      monday.setDate(dt.getDate() - ((dayOfWeek + 6) % 7));
      const key = monday.toISOString().slice(0,10);
      if (!buckets[key]) buckets[key] = 0;
      buckets[key] += (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
    });
    const keys = Object.keys(buckets).sort();
    const labels = keys.map(k => {
      const p = k.split('-');
      return MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10);
    });
    return { labels: keys, totals: keys.map(k=>buckets[k]), displayLabels: labels, avgWindow: 4 };
  }

  if (period === 'month') {
    datesSorted.forEach(d => {
      const key = d.slice(0,7); // YYYY-MM
      if (!buckets[key]) buckets[key] = 0;
      buckets[key] += (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
    });
    const keys = Object.keys(buckets).sort();
    const labels = keys.map(k => {
      const p = k.split('-');
      return MON[parseInt(p[1],10)-1] + ' ' + p[0].slice(2);
    });
    return { labels: keys, totals: keys.map(k=>buckets[k]), displayLabels: labels, avgWindow: 3 };
  }
}

function renderDailyBar(targetId) {
  const cv = document.getElementById(targetId || 'dailyBarCanvas');
  if (!cv) return;
  const W = cv.parentElement.clientWidth || 900;
  const H = 220;
  const dpr = window.devicePixelRatio || 1;
  cv.width = W * dpr; cv.height = H * dpr;
  cv.style.width = W + 'px'; cv.style.height = H + 'px';
  const c = cv.getContext('2d');
  c.scale(dpr, dpr);
  c.clearRect(0, 0, W, H);
  dailyBarDots = [];

  if (!datesSorted || !datesSorted.length) return;

  const isDark = !document.body.classList.contains('light');
  const gridCol  = isDark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.07)';
  const labelCol = isDark ? '#5c6378' : '#9ca3af';
  const fontFace = 'Inter,sans-serif';
  const pad = { l: 66, r: 16, t: 18, b: 44 };
  const iW = W - pad.l - pad.r;
  const iH = H - pad.t - pad.b;

  // Aggregate data by period
  const agg = aggregateByPeriod(barPeriod);
  const periodLabels = agg.labels;
  const dailyTotals = agg.totals;
  const dispLabels = agg.displayLabels || periodLabels;
  const n = periodLabels.length;
  if (!n) return;

  const maxV = Math.max(...dailyTotals) * 1.08 || 1;

  // Rolling average for color coding
  const avgWin = agg.avgWindow;
  const avg7 = periodLabels.map((_, i) => {
    const slice = dailyTotals.slice(Math.max(0, i - (avgWin-1)), i + 1);
    return slice.reduce((a, b) => a + b, 0) / slice.length;
  });
  const globalAvg = dailyTotals.reduce((a, b) => a + b, 0) / dailyTotals.length;

  // Grid lines + y labels
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + (iH / 4) * i;
    const v = maxV - (maxV / 4) * i;
    c.strokeStyle = gridCol; c.lineWidth = 1;
    c.beginPath(); c.moveTo(pad.l, y); c.lineTo(W - pad.r, y); c.stroke();
    c.fillStyle = labelCol; c.font = `500 10px ${fontFace}`; c.textAlign = 'right';
    c.fillText('$' + v.toFixed(2), pad.l - 5, y + 4);
  }

  // Average line
  const avgY = pad.t + iH - (globalAvg / maxV) * iH;
  c.strokeStyle = isDark ? 'rgba(255,255,255,.18)' : 'rgba(0,0,0,.15)';
  c.lineWidth = 1; c.setLineDash([4, 4]);
  c.beginPath(); c.moveTo(pad.l, avgY); c.lineTo(W - pad.r, avgY); c.stroke();
  c.setLineDash([]);
  c.fillStyle = isDark ? 'rgba(255,255,255,.35)' : 'rgba(0,0,0,.35)';
  c.font = `600 9px ${fontFace}`; c.textAlign = 'left';
  c.fillText('avg $' + globalAvg.toFixed(2), pad.l + 4, avgY - 4);

  // Bars
  const gap   = Math.max(2, Math.min(6, iW / n * 0.12));
  const barW  = (iW / n) - gap;
  const MON   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DOW   = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  periodLabels.forEach((d, i) => {
    const v   = dailyTotals[i];
    const x   = pad.l + i * (iW / n) + gap / 2;
    const bH  = (v / maxV) * iH;
    const y   = pad.t + iH - bH;

    // Color: above avg = green/blue, below = amber/red
    const ratio = v / (avg7[i] || globalAvg || 1);
    let barCol;
    if      (ratio >= 1.15) barCol = muteHex('#10b981');
    else if (ratio >= 0.95) barCol = muteHex('#3b82f6');
    else if (ratio >= 0.75) barCol = muteHex('#f59e0b');
    else                    barCol = muteHex('#ef4444');

    // Bar with rounded top
    c.beginPath();
    const r2 = Math.min(4, barW / 2);
    c.moveTo(x + r2, y);
    c.lineTo(x + barW - r2, y);
    c.quadraticCurveTo(x + barW, y, x + barW, y + r2);
    c.lineTo(x + barW, pad.t + iH);
    c.lineTo(x, pad.t + iH);
    c.lineTo(x, y + r2);
    c.quadraticCurveTo(x, y, x + r2, y);
    c.closePath();
    c.fillStyle = barCol + 'cc';
    c.fill();

    // Thin top highlight
    c.fillStyle = barCol;
    c.fillRect(x, y, barW, Math.min(3, bH));

    // Date label — adapt step and format to period
    const step = n > 20 ? 3 : n > 10 ? 2 : 1;
    if (i % step === 0) {
      c.fillStyle = labelCol; c.textAlign = 'center';
      c.font = `600 10px ${fontFace}`;
      if (barPeriod === 'day') {
        const p   = d.split('-');
        const mo  = parseInt(p[1],10), dy = parseInt(p[2],10);
        const dow = new Date(parseInt(p[0],10), mo - 1, dy).getDay();
        c.fillText(MON[mo-1] + ' ' + dy, x + barW / 2, H - 24);
        c.font = `500 8.5px ${fontFace}`;
        c.fillStyle = isDark ? '#3d4556' : '#c8cdd6';
        c.fillText(DOW[dow], x + barW / 2, H - 12);
      } else if (barPeriod === 'week') {
        const p = d.split('-');
        c.fillText(MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10), x + barW / 2, H - 24);
        c.font = `500 8.5px ${fontFace}`;
        c.fillStyle = isDark ? '#3d4556' : '#c8cdd6';
        c.fillText('wk', x + barW / 2, H - 12);
      } else {
        const dl = dispLabels[i] || d;
        c.fillText(dl, x + barW / 2, H - 20);
      }
    }

    // Note indicator dot on bars that have notes (daily only)
    if (barPeriod === 'day' && notesData && notesData[d]) {
      const dotX = x + barW / 2;
      const dotY = Math.max(pad.t + 8, y - 6);
      c.beginPath(); c.arc(dotX, dotY, 4, 0, Math.PI*2);
      c.fillStyle = '#f59e0b'; c.fill();
      c.strokeStyle = isDark ? '#242836' : '#fff'; c.lineWidth = 1.5; c.stroke();
    }

    // Store hit area
    dailyBarDots.push({ x, y, w: barW, bH, v, d, col: barCol, avg7: avg7[i] });
  });
}

// Hover handler
function dailyBarHover(cv, e) {
  const rect = cv.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (cv.width / rect.width / (window.devicePixelRatio||1));
  const my = (e.clientY - rect.top)  * (cv.height / rect.height / (window.devicePixelRatio||1));
  const tip = document.getElementById('dailyBarTip2');
  const pad = { l: 66, r: 16, t: 18, b: 44 };
  const iH  = 220 - pad.t - pad.b;

  let hit = null;
  for (const d of dailyBarDots) {
    if (mx >= d.x && mx <= d.x + d.w && my >= pad.t && my <= pad.t + iH) { hit = d; break; }
  }

  if (!hit) { tip.style.display = 'none'; return; }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DOW = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const p = hit.d.split('-');
  const mo = parseInt(p[1],10), dy = parseInt(p[2],10);
  const dow = new Date(parseInt(p[0],10), mo-1, dy).getDay();
  const txns = (byDate[hit.d]||[]).length;
  const diff = ((hit.v - hit.avg7) / hit.avg7 * 100);
  const diffStr = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';
  const diffCol = diff >= 0 ? '#10b981' : '#ef4444';

  tip.style.display = 'block';
  tip.style.borderLeftColor = hit.col;
  const noteText = notesData && notesData[hit.d] ? `<div style="margin-top:.35rem;padding:.3rem .5rem;background:rgba(245,158,11,.12);border-radius:5px;font-size:.65rem;color:#b45309;border-left:2px solid #f59e0b">📝 ${sanitizeText(notesData[hit.d])}</div>` : '';
  tip.innerHTML = `
    <div style="font-family:var(--font-heading),sans-serif;font-size:.85rem;font-weight:700;margin-bottom:.3rem">${MON[mo-1]} ${dy} — ${DOW[dow]}</div>
    <div style="font-family:var(--font-mono),monospace;font-size:1.1rem;font-weight:700;color:${hit.col};margin-bottom:.25rem">$${hit.v.toFixed(4)}</div>
    <div style="font-size:.68rem;color:var(--text2)">${txns} transactions</div>
    <div style="font-size:.68rem;color:${diffCol};margin-top:.15rem">${diffStr} vs 7-day avg ($${hit.avg7.toFixed(4)})</div>
    ${noteText}
  `;

  let tx = e.clientX + 14, ty = e.clientY - 20;
  const tw = 200, th = 100;
  if (tx + tw > window.innerWidth  - 16) tx = e.clientX - tw - 14;
  if (ty + th > window.innerHeight - 16) ty = e.clientY - th - 10;
  tip.style.left = tx + 'px';
  tip.style.top  = ty + 'px';
}

document.getElementById('dailyBarCanvas').addEventListener('mousemove', function(e) { dailyBarHover(this, e); });
document.getElementById('dailyBarCanvas').addEventListener('mouseleave', function() {
  document.getElementById('dailyBarTip2').style.display = 'none';
});
document.getElementById('dailyBarCanvas').addEventListener('click', function(e) {
  const rect = this.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (this.width / rect.width / (window.devicePixelRatio||1));
  const pad = { l:66, t:18, b:44 };
  const iH  = 220 - pad.t - pad.b;
  let hit = null;
  for (const d of dailyBarDots) {
    if (mx >= d.x && mx <= d.x + d.w) { hit = d; break; }
  }
  if (hit) openNoteModal(hit.d);
});

// Easy mode trend canvas hover
(function() {
  var ecv = document.getElementById('easyTrendCanvas');
  if (!ecv) return;
  ecv.style.cursor = 'crosshair';
  ecv.addEventListener('mousemove', function(e) { dailyBarHover(this, e); });
  ecv.addEventListener('mouseleave', function() { document.getElementById('dailyBarTip2').style.display = 'none'; });
})();


/* ═══════════════════════════════════════════════════════
   EARNINGS HEATMAP CALENDAR
═══════════════════════════════════════════════════════ */
function renderHeatmap(targetId) {
  const el = document.getElementById(targetId || 'heatmapChart');
  if (!el || !datesSorted || !datesSorted.length || !byDate) return;

  const isDark = !document.body.classList.contains('light');
  const emptyCol = isDark ? '#2c3142' : '#f0f2f5';

  // Build daily totals map
  const totMap = {};
  datesSorted.forEach(d => {
    totMap[d] = (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
  });

  const vals = Object.values(totMap).filter(v=>v>0);
  const maxV = vals.length ? Math.max(...vals) : 1;

  // Color scale: 5 levels green
  const getCol = (v) => {
    if (!v) return emptyCol;
    const t = v / maxV;
    if (t >= .8)  return '#065f46';
    if (t >= .6)  return '#10b981';
    if (t >= .4)  return '#34d399';
    if (t >= .2)  return '#6ee7b7';
    return '#a7f3d0';
  };

  // Date range: first to last in dataset
  const first = new Date(datesSorted[0]);
  const last  = new Date(datesSorted[datesSorted.length-1]);

  // Go back to Sunday of first week
  const startSun = new Date(first);
  startSun.setDate(startSun.getDate() - startSun.getDay());

  // Go forward to Saturday of last week
  const endSat = new Date(last);
  endSat.setDate(endSat.getDate() + (6 - endSat.getDay()));

  // Build weeks
  const weeks = [];
  let cur = new Date(startSun);
  let _loopSafe = 0;
  while (cur <= endSat && _loopSafe++ < 200) {
    const week = [];
    for (let dow=0; dow<7; dow++) {
      const d = new Date(cur);
      d.setDate(cur.getDate() + dow);
      const iso = d.toISOString().slice(0,10);
      const inRange = d >= first && d <= last;
      week.push({ iso, v: inRange ? (totMap[iso]||0) : null, d: new Date(d) });
    }
    weeks.push(week);
    cur.setDate(cur.getDate() + 7);
  }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const DOW_LABELS = ['S','M','T','W','T','F','S'];
  const CELL = 14, GAP = 2;

  // Build month labels
  let monthLabels = '<div style="display:flex;margin-left:26px;margin-bottom:3px;gap:0">';
  let lastMo = -1;
  weeks.forEach(wk => {
    const mo = wk[0].d.getMonth();
    if (mo !== lastMo) {
      monthLabels += `<div style="font-size:9px;color:var(--muted);width:${CELL+GAP}px;white-space:nowrap">${MON[mo]}</div>`;
      lastMo = mo;
    } else {
      monthLabels += `<div style="width:${CELL+GAP}px"></div>`;
    }
  });
  monthLabels += '</div>';

  // DOW labels
  let dowLabels = '<div style="display:flex;flex-direction:column;gap:'+GAP+'px;margin-right:4px;margin-top:0">';
  DOW_LABELS.forEach(l => {
    dowLabels += `<div style="height:${CELL}px;font-size:8.5px;color:var(--muted);line-height:${CELL}px;text-align:right;width:18px">${l}</div>`;
  });
  dowLabels += '</div>';

  // Build cell grid
  let grid = '<div style="display:flex;gap:'+GAP+'px">';
  weeks.forEach(wk => {
    grid += '<div style="display:flex;flex-direction:column;gap:'+GAP+'px">';
    wk.forEach(cell => {
      if (cell.v === null) {
        grid += `<div style="width:${CELL}px;height:${CELL}px;border-radius:2px;background:transparent"></div>`;
      } else {
        const col = getCol(cell.v);
        const MON2 = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const DOW2 = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const p = cell.iso.split('-');
        const label = `${DOW2[cell.d.getDay()]} ${MON2[cell.d.getMonth()]} ${cell.d.getDate()}`;
        const valStr = cell.v > 0 ? `$${cell.v.toFixed(4)}` : 'No earnings';
        grid += `<div class="hm-cell" style="background:${col}"
          data-tip="${label}|${valStr}"
          onmouseenter="showHmTip(event,this)"
          onmouseleave="hideHmTip()"></div>`;
      }
    });
    grid += '</div>';
  });
  grid += '</div>';

  // Legend
  const legendCols = ['#a7f3d0','#6ee7b7','#34d399','#10b981','#065f46'];
  const legend = `<div style="display:flex;align-items:center;gap:.4rem;margin-top:.6rem;font-size:.65rem;color:var(--muted)">
    <span>Less</span>
    ${legendCols.map(c=>`<div style="width:11px;height:11px;border-radius:2px;background:${c}"></div>`).join('')}
    <span>More</span>
    <span style="margin-left:.8rem;color:${emptyCol==='#1a2030'?'#2d3a4e':'#d1d5db'}">■</span><span>No data</span>
  </div>`;

  el.innerHTML = `
    <div style="display:inline-block">
      ${monthLabels}
      <div style="display:flex">
        ${dowLabels}
        ${grid}
      </div>
      ${legend}
    </div>`;

  // Notes overlay dots on heatmap cells
  renderHeatmapNotes();
}

function showHmTip(e, el) {
  const tip = document.getElementById('hmTip');
  if (!tip) return;
  const parts = el.dataset.tip.split('|');
  const hmGreen = document.body.classList.contains('light') ? '#10b981' : '#5eaa8d';
  tip.innerHTML = `<strong>${parts[0]}</strong><br><span style="color:${hmGreen};font-family:var(--font-mono),monospace">${parts[1]}</span>`;
  tip.style.display = 'block';
  moveTip(tip, e);
}
function hideHmTip() {
  const tip = document.getElementById('hmTip');
  if (tip) tip.style.display = 'none';
}
document.addEventListener('mousemove', e => {
  const tip = document.getElementById('hmTip');
  if (tip && tip.style.display !== 'none') moveTip(tip, e);
});
function moveTip(tip, e) {
  let tx = e.clientX + 12, ty = e.clientY - 10;
  if (tx + 180 > window.innerWidth)  tx = e.clientX - 184;
  if (ty + 70  > window.innerHeight) ty = e.clientY - 70;
  tip.style.left = tx + 'px'; tip.style.top = ty + 'px';
}

/* ═══════════════════════════════════════════════════════
   HOUR OF DAY CHART
═══════════════════════════════════════════════════════ */
function renderRadar() {
  const cv = document.getElementById('radarCanvas');
  if (!cv || !allData || !allData.length) return;

  const SIZE = Math.min(cv.parentElement.clientWidth || 600, 600);
  const H = Math.min(SIZE * 0.7, 340);
  const dpr = window.devicePixelRatio || 1;
  cv.width  = (cv.parentElement.clientWidth || 600) * dpr;
  cv.height = H * dpr;
  cv.style.width  = (cv.parentElement.clientWidth || 600) + 'px';
  cv.style.height = H + 'px';
  const c = cv.getContext('2d');
  c.scale(dpr, dpr);
  const W = cv.parentElement.clientWidth || 600;
  c.clearRect(0, 0, W, H);

  const isDark = !document.body.classList.contains('light');
  const gridCol  = isDark ? 'rgba(255,255,255,.08)' : 'rgba(0,0,0,.08)';
  const labelCol = isDark ? '#8e95a8' : '#4b5563';
  const textCol  = isDark ? '#d4d8e3' : '#1a2c38';

  // ── Collect per-group stats ──
  const groups = {};
  allData.forEach(r => {
    const last4 = r.licenseId.slice(-4);
    const g     = getGroupDynamic(last4, r.completedAt.slice(0,10), window._activeLeaseMap || {});
    if (!groups[g]) groups[g] = { txns: [], byDay: {}, lease: new Set() };
    const usd = adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    groups[g].txns.push(usd);
    const d = r.completedAt.slice(0,10);
    groups[g].byDay[d] = (groups[g].byDay[d] || 0) + usd;
    groups[g].lease.add(last4);
  });

  const gNames = Object.keys(groups).filter(g => g !== 'Unassigned' && groups[g].txns.length > 5);
  // If all unassigned, include it so single-file users see something
  const gNamesAll = Object.keys(groups).filter(g => groups[g].txns.length > 5);
  const finalNames = gNames.length >= 2 ? gNames : gNamesAll;
  if (finalNames.length < 1) {
    c.fillStyle = labelCol; c.font = '13px sans-serif'; c.textAlign = 'center';
    c.fillText('Not enough data to render radar', W/2, H/2);
    return;
  }

  // ── Score each group 0–1 across 5 axes ──
  const AXES = ['Avg Txn', 'Peak Day', 'Active Rate', 'Consistency', 'Volume'];
  const scores = {};
  const globalAvg = allData.reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0) / allData.length;

  finalNames.forEach(g => {
    const {txns, byDay, lease} = groups[g];
    const avg      = txns.reduce((s,v)=>s+v,0) / txns.length;
    const days     = Object.values(byDay);
    const peak     = Math.max(...days);
    const activeR  = days.length / datesSorted.length;
    const mean     = days.reduce((s,v)=>s+v,0) / days.length;
    const variance = days.reduce((s,v)=>s+(v-mean)**2,0) / days.length;
    const consistency = 1 / (1 + Math.sqrt(variance) / (mean || 1));
    const volume   = txns.length;
    scores[g] = { avg, peak, activeR, consistency, volume };
  });

  // Normalize per axis to [0.1, 1.0]
  const normalize = (key, raw) => {
    const vals = finalNames.map(g => scores[g][key]);
    const mn = Math.min(...vals), mx = Math.max(...vals);
    return mx === mn ? 0.6 : 0.1 + 0.9 * (raw - mn) / (mx - mn);
  };

  const normalized = {};
  finalNames.forEach(g => {
    normalized[g] = [
      normalize('avg',         scores[g].avg),
      normalize('peak',        scores[g].peak),
      normalize('activeR',     scores[g].activeR),
      normalize('consistency', scores[g].consistency),
      normalize('volume',      scores[g].volume),
    ];
  });

  // ── Draw radar ──
  const N     = AXES.length;
  const CX    = W * 0.42;
  const CY    = H / 2;
  const R     = Math.min(CX, CY) * 0.72;
  const angleStep = (Math.PI * 2) / N;
  const startAngle = -Math.PI / 2;

  const pt = (r, i) => ({
    x: CX + r * Math.cos(startAngle + i * angleStep),
    y: CY + r * Math.sin(startAngle + i * angleStep),
  });

  // Grid rings
  [0.25, 0.5, 0.75, 1.0].forEach(frac => {
    c.beginPath();
    for (let i=0; i<N; i++) {
      const p = pt(R * frac, i);
      i === 0 ? c.moveTo(p.x, p.y) : c.lineTo(p.x, p.y);
    }
    c.closePath();
    c.strokeStyle = gridCol; c.lineWidth = 1; c.stroke();
  });

  // Spokes + labels
  for (let i=0; i<N; i++) {
    const outer = pt(R, i);
    c.beginPath(); c.moveTo(CX, CY); c.lineTo(outer.x, outer.y);
    c.strokeStyle = gridCol; c.lineWidth = 1; c.stroke();

    const lp = pt(R * 1.18, i);
    c.fillStyle  = labelCol;
    c.font       = `600 ${Math.max(9, Math.round(W*0.013))}px var(--font-heading), sans-serif`;
    c.textAlign  = lp.x > CX + 5 ? 'left' : lp.x < CX - 5 ? 'right' : 'center';
    c.textBaseline = lp.y < CY ? 'bottom' : 'top';
    c.fillText(AXES[i], lp.x, lp.y);
  }

  // Group shapes
  radarDots = [];
  finalNames.forEach((g, gi) => {
    const col = grpCol(g);
    const vals = normalized[g];

    c.beginPath();
    vals.forEach((v, i) => {
      const p = pt(R * v, i);
      i === 0 ? c.moveTo(p.x, p.y) : c.lineTo(p.x, p.y);
    });
    c.closePath();
    c.strokeStyle = col; c.lineWidth = 2.2;
    c.globalAlpha = 0.85; c.stroke();
    c.fillStyle   = col;
    c.globalAlpha = 0.12; c.fill();
    c.globalAlpha = 1;

    // Dots on vertices
    vals.forEach((v, i) => {
      const p = pt(R * v, i);
      c.beginPath(); c.arc(p.x, p.y, 4, 0, Math.PI*2);
      c.fillStyle = col; c.fill();
      radarDots.push({ x: p.x, y: p.y, g, axis: AXES[i],
        raw: [scores[g].avg, scores[g].peak, scores[g].activeR,
              scores[g].consistency, scores[g].volume][i], gi });
    });
  });

  // Legend (right side)
  const lx = W * 0.86;
  let ly   = H * 0.18;
  c.font = `700 ${Math.max(9, Math.round(W*0.013))}px var(--font-heading), sans-serif`;
  finalNames.forEach(g => {
    const col = grpCol(g);
    c.fillStyle = col;
    c.fillRect(lx, ly - 6, 10, 10);
    c.fillStyle = textCol;
    c.textAlign = 'left'; c.textBaseline = 'middle';
    c.fillText(g, lx + 14, ly);
    ly += 20;
  });

  // Axis score labels at 25/50/75/100%
  c.fillStyle = isDark ? 'rgba(255,255,255,.18)' : 'rgba(0,0,0,.2)';
  c.font = `${Math.max(8,Math.round(W*0.011))}px monospace`;
  c.textAlign = 'center'; c.textBaseline = 'middle';
  [0.25,0.5,0.75,1.0].forEach(frac => {
    const p = pt(R * frac, 0);
    c.fillText(Math.round(frac*100)+'%', p.x + 4, p.y - 6);
  });
}

// Radar hover state
let radarDots = [];
function initRadarHover() {
  const cv = document.getElementById('radarCanvas');
  if (!cv) return;
  cv.addEventListener('mousemove', function(e) {
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    let found = null;
    for (const d of radarDots) {
      if (Math.hypot(mx - d.x, my - d.y) < 12) { found = d; break; }
    }
    const tip = document.getElementById('htip');
    if (found) {
      const axisLabels = {
        'Avg Txn':     `Avg: $${found.raw.toFixed(4)}`,
        'Peak Day':    `Peak: $${found.raw.toFixed(4)}`,
        'Active Rate': `Active: ${(found.raw*100).toFixed(0)}% of days`,
        'Consistency': `Consistency: ${(found.raw*100).toFixed(0)}%`,
        'Volume':      `Txns: ${Math.round(found.raw).toLocaleString()}`
      };
      document.getElementById('htip-name').textContent = found.g;
      document.getElementById('htip-grp').textContent  = found.axis;
      document.getElementById('htip-val').textContent  = axisLabels[found.axis] || '';
      tip.style.borderLeftColor = grpCol(found.g);
      tip.style.display = 'block';
      requestAnimationFrame(() => moveTip(e));
    } else {
      tip.style.display = 'none';
    }
  });
  cv.addEventListener('mouseleave', () => {
    document.getElementById('htip').style.display = 'none';
  });
}


function renderWoW() {
  const el = document.getElementById('wowContent');
  if (!el || !datesSorted || !datesSorted.length || !byDate) return;

  const today = datesSorted[datesSorted.length - 1];
  const todayDate = new Date(today);

  // This week = last 7 days of data, Last week = 7 days before that
  const thisWeekDates = datesSorted.slice(-7);
  const lastWeekDates = datesSorted.slice(-14, -7);

  if (!lastWeekDates.length) {
    el.innerHTML = `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">Need at least 14 days of data for week-over-week comparison.</div>`;
    return;
  }

  const sum = dates => dates.reduce((s, d) => s + (byDate[d]||[]).reduce((ss,r) => ss + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)), 0), 0);
  const txnCount = dates => dates.reduce((s, d) => s + (byDate[d]||[]).length, 0);
  const activeLeases = dates => new Set(dates.flatMap(d => (byDate[d]||[]).map(r => r.licenseId))).size;
  const avgDaily = dates => sum(dates) / (dates.length || 1);
  const maxDay = dates => Math.max(...dates.map(d => (byDate[d]||[]).reduce((s,r) => s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0)));

  const tw = { earn: sum(thisWeekDates), txns: txnCount(thisWeekDates), leases: activeLeases(thisWeekDates), avg: avgDaily(thisWeekDates), best: maxDay(thisWeekDates) };
  const lw = { earn: sum(lastWeekDates), txns: txnCount(lastWeekDates), leases: activeLeases(lastWeekDates), avg: avgDaily(lastWeekDates), best: maxDay(lastWeekDates) };

  const delta = (tw, lw) => {
    if (!lw) return { pct: 0, str: '—', col: 'var(--muted)' };
    const pct = ((tw - lw) / lw) * 100;
    const col = pct >= 5 ? '#10b981' : pct <= -5 ? '#ef4444' : '#f59e0b';
    return { pct, str: (pct >= 0 ? '▲ +' : '▼ ') + pct.toFixed(1) + '%', col };
  };

  const metrics = [
    { lbl: 'Total Earned',   tw: '$'+tw.earn.toFixed(4), lw: '$'+lw.earn.toFixed(4), d: delta(tw.earn, lw.earn) },
    { lbl: 'Avg Daily',      tw: '$'+tw.avg.toFixed(4),  lw: '$'+lw.avg.toFixed(4),  d: delta(tw.avg,  lw.avg)  },
    { lbl: 'Best Day',       tw: '$'+tw.best.toFixed(4), lw: '$'+lw.best.toFixed(4), d: delta(tw.best, lw.best) },
    { lbl: 'Transactions',   tw: tw.txns.toLocaleString(),lw: lw.txns.toLocaleString(), d: delta(tw.txns, lw.txns) },
    { lbl: 'Active Leases',  tw: tw.leases, lw: lw.leases, d: delta(tw.leases, lw.leases) },
  ];

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmtD = d => { const p=d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); };

  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.3rem;font-size:.68rem;color:var(--muted);margin-bottom:.5rem">
      <div>📅 This week: ${fmtD(thisWeekDates[0])} – ${fmtD(thisWeekDates[thisWeekDates.length-1])}</div>
      <div>📅 Last week: ${fmtD(lastWeekDates[0])} – ${fmtD(lastWeekDates[lastWeekDates.length-1])}</div>
    </div>
    <div class="wow-grid">
      ${metrics.map(m => `<div class="wow-card">
        <div class="wow-lbl">${m.lbl}</div>
        <div class="wow-val">${m.tw}</div>
        <div style="font-size:.65rem;color:var(--muted)">was ${m.lw}</div>
        <div class="wow-delta" style="color:${m.d.col}">${m.d.str}</div>
        <div class="wow-bar-wrap">
          <div class="wow-bar" style="width:${Math.min(100,Math.abs(m.d.pct||0))}%;background:${m.d.col}"></div>
        </div>
      </div>`).join('')}
    </div>`;
}

/* ═══════════════════════════════════════════════════════
   NOTES / ANNOTATIONS
   Notes are saved into the naming file via __notes in dynamicLeaseMap.
   Click any daily bar on the Earnings page to add a note for that date.
═══════════════════════════════════════════════════════ */
let notesData = {};

// Called once on first build — load from naming file data
function loadNotes() {
  try {
    if (dynamicLeaseMap && dynamicLeaseMap.__notes) {
      notesData = JSON.parse(JSON.stringify(dynamicLeaseMap.__notes));
    } else {
      notesData = {};
    }
  } catch(e) { notesData = {}; }
}

// Sync notes back into dynamicLeaseMap so they export with the naming file
function syncNotesToMap() {
  if (!dynamicLeaseMap) return;
  try {
    if (Object.keys(notesData).length > 0) {
      dynamicLeaseMap.__notes = JSON.parse(JSON.stringify(notesData));
    } else {
      delete dynamicLeaseMap.__notes;
    }
  } catch(e) { console.warn('[Notes] Failed to sync notes:', e); }
}

var neHasUnsavedNotes = false;
var _unsavedBannerDismissed = false;

function showUnsavedBanner() {
  if (_unsavedBannerDismissed) return;
  var b = document.getElementById('unsavedNotesBanner');
  if (!b) return;
  b.classList.remove('hiding');
  b.style.display = 'flex';
}

function hideUnsavedBanner() {
  var b = document.getElementById('unsavedNotesBanner');
  if (!b) return;
  b.classList.add('hiding');
  _unsavedBannerDismissed = true;
  setTimeout(function() { b.style.display = 'none'; }, 320);
}

function saveLeaseNote(last4) {
  var el = document.getElementById('ldNoteText');
  if (!el) return;
  var text = el.value.trim();
  var key = 'lease:' + last4;
  if (text) notesData[key] = text;
  else delete notesData[key];
  syncNotesToMap();
  neHasUnsavedNotes = true;
  _unsavedBannerDismissed = false;
  showUnsavedBanner();
  showToast('📝','Note Saved','Export naming file to keep permanently','#10b981');
}

function deleteLeaseNote(last4) {
  var key = 'lease:' + last4;
  delete notesData[key];
  syncNotesToMap();
  var el = document.getElementById('ldNoteText');
  if (el) el.value = '';
  showToast('🗑','Note Cleared','','#6b7280');
}

function showLeaseNotePopup(last4, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }
  var key = 'lease:' + last4;
  var note = notesData[key];
  if (!note) return;
  var lMap = window._activeLeaseMap || LEASE_MAP || {};
  var info = lMap[last4];
  var name = (info && info.name && info.name !== last4) ? info.name : last4;
  document.getElementById('leaseNotePopupTitle').textContent = '📝 Note for ' + name;
  document.getElementById('leaseNotePopupBody').textContent = note;
  document.getElementById('leaseNotePopup').style.display = 'flex';
}

function saveNote(date, text) {
  if (text.trim()) notesData[date] = text.trim();
  else delete notesData[date];
  syncNotesToMap();
  neHasUnsavedNotes = true;
  _unsavedBannerDismissed = false;
  showUnsavedBanner();
}

let _noteModalDate = null;
function openNoteModal(date) {
  _noteModalDate = date;
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const p = date.split('-');
  const dateStr = MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10) + ', ' + p[0];
  document.getElementById('noteModalTitle').textContent = '📝 Note for ' + dateStr;
  document.getElementById('noteText').value = notesData[date] || '';
  document.getElementById('noteModal').classList.add('open');
  setTimeout(() => document.getElementById('noteText').focus(), 50);
}

function closeNoteModal() {
  document.getElementById('noteModal').classList.remove('open');
  _noteModalDate = null;
}

function saveNoteFromModal() {
  if (!_noteModalDate) return;
  saveNote(_noteModalDate, document.getElementById('noteText').value);
  closeNoteModal();
  renderDailyBar(); // re-render to show/hide note dot
  renderHeatmap();
}

function deleteNote() {
  if (!_noteModalDate) return;
  delete notesData[_noteModalDate];
  syncNotesToMap();
  closeNoteModal();
  renderDailyBar();
  renderHeatmap();
}

function renderHeatmapNotes() {
  // Add note indicators to heatmap cells
  const cells = document.querySelectorAll('.hm-cell[data-tip]');
  cells.forEach(cell => {
    const date = cell.dataset.tip.split('|')[0]; // not the date — need ISO
    // The tip contains "Mon Jan 6" not ISO — skip for now, notes done via bar chart click
  });
}

/* ═══════════════════════════════════════════════════════
   EXPORT CSV
═══════════════════════════════════════════════════════ */
function exportCSV() {
  if (viewMode === 'gross') {
    showToast('⚠️', 'Export Blocked', 'Switch to UNO Earnings view before exporting — UNO + ULO data is calculated, not actual earnings', '#f59e0b');
    return;
  }
  if (!allData || !allData.length) {
    alert('No data loaded yet. Please upload your earnings files first.');
    return;
  }

  const header = ['Date','Time','LicenseID','LeaseName','Group','Node','Amount_USD','TransactionID'];
  const rows = [...allData]
    .sort((a,b) => a.completedAt < b.completedAt ? -1 : 1)
    .map(r => {
      const l4   = r.licenseId.slice(-4);
      const lMap = window._activeLeaseMap || LEASE_MAP;
      const name = getLeaseNameDynamic(l4, lMap);
      const grp  = getGroupDynamic(l4, r.completedAt.slice(0,10), lMap);
      const node = getNode(l4, lMap);
      const dt   = r.completedAt;
      return [
        dt.slice(0,10),
        dt.slice(11,19),
        r.licenseId,
        name,
        grp,
        'Node ' + node,
        (adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10))).toFixed(6),
        r.id || ''
      ].map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',');
    });

  const csv  = [header.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const today = new Date().toISOString().slice(0,10);
  const filename = `Earnings_File_UnityNodes_${today}.csv`;
  a.href     = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
  showToast('💾', 'File Saved', filename + ' → Downloads folder', '#10b981');
}
/* ═══════════════════════════════════════════════════════
   ARCHIVE BANNER (persistent top-of-page strip)
═══════════════════════════════════════════════════════ */
function buildArchiveBanner() {
  // Populate the Archive PAGE elements (not a banner anymore)
  buildArchivePage();
}

function buildArchivePage() {
  const statusEl  = document.getElementById('arcStatusContent');
  const monthGrid = document.getElementById('arcMonthGrid');
  const fullSum   = document.getElementById('arcFullSummary');
  if (!statusEl || !allData.length) return;

  const MON    = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const now    = new Date();
  const nowYM  = now.toISOString().slice(0,7);

  // Group earnings by month
  const months = {};
  allData.forEach(r => {
    const ym = r.completedAt.slice(0,7);
    if (!months[ym]) months[ym] = { count:0, total:0 };
    months[ym].count++;
    months[ym].total += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
  });
  const sorted  = Object.keys(months).sort();
  const mCount  = sorted.length;
  const allTotal = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);

  // Withdrawal summary
  const allWith = Object.values(withdrawFiles).flat();
  const wSeen = new Set();
  const wDeduped = allWith.filter(w => { const k = w.id || JSON.stringify(w); if (wSeen.has(k)) return false; wSeen.add(k); return true; });
  const hasWithdrawals = wDeduped.length > 0;
  const wTotal = wDeduped.reduce((s,w) => s + (w.amountMicros||0)/1e6, 0);
  const wMonths = new Set(wDeduped.map(w => (w.completedAt||w.createdAt||'').slice(0,7)).filter(d=>d));

  // Current month progress
  const daysIn    = now.getDate();
  const daysTotal = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const pct       = Math.round(daysIn/daysTotal*100);
  const isCurLoaded = sorted.includes(nowYM);
  const nearEnd   = daysIn >= 25 && isCurLoaded;
  const curMonth = isCurLoaded ? months[nowYM] : null;

  // ── Combined status card ──
  statusEl.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.6rem;margin-bottom:.8rem">
      <div style="background:var(--surface2);border-radius:8px;padding:.65rem .8rem;border:1px solid var(--border)">
        <div style="font-size:.58rem;font-weight:700;color:#8b5cf6;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.25rem">💰 Total Earned</div>
        <div style="font-size:1.3rem;font-weight:800;color:#1a5ff5;font-family:var(--font-mono),monospace">$${allTotal.toFixed(2)}</div>
        <div style="font-size:.6rem;color:var(--muted)">${allData.length.toLocaleString()} txns · ${mCount} month${mCount!==1?'s':''}</div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:.65rem .8rem;border:1px solid var(--border)">
        <div style="font-size:.58rem;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.25rem">💸 Total Withdrawn</div>
        <div style="font-size:1.3rem;font-weight:800;color:${hasWithdrawals ? '#10b981' : 'var(--muted)'};font-family:var(--font-mono),monospace">${hasWithdrawals ? '$'+wTotal.toFixed(2) : '—'}</div>
        <div style="font-size:.6rem;color:var(--muted)">${hasWithdrawals ? wDeduped.length+' withdrawal'+(wDeduped.length!==1?'s':'')+' · '+wMonths.size+' month'+(wMonths.size!==1?'s':'') : 'No withdrawal data loaded'}</div>
      </div>
      ${hasWithdrawals ? `
      <div style="background:var(--surface2);border-radius:8px;padding:.65rem .8rem;border:1px solid var(--border)">
        <div style="font-size:.58rem;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.25rem">📊 Net Balance</div>
        <div style="font-size:1.3rem;font-weight:800;color:#f59e0b;font-family:var(--font-mono),monospace">$${(allTotal - wTotal).toFixed(2)}</div>
        <div style="font-size:.6rem;color:var(--muted)">Earned minus withdrawn</div>
      </div>` : ''}
      ${isCurLoaded ? `
      <div style="background:${nearEnd?'rgba(16,185,129,.07)':'rgba(59,130,246,.06)'};border-radius:8px;padding:.65rem .8rem;border:1px solid ${nearEnd?'rgba(16,185,129,.25)':'rgba(59,130,246,.2)'}">
        <div style="font-size:.58rem;font-weight:700;color:${nearEnd?'#10b981':'#3b82f6'};text-transform:uppercase;letter-spacing:.07em;margin-bottom:.25rem">${nearEnd?'⚠ Save Soon!':'Current Month'}</div>
        <div style="font-size:1rem;font-weight:800;color:var(--text);font-family:var(--font-mono),monospace">${MON[now.getMonth()]} ${now.getFullYear()}</div>
        <div style="font-size:.6rem;color:var(--muted);margin-bottom:.4rem">${daysIn} of ${daysTotal} days · $${curMonth.total.toFixed(2)}</div>
        <div style="height:5px;border-radius:3px;background:var(--border);overflow:hidden">
          <div style="height:100%;width:${pct}%;background:${nearEnd?'linear-gradient(90deg,#10b981,#059669)':'linear-gradient(90deg,#3b82f6,#8b5cf6)'};border-radius:3px;transition:width .5s ease"></div>
        </div>
        <div style="font-size:.58rem;color:${nearEnd?'#10b981':'#3b82f6'};margin-top:.25rem;font-weight:600">${pct}% through month${nearEnd?' — save now before month ends!':''}</div>
      </div>` : `
      <div style="background:rgba(245,158,11,.06);border-radius:8px;padding:.65rem .8rem;border:1px solid rgba(245,158,11,.2)">
        <div style="font-size:.58rem;font-weight:700;color:#d97706;text-transform:uppercase;letter-spacing:.07em;margin-bottom:.25rem">Current Month</div>
        <div style="font-size:.75rem;color:var(--muted)">Not loaded — upload this month's Unity export to include it</div>
      </div>`}
    </div>`;

  // ── Month grid ──
  if (monthGrid) {
    monthGrid.innerHTML = sorted.map(ym => {
      const [y,m] = ym.split('-');
      const lbl   = MON[parseInt(m,10)-1] + ' ' + y;
      const isCur = ym === nowYM;
      const col   = isCur ? '#3b82f6' : '#10b981';
      const bgCol = isCur ? 'rgba(59,130,246,.07)' : 'rgba(16,185,129,.06)';
      const bCol  = isCur ? 'rgba(59,130,246,.2)' : 'rgba(16,185,129,.2)';
      return `<div style="background:${bgCol};border:1px solid ${bCol};border-radius:10px;padding:.75rem .9rem">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem">
          <div style="font-size:.82rem;font-weight:800;color:var(--text)">${lbl}</div>
          <div style="font-size:.6rem;font-weight:700;color:${col};background:${bgCol};border:1px solid ${bCol};border-radius:20px;padding:.1rem .45rem">${isCur?'CURRENT':'SAVED'}</div>
        </div>
        <div style="font-size:.67rem;color:var(--muted);margin-bottom:.1rem">${months[ym].count.toLocaleString()} transactions</div>
        <div style="font-size:1rem;font-weight:700;color:#1a5ff5;font-family:var(--font-mono),monospace;margin-bottom:.5rem">$${months[ym].total.toFixed(4)}</div>
        <button onclick="saveMonth('${ym}')" id="arcSaveBtn_${ym.replace('-','_')}"
          style="width:100%;background:${col}18;border:1px solid ${col}40;color:${col};border-radius:7px;padding:.32rem .5rem;font-size:.68rem;font-weight:700;cursor:pointer;">
          ⬇ Save ${MON[parseInt(m,10)-1]} File
        </button>
      </div>`;
    }).join('');
  }

  // ── Full archive summary ──
  if (fullSum) {
    const start = sorted[0]  ? MON[parseInt(sorted[0].split('-',10)[1])-1]+' '+sorted[0].split('-')[0]  : '—';
    const end   = sorted[sorted.length-1] ? MON[parseInt(sorted[sorted.length-1].split('-',10)[1])-1]+' '+sorted[sorted.length-1].split('-')[0] : '—';
    fullSum.textContent = `${allData.length.toLocaleString()} transactions · ${mCount} month${mCount!==1?'s':''} · $${allTotal.toFixed(2)} · ${start} → ${end}`;
  }

  // ── Withdrawal months grid ──
  buildWithdrawalMonths();
}


/* ═══════════════════════════════════════════════════════
   WITHDRAWAL MONTHLY ARCHIVE
═══════════════════════════════════════════════════════ */
function buildWithdrawalMonths() {
  const grid = document.getElementById('arcWithMonthGrid');
  const card = document.getElementById('arcWithMonthsCard');
  const sumEl = document.getElementById('arcWithSummary');
  if (!grid) return;

  const allWith = Object.values(withdrawFiles).flat();
  if (!allWith || !allWith.length) {
    if (card) card.style.display = 'none';
    return;
  }
  if (card) card.style.display = '';

  // Deduplicate
  const seen = new Set();
  const deduped = allWith.filter(w => {
    const key = w.id || JSON.stringify(w);
    if (seen.has(key)) return false;
    seen.add(key); return true;
  });

  // Group by month
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const months = {};
  deduped.forEach(w => {
    const date = w.completedAt || w.createdAt || '';
    const ym = date.slice(0, 7);
    if (!ym) return;
    if (!months[ym]) months[ym] = { count: 0, totalUsd: 0, records: [] };
    months[ym].count++;
    months[ym].totalUsd += (w.amountMicros || 0) / 1e6;
    months[ym].records.push(w);
  });

  const sorted = Object.keys(months).sort();
  const now = new Date();
  const nowYM = now.toISOString().slice(0, 7);

  grid.innerHTML = sorted.map(ym => {
    const [y, m] = ym.split('-');
    const lbl = MON[parseInt(m,10) - 1] + ' ' + y;
    const isCur = ym === nowYM;
    const col = '#10b981';
    const bgCol = isCur ? 'rgba(16,185,129,.1)' : 'rgba(16,185,129,.05)';
    const bCol = isCur ? 'rgba(16,185,129,.3)' : 'rgba(16,185,129,.15)';
    return `<div style="background:${bgCol};border:1px solid ${bCol};border-radius:10px;padding:.75rem .9rem">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.35rem">
        <div style="font-size:.82rem;font-weight:800;color:var(--text)">${lbl}</div>
        ${isCur ? '<div style="font-size:.6rem;font-weight:700;color:#10b981;background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.25);border-radius:20px;padding:.1rem .45rem">CURRENT</div>' : ''}
      </div>
      <div style="font-size:.67rem;color:var(--muted);margin-bottom:.1rem">${months[ym].count} withdrawal${months[ym].count !== 1 ? 's' : ''}</div>
      <div style="font-size:1rem;font-weight:700;color:#10b981;font-family:var(--font-mono),monospace;margin-bottom:.5rem">$${months[ym].totalUsd.toFixed(4)}</div>
      <button onclick="saveWithMonth('${ym}')"
        style="width:100%;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);color:#10b981;border-radius:7px;padding:.32rem .5rem;font-size:.68rem;font-weight:700;cursor:pointer;">
        ⬇ Save ${MON[parseInt(m,10) - 1]} Withdrawals
      </button>
    </div>`;
  }).join('');

  // Update summary text
  if (sumEl) {
    const totalUsd = deduped.reduce((s, w) => s + (w.amountMicros || 0) / 1e6, 0);
    const start = sorted[0] ? MON[parseInt(sorted[0].split('-',10)[1]) - 1] + ' ' + sorted[0].split('-')[0] : '—';
    const end = sorted[sorted.length - 1] ? MON[parseInt(sorted[sorted.length - 1].split('-',10)[1]) - 1] + ' ' + sorted[sorted.length - 1].split('-')[0] : '—';
    sumEl.textContent = `${deduped.length} withdrawal${deduped.length !== 1 ? 's' : ''} · ${sorted.length} month${sorted.length !== 1 ? 's' : ''} · $${totalUsd.toFixed(2)} · ${start} → ${end}`;
  }
}

function saveWithMonth(ym) {
  const allWith = Object.values(withdrawFiles).flat();
  const seen = new Set();
  const monthData = allWith.filter(w => {
    const key = w.id || JSON.stringify(w);
    if (seen.has(key)) return false;
    seen.add(key);
    const date = w.completedAt || w.createdAt || '';
    return date.slice(0, 7) === ym;
  });

  if (!monthData.length) { showToast('⚠️', 'No Data', 'No withdrawals for ' + ym, '#f59e0b'); return; }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const [y, m] = ym.split('-');
  const label = MON[parseInt(m,10) - 1] + '_' + y;

  const blob = new Blob([JSON.stringify(monthData)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Withdraw_File_UnityNodes_${new Date().toISOString().slice(0,10)}_${label}_${monthData.length}records.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('💾', 'Saved', `${label} withdrawals — ${monthData.length} records`, '#10b981');
}


/* ═══════════════════════════════════════════════════════
   MONTHLY ARCHIVE SYSTEM
═══════════════════════════════════════════════════════ */

function saveMonth(ym) {
  const [y, m] = ym.split('-');
  const MON    = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const label  = MON[parseInt(m,10)-1] + '_' + y;

  const monthData = allData.filter(r => r.completedAt.slice(0,7) === ym);
  if (!monthData.length) { alert('No data for ' + label); return; }

  // Output in original Unity JSON format — can be reloaded directly
  const out = monthData.map(r => ({
    id:           r.id           || ('arc_' + r.licenseId.slice(-4) + '_' + r.completedAt.replace(/\D/g,'')),
    licenseId:    r.licenseId,
    amountMicros: r.amountMicros,
    completedAt:  r.completedAt
  }));

  const total = monthData.reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
  const blob  = new Blob([JSON.stringify(out)], { type: 'application/json' });
  const url   = URL.createObjectURL(blob);
  const a     = document.createElement('a');
  a.href      = url;
  a.download  = `Earnings_File_UnityNodes_${new Date().toISOString().slice(0,10)}_${label}_${monthData.length}txns.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('💾', 'Saved', `${label} earnings — ${monthData.length} transactions`, '#10b981');

  // Visual feedback
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = '✅ Saved!';
  btn.style.background = 'rgba(16,185,129,.12)';
  btn.style.borderColor = 'rgba(16,185,129,.3)';
  btn.style.color = '#10b981';
  setTimeout(() => {
    btn.textContent = orig;
    btn.style.background = '';
    btn.style.borderColor = '';
    btn.style.color = '';
  }, 2000);
}

function saveFullArchive() {
  if (!allData || !allData.length) return;

  // Deduplicate by id before saving
  const seen  = new Set();
  const dedup = allData.filter(r => {
    const key = r.id || (r.licenseId + r.completedAt);
    if (seen.has(key)) return false;
    seen.add(key); return true;
  });

  const out = dedup
    .sort((a,b) => a.completedAt < b.completedAt ? -1 : 1)
    .map(r => {
      const out = {
        id:           r.id           || ('arc_' + r.licenseId.slice(-4) + '_' + r.completedAt.replace(/\D/g,'')),
        licenseId:    r.licenseId,
        amountMicros: r.amountMicros,
        completedAt:  r.completedAt
      };
      if (r.nodeId) out.nodeId = r.nodeId;
      return out;
    });

  const start  = out[0].completedAt.slice(0,7).replace('-','_');
  const end    = out[out.length-1].completedAt.slice(0,7).replace('-','_');
  const total  = dedup.reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
  const months = new Set(dedup.map(r => r.completedAt.slice(0,7))).size;

  const blob = new Blob([JSON.stringify(out)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `Archive_Earnings_UnityNodes_${new Date().toISOString().slice(0,10)}_${start}_to_${end}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('📦', 'Archive Saved', `Earnings archive ${start} to ${end}`, '#8b5cf6');

  // Feedback
  const btn = document.querySelector('[onclick="saveFullArchive()"]');
  if (btn) {
    const orig = btn.innerHTML;
    btn.innerHTML = '✅ Archive saved!';
    btn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
    setTimeout(() => { btn.innerHTML = orig; btn.style.background = 'linear-gradient(135deg,#8b5cf6,#7c3aed)'; }, 2500);
  }
}

function saveWithdrawalArchive() {
  const allWith = Object.values(withdrawFiles).flat();
  if (!allWith || !allWith.length) {
    showToast('⚠️', 'No Data', 'No withdrawal files loaded', '#f59e0b');
    return;
  }

  // Deduplicate by id
  const seen = new Set();
  const dedup = allWith.filter(w => {
    const key = w.id || JSON.stringify(w);
    if (seen.has(key)) return false;
    seen.add(key); return true;
  });

  // Sort by date
  dedup.sort((a, b) => {
    const da = a.completedAt || a.createdAt || '';
    const db = b.completedAt || b.createdAt || '';
    return da < db ? -1 : 1;
  });

  const firstDate = (dedup[0].completedAt || dedup[0].createdAt || '').slice(0, 7).replace('-', '_');
  const lastDate = (dedup[dedup.length - 1].completedAt || dedup[dedup.length - 1].createdAt || '').slice(0, 7).replace('-', '_');

  const blob = new Blob([JSON.stringify(dedup)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Archive_Withdraw_UnityNodes_${new Date().toISOString().slice(0,10)}_${firstDate}_to_${lastDate}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('📦', 'Archive Saved', `Withdrawal archive ${firstDate} to ${lastDate}`, '#8b5cf6');

  // Feedback
  const btn = document.getElementById('btnSaveWithArchive');
  if (btn) {
    const orig = btn.innerHTML;
    btn.innerHTML = '✅ Withdrawal archive saved!';
    setTimeout(() => { btn.innerHTML = orig; }, 2500);
  }
}
function printReport() {
  if (viewMode === 'gross') {
    showToast('⚠️', 'Export Blocked', 'Switch to UNO Earnings view before exporting', '#f59e0b');
    return;
  }
  // Re-render all canvases at print resolution before printing
  const origSizes = [];
  document.querySelectorAll('canvas').forEach(cv => {
    origSizes.push({ cv, w: cv.style.width, h: cv.style.height });
  });

  // Show print notice briefly
  const notice = document.createElement('div');
  notice.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--surface);border:1px solid var(--border2);border-radius:14px;padding:1.5rem 2rem;font-size:.9rem;font-weight:600;z-index:99999;box-shadow:0 20px 60px rgba(0,0,0,.4);text-align:center';
  notice.innerHTML = '🖨️ Preparing PDF report…<br><span style="font-size:.72rem;color:var(--muted);font-weight:400">Use "Save as PDF" in the print dialog</span>';
  document.body.appendChild(notice);

  setTimeout(() => {
    document.body.removeChild(notice);
    window.print();
  }, 600);
}


/* ═══════════════════════════════════════════════════════
   CARD COLLAPSE / CLOSE SYSTEM
═══════════════════════════════════════════════════════ */

// State persisted to localStorage
let cardState = {};  // { cardId: 'open' | 'minimized' | 'closed' }

function loadCardState() {
  // Reset card state — prevents stale states from hiding cards after page reorganization
  cardState = {};
  try { localStorage.removeItem('dn_card_state'); } catch(e) {}
}

function saveCardState() {
  try { localStorage.setItem('dn_card_state', JSON.stringify(cardState)); } catch(e) {}
}

function minimizeCard(id) {
  cardState[id] = 'minimized';
  saveCardState();
  applyCardState(id);
  buildRestoreTray();
}

function closeCard(id) {
  cardState[id] = 'closed';
  saveCardState();
  applyCardState(id);
  buildRestoreTray();
}

function restoreCard(id) {
  cardState[id] = 'open';
  saveCardState();
  applyCardState(id);
  buildRestoreTray();
}

function applyCardState(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const state = cardState[id] || 'open';
  if (state === 'closed') {
    el.style.display = 'none';
    return;
  }
  el.style.display = '';
  if (state === 'minimized') {
    el.classList.add('minimized');
    // Update min button tooltip
    const minBtn = el.querySelector('.min-btn');
    if (minBtn) { minBtn.title = 'Expand'; minBtn.textContent = '▲'; }
  } else {
    el.classList.remove('minimized');
    const minBtn = el.querySelector('.min-btn');
    if (minBtn) { minBtn.title = 'Minimize'; minBtn.textContent = '—'; }
  }
}

function toggleMinimize(id) {
  const state = cardState[id] || 'open';
  if (state === 'minimized') restoreCard(id);
  else minimizeCard(id);
}

function buildRestoreTray() {
  let tray = document.getElementById('restoreTray');
  if (!tray) {
    tray = document.createElement('div');
    tray.id = 'restoreTray';
    document.body.appendChild(tray);
  }
  tray.innerHTML = '';

  const closed = Object.entries(cardState)
    .filter(([,v]) => v === 'closed')
    .map(([k]) => k);

  if (!closed.length) { tray.style.display = 'none'; return; }
  tray.style.display = 'flex';

  closed.forEach(id => {
    const el = document.getElementById(id);
    const titleEl = el ? el.querySelector('.sc-title, .ld-title-block') : null;
    const icon = el ? el.querySelector('.sc-title svg') : null;
    // Get clean title text
    let name = id.replace(/^card-/, '').replace(/-/g, ' ');
    if (titleEl) {
      name = titleEl.textContent.trim().replace(/\s+/g,' ').substring(0, 32);
    }
    const chip = document.createElement('div');
    chip.className = 'restore-chip';
    chip.title = 'Click to restore "' + name + '"';
    chip.innerHTML = `<span class="restore-chip-icon">+</span><span class="restore-chip-name">${sanitizeText(name)}</span>`;
    chip.onclick = () => restoreCard(id);
    tray.appendChild(chip);
  });
}


// Inject card control buttons into all .sc cards that have a sc-title
function initCardControls() {
  document.querySelectorAll('.sc').forEach((el, i) => {
    const titleEl = el.querySelector('.sc-title');
    if (!titleEl) return;
    if (!el.id) el.id = 'card-' + i;
    const id = el.id;
    const children = Array.from(el.children);
    const titleIdx = children.indexOf(titleEl);
    let bodyStartIdx = titleIdx + 1;
    if (children[bodyStartIdx] && children[bodyStartIdx].classList.contains('sc-sub')) {
      bodyStartIdx++;
    }
    if (!el.querySelector('.sc-body')) {
      const body = document.createElement('div');
      body.className = 'sc-body';
      const toWrap = children.slice(bodyStartIdx);
      toWrap.forEach(c => body.appendChild(c));
      el.appendChild(body);
    }
    if (el.querySelector('.card-controls')) return;
    const controls = document.createElement('div');
    controls.className = 'card-controls';
    controls.innerHTML = `
      <button class="cc-btn min-btn" onclick="toggleMinimize('${id}')" title="Minimize">—</button>
      <button class="cc-btn close-btn" onclick="closeCard('${id}')" title="Remove from view">✕</button>
    `;
    el.appendChild(controls);
    applyCardState(id);
  });
  buildRestoreTray();
}

/* ═══════════════════════════════════════════════════════
   LEASE DETAIL PAGE
═══════════════════════════════════════════════════════ */

function openLeasePage(last4) {
  // Auto-save any note from the previously open lease
  var prevEl = document.getElementById('ldNoteText');
  var prevHex = window._currentLeaseHex;
  if (prevEl && prevHex) {
    var prevText = prevEl.value.trim();
    var prevKey = 'lease:' + prevHex;
    var prevOld = notesData[prevKey] || '';
    if (prevText !== prevOld) {
      if (prevText) notesData[prevKey] = prevText;
      else delete notesData[prevKey];
      syncNotesToMap();
      neHasUnsavedNotes = true;
      _unsavedBannerDismissed = false;
    }
  }

  window._dashScrollPos = window.scrollY || (document.documentElement && document.documentElement.scrollTop) || 0;
  const lease = leaseData.find(l => l.last4 === last4);
  if (!lease) return;

  const col   = grpCol(lease.group);
  const lMap  = window._activeLeaseMap || LEASE_MAP;
  const displayName = lease.name;

  // All transactions for this lease, sorted by date
  const datesSorted = window._datesSorted || [];
  const txns = allData
    .filter(r => r.licenseId.slice(-4) === last4)
    .sort((a,b) => a.completedAt < b.completedAt ? -1 : 1);

  if (!txns.length) return;

  // ── Basic stats ──
  const vals = txns.map(r => adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)));
  const total   = vals.reduce((a,b)=>a+b,0);
  const avg     = total / vals.length;
  const maxV    = Math.max(...vals);
  const minV    = Math.min(...vals);
  const stddev  = Math.sqrt(vals.map(v=>(v-avg)**2).reduce((a,b)=>a+b,0)/vals.length);

  // Days active vs total days
  const activeDaySet = new Set(txns.map(r=>r.completedAt.slice(0,10)));
  const totalDays = datesSorted.length;
  const activeDays = activeDaySet.size;
  const consistency = Math.round(activeDays/totalDays*100);

  // Streak
  let streak = 0;
  for (let i = datesSorted.length-1; i >= 0; i--) {
    if (activeDaySet.has(datesSorted[i])) streak++;
    else break;
  }

  // Daily totals
  const dailyTotals = {};
  txns.forEach(r => {
    const d = r.completedAt.slice(0,10);
    dailyTotals[d] = (dailyTotals[d]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
  });
  const dailyArr = datesSorted.map(d => ({ d, v: dailyTotals[d]||0 }));

  // Day of week
  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const dowTotals = [0,0,0,0,0,0,0], dowCounts = [0,0,0,0,0,0,0];
  Object.entries(dailyTotals).forEach(([d,v]) => {
    const p = d.split('-');
    const dow = new Date(parseInt(p[0],10),parseInt(p[1],10)-1,parseInt(p[2],10)).getDay();
    dowTotals[dow] += v; dowCounts[dow]++;
  });
  const dowAvgs = dowTotals.map((t,i) => dowCounts[i]>0 ? t/dowCounts[i] : 0);

  // Best / worst days
  const daysSorted_best = Object.entries(dailyTotals).sort((a,b)=>b[1]-a[1]);
  const daysSorted_worst = [...daysSorted_best].reverse();

  // Running total
  let running = 0;
  const runningTotals = txns.map(r => { running += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); return running; });

  // ── Render header ──
  document.getElementById('ld-name').innerHTML = sanitizeText(displayName) + (notesData['lease:'+last4] ? ' <span style="font-size:.65em;opacity:.7;vertical-align:middle" title="This lease has a note">📝</span>' : '');
  document.getElementById('ld-meta').textContent =
    `${lease.group} · Node ${lease.node} · ${txns.length} transactions · ${activeDays} of ${totalDays} days active`;

  var safeGroupName = sanitizeText(lease.group || 'Unassigned');
  var safeCol = /^#[0-9a-fA-F]{3,6}$/.test(col) ? col : '#888888';
  safeHTML('ld-badges', `
    <span class="ld-badge" style="background:${safeCol}18;color:${safeCol};border-color:${safeCol}40">${safeGroupName}</span>
    <span class="ld-badge" style="background:var(--surface2);color:var(--text2);border-color:var(--border)">Node ${lease.node}</span>
    <span class="ld-badge" style="background:${consistency>=90?'rgba(16,185,129,.15)':consistency>=70?'rgba(59,130,246,.12)':'rgba(239,68,68,.12)'};color:${consistency>=90?'#10b981':consistency>=70?'#3b82f6':'#ef4444'};border-color:${consistency>=90?'rgba(16,185,129,.3)':consistency>=70?'rgba(59,130,246,.3)':'rgba(239,68,68,.3)'}">
      ${consistency}% consistency
    </span>
    ${streak > 0 ? `<span class="ld-badge" style="background:rgba(245,158,11,.12);color:#f59e0b;border-color:rgba(245,158,11,.3)">🔥 ${streak}d streak</span>` : ''}
    ${notesData['lease:'+last4] ? `<span class="ld-badge" style="background:rgba(245,158,11,.10);color:#b45309;border-color:rgba(245,158,11,.3)">📝 Has Note</span>` : ''}
  `);

  // ── KPI strip ──
  const kpis = [
    { lbl:'Total Earned',     val:'$'+total.toFixed(4),       sub:'all time',               col:'#3b82f6' },
    { lbl:'Today / Latest',   val:'$'+lease.today.toFixed(4), sub:datesSorted[datesSorted.length-1], col:'#10b981' },
    { lbl:'Avg per Day',      val:'$'+(total/activeDays).toFixed(4), sub:'active days only', col:'#8b5cf6' },
    { lbl:'Avg per Txn',      val:'$'+avg.toFixed(4),          sub:txns.length+' transactions', col:'#f59e0b' },
    { lbl:'Best Single Day',  val:'$'+daysSorted_best[0][1].toFixed(4), sub:fmtDateShort(daysSorted_best[0][0]), col:'#10b981' },
    { lbl:'Worst Active Day', val:'$'+daysSorted_worst[0][1].toFixed(4), sub:fmtDateShort(daysSorted_worst[0][0]), col:'#ef4444' },
    { lbl:'Max Txn',          val:'$'+maxV.toFixed(4),          sub:'highest single reward', col:'#f59e0b' },
  ];
  document.getElementById('ld-kpis').innerHTML = kpis.map(k =>
    `<div class="ld-kpi" style="--kc-col:${k.col}">
      <div class="ld-kpi-lbl">${k.lbl}</div>
      <div class="ld-kpi-val">${k.val}</div>
      <div class="ld-kpi-sub">${k.sub}</div>
    </div>`
  ).join('');

  // ── Node rank ──
  const sameNodeLeases = leaseData.filter(l2 => l2.node === lease.node).sort((a,b) => b.alltime - a.alltime);
  const nodeRank = sameNodeLeases.findIndex(l2 => l2.last4 === last4) + 1;
  const nodeTotal = sameNodeLeases.length;
  const nodeName = (function() { const nids = Object.keys(nodeMap); return nids[lease.node-1] ? nodeMap[nids[lease.node-1]].name : 'Node '+lease.node; })();
  const rankPct = Math.round(nodeRank / nodeTotal * 100);
  const rankBadgeCol = rankPct <= 25 ? '#10b981' : rankPct <= 50 ? '#3b82f6' : rankPct <= 75 ? '#f59e0b' : '#ef4444';

  appendSafeHTML('ld-badges', `
    <span class="ld-badge" style="background:${rankBadgeCol}18;color:${rankBadgeCol};border-color:${rankBadgeCol}40">
      #${nodeRank} of ${nodeTotal} on ${sanitizeText(nodeName)}
    </span>`);

  // ── Active/Inactive day calendar ──
  const calEl = document.getElementById('ld-activity-cal');
  if (calEl) {
    const calDays = datesSorted.map(d => {
      const active = activeDaySet.has(d);
      const dayVal = dailyTotals[d] || 0;
      const p = d.split('-');
      const dayNum = parseInt(p[2],10);
      const bgCol = active ? (dayVal > avg ? '#10b981' : col) : '#ef4444';
      const opacity = active ? (Math.min(1, 0.3 + (dayVal / (maxV || 1) * 0.7))).toFixed(2) : '0.25';
      return `<div title="${fmtDateShort(d)}: ${active ? '$'+dayVal.toFixed(4) : 'INACTIVE'}" style="width:22px;height:22px;border-radius:4px;background:${bgCol};opacity:${opacity};display:flex;align-items:center;justify-content:center;font-size:.42rem;font-weight:700;color:#fff;cursor:default">${dayNum}</div>`;
    }).join('');
    calEl.innerHTML = `
      <div style="font-size:.62rem;color:var(--muted);margin-bottom:.35rem;display:flex;gap:1rem;flex-wrap:wrap">
        <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#10b981;vertical-align:middle"></span> above avg</span>
        <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${col};vertical-align:middle"></span> below avg</span>
        <span><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:#ef4444;opacity:.25;vertical-align:middle"></span> inactive</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:3px">${calDays}</div>`;
  }
  const first = txns[0].completedAt.slice(0,10);
  const last  = txns[txns.length-1].completedAt.slice(0,10);
  document.getElementById('ld-trend-sub').textContent =
    `${fmtDateShort(first)} → ${fmtDateShort(last)} · ${activeDays} active days`;

  // ── Render trend canvas ──
  // Per-day uptime estimates for heatmap
  const dailyUptime = datesSorted.map(d => {
    const dayMap = {};
    (window._byDate && window._byDate[d] || []).forEach(r => {
      const l4 = r.licenseId.slice(-4);
      dayMap[l4] = (dayMap[l4]||0) + 1;
    });
    const n = dayMap[last4] || 0;
    const baseline = window._uptimeBaseline || 1;
    return { d, n, pct: Math.min(100, Math.round(n/baseline*100)) };
  });

  setTimeout(() => {
    renderLeaseDetailTrend(dailyArr, col, lease);
    renderLeaseDetailDist(txns, avg, col);
    renderUptimeHeatmap(dailyUptime, last4);
  }, 50);

  // ── Stats breakdown ──
  const missedDays = totalDays - activeDays;
  const bestDow = dowAvgs.indexOf(Math.max(...dowAvgs));
  const worstDow = dowAvgs.indexOf(Math.min(...dowAvgs.filter(v=>v>0)));
  safeHTML('ld-stats', `
    <div class="proj-row"><span class="proj-lbl">Total earned</span><span class="proj-val accent">$${total.toFixed(4)}</span></div>
    <div class="proj-row"><span class="proj-lbl">Active days</span><span class="proj-val">${activeDays} / ${totalDays} days</span></div>
    <div class="proj-row"><span class="proj-lbl">Missed days</span><span class="proj-val ${missedDays>0?'down':'up'}">${missedDays} days</span></div>
    <div class="proj-row"><span class="proj-lbl">Current streak</span><span class="proj-val ${streak===totalDays?'up':''}">${streak} day${streak!==1?'s':''} ${streak===totalDays?'🔥 (perfect!)':''}</span></div>
    <div class="proj-row"><span class="proj-lbl">Best day of week</span><span class="proj-val up">${DOW[bestDow]} ($${dowAvgs[bestDow].toFixed(4)} avg)</span></div>
    <div class="proj-row"><span class="proj-lbl">Weakest day of week</span><span class="proj-val">${DOW[worstDow]} ($${dowAvgs[worstDow].toFixed(4)} avg)</span></div>
    <div class="proj-row"><span class="proj-lbl">Max single txn</span><span class="proj-val">$${maxV.toFixed(4)}</span></div>
    <div class="proj-row"><span class="proj-lbl">Min single txn</span><span class="proj-val">$${minV.toFixed(4)}</span></div>
    <div class="proj-row"><span class="proj-lbl">Max − Min spread</span><span class="proj-val">$${(maxV-minV).toFixed(4)}</span></div>
    <div class="proj-row"><span class="proj-lbl">Std deviation</span><span class="proj-val">$${stddev.toFixed(4)}</span></div>
    <div class="proj-row"><span class="proj-lbl">Consistency score</span>
      <span class="proj-val" style="color:${consistency>=90?'#10b981':consistency>=70?'#3b82f6':'#ef4444'}">${consistency}/100</span>
    </div>
    <div class="proj-row"><span class="proj-lbl">Txns per active day</span><span class="proj-val">${(txns.length/activeDays).toFixed(1)}</span></div>
    <div class="proj-row">
      <span class="proj-lbl">Est. avg uptime/day <span style="font-size:.58rem;color:var(--muted);font-weight:400">(estimated)</span></span>
      <span class="proj-val" style="color:${(txns.length/activeDays)/(window._uptimeBaseline||1)>=.85?'#10b981':(txns.length/activeDays)/(window._uptimeBaseline||1)>=.6?'#f59e0b':'#ef4444'}">
        ~${Math.min(100,Math.round((txns.length/activeDays)/(window._uptimeBaseline||1)*100))}%
      </span>
    </div>
    <div style="margin-top:.4rem;padding:.5rem .65rem;background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.2);border-radius:7px;font-size:.65rem;color:#b45309;line-height:1.5">
      ⚠️ Uptime is <em>estimated</em> from transaction frequency. Baseline = top-10% txn rate across all your leases (~${window._uptimeBaseline||'?'} txns/day = 100%).
    </div>
  `);

  // ── Day of week ──
  const maxDow = Math.max(...dowAvgs.filter(v=>v>0)) || 1;
  document.getElementById('ld-dow').innerHTML = DOW.map((day,i) => {
    if (!dowCounts[i]) return `<div class="dow-row"><div class="dow-lbl" style="color:var(--muted)">${day}</div><div class="dow-bar-bg" style="flex:1;height:22px;background:var(--surface2);border-radius:5px"></div><div class="dow-count" style="color:var(--muted)">—</div></div>`;
    const pct = (dowAvgs[i]/maxDow*100).toFixed(0);
    const c2 = i===bestDow?'#10b981':i===worstDow?'#ef4444':col;
    return `<div class="dow-row">
      <div class="dow-lbl" style="color:${c2}">${day}${i===bestDow?' 🏆':i===worstDow?' ⬇':''}</div>
      <div class="dow-bar-bg">
        <div class="dow-bar-fill" style="width:${pct}%;background:${c2}">
          <span class="dow-bar-val">$${dowAvgs[i].toFixed(3)}</span>
        </div>
      </div>
      <div class="dow-count">${dowCounts[i]}x</div>
    </div>`;
  }).join('');

  // ── Best/Worst days ──
  const dayRow = (d, v, rank) => `<div class="proj-row">
    <span class="proj-lbl">#${rank} · ${fmtDateShort(d)}</span>
    <span class="proj-val">$${v.toFixed(4)}</span>
  </div>`;
  document.getElementById('ld-best').innerHTML  = daysSorted_best.slice(0,8).map((x,i)=>dayRow(x[0],x[1],i+1)).join('');
  document.getElementById('ld-worst').innerHTML = daysSorted_worst.slice(0,8).map((x,i)=>dayRow(x[0],x[1],i+1)).join('');

  // ── Transaction log ──
  document.getElementById('ld-txn-sub').textContent =
    `${txns.length} transactions · $${avg.toFixed(4)} avg · sorted newest first`;

  const tbody = document.getElementById('ldTxnBody');
  const txnsSorted = [...txns].reverse(); // newest first
  let runRev = total;
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  tbody.innerHTML = txnsSorted.map((r, idx) => {
    const v = adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    const dt = r.completedAt;
    const dateStr = (() => { const p=dt.slice(0,10).split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); })();
    const timeStr = dt.slice(11,16);
    const mult = v/avg;
    const diffPct = ((v-avg)/avg*100).toFixed(1);
    const isHigh = v > avg*1.5, isLow = v < avg*0.5;
    const badge = isHigh
      ? `<span class="txn-badge" style="background:rgba(16,185,129,.15);color:#10b981">${mult.toFixed(1)}×</span>`
      : isLow
      ? `<span class="txn-badge" style="background:rgba(239,68,68,.15);color:#ef4444">${mult.toFixed(1)}×</span>`
      : '';
    const runBefore = runRev;
    runRev -= v;
    return `<tr>
      <td style="color:var(--muted);font-size:.68rem">${txnsSorted.length-idx}</td>
      <td style="font-weight:600">${dateStr}</td>
      <td style="color:var(--muted);font-family:var(--font-mono),monospace;font-size:.7rem">${timeStr}</td>
      <td style="font-family:var(--font-mono),monospace;font-weight:700;color:${col}">$${v.toFixed(4)}${badge}</td>
      <td style="font-size:.7rem;color:${parseFloat(diffPct)>=0?'#10b981':'#ef4444'};font-family:var(--font-mono),monospace">${parseFloat(diffPct)>=0?'+':''}${diffPct}%</td>
      <td style="font-family:var(--font-mono),monospace;font-size:.72rem;color:var(--text2)">$${runBefore.toFixed(4)}</td>
    </tr>`;
  }).join('');

  // ── Lease Notes ──
  const noteKey = 'lease:' + last4;
  const existingNote = notesData[noteKey] || '';
  window._currentLeaseHex = last4;
  const ldNotes = document.getElementById('ld-notes');
  ldNotes.innerHTML = `
    <textarea id="ldNoteText" style="width:100%;min-height:80px;padding:.5rem .7rem;font-size:.72rem;font-family:var(--font-main);border:1px solid var(--border);border-radius:8px;background:var(--surface2);color:var(--text);resize:vertical;outline:none;line-height:1.6" placeholder="Add notes about this lease… e.g. 'Uptime issues since Feb 10', 'Connected via ethernet', 'Runs on Node 2 backup'">${existingNote.replace(/</g,'&lt;')}</textarea>
    <div style="font-size:.54rem;color:var(--muted);margin-top:.3rem">Notes auto-save when you navigate away · Export naming file to keep permanently</div>`;

  // ── Show the page ──
  document.getElementById('dashboard').style.display = 'none';
  const ld = document.getElementById('leaseDetail');
  ld.style.display = 'block';
  ld.scrollTop = 0;
}

function closeLeasePage() {
  // Auto-save any note text in the textarea
  var el = document.getElementById('ldNoteText');
  var hex = window._currentLeaseHex;
  if (el && hex) {
    var text = el.value.trim();
    var key = 'lease:' + hex;
    var oldNote = notesData[key] || '';
    if (text !== oldNote) {
      if (text) notesData[key] = text;
      else delete notesData[key];
      syncNotesToMap();
      neHasUnsavedNotes = true;
      _unsavedBannerDismissed = false;
      showUnsavedBanner();
      showToast('📝', 'Note auto-saved', 'Export naming file to keep permanently', '#10b981');
    }
  }
  window._currentLeaseHex = null;
  document.getElementById('leaseDetail').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  if (window.scrollTo) window.scrollTo(0, window._dashScrollPos || 0);
}

function fmtDateShort(d) {
  if (!d) return '—';
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const p = d.split('-');
  return MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10);
}

/* ── Lease detail: trend canvas ── */
function renderLeaseDetailTrend(dailyArr, col, lease) {
  const cv = document.getElementById('ldTrendCanvas');
  if (!cv) return;
  const W = cv.parentElement.clientWidth || 500;
  const H = 180;
  const dpr = window.devicePixelRatio||1;
  cv.width = W*dpr; cv.height = H*dpr;
  cv.style.width = W+'px'; cv.style.height = H+'px';
  const c = cv.getContext('2d');
  c.scale(dpr, dpr);
  c.clearRect(0,0,W,H);

  const isDark = !document.body.classList.contains('light');
  const gridCol = isDark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.06)';
  const labelCol = isDark ? '#5c6378' : '#9ca3af';
  const pad = {l:55,r:14,t:14,b:36};
  const iW = W-pad.l-pad.r, iH = H-pad.t-pad.b;

  const vals = dailyArr.map(x=>x.v);
  const activeVals = vals.filter(v=>v>0);
  const maxV = activeVals.length ? Math.max(...activeVals)*1.1 : .01;

  // Grid
  for (let i=0;i<=4;i++) {
    const y = pad.t+(iH/4)*i;
    c.strokeStyle=gridCol; c.lineWidth=1;
    c.beginPath(); c.moveTo(pad.l,y); c.lineTo(W-pad.r,y); c.stroke();
    c.fillStyle=labelCol; c.font=`500 9px Inter,sans-serif`; c.textAlign='right';
    c.fillText('$'+(maxV-(maxV/4)*i).toFixed(3), pad.l-4, y+3);
  }

  // Zero line marker for missed days
  const pts = dailyArr.map((x,i) => [pad.l+i*(iW/(dailyArr.length-1||1)), pad.t+iH-(x.v/maxV)*iH]);

  // Missed day markers — red highlight columns for zero-earning days
  dailyArr.forEach((x,i) => {
    if (x.v === 0) {
      const px = pad.l+i*(iW/(dailyArr.length-1||1));
      c.fillStyle = 'rgba(239,68,68,.13)';
      c.fillRect(px-3, pad.t, 6, iH);
      // Red bottom border accent
      c.fillStyle = 'rgba(239,68,68,.45)';
      c.fillRect(px-3, pad.t+iH-2, 6, 2);
    }
  });

  if (!pts.length) return;

  // Area fill — includes zero days (line drops to bottom)
  const grad = c.createLinearGradient(0,pad.t,0,pad.t+iH);
  grad.addColorStop(0, col+'50'); grad.addColorStop(1, col+'05');
  if (pts.length >= 2) {
    c.beginPath();
    c.moveTo(pts[0][0], pad.t+iH);
    pts.forEach(p => c.lineTo(p[0],p[1]));
    c.lineTo(pts[pts.length-1][0], pad.t+iH);
    c.closePath(); c.fillStyle=grad; c.fill();
  }

  // Line — continuous through all points including zeros
  c.beginPath();
  c.moveTo(pts[0][0], pts[0][1]);
  for (let i=1; i<pts.length; i++) c.lineTo(pts[i][0], pts[i][1]);
  c.strokeStyle=col; c.lineWidth=2; c.lineJoin='round'; c.stroke();

  // Dots — green for active, red for zero
  pts.forEach((p,i) => {
    c.beginPath(); c.arc(p[0],p[1],3,0,Math.PI*2);
    if (dailyArr[i].v === 0) {
      c.fillStyle='#ef4444'; c.fill();
      c.strokeStyle='#ef4444'; c.lineWidth=1.5; c.stroke();
    } else {
      c.fillStyle=col; c.fill();
    }
  });

  // Date labels — show first, middle, last
  const labelIdx = [0, Math.floor(dailyArr.length/2), dailyArr.length-1];
  labelIdx.forEach(i => {
    if (i >= dailyArr.length) return;
    const px = pad.l+i*(iW/(dailyArr.length-1||1));
    c.fillStyle=labelCol; c.font=`500 9px Inter,sans-serif`; c.textAlign='center';
    c.fillText(fmtDateShort(dailyArr[i].d), px, H-8);
  });
}

/* ── Uptime heatmap for lease detail ── */
function renderUptimeHeatmap(dailyUptime, last4) {
  const el = document.getElementById('ldUptimeRow');
  if (!el) return;
  const baseline = window._uptimeBaseline || 1;
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  const cells = dailyUptime.map(x => {
    const p = x.d.split('-');
    const label = MON[parseInt(p[1],10)-1] + ' ' + parseInt(p[2],10);
    let bg, textCol;
    if (x.n === 0)        { bg = 'rgba(239,68,68,.15)';    textCol = '#ef4444'; }
    else if (x.pct >= 85) { bg = 'rgba(16,185,129,.18)';   textCol = '#10b981'; }
    else if (x.pct >= 60) { bg = 'rgba(59,130,246,.15)';   textCol = '#3b82f6'; }
    else if (x.pct >= 35) { bg = 'rgba(245,158,11,.15)';   textCol = '#f59e0b'; }
    else                  { bg = 'rgba(239,68,68,.15)';     textCol = '#ef4444'; }

    return `<div title="${label}: ${x.n} txns · ~${x.pct}% uptime (estimated)" style="
      display:flex;flex-direction:column;align-items:center;gap:2px;
      background:${bg};border-radius:6px;padding:4px 3px;flex:1;min-width:28px;cursor:default">
      <div style="font-size:.62rem;font-weight:700;color:${textCol};font-family:var(--font-mono),monospace">${x.n===0?'—':x.pct+'%'}</div>
      <div style="font-size:.52rem;color:var(--muted);white-space:nowrap">${label.split(' ')[1]}</div>
    </div>`;
  }).join('');

  // avg uptime
  const activeDays = dailyUptime.filter(x=>x.n>0);
  const avgUptime = activeDays.length
    ? Math.min(100, Math.round(activeDays.reduce((s,x)=>s+x.pct,0)/activeDays.length))
    : 0;

  el.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.4rem">
      <div style="font-size:.65rem;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.07em">
        Est. Daily Uptime <span style="font-size:.58rem;color:var(--muted);font-weight:400;text-transform:none">(estimated from txn frequency · baseline ~${baseline} txns/day)</span>
      </div>
      <div style="font-size:.72rem;font-weight:700;color:${avgUptime>=85?'#10b981':avgUptime>=60?'#3b82f6':'#ef4444'}">avg ~${avgUptime}%</div>
    </div>
    <div style="display:flex;gap:3px;flex-wrap:nowrap;overflow-x:auto">${cells}</div>
    <div style="font-size:.6rem;color:var(--muted);margin-top:.35rem">
      Hover each cell for details · green ≥85% · blue 60-84% · amber 35-59% · red &lt;35% · — = offline
    </div>`;
}

/* ═══════════════════════════════════════════════════════
   ALL NEW INSIGHT MODULES
═══════════════════════════════════════════════════════ */

function buildAllInsights(allData, byDate, datesSorted, leaseData, withdrawData, lMap) {
  buildProjector(allData, datesSorted, byDate);
  buildPendingWithdrawal(allData, withdrawData, datesSorted);
  buildNodeVsNode(allData, datesSorted, byDate, lMap);
  buildGoneDark(leaseData, byDate, datesSorted);
  buildStreaks(leaseData, byDate, datesSorted);
  buildDOWChart(allData, datesSorted);
  buildConsistency(leaseData, byDate, datesSorted);
  buildOutliers(allData);
  buildNewLeases(leaseData, byDate, datesSorted);
  buildGroupEfficiency(allData, byDate, datesSorted, lMap);
  buildWithdrawIntel(withdrawData, datesSorted);
  buildParticipationAlert(byDate, datesSorted);
}

/* ── 1. MONTHLY PROJECTOR ── */
function buildProjector(allData, datesSorted, byDate) {
  const el = document.getElementById('projectorContent');
  if (!el) return;
  const today = datesSorted[datesSorted.length - 1];
  const [yr, mo] = today.split('-').map(Number);
  const daysInMonth = new Date(yr, mo, 0).getDate();
  const dayOfMonth = parseInt(today.slice(8,10));

  // Daily totals for this month so far
  const thisMonthDates = datesSorted.filter(d => d.startsWith(`${yr}-${String(mo).padStart(2,'0')}`));
  const monthTotal = thisMonthDates.reduce((s,d) => s + (byDate[d]||[]).reduce((ss,r) => ss + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)), 0), 0);
  const daysWithData = thisMonthDates.length;
  const dailyRate = daysWithData > 0 ? monthTotal / daysWithData : 0;
  const projected = dailyRate * daysInMonth;
  const remaining = daysInMonth - dayOfMonth;
  const projectedRemaining = dailyRate * remaining;

  // Last 7 day avg
  const last7 = datesSorted.slice(-7).reduce((s,d) => s + (byDate[d]||[]).reduce((ss,r) => ss + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)), 0), 0) / Math.min(7, datesSorted.length);

  // Month name
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  el.innerHTML = `
    <div class="proj-row">
      <span class="proj-lbl">${MON[mo-1]} so far (${daysWithData} days)</span>
      <span class="proj-val accent">$${monthTotal.toFixed(4)}</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Avg daily rate (this month)</span>
      <span class="proj-val">$${dailyRate.toFixed(4)}/day</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">7-day avg daily rate</span>
      <span class="proj-val">$${last7.toFixed(4)}/day</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Projected ${MON[mo-1]} total (${daysInMonth} days)</span>
      <span class="proj-val up">$${projected.toFixed(2)}</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Still to earn (${remaining} days left)</span>
      <span class="proj-val">~$${projectedRemaining.toFixed(2)}</span>
    </div>
    <div style="margin-top:.75rem">
      <div style="display:flex;justify-content:space-between;font-size:.62rem;color:var(--muted);margin-bottom:.3rem">
        <span>Month progress</span>
        <span>${dayOfMonth} / ${daysInMonth} days (${Math.round(dayOfMonth/daysInMonth*100)}%)</span>
      </div>
      <div style="height:8px;background:var(--surface2);border-radius:4px;overflow:hidden">
        <div style="height:100%;width:${(dayOfMonth/daysInMonth*100).toFixed(1)}%;background:linear-gradient(90deg,#3b82f6,#8b5cf6);border-radius:4px"></div>
      </div>
    </div>
    ${(() => {
      // Trend + confidence range
      const allDailyTotals = datesSorted.map(d => (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0));
      const n = allDailyTotals.length;
      if (n < 7) return '';
      const overall = allDailyTotals.reduce((a,b)=>a+b,0)/n;
      const prev7 = n >= 14 ? allDailyTotals.slice(-14,-7).reduce((a,b)=>a+b,0)/7 : last7;
      const trendMult = prev7 > 0 ? last7/prev7 : 1;
      const trendDir = trendMult >= 1.05 ? '📈 Accelerating' : trendMult <= 0.95 ? '📉 Declining' : '➡️ Steady';
      const trendCol = trendMult >= 1.05 ? '#10b981' : trendMult <= 0.95 ? '#ef4444' : '#f59e0b';
      const projLow = monthTotal + remaining * last7 * 0.85;
      const projHigh = monthTotal + remaining * last7 * 1.15;
      const q90 = overall * 90;
      return '<div style="margin-top:.65rem;padding-top:.55rem;border-top:1px solid var(--border)">' +
        '<div class="proj-row"><span class="proj-lbl">Week-over-week trend</span><span class="proj-val" style="color:'+trendCol+'">'+trendDir+' ('+((trendMult-1)*100).toFixed(1)+'%)</span></div>' +
        '<div class="proj-row"><span class="proj-lbl">'+MON[mo-1]+' confidence range</span><span class="proj-val">$'+projLow.toFixed(2)+' — $'+projHigh.toFixed(2)+'</span></div>' +
        '<div class="proj-row"><span class="proj-lbl">90-day projection</span><span class="proj-val accent">~$'+q90.toFixed(2)+'</span></div>' +
        '</div>';
    })()}`;
}

/* ── 2. PENDING WITHDRAWAL ── */
function buildPendingWithdrawal(allData, withdrawData, datesSorted) {
  const el = document.getElementById('pendingWithdrawal');
  if (!el) return;

  // Find the most recent withdrawal date
  let lastWithDate = null;
  if (withdrawData && withdrawData.length > 0) {
    const sorted = [...withdrawData].sort((a,b) => b.date > a.date ? 1 : -1);
    lastWithDate = sorted[0].date;
  }

  const since = lastWithDate || datesSorted[0];
  const pending = allData.filter(r => r.completedAt.slice(0,10) > since)
    .reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
  const pendingTxns = allData.filter(r => r.completedAt.slice(0,10) > since).length;
  const daysSince = Math.max(1, datesSorted.filter(d => d > since).length);

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmtDate = d => { const p = d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); };

  el.innerHTML = lastWithDate ? `
    <div class="proj-row">
      <span class="proj-lbl">Last withdrawal</span>
      <span class="proj-val">${fmtDate(lastWithDate)}</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Days since last withdrawal</span>
      <span class="proj-val">${daysSince} days</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Earnings since then</span>
      <span class="proj-val up">$${pending.toFixed(4)}</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Transactions since then</span>
      <span class="proj-val">${pendingTxns.toLocaleString()}</span>
    </div>
    <div style="margin-top:.65rem;padding:.65rem .85rem;background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.2);border-radius:8px;font-size:.75rem;color:#10b981;font-weight:600">
      💰 You could withdraw ~$${pending.toFixed(2)} right now
    </div>` :
    `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">
      No withdrawal files loaded — upload your withdrawal JSON to see pending balance.
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Total earned (all data)</span>
      <span class="proj-val up">$${allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0).toFixed(4)}</span>
    </div>`;
}

/* ── 3. NODE VS NODE ── */
function buildNodeVsNode(allData, datesSorted, byDate, lMap) {
  const el = document.getElementById('nodeVsNode');
  if (!el) return;
  const today = datesSorted[datesSorted.length - 1];

  // Gather all unique node numbers from data
  const nodeStats = {};
  allData.forEach(r => {
    const last4 = r.licenseId.slice(-4);
    let node = getNode(last4, lMap);
    // Also try auto-detect from nodeMap
    if (node === 1 && window._licenseNodeMap && window._licenseNodeMap[last4]) {
      const nid = window._licenseNodeMap[last4];
      const nodeIds = Object.keys(nodeMap);
      const idx = nodeIds.indexOf(nid);
      if (idx >= 0) node = idx + 1;
    }
    const v = adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    if (!nodeStats[node]) nodeStats[node] = {total:0, today:0, leases:new Set(), txns:0, max:0, node};
    const nd = nodeStats[node];
    nd.total += v; nd.txns++;
    nd.leases.add(last4);
    if (v > nd.max) nd.max = v;
    if (r.completedAt.slice(0,10) === today) nd.today += v;
  });

  const nodes = Object.values(nodeStats).sort((a,b) => a.node - b.node);

  // If only 1 node, show simple summary
  if (nodes.length <= 1) {
    const n = nodes[0] || {total:0, today:0, leases:new Set(), txns:0, max:0};
    const nodeName = Object.values(nodeMap)[0]?.name || 'Node 1';
    el.innerHTML = `<div style="font-size:.78rem;color:var(--muted);padding:.3rem 0">
      Single node detected: <strong style="color:var(--text)">${nodeName}</strong> — ${n.leases.size} leases, $${n.total.toFixed(4)} total, ${n.txns.toLocaleString()} transactions.
    </div>`;
    return;
  }

  // Color palette for nodes
  const nodeColors = ['#3b82f6','#8b5cf6','#10b981','#f59e0b','#ef4444','#ec4899','#06b6d4','#84cc16'];

  // Build comparison for each metric
  const metricDefs = [
    { lbl:'Total Earned', key:'total', fmt: v=>'$'+v.toFixed(4) },
    { lbl:'Today',        key:'today', fmt: v=>'$'+v.toFixed(4) },
    { lbl:'Transactions', key:'txns',  fmt: v=>v.toLocaleString() },
    { lbl:'Active Leases',key:'leaseCount', fmt: v=>v },
    { lbl:'Max Single Txn',key:'max',  fmt: v=>'$'+v.toFixed(4) },
    { lbl:'Avg per Txn',  key:'avg',   fmt: v=>'$'+v.toFixed(4) },
  ];

  // Compute derived values
  nodes.forEach(n => { n.leaseCount = n.leases.size; n.avg = n.total / Math.max(1, n.txns); });

  // Get node names
  const nodeIds = Object.keys(nodeMap);

  let html = '';
  metricDefs.forEach(m => {
    const vals = nodes.map(n => n[m.key]);
    const maxVal = Math.max(...vals) || 1;
    const winnerIdx = vals.indexOf(Math.max(...vals));

    html += `<div style="margin-bottom:.65rem">
      <div style="font-size:.78rem;color:var(--text);font-weight:800;margin-bottom:.3rem">${m.lbl}</div>`;

    nodes.forEach((n, i) => {
      const col = nodeColors[i % nodeColors.length];
      const pct = (vals[i] / maxVal * 100).toFixed(1);
      const isWinner = i === winnerIdx && nodes.length > 1;
      const nName = (nodeIds[i] && nodeMap[nodeIds[i]]) ? nodeMap[nodeIds[i]].name : ('Node ' + n.node);
      html += `<div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.2rem">
        <div style="font-size:.6rem;font-weight:700;color:${col};min-width:55px;text-align:right">${nName}</div>
        <div style="flex:1;background:var(--surface2);border-radius:3px;height:14px;overflow:hidden">
          <div style="width:${pct}%;background:${col};height:100%;border-radius:3px;transition:width .3s"></div>
        </div>
        <div style="font-size:.64rem;font-weight:600;color:${col};min-width:70px">${m.fmt(vals[i])}${isWinner ? ' ✓' : ''}</div>
      </div>`;
    });

    html += '</div>';
  });

  el.innerHTML = html;
}

/* ── 4. GONE DARK ── */
function buildGoneDark(leaseData, byDate, datesSorted) {
  const el = document.getElementById('goneDark');
  if (!el) return;
  const today = datesSorted[datesSorted.length - 1];
  const last3 = new Set(datesSorted.slice(-3));

  // Which leases earned in last 3 days?
  const recentActive = new Set();
  last3.forEach(d => (byDate[d]||[]).forEach(r => recentActive.add(r.licenseId.slice(-4))));

  // All known leases
  const allKnown = new Set(leaseData.map(l => l.last4));
  const dark = leaseData.filter(l => !recentActive.has(l.last4));

  if (dark.length === 0) {
    el.innerHTML = `<div style="color:#10b981;font-size:.78rem;padding:.5rem 0;font-weight:600">✅ All leases are active — none have gone dark in the last 3 days.</div>`;
    return;
  }

  // Last seen date per lease
  const lastSeen = {};
  datesSorted.forEach(d => (byDate[d]||[]).forEach(r => { lastSeen[r.licenseId.slice(-4)] = d; }));

  const rows = dark.sort((a,b) => (lastSeen[a.last4]||'') < (lastSeen[b.last4]||'') ? -1 : 1).map(l => {
    const ls = lastSeen[l.last4];
    const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const lsStr = ls ? (() => { const p=ls.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); })() : 'Never';
    const daysAgo = ls ? datesSorted.filter(d => d > ls).length : '?';
    const nodeBadge = l.node >= 2 ? `<span class="sm-badge">N${l.node}</span>` : '';
    return `<div class="dark-lease">
      <div>
        <div style="font-size:.78rem;font-weight:600">${l.name}${nodeBadge}</div>
        <div style="font-size:.62rem;color:var(--muted)">Last seen: ${lsStr} · <span style="color:#ef4444">${daysAgo} days ago</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:.5rem">
        <span style="font-size:.72rem;color:var(--muted);font-family:var(--font-mono),monospace">$${l.alltime.toFixed(4)}</span>
        <span class="dark-badge" style="background:${daysAgo>=7?'rgba(239,68,68,.18)':daysAgo>=5?'rgba(245,158,11,.15)':'rgba(239,68,68,.1)'};color:${daysAgo>=7?'#dc2626':daysAgo>=5?'#d97706':'#ef4444'};border-color:${daysAgo>=7?'rgba(220,38,38,.3)':daysAgo>=5?'rgba(217,119,6,.3)':'rgba(239,68,68,.2)'}">${daysAgo}d dark</span>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = `<div style="margin-bottom:.4rem;font-size:.72rem;color:#ef4444;font-weight:600">⚠️ ${dark.length} lease${dark.length>1?'s':''} inactive for 3+ days</div>
    <div class="list-scroll">${rows}</div>`;
}

/* ── 5. STREAKS ── */
function buildStreaks(leaseData, byDate, datesSorted) {
  const el = document.getElementById('streakContent');
  if (!el) return;
  const totalDays = datesSorted.length;

  // For each lease count current consecutive streak from most recent day backwards
  const streaks = leaseData.map(l => {
    let streak = 0;
    for (let i = datesSorted.length - 1; i >= 0; i--) {
      const d = datesSorted[i];
      const active = (byDate[d]||[]).some(r => r.licenseId.slice(-4) === l.last4);
      if (active) streak++;
      else break;
    }
    return { ...l, streak };
  }).filter(l => l.streak > 0).sort((a,b) => b.streak - a.streak);

  const maxStreak = streaks[0]?.streak || 1;
  const top = streaks.slice(0, 15);
  const perfect = streaks.filter(l => l.streak === totalDays);

  const header = perfect.length > 0
    ? `<div style="margin-bottom:.5rem;font-size:.72rem;color:#10b981;font-weight:600">🔥 ${perfect.length} lease${perfect.length>1?'s':''} with a PERFECT ${totalDays}-day streak!</div>`
    : `<div style="margin-bottom:.5rem;font-size:.72rem;color:var(--muted)">Top current streaks (earning every consecutive day)</div>`;

  const rows = top.map(l => {
    const pct  = (l.streak / maxStreak * 100).toFixed(0);
    const col  = grpCol(l.group);
    const flame = l.streak >= totalDays ? '🔥' : l.streak >= totalDays*.75 ? '⚡' : l.streak >= totalDays*.5 ? '✅' : '📊';
    const nodeBadge = l.node >= 2 ? `<span class="sm-badge">N${l.node}</span>` : '';
    const streakNoteIcon = notesData && notesData['lease:' + l.last4] ? ` <span class="note-icon" onclick="event.stopPropagation();showLeaseNotePopup('${l.last4}',event)" style="font-size:.55rem;cursor:pointer" title="View note">📝</span>` : '';
    return `<div class="streak-row">
      <span class="streak-flame">${flame}</span>
      <div style="flex:1;min-width:0">
        <div class="streak-name">${l.name}${nodeBadge}${streakNoteIcon}</div>
        <div class="streak-bar" style="margin-top:3px"><div class="streak-fill" style="width:${pct}%;background:${col}"></div></div>
      </div>
      <span class="streak-days" style="color:${col}">${l.streak}<span style="font-size:.58rem;font-weight:400;color:var(--muted)">d</span></span>
    </div>`;
  }).join('');

  el.innerHTML = header + `<div class="list-scroll">${rows}</div>`;
}

/* ── 6. DAY OF WEEK ── */
function buildDOWChart(allData, datesSorted) {
  const el = document.getElementById('dowChart');
  if (!el || !allData.length) return;

  const DAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const totals = [0,0,0,0,0,0,0];
  const counts  = [0,0,0,0,0,0,0];

  // Use byDate lookup for speed
  datesSorted.forEach(d => {
    const p   = d.split('-');
    const dow = new Date(parseInt(p[0],10), parseInt(p[1],10)-1, parseInt(p[2],10)).getDay();
    const tot = (byDate[d]||[]).reduce((s,r) => s + adjEarn(r.amountMicros, (r.licenseId||'').slice(-4), (r.completedAt||'').slice(0,10)), 0);
    totals[dow] += tot;
    counts[dow]++;
  });

  const avgs    = totals.map((t,i) => counts[i] > 0 ? t/counts[i] : 0);
  const max     = Math.max(...avgs) || 1;
  const bestI   = avgs.indexOf(Math.max(...avgs));
  const worstI  = avgs.indexOf(Math.min(...avgs.filter(v=>v>0)));
  const isDark  = !document.body.classList.contains('light');

  // Build a canvas chart
  const W = el.parentElement.clientWidth - 10 || 320;
  const ROW_H = 32, PAD_L = 42, PAD_R = 10, PAD_T = 8, PAD_B = 24;
  const H = DAYS.length * ROW_H + PAD_T + PAD_B;
  const dpr = window.devicePixelRatio || 1;

  el.innerHTML = `<canvas id="dowCanvas" style="width:100%;display:block"></canvas>
    <div style="display:flex;gap:1.2rem;margin-top:.4rem;flex-wrap:wrap">
      <span style="font-size:.62rem;color:var(--muted)">🏆 Best: <strong style="color:#10b981">${DAYS[bestI]}</strong> avg $${avgs[bestI].toFixed(2)}</span>
      <span style="font-size:.62rem;color:var(--muted)">⬇ Worst: <strong style="color:#ef4444">${DAYS[worstI]}</strong> avg $${avgs[worstI].toFixed(2)}</span>
    </div>`;

  const cv = document.getElementById('dowCanvas');
  cv.width  = W * dpr; cv.height = H * dpr;
  cv.style.width = W + 'px'; cv.style.height = H + 'px';
  const c = cv.getContext('2d');
  c.scale(dpr, dpr);

  const iW = W - PAD_L - PAD_R;
  const gridCol  = isDark ? 'rgba(255,255,255,.05)' : 'rgba(0,0,0,.06)';
  const labelCol = isDark ? '#8e95a8' : '#4b5563';
  const textCol  = isDark ? '#d4d8e3' : '#1a2c38';

  // Grid lines
  [0.25,0.5,0.75,1].forEach(f => {
    const x = PAD_L + iW * f;
    c.beginPath(); c.moveTo(x, PAD_T); c.lineTo(x, H - PAD_B);
    c.strokeStyle = gridCol; c.lineWidth = 1; c.stroke();
    c.fillStyle = labelCol; c.font = '9px DM Sans,sans-serif';
    c.textAlign = 'center';
    c.fillText('$'+(max*f).toFixed(2), x, H - PAD_B + 12);
  });

  // Bars
  DAYS.forEach((day, i) => {
    const y   = PAD_T + i * ROW_H;
    const bH  = ROW_H * 0.52;
    const by  = y + (ROW_H - bH) / 2;
    const bW  = avgs[i] / max * iW;
    const pct = avgs[i] / max;
    const col = i === bestI  ? '#10b981'
              : i === worstI ? '#ef4444'
              : pct >= .75   ? '#3b82f6'
              : pct >= .5    ? '#8b5cf6'
              :                '#f59e0b';

    // Bar bg
    c.fillStyle = isDark ? 'rgba(255,255,255,.04)' : 'rgba(0,0,0,.04)';
    c.beginPath(); c.roundRect(PAD_L, by, iW, bH, 4); c.fill();

    // Bar fill with gradient
    if (bW > 2) {
      const grad = c.createLinearGradient(PAD_L, 0, PAD_L + bW, 0);
      grad.addColorStop(0, col + 'cc');
      grad.addColorStop(1, col);
      c.fillStyle = grad;
      c.beginPath(); c.roundRect(PAD_L, by, bW, bH, 4); c.fill();
    }

    // Day label
    const badge = i === bestI ? ' 🏆' : i === worstI ? ' ↓' : '';
    c.fillStyle = i === bestI ? '#10b981' : i === worstI ? '#ef4444' : labelCol;
    c.font = `${i === bestI || i === worstI ? '700' : '500'} 10px DM Sans,sans-serif`;
    c.textAlign = 'right';
    c.fillText(day, PAD_L - 6, by + bH/2 + 3.5);

    // Value label inside bar
    if (bW > 50 && avgs[i] > 0) {
      c.fillStyle = '#fff';
      c.font = '600 9.5px JetBrains Mono,monospace';
      c.textAlign = 'left';
      c.fillText('$' + avgs[i].toFixed(2), PAD_L + bW - 50, by + bH/2 + 3.5);
    }

    // Count badge
    c.fillStyle = labelCol;
    c.font = '9px DM Sans,sans-serif';
    c.textAlign = 'left';
    c.fillText(counts[i] + 'x', PAD_L + iW + 4, by + bH/2 + 3.5);
  });
}

/* ── 7. CONSISTENCY SCORES ── */
function buildConsistency(leaseData, byDate, datesSorted) {
  const el = document.getElementById('consistencyContent');
  if (!el) return;
  const totalDays = datesSorted.length;

  const scored = leaseData.map(l => {
    let activeDays = 0;
    datesSorted.forEach(d => {
      if ((byDate[d]||[]).some(r => r.licenseId.slice(-4) === l.last4)) activeDays++;
    });
    const score = Math.round(activeDays / totalDays * 100);
    return { ...l, score, activeDays };
  }).sort((a,b) => b.score - a.score);

  const getScoreStyle = (s) => {
    if (s >= 95) return { bg:'rgba(16,185,129,.18)', col:'#10b981', border:'rgba(16,185,129,.3)' };
    if (s >= 80) return { bg:'rgba(59,130,246,.15)', col:'#3b82f6', border:'rgba(59,130,246,.25)' };
    if (s >= 60) return { bg:'rgba(245,158,11,.12)', col:'#f59e0b', border:'rgba(245,158,11,.25)' };
    return { bg:'rgba(239,68,68,.12)', col:'#ef4444', border:'rgba(239,68,68,.25)' };
  };

  const perfect = scored.filter(l => l.score === 100).length;
  const header = perfect > 0
    ? `<div style="margin-bottom:.5rem;font-size:.72rem;color:#10b981;font-weight:600">⭐ ${perfect} lease${perfect>1?'s':''} with 100% consistency</div>`
    : '';

  const rows = scored.slice(0,20).map(l => {
    const s = getScoreStyle(l.score);
    const consNoteIcon = notesData && notesData['lease:' + l.last4] ? ` <span class="note-icon" onclick="event.stopPropagation();showLeaseNotePopup('${l.last4}',event)" style="font-size:.55rem;cursor:pointer" title="View note">📝</span>` : '';
    return `<div class="cons-row">
      <div class="cons-score" style="background:${s.bg};color:${s.col};border:1.5px solid ${s.border}">${l.score}</div>
      <div style="flex:1;min-width:0">
        <div class="cons-name">${l.name}${l.node >= 2 ? '<span class="sm-badge">N'+l.node+'</span>' : ''}${consNoteIcon}</div>
        <div style="margin-top:3px;height:4px;border-radius:3px;background:var(--border);overflow:hidden">
          <div style="height:100%;width:${l.score}%;background:${s.col};border-radius:3px;transition:width .4s ease"></div>
        </div>
      </div>
      <div style="font-family:var(--font-mono),monospace;font-size:.72rem;font-weight:700;color:${s.col};flex-shrink:0">${l.activeDays}<span style="font-size:.58rem;font-weight:400;color:var(--muted)">/${totalDays}d</span></div>
    </div>`;
  }).join('');

  el.innerHTML = header + `<div class="list-scroll">${rows}</div>`;
}

/* ── 8. OUTLIERS ── */
function buildOutliers(allData) {
  const el = document.getElementById('outlierContent');
  if (!el) return;
  const avg = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0)/allData.length;
  const threshold = avg * 2.5;

  const outliers = allData
    .filter(r => adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)) >= threshold)
    .map(r => ({ ...r, v: adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)), mult: (adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10))/avg) }))
    .sort((a,b) => b.v - a.v)
    .slice(0, 20);

  if (outliers.length === 0) {
    el.innerHTML = `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">No outliers found — all transactions are within 2.5× the average.</div>`;
    return;
  }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmtDate = d => { const p=d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); };

  const rows = outliers.map(r => {
    const l4   = r.licenseId.slice(-4);
    const name = getLeaseNameDynamic(l4, window._activeLeaseMap||LEASE_MAP);
    const grp  = getGroupDynamic(l4, r.completedAt.slice(0,10), window._activeLeaseMap||{});
    const col  = grpCol(grp);
    const barW = Math.min(100, (r.mult / (outliers[0]?.mult||1) * 100)).toFixed(1);
    let oNode = 1;
    if (window._licenseNodeMap && window._licenseNodeMap[l4]) {
      const nidx = Object.keys(nodeMap).indexOf(window._licenseNodeMap[l4]);
      if (nidx >= 0) oNode = nidx + 1;
    }
    const nodeBadge = oNode >= 2 ? `<span class="sm-badge">N${oNode}</span>` : '';
    return `<div class="outlier-row" style="border-left:3px solid ${col}20">
      <div style="display:flex;align-items:center;gap:.4rem;min-width:0;flex:1">
        <span class="outlier-mult" style="background:${col}18;color:${col}">${r.mult.toFixed(1)}×</span>
        <div style="min-width:0;flex:1">
          <div class="outlier-name">${sanitizeText(name)}${nodeBadge}</div>
          <div style="margin-top:2px;height:3px;border-radius:2px;background:var(--border)">
            <div style="height:100%;width:${barW}%;background:${col};border-radius:2px"></div>
          </div>
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div class="outlier-val">$${r.v.toFixed(4)}</div>
        <div style="font-size:.6rem;color:var(--muted)">${fmtDate(r.completedAt.slice(0,10))}</div>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = `
    <div style="display:flex;gap:1.4rem;margin-bottom:.7rem;flex-wrap:wrap">
      <div style="font-size:.72rem;color:var(--muted)">Avg txn <strong style="color:var(--text);font-family:var(--font-mono),monospace">$${avg.toFixed(4)}</strong></div>
      <div style="font-size:.72rem;color:var(--muted)">Threshold (2.5×) <strong style="color:#f59e0b;font-family:var(--font-mono),monospace">$${threshold.toFixed(4)}</strong></div>
      <div style="font-size:.72rem;color:var(--muted)">Found <strong style="color:var(--text)">${outliers.length}</strong> outlier${outliers.length!==1?'s':''}</div>
    </div>
    <div class="list-scroll">${rows}</div>`;
}

/* ── 9. NEW & RETURNING LEASES ── */
function buildNewLeases(leaseData, byDate, datesSorted) {
  const el = document.getElementById('newLeasesContent');
  if (!el) return;
  if (datesSorted.length < 4) {
    el.innerHTML = `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">Need more data — upload at least 4 days to detect new/returning leases.</div>`;
    return;
  }

  const firstSeen = {}, lastSeen = {};
  datesSorted.forEach(d => {
    (byDate[d]||[]).forEach(r => {
      const l4 = r.licenseId.slice(-4);
      if (!firstSeen[l4]) firstSeen[l4] = d;
      lastSeen[l4] = d;
    });
  });

  const cutoff = datesSorted[Math.max(0, datesSorted.length - 4)]; // last 4 days
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmtDate = d => { const p=d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); };

  // New = first seen in last 4 days AND wasn't in earlier data
  const newLeases = leaseData.filter(l => firstSeen[l.last4] >= cutoff);
  // Returning = disappeared for 3+ days then came back in last 2 days
  const recentDates = new Set(datesSorted.slice(-2));
  const returning = leaseData.filter(l => {
    const fs = firstSeen[l.last4], ls = lastSeen[l.last4];
    if (fs >= cutoff) return false; // that's new, not returning
    const gap = datesSorted.filter(d => d > fs && d < ls &&
      !(byDate[d]||[]).some(r => r.licenseId.slice(-4) === l.last4)).length;
    return gap >= 3 && recentDates.has(ls);
  });

  let html = '';
  if (newLeases.length === 0 && returning.length === 0) {
    html = `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">No newly appeared or returning leases in the last 4 days.</div>`;
  }
  if (newLeases.length > 0) {
    html += `<div style="font-size:.7rem;font-weight:700;color:#10b981;margin-bottom:.35rem;text-transform:uppercase;letter-spacing:.06em">🆕 New (${newLeases.length})</div>`;
    html += newLeases.map(l => {
      const nBadge = l.node >= 2 ? `<span class="sm-badge">N${l.node}</span>` : '';
      return `<div class="newlease-row">
      <span class="new-badge" style="background:rgba(16,185,129,.12);color:#10b981;border-color:rgba(16,185,129,.3)">NEW</span>
      <span style="font-size:.78rem;font-weight:600;flex:1">${l.name}${nBadge}</span>
      <span style="font-size:.65rem;color:var(--muted)">First seen ${fmtDate(firstSeen[l.last4])}</span>
    </div>`;}).join('');
  }
  if (returning.length > 0) {
    html += `<div style="font-size:.7rem;font-weight:700;color:#f59e0b;margin:.5rem 0 .35rem;text-transform:uppercase;letter-spacing:.06em">↩ Returning (${returning.length})</div>`;
    html += returning.map(l => {
      const nBadge = l.node >= 2 ? `<span class="sm-badge">N${l.node}</span>` : '';
      return `<div class="newlease-row">
      <span class="new-badge" style="background:rgba(245,158,11,.12);color:#f59e0b;border-color:rgba(245,158,11,.3)">BACK</span>
      <span style="font-size:.78rem;font-weight:600;flex:1">${l.name}${nBadge}</span>
      <span style="font-size:.65rem;color:var(--muted)">Back ${fmtDate(lastSeen[l.last4])}</span>
    </div>`;}).join('');
  }
  el.innerHTML = `<div class="list-scroll">${html}</div>`;
}

/* ── 10. GROUP EFFICIENCY ── */
function buildGroupEfficiency(allData, byDate, datesSorted, lMap) {
  const el = document.getElementById('groupEfficiency');
  if (!el) return;
  const totalDays = datesSorted.length || 1;

  // Per group: total earned, active lease-days
  const grpEarnings = {}, grpLeaseDays = {};
  getGroupsAll().forEach(g => { grpEarnings[g] = 0; grpLeaseDays[g] = 0; });

  datesSorted.forEach(d => {
    const seen = {};
    (byDate[d]||[]).forEach(r => {
      const l4 = r.licenseId.slice(-4);
      const g = getGroupDynamic(l4, d, lMap);
      grpEarnings[g] = (grpEarnings[g]||0) + adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
      if (!seen[l4]) { grpLeaseDays[g] = (grpLeaseDays[g]||0) + 1; seen[l4] = 1; }
    });
  });

  // avg per active lease-day
  const efficiency = getGroupsAll().map(g => ({
    g,
    earn: grpEarnings[g]||0,
    leaseDays: grpLeaseDays[g]||0,
    effPerDay: grpLeaseDays[g] > 0 ? (grpEarnings[g]||0)/grpLeaseDays[g] : 0,
    leaseCount: new Set(allData.filter(r => getGroupDynamic(r.licenseId.slice(-4), r.completedAt.slice(0,10), lMap) === g).map(r=>r.licenseId.slice(-4))).size
  })).filter(x => x.earn > 0).sort((a,b) => b.effPerDay - a.effPerDay);

  const maxEff = efficiency[0]?.effPerDay || 1;
  const rows = efficiency.map(x => {
    const col = grpCol(x.g);
    const pct = (x.effPerDay/maxEff*100).toFixed(1);
    return `<div class="grp-eff-row">
      <div class="grp-eff-lbl" style="color:${col}">${grpLabel(x.g)}</div>
      <div class="grp-eff-bg">
        <div class="grp-eff-fill" style="width:${pct}%;background:${col}">
          <span class="grp-eff-val">$${x.effPerDay.toFixed(4)}</span>
          <span class="grp-eff-count">${x.leaseCount} leases</span>
        </div>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = rows + `<div style="font-size:.62rem;color:var(--muted);margin-top:.3rem">$/lease-day = earnings per active lease per day — true efficiency metric</div>`;
}

/* ── 11. WITHDRAWAL INTELLIGENCE ── */
function buildWithdrawIntel(withdrawData, datesSorted) {
  const el = document.getElementById('withdrawIntel');
  if (!el) return;

  if (!withdrawData || withdrawData.length === 0) {
    el.innerHTML = `<div style="color:var(--muted);font-size:.78rem;padding:.5rem 0">No withdrawal files loaded — upload your withdrawal JSON to see intelligence.</div>`;
    return;
  }

  // Date range from earnings data
  const rangeStart = datesSorted && datesSorted.length ? datesSorted[0] : null;
  const rangeEnd = datesSorted && datesSorted.length ? datesSorted[datesSorted.length-1] : null;
  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const fmtDate = d => { const p=d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10); };
  const fmtDateFull = d => { const p=d.split('-'); return MON[parseInt(p[1],10)-1]+' '+parseInt(p[2],10)+', '+p[0]; };

  // Count total withdrawals from all files (pre-filter) for context
  const allWithRaw = typeof withdrawFiles !== 'undefined' ? Object.values(withdrawFiles).flat() : [];
  const totalWithCount = allWithRaw.length > 0
    ? [...new Set(allWithRaw.map(w => w.id || JSON.stringify(w)))].length
    : withdrawData.length;

  const sorted = [...withdrawData].sort((a,b) => a.date > b.date ? 1 : -1);
  const totalUSD = sorted.reduce((s,w) => s + (w.usd||0), 0);
  const totalADA = sorted.reduce((s,w) => s + (w.ada||0), 0);
  const avgADARate = totalADA > 0 ? totalUSD/totalADA : 0;
  const rates = sorted.filter(w=>w.ada>0&&w.usd>0).map(w=>w.usd/w.ada);
  const maxRate = rates.length ? Math.max(...rates) : 0;
  const minRate = rates.length ? Math.min(...rates) : 0;

  // Gaps between withdrawals
  const gaps = [];
  for (let i=1;i<sorted.length;i++) {
    const a = new Date(sorted[i-1].date), b = new Date(sorted[i].date);
    gaps.push(Math.round((b-a)/(1000*60*60*24)));
  }
  const avgGap = gaps.length ? gaps.reduce((a,b)=>a+b,0)/gaps.length : 0;

  // Build scope note
  const scopeNote = (rangeStart && rangeEnd)
    ? `<div style="background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:6px;padding:.4rem .6rem;margin-bottom:.7rem;font-size:.62rem;color:#3b82f6;line-height:1.5">
        ℹ️ Showing <strong>${sorted.length} of ${totalWithCount} withdrawal${totalWithCount!==1?'s':''}</strong> that fall within your earnings data range (<strong>${fmtDateFull(rangeStart)}</strong> – <strong>${fmtDateFull(rangeEnd)}</strong>). See <em>Withdrawal Summary</em> for the complete history.
      </div>`
    : '';

  el.innerHTML = `
    ${scopeNote}
    <div class="with-intel-grid">
      <div class="with-intel-card">
        <div class="with-intel-lbl">Total Withdrawn</div>
        <div class="with-intel-val" style="color:#10b981">$${totalUSD.toFixed(2)}</div>
      </div>
      <div class="with-intel-card">
        <div class="with-intel-lbl">Total ADA</div>
        <div class="with-intel-val">₳${totalADA.toFixed(2)}</div>
      </div>
      <div class="with-intel-card">
        <div class="with-intel-lbl">Avg ADA Rate</div>
        <div class="with-intel-val">$${avgADARate.toFixed(4)}</div>
      </div>
      <div class="with-intel-card">
        <div class="with-intel-lbl">Withdrawals</div>
        <div class="with-intel-val">${sorted.length}</div>
      </div>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Best rate received</span>
      <span class="proj-val up">$${maxRate.toFixed(4)}/ADA</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Worst rate received</span>
      <span class="proj-val down">$${minRate.toFixed(4)}/ADA</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Avg days between withdrawals</span>
      <span class="proj-val">${avgGap.toFixed(1)} days</span>
    </div>
    <div class="proj-row">
      <span class="proj-lbl">Last withdrawal</span>
      <span class="proj-val">${fmtDate(sorted[sorted.length-1].date)}</span>
    </div>
    <div style="margin-top:.65rem">
      <div style="font-size:.62rem;color:var(--muted);margin-bottom:.4rem;font-weight:600;text-transform:uppercase;letter-spacing:.06em">Rate history per withdrawal</div>
      ${sorted.filter(w=>w.ada>0&&w.usd>0).map(w => {
        const rate = w.usd/w.ada;
        const pct = maxRate > 0 ? (rate/maxRate*100).toFixed(0) : 0;
        const col = rate >= avgADARate ? '#10b981' : '#ef4444';
        return `<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.3rem">
          <span style="font-size:.62rem;color:var(--muted);width:54px;flex-shrink:0">${fmtDate(w.date)}</span>
          <div style="flex:1;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden">
            <div style="width:${pct}%;height:100%;background:${col};border-radius:3px"></div>
          </div>
          <span style="font-size:.62rem;font-family:var(--font-mono),monospace;color:${col};width:60px;text-align:right">$${rate.toFixed(4)}</span>
        </div>`;
      }).join('')}
    </div>`;
}

/* ── 12. PARTICIPATION DROP ALERT ── */
function buildParticipationAlert(byDate, datesSorted) {
  const el = document.getElementById('participationAlertCard');
  if (!el || datesSorted.length < 2) return;

  const today = datesSorted[datesSorted.length-1];
  const yesterday = datesSorted[datesSorted.length-2];
  const totalKnown = window._totalKnownLeases || 1;

  const todayAct = new Set((byDate[today]||[]).map(r=>r.licenseId)).size;
  const yestAct  = new Set((byDate[yesterday]||[]).map(r=>r.licenseId)).size;
  const drop = yestAct > 0 ? (yestAct - todayAct) / yestAct : 0;

  if (drop >= 0.10) {
    el.style.display = 'block';
    el.innerHTML = `<div class="part-alert">
      <div class="part-alert-icon">⚠️</div>
      <div>
        <div class="part-alert-title">Participation Drop Detected</div>
        <div class="part-alert-body">
          Active leases dropped from <strong>${yestAct}</strong> yesterday to <strong>${todayAct}</strong> today —
          a <strong style="color:#ef4444">${(drop*100).toFixed(1)}% decline</strong>.
          ${todayAct < totalKnown * 0.7 ? ' Participation is now below 70% threshold.' : ''}
          Check your nodes if this is unexpected.
        </div>
      </div>
    </div>`;
  } else {
    el.style.display = 'none';
  }
}

/* ═══════════════════════════════════════════════════════
   TOOLS PAGE FUNCTIONS
═══════════════════════════════════════════════════════ */

/* ── DATA HEALTH CHECK ── */
function buildHealthCheck() {
  const el = document.getElementById('healthCheckContent');
  if (!el || !allData.length) return;
  const issues = [];
  const warnings = [];
  const ok = [];

  // 1. Check for timeline gaps
  const ds = datesSorted;
  const gaps = [];
  for (let i = 1; i < ds.length; i++) {
    const d1 = new Date(ds[i-1]), d2 = new Date(ds[i]);
    const diff = Math.round((d2 - d1) / 86400000);
    if (diff > 1) gaps.push({ after: ds[i-1], before: ds[i], days: diff - 1 });
  }
  if (gaps.length > 0) {
    const gapList = gaps.slice(0,5).map(g => `${g.days}d gap after ${g.after}`).join(', ');
    issues.push({ icon:'📅', txt:`<strong>${gaps.length} timeline gap${gaps.length>1?'s':''}:</strong> ${gapList}${gaps.length>5?' + '+(gaps.length-5)+' more':''}. You may need to re-export from Unity to fill missing days.` });
  } else {
    ok.push({ icon:'✅', txt:'<strong>No timeline gaps</strong> — continuous data with no missing days.' });
  }

  // 2. Check for duplicate lease IDs across different nodes
  const leaseNodes = {};
  allData.forEach(r => {
    const l4 = r.licenseId.slice(-4);
    const nid = r.nodeId || '';
    if (!leaseNodes[l4]) leaseNodes[l4] = new Set();
    if (nid) leaseNodes[l4].add(nid);
  });
  const multiNode = Object.entries(leaseNodes).filter(([k,v]) => v.size > 1);
  if (multiNode.length > 0) {
    const names = multiNode.slice(0,4).map(([k]) => sanitizeText(getLeaseName(k))).join(', ');
    warnings.push({ icon:'⚠️', txt:`<strong>${multiNode.length} lease${multiNode.length>1?'s':''} appear on multiple nodes:</strong> ${names}${multiNode.length>4?' + '+(multiNode.length-4)+' more':''}. This may indicate node reassignment or a data issue.` });
  } else {
    ok.push({ icon:'✅', txt:'<strong>No cross-node duplicates</strong> — every lease is assigned to exactly one node.' });
  }

  // 3. Check for zero-earning days
  const zeroDays = ds.filter(d => !(byDate[d]||[]).length || (byDate[d]||[]).reduce((s,r)=>s+r.amountMicros,0) === 0);
  if (zeroDays.length > 0) {
    warnings.push({ icon:'🔇', txt:`<strong>${zeroDays.length} day${zeroDays.length>1?'s':''} with zero earnings.</strong> This could indicate all nodes were offline or data wasn't captured.` });
  } else {
    ok.push({ icon:'✅', txt:'<strong>No zero-earning days</strong> — every day in your data has at least some earnings.' });
  }

  // 4. Check data recency
  const lastDate = ds[ds.length-1];
  const today = new Date().toISOString().slice(0,10);
  const daysSince = Math.round((new Date(today) - new Date(lastDate)) / 86400000);
  if (daysSince > 2) {
    warnings.push({ icon:'🕐', txt:`<strong>Data is ${daysSince} days old</strong> — last record is from ${lastDate}. Upload a fresh Unity export to bring it current.` });
  } else {
    ok.push({ icon:'✅', txt:`<strong>Data is current</strong> — latest record from ${lastDate}.` });
  }

  // 5. Check for unusually low-earning leases (might be broken)
  const leaseAvgs = {};
  allData.forEach(r => {
    const l4 = r.licenseId.slice(-4);
    if (!leaseAvgs[l4]) leaseAvgs[l4] = { sum:0, count:0 };
    leaseAvgs[l4].sum += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10));
    leaseAvgs[l4].count++;
  });
  const globalAvg = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0) / Object.keys(leaseAvgs).length;
  const suspectLeases = Object.entries(leaseAvgs).filter(([k,v]) => v.sum < globalAvg * 0.1 && v.count > 3);
  if (suspectLeases.length > 0) {
    const names2 = suspectLeases.slice(0,4).map(([k]) => sanitizeText(getLeaseName(k))).join(', ');
    warnings.push({ icon:'🐌', txt:`<strong>${suspectLeases.length} lease${suspectLeases.length>1?'s':''} earning <10% of average:</strong> ${names2}. These may have issues.` });
  }

  // 6. Check withdrawal data availability
  const allWith = Object.values(withdrawFiles).flat();
  if (!allWith.length) {
    warnings.push({ icon:'💸', txt:'<strong>No withdrawal data loaded.</strong> Upload withdrawal JSON files to unlock balance tracking and withdrawal analytics.' });
  } else {
    ok.push({ icon:'✅', txt:`<strong>Withdrawal data loaded</strong> — ${allWith.length} record${allWith.length>1?'s':''}.` });
  }

  // 7. Check naming file
  const namedLeases = leaseData.filter(l => l.name !== l.last4 && !l.name.startsWith('…')).length;
  const totalLeases2 = leaseData.length;
  if (namedLeases < totalLeases2 * 0.5) {
    warnings.push({ icon:'🏷️', txt:`<strong>Only ${namedLeases} of ${totalLeases2} leases named</strong> (${Math.round(namedLeases/totalLeases2*100)}%). Upload a naming file or use the Names Editor to label them.` });
  } else {
    ok.push({ icon:'✅', txt:`<strong>${namedLeases} of ${totalLeases2} leases named</strong> (${Math.round(namedLeases/totalLeases2*100)}%).` });
  }

  const allItems = [...issues.map(i=>({...i,type:'issue'})), ...warnings.map(w=>({...w,type:'warn'})), ...ok.map(o=>({...o,type:'ok'}))];
  const issueCount = issues.length;
  const warnCount = warnings.length;

  const headerCol = issueCount > 0 ? '#ef4444' : warnCount > 0 ? '#f59e0b' : '#10b981';
  const headerIcon = issueCount > 0 ? '🔴' : warnCount > 0 ? '🟡' : '🟢';
  const headerTxt = issueCount > 0 ? `${issueCount} issue${issueCount>1?'s':''} found` : warnCount > 0 ? `${warnCount} warning${warnCount>1?'s':''}` : 'All checks passed!';

  safeHTML(el, `
    <div style="font-size:.82rem;font-weight:800;color:${headerCol};margin-bottom:.6rem">${headerIcon} ${headerTxt}</div>
    ${allItems.map(item => {
      const bg = item.type === 'issue' ? 'rgba(239,68,68,.08)' : item.type === 'warn' ? 'rgba(245,158,11,.08)' : 'rgba(16,185,129,.06)';
      const border = item.type === 'issue' ? 'rgba(239,68,68,.2)' : item.type === 'warn' ? 'rgba(245,158,11,.2)' : 'rgba(16,185,129,.15)';
      return `<div style="background:${bg};border:1px solid ${border};border-radius:8px;padding:.5rem .7rem;margin-bottom:.4rem;font-size:.72rem;line-height:1.5;display:flex;align-items:flex-start;gap:.4rem">
        <span style="flex-shrink:0">${item.icon}</span><span>${item.txt}</span>
      </div>`;
    }).join('')}`);

  // Update health badge on Tools tab
  const badge = document.getElementById('healthBadge');
  if (badge) {
    const total = issueCount + warnCount;
    if (total > 0) {
      badge.textContent = total;
      badge.style.display = 'inline-block';
      badge.style.background = issueCount > 0 ? '#ef4444' : '#f59e0b';
    } else {
      badge.style.display = 'none';
    }
  }
}

/* ── TOOL SECTION TOGGLE ── */
function toggleToolSection(id) {
  const el = document.getElementById(id);
  const tog = document.getElementById(id + 'Toggle');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = '';
    if (tog) tog.textContent = '▼';
  } else {
    el.style.display = 'none';
    if (tog) tog.textContent = '▶';
  }
}

/* ── COMPACT VIEW OVERLAY ── */
function toggleCompactView() {
  const overlay = document.getElementById('compactOverlay');
  if (!overlay) return;
  if (overlay.style.display === 'flex') {
    overlay.style.display = 'none';
  } else {
    buildCompactView();
    overlay.style.display = 'flex';
  }
}
function saveGoal() {
  const v = document.getElementById('goalInput')?.value;
  if (v) { try { localStorage.setItem('dnd_monthlyGoal', v); } catch(e){} showToast('💾','Goal Saved','$'+v+' monthly target saved — export your naming file to keep it','#8b5cf6'); }
  updateGoalTracker();
}
function loadGoal() {
  try { const v = localStorage.getItem('dnd_monthlyGoal'); if (v) document.getElementById('goalInput').value = v; } catch(e){}
}
function updateGoalTracker() {
  const el = document.getElementById('goalTrackerContent');
  if (!el || !allData.length) return;
  const goal = parseFloat(document.getElementById('goalInput')?.value);
  if (!goal || goal <= 0) { safeHTML(el, '<div style="color:var(--muted);font-size:.78rem">Enter a monthly target to see projections.</div>'); return; }

  const now = new Date();
  const yr = now.getFullYear(), mo = now.getMonth() + 1;
  const ymStr = yr + '-' + String(mo).padStart(2,'0');
  const daysInMonth = new Date(yr, mo, 0).getDate();
  const dayOfMonth = now.getDate();

  const monthData = allData.filter(r => r.completedAt.slice(0,7) === ymStr);
  const earned = monthData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
  const daysWithData = new Set(monthData.map(r=>r.completedAt.slice(0,10))).size;
  const dailyRate = daysWithData > 0 ? earned / daysWithData : 0;
  const projected = dailyRate * daysInMonth;
  const remaining = goal - earned;
  const onTrack = projected >= goal;
  const pct = Math.min(100, (earned / goal * 100));
  const neededPerDay = remaining > 0 ? remaining / Math.max(1, daysInMonth - dayOfMonth) : 0;

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const barCol = onTrack ? '#10b981' : pct >= 60 ? '#f59e0b' : '#ef4444';

  safeHTML(el, `
    <div style="margin-bottom:.6rem">
      <div style="display:flex;justify-content:space-between;font-size:.68rem;color:var(--muted);margin-bottom:.3rem">
        <span>${MON[mo-1]} ${yr} — $${earned.toFixed(2)} of $${goal.toFixed(2)}</span>
        <span style="font-weight:700;color:${barCol}">${pct.toFixed(1)}%</span>
      </div>
      <div style="height:16px;background:var(--surface2);border-radius:8px;overflow:hidden;border:1px solid var(--border)">
        <div style="height:100%;width:${pct.toFixed(1)}%;background:${barCol};border-radius:8px;transition:width .5s"></div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem">
      <div class="inner-panel">
        <div class="sec-lbl">Earned So Far</div>
        <div style="font-size:1.1rem;font-weight:800;color:#1a5ff5;font-family:var(--font-mono),monospace">$${earned.toFixed(2)}</div>
      </div>
      <div class="inner-panel">
        <div class="sec-lbl">Remaining</div>
        <div style="font-size:1.1rem;font-weight:800;color:${remaining>0?'#ef4444':'#10b981'};font-family:var(--font-mono),monospace">${remaining>0?'$'+remaining.toFixed(2):'🎉 Goal reached!'}</div>
      </div>
      <div class="inner-panel">
        <div class="sec-lbl">Projected ${MON[mo-1]} Total</div>
        <div style="font-size:1.1rem;font-weight:800;color:${onTrack?'#10b981':'#f59e0b'};font-family:var(--font-mono),monospace">$${projected.toFixed(2)}</div>
      </div>
      <div class="inner-panel">
        <div class="sec-lbl">Need $/day</div>
        <div style="font-size:1.1rem;font-weight:800;color:${neededPerDay>dailyRate*1.3?'#ef4444':'#10b981'};font-family:var(--font-mono),monospace">${remaining>0?'$'+neededPerDay.toFixed(4):'—'}</div>
        <div style="font-size:.55rem;color:var(--muted)">Current: $${dailyRate.toFixed(4)}/day</div>
      </div>
    </div>
    <div style="margin-top:.5rem;font-size:.65rem;color:${onTrack?'#10b981':'#f59e0b'};font-weight:600">
      ${onTrack ? '✅ On track! Current pace projects $'+projected.toFixed(2)+' which beats your $'+goal.toFixed(2)+' goal.' : '⚠️ Behind pace. Need $'+neededPerDay.toFixed(4)+'/day but averaging $'+dailyRate.toFixed(4)+'/day.'}
    </div>`);
}

/* ── EARNING ALERTS ── */
function runEarningAlerts() {
  const el = document.getElementById('alertsContent');
  if (!el || !allData.length) return;
  const leaseMin = parseFloat(document.getElementById('alertLeaseMin')?.value) || 0;
  const dayMin = parseFloat(document.getElementById('alertDayMin')?.value) || 0;

  if (!leaseMin && !dayMin) { safeHTML(el, '<div style="color:var(--muted);font-size:.78rem">Set at least one threshold.</div>'); return; }

  const alerts = [];

  // Per-lease alerts
  if (leaseMin > 0) {
    const recentDates = datesSorted.slice(-7);
    leaseData.forEach(l => {
      const recentTotal = recentDates.reduce((s,d) => s + ((byDate[d]||[]).filter(r=>r.licenseId.slice(-4)===l.last4).reduce((ss,r)=>ss+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0)), 0);
      const avgPerDay = recentTotal / recentDates.length;
      if (avgPerDay < leaseMin && avgPerDay > 0) {
        alerts.push({ type:'lease', name:l.name, node:l.node, val:avgPerDay, threshold:leaseMin });
      }
    });
  }

  // Per-day alerts
  if (dayMin > 0) {
    datesSorted.slice(-14).forEach(d => {
      const dayTotal = (byDate[d]||[]).reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
      if (dayTotal < dayMin && dayTotal > 0) {
        alerts.push({ type:'day', date:d, val:dayTotal, threshold:dayMin });
      }
    });
  }

  if (alerts.length === 0) {
    safeHTML(el, '<div style="color:#10b981;font-size:.78rem;font-weight:600">✅ All clear — no leases or days below your thresholds.</div>');
    return;
  }

  safeHTML(el, `<div style="font-size:.72rem;font-weight:700;color:#ef4444;margin-bottom:.4rem">🔔 ${alerts.length} alert${alerts.length>1?'s':''} found</div>` +
    alerts.map(a => {
      if (a.type === 'lease') {
        return `<div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:6px;padding:.4rem .6rem;margin-bottom:.3rem;font-size:.7rem;display:flex;justify-content:space-between;align-items:center">
          <span><strong>${sanitizeText(a.name)}</strong> ${a.node>=2?'<span style="font-size:.5rem;background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:.05rem .2rem">N'+a.node+'</span>':''}</span>
          <span style="color:#ef4444;font-weight:700;font-family:var(--font-mono),monospace">$${a.val.toFixed(4)}/day <span style="color:var(--muted);font-weight:400">(min $${a.threshold})</span></span>
        </div>`;
      } else {
        return `<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:6px;padding:.4rem .6rem;margin-bottom:.3rem;font-size:.7rem;display:flex;justify-content:space-between;align-items:center">
          <span><strong>${fmtDateShort(a.date)}</strong></span>
          <span style="color:#f59e0b;font-weight:700;font-family:var(--font-mono),monospace">$${a.val.toFixed(4)} <span style="color:var(--muted);font-weight:400">(min $${a.threshold})</span></span>
        </div>`;
      }
    }).join(''));
}
function buildCompactView() {
  const el = document.getElementById('compactViewContent');
  if (!el || !allData.length || !datesSorted.length) return;

  const today = datesSorted[datesSorted.length-1];
  const yest = datesSorted.length >= 2 ? datesSorted[datesSorted.length-2] : null;
  const todayData = byDate[today] || [];
  const yestData = yest ? (byDate[yest] || []) : [];

  const todayTotal = todayData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
  const yestTotal = yestData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
  const todayLeases = new Set(todayData.map(r=>r.licenseId)).size;
  const todayTxns = todayData.length;
  const allTimeTotal = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
  const last7 = datesSorted.slice(-7).reduce((s,d)=>s+(byDate[d]||[]).reduce((ss,r)=>ss+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0),0);
  const avg7 = last7 / Math.min(7, datesSorted.length);
  const dayDelta = yestTotal > 0 ? ((todayTotal-yestTotal)/yestTotal*100).toFixed(1) : '—';
  const deltaCol = parseFloat(dayDelta) > 0 ? '#10b981' : parseFloat(dayDelta) < 0 ? '#ef4444' : 'var(--muted)';

  // Per-node today
  const nodeIds = Object.keys(nodeMap);
  const nodeToday = nodeIds.map((nid,i) => {
    const nt = todayData.filter(r=>r.nodeId===nid).reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
    return `<span style="font-weight:700;color:${['#3b82f6','#8b5cf6','#10b981','#f59e0b','#ef4444'][i%5]}">${sanitizeText(nodeMap[nid].name)}: $${nt.toFixed(4)}</span>`;
  }).join(' · ');

  safeHTML(el, `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.5rem;margin-bottom:.6rem">
      <div style="background:rgba(59,130,246,.08);border-radius:10px;padding:.6rem .8rem;text-align:center;border:1px solid rgba(59,130,246,.15)">
        <div style="font-size:.55rem;font-weight:700;color:#3b82f6;text-transform:uppercase">Today</div>
        <div style="font-size:1.4rem;font-weight:800;color:#1a5ff5;font-family:var(--font-mono),monospace">$${todayTotal.toFixed(4)}</div>
        <div style="font-size:.58rem;color:${deltaCol};font-weight:600">${parseFloat(dayDelta)>0?'▲ +':'▼ '}${dayDelta}% vs yesterday</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:.6rem .8rem;text-align:center;border:1px solid var(--border)">
        <div class="sec-lbl">7-Day Avg</div>
        <div style="font-size:1.4rem;font-weight:800;color:var(--text);font-family:var(--font-mono),monospace">$${avg7.toFixed(4)}</div>
        <div style="font-size:.58rem;color:var(--muted)">/day</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:.6rem .8rem;text-align:center;border:1px solid var(--border)">
        <div class="sec-lbl">Active Leases</div>
        <div style="font-size:1.4rem;font-weight:800;color:var(--text);font-family:var(--font-mono),monospace">${todayLeases}</div>
        <div style="font-size:.58rem;color:var(--muted)">${todayTxns} txns today</div>
      </div>
      <div style="background:var(--surface2);border-radius:10px;padding:.6rem .8rem;text-align:center;border:1px solid var(--border)">
        <div class="sec-lbl">All Time</div>
        <div style="font-size:1.4rem;font-weight:800;color:#8b5cf6;font-family:var(--font-mono),monospace">$${allTimeTotal.toFixed(2)}</div>
        <div style="font-size:.58rem;color:var(--muted)">${datesSorted.length} days</div>
      </div>
    </div>
    ${nodeIds.length > 1 ? `<div style="font-size:.68rem;color:var(--muted);padding:.3rem 0">Today by node: ${nodeToday}</div>` : ''}
    <div style="font-size:.62rem;color:var(--muted);margin-top:.2rem">Latest data: ${today}</div>`);
}
function exportPDFReport() {
  if (viewMode === 'gross') {
    showToast('⚠️', 'Export Blocked', 'Switch to UNO Earnings view before exporting — UNO + ULO data is calculated, not actual earnings', '#f59e0b');
    return;
  }
  const el = document.getElementById('pdfStatus');
  if (!allData.length) { if(el) el.innerHTML = '<div style="color:#f59e0b;font-size:.72rem">No data loaded.</div>'; return; }

  const MON = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const now = new Date();
  const total = allData.reduce((s,r)=>s+adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)),0);
  const leaseCount = leaseData.length;
  const nodeIds = Object.keys(nodeMap);
  const first = datesSorted[0], last = datesSorted[datesSorted.length-1];

  // Withdrawal summary
  const allWith = Object.values(withdrawFiles).flat();
  const wTotal = allWith.reduce((s,w)=>s+(w.amountMicros||0)/1e6,0);

  // Per-node breakdown
  const nodeRows = nodeIds.map((nid,i) => {
    const nm = nodeMap[nid];
    return `<tr><td style="padding:6px 12px;border:1px solid #ddd">${sanitizeText(nm.name)}</td><td style="padding:6px 12px;border:1px solid #ddd;text-align:right">${nm.leaseCount}</td><td style="padding:6px 12px;border:1px solid #ddd;text-align:right">$${nm.earnings.toFixed(4)}</td><td style="padding:6px 12px;border:1px solid #ddd;text-align:right">$${(nm.leaseCount>0?(nm.earnings/nm.leaseCount):0).toFixed(4)}</td></tr>`;
  }).join('');

  // Top 10 leases
  const topLeases = [...leaseData].sort((a,b)=>b.alltime-a.alltime).slice(0,10);
  const topRows = topLeases.map((l,i) => `<tr><td style="padding:4px 10px;border:1px solid #ddd">${i+1}</td><td style="padding:4px 10px;border:1px solid #ddd">${sanitizeText(l.name)}</td><td style="padding:4px 10px;border:1px solid #ddd;text-align:right">$${l.alltime.toFixed(4)}</td><td style="padding:4px 10px;border:1px solid #ddd">Node ${l.node}</td></tr>`).join('');

  const htmlContent = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Unity Earnings Report</title>
<style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px;color:#1a2c38}
h1{color:#1a5ff5;border-bottom:3px solid #1a5ff5;padding-bottom:10px}
h2{color:#374151;margin-top:30px;border-bottom:1px solid #ddd;padding-bottom:6px}
.kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:15px 0}
.kpi{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:15px;text-align:center}
.kpi-val{font-size:24px;font-weight:800;color:#1a5ff5}
.kpi-lbl{font-size:11px;color:#64748b;text-transform:uppercase;margin-top:4px}
table{border-collapse:collapse;width:100%;margin:10px 0;font-size:13px}
th{background:#f1f5f9;padding:8px 12px;border:1px solid #ddd;text-align:left;font-weight:700}
.footer{margin-top:40px;padding-top:15px;border-top:1px solid #ddd;font-size:11px;color:#94a3b8;text-align:center}
@media print{body{padding:20px}}
/* ── UTILITY CLASSES (extracted from repeated inline styles) ── */
.sec-lbl{font-size:.55rem;font-weight:700;color:var(--muted);text-transform:uppercase}
.sm-badge{font-size:.5rem;font-weight:700;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:.05rem .2rem;margin-left:.3rem}
.inner-card{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.7rem .9rem;margin-bottom:.6rem}
.inner-panel{background:var(--surface2);border-radius:8px;padding:.5rem .7rem;border:1px solid var(--border)}
</style></head><body>
<h1>📊 Unity Earnings Report</h1>
<p style="color:#64748b">Generated ${now.toLocaleDateString()} · Data: ${fmtDateShort(first)} → ${fmtDateShort(last)} (${datesSorted.length} days)</p>

<div class="kpi-grid">
  <div class="kpi"><div class="kpi-val">$${total.toFixed(2)}</div><div class="kpi-lbl">Total Earned</div></div>
  <div class="kpi"><div class="kpi-val">${leaseCount}</div><div class="kpi-lbl">Active Leases</div></div>
  <div class="kpi"><div class="kpi-val">${nodeIds.length}</div><div class="kpi-lbl">Nodes</div></div>
  <div class="kpi"><div class="kpi-val">$${(total/datesSorted.length).toFixed(4)}</div><div class="kpi-lbl">Avg $/Day</div></div>
  <div class="kpi"><div class="kpi-val">$${(total/leaseCount).toFixed(4)}</div><div class="kpi-lbl">Avg $/Lease</div></div>
  <div class="kpi"><div class="kpi-val">${allWith.length?'$'+wTotal.toFixed(2):'—'}</div><div class="kpi-lbl">Total Withdrawn</div></div>
</div>

<h2>Node Performance</h2>
<table><thead><tr><th>Node</th><th style="text-align:right">Leases</th><th style="text-align:right">Total Earned</th><th style="text-align:right">$/Lease</th></tr></thead><tbody>${nodeRows}</tbody></table>

<h2>Top 10 Leases</h2>
<table><thead><tr><th>#</th><th>Name</th><th style="text-align:right">Total Earned</th><th>Node</th></tr></thead><tbody>${topRows}</tbody></table>

${allWith.length ? `<h2>Withdrawal Summary</h2><p>${allWith.length} withdrawals totaling $${wTotal.toFixed(2)} USD</p>` : ''}

<div class="footer">dataNerds Unity Dashboard · Report generated automatically · Not financial advice</div>
</body></html>`;

  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Earnings_File_UnityNodes_' + now.toISOString().slice(0,10) + '_Report.html';
  a.click();
  URL.revokeObjectURL(url);
  if(el) el.innerHTML = '<div style="color:#10b981;font-size:.72rem;font-weight:600;margin-top:.3rem">✅ Report downloaded!</div>';
  showToast('📄', 'Report Saved', 'PDF Report → Downloads folder', '#06b6d4');
  showToast('📄','Report Exported','Open the file and use Print → Save as PDF','#06b6d4');
}

/* ═══════════════════════════════════════════════════════
   🎉 SURPRISE FEATURES
   1. Animated particle background on upload screen
   2. Animated number counters on KPI reveal
   3. Toast notification system
   4. (removed)
   5. Live earnings ticker at bottom
   6. Light/dark theme toggle
   7. Upload screen live stats bar
   8. Sparklines on KPI cards
   9. Keyboard shortcuts
   10. Easter egg 🥚
═══════════════════════════════════════════════════════ */

/* ── 1. PARTICLE BACKGROUND ── */
(function() {
  const canvas = document.getElementById('particleCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let W, H, particles = [];

  function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);

  const COLORS = ['#3b82f6','#8b5cf6','#ef4444','#f59e0b','#10b981'];
  for (let i = 0; i < 60; i++) {
    particles.push({
      x: Math.random() * 2000, y: Math.random() * 1000,
      vx: (Math.random() - .5) * .4, vy: (Math.random() - .5) * .3,
      r: Math.random() * 1.8 + .6,
      col: COLORS[Math.floor(Math.random() * COLORS.length)],
      a: Math.random() * .5 + .15
    });
  }

  function drawFrame() {
    if (!document.getElementById('uploadScreen') ||
        document.getElementById('uploadScreen').style.display === 'none') {
      requestAnimationFrame(drawFrame); return;
    }
    ctx.clearRect(0, 0, W, H);
    particles.forEach(p => {
      p.x += p.vx; p.y += p.vy;
      if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
      if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = p.col;
      ctx.globalAlpha = p.a;
      ctx.fill();
    });
    // draw connecting lines between nearby particles
    ctx.globalAlpha = 1;
    for (let i = 0; i < particles.length; i++) {
      for (let j = i+1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 120) {
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.strokeStyle = particles[i].col;
          ctx.globalAlpha = (1 - dist/120) * .08;
          ctx.lineWidth = .6;
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(drawFrame);
  }
  drawFrame();
})();

/* ── 2. ANIMATED COUNTER ── */
function animateCounter(el, from, to, prefix, suffix, decimals, duration) {
  const start = performance.now();
  function step(now) {
    const pct = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - pct, 3); // ease-out cubic
    const val = from + (to - from) * ease;
    el.textContent = prefix + val.toFixed(decimals) + suffix;
    if (pct < 1) requestAnimationFrame(step);
    else el.textContent = prefix + to.toFixed(decimals) + suffix;
  }
  requestAnimationFrame(step);
}


/* ── 3. TOAST SYSTEM ── */
// inject container
document.body.insertAdjacentHTML('beforeend',
  '<div id="toastContainer"></div>' +
  '<div id="earningsTicker"><div class="ticker-track" id="tickerTrack"></div></div>' +
  '<div id="unsavedNotesBanner">' +
    '<span class="uns-icon">📝</span>' +
    '<div class="uns-text">You have unsaved notes<small>Export your naming file to keep them permanently</small></div>' +
    '<button class="uns-btn uns-export" onclick="neExportFile();hideUnsavedBanner()">💾 Export Now</button>' +
    '<button class="uns-btn uns-dismiss" onclick="hideUnsavedBanner()" title="Dismiss">✕</button>' +
  '</div>'
);

function showToast(icon, title, sub, color) {
  const tc = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.borderLeft = '3px solid ' + (color || '#3b82f6');
  const safeIcon = sanitizeText(icon);
  const safeTitle = sanitizeText(title);
  const safeSub = sub ? sanitizeText(sub) : '';
  t.innerHTML = `<div class="toast-icon">${safeIcon}</div><div><div class="toast-text">${safeTitle}</div>${safeSub?`<div class="toast-sub">${safeSub}</div>`:''}</div>`;
  tc.appendChild(t);
  setTimeout(() => { t.classList.add('out'); setTimeout(() => t.remove(), 350); }, 3500);
}

/* ── 5. EARNINGS TICKER ── */
function buildTicker(leaseData) {
  const ticker = document.getElementById('earningsTicker');
  const track  = document.getElementById('tickerTrack');
  if (!leaseData || leaseData.length === 0) { ticker.style.display = 'none'; return; }
  ticker.style.display = 'block';

  const sorted = [...leaseData].sort((a,b) => b.today - a.today).filter(l => l.today > 0);
  if (sorted.length === 0) { ticker.style.display = 'none'; return; }

  const items = sorted.map(l =>
    `<span class="ticker-item">
      <span class="ti-name">${sanitizeText(l.name)}</span>
      &nbsp;<span class="ti-val">$${l.today.toFixed(4)}</span>
      &nbsp;<span style="color:var(--muted)">·</span>&nbsp;
    </span>`
  ).join('');

  // Duplicate for seamless loop
  track.innerHTML = items + items;
  // Adjust speed based on content width
  const speed = Math.max(20, sorted.length * 3);
  track.style.animationDuration = speed + 's';
  document.getElementById('dashboard').style.paddingBottom = '2.5rem';
}

/* ── 6. LIGHT/DARK TOGGLE ── */
/* ═══════════════════════════════════════════════════════
   FEATURE: EASY / ADVANCED MODE
═══════════════════════════════════════════════════════ */
var dashboardMode = 'easy'; // default

function toggleDashboardMode() {
  const toggle = document.getElementById('modeToggle');
  const isAdvanced = toggle && toggle.checked;
  setDashboardMode(isAdvanced ? 'advanced' : 'easy');
}

function switchModeFromHeader() {
  const current = document.body.classList.contains('easy-mode') ? 'easy' : 'advanced';
  const newMode = current === 'easy' ? 'advanced' : 'easy';
  setDashboardMode(newMode);
  // Sync upload page toggle if visible
  const toggle = document.getElementById('modeToggle');
  if (toggle) toggle.checked = (newMode === 'advanced');
  updateModeLabels(newMode);
}

function setDashboardMode(mode) {
  dashboardMode = mode;
  try { sessionStorage.setItem('unity_dash_mode', mode); } catch(e) {}

  // Animated transition
  var dash = document.getElementById('dashboard');
  if (dash) { dash.classList.remove('mode-fade'); void dash.offsetWidth; dash.classList.add('mode-fade'); }

  var overviewTab = document.querySelector('[data-page="overview"]');
  var uploadDesc = document.getElementById('uploadDesc');

  if (mode === 'easy') {
    document.body.classList.add('easy-mode');
    // Show/hide mode explanations
    var expEasy = document.getElementById('modeExplainEasy');
    var expAdv = document.getElementById('modeExplainAdv');
    if (expEasy) expEasy.style.display = '';
    if (expAdv) expAdv.style.display = 'none';
    // Rename overview tab
    if (overviewTab) overviewTab.innerHTML = overviewTab.innerHTML.replace('>Overview<', '>Dashboard<').replace('>Advanced<', '>Dashboard<');
    if (uploadDesc) uploadDesc.textContent = 'Drop your Unity export file(s) here';
    // Show easy mode charts on overview
    var ec = document.getElementById('easyModeCharts');
    if (ec) ec.style.display = '';
    // Only render if data exists (not during initial page load before build)
    if (typeof datesSorted !== 'undefined' && datesSorted && datesSorted.length > 0) {
      setTimeout(renderEasyCharts, 150);
    }
    // Update header link
    var link = document.getElementById('switchModeLink');
    if (link) { link.style.display = ''; link.textContent = 'Switch to Advanced \u2192'; }
    // Always go to overview/dashboard page
    showPage('overview');
  } else {
    document.body.classList.remove('easy-mode');
    // Show/hide mode explanations
    var expEasy = document.getElementById('modeExplainEasy');
    var expAdv = document.getElementById('modeExplainAdv');
    if (expEasy) expEasy.style.display = 'none';
    if (expAdv) expAdv.style.display = '';
    // Rename overview tab back
    if (overviewTab) overviewTab.innerHTML = overviewTab.innerHTML.replace('>Dashboard<', '>Overview<');
    if (uploadDesc) uploadDesc.textContent = 'Naming, earnings, withdrawals \u2014 auto-sorted';
    var ec = document.getElementById('easyModeCharts');
    if (ec) ec.style.display = 'none';
    var link = document.getElementById('switchModeLink');
    if (link) { link.style.display = ''; link.textContent = '\u2190 Switch to Easy'; }
  }
  updateModeLabels(mode);
}

function updateModeLabels(mode) {
  const easy = document.getElementById('modeLabelEasy');
  const adv = document.getElementById('modeLabelAdv');
  const knob = document.getElementById('modeKnob');
  const track = knob ? knob.parentElement.querySelector('span:not(#modeKnob)') : null;
  if (mode === 'advanced') {
    if (easy) { easy.style.color = 'var(--muted)'; easy.style.fontWeight = '600'; }
    if (adv) { adv.style.color = '#8b5cf6'; adv.style.fontWeight = '700'; }
    if (knob) knob.style.left = '22px';
    if (track) track.style.background = '#8b5cf6';
  } else {
    if (easy) { easy.style.color = '#3b82f6'; easy.style.fontWeight = '700'; }
    if (adv) { adv.style.color = 'var(--muted)'; adv.style.fontWeight = '600'; }
    if (knob) knob.style.left = '2px';
    if (track) track.style.background = '#3b82f6';
  }
}

function renderEasyCharts() {
  if (!datesSorted || !datesSorted.length) { console.warn('[EasyCharts] No data'); return; }
  var container = document.getElementById('easyModeCharts');
  if (!container) { console.warn('[EasyCharts] No container'); return; }
  
  container.style.display = '';
  
  // Force layout recalc
  void container.offsetWidth;
  
  // Render each chart with a small stagger
  setTimeout(function() {
    try { 
      var cv1 = document.getElementById('easyTrendCanvas');
      if (cv1) { console.log('[EasyTrend] parentWidth=' + cv1.parentElement.clientWidth); }
      renderDailyBar('easyTrendCanvas'); 
    } catch(e) { console.error('[EasyTrend]', e); }
  }, 50);
  
  setTimeout(function() {
    try { renderDist('easyDistCanvas'); } catch(e) { console.error('[EasyDist]', e); }
  }, 100);
  
  setTimeout(function() {
    try { renderTrend('easyRevTrendCanvas'); } catch(e) { console.error('[EasyRevTrend]', e); }
  }, 150);

  setTimeout(function() {
    try { renderHeatmap('easyHeatmapChart'); } catch(e) { console.error('[EasyHeatmap]', e); }
  }, 200);
}

/* ══════════════════════════════════════
   PAGE NAVIGATION
══════════════════════════════════════ */
let _currentPage = 'overview';

// Restore mode on load
(function() {
  try {
    var saved = sessionStorage.getItem('unity_dash_mode');
    if (saved === 'advanced') {
      dashboardMode = 'advanced';
      var toggle = document.getElementById('modeToggle');
      if (toggle) toggle.checked = true;
      setDashboardMode('advanced');
    } else {
      setDashboardMode('easy');
    }
  } catch(e) {
    setDashboardMode('easy');
  }
})();

function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  document.getElementById('themeBtn').textContent = isLight ? '🌙 Dark' : '☀ Light';
  try { localStorage.setItem('unity_theme', isLight ? 'light' : 'dark'); } catch(e) {}
}

/* showPage handles tab switching */
function showPage(page) {
  // Hide all pages
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  // Deactivate all tabs
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  // Show selected page
  const pageEl = document.getElementById('page-' + page);
  if (pageEl) pageEl.classList.add('active');
  // Activate tab
  const tabEl = document.querySelector('[data-page="' + page + '"]');
  if (tabEl) tabEl.classList.add('active');
  _currentPage = page;
  // Scroll to top of content
  window.scrollTo({top: 0, behavior: 'smooth'});
  // Redraw canvases that need resize after being shown
  setTimeout(() => {
    if (page === 'distribution') {
      if (typeof renderDist   === 'function') renderDist();
      if (typeof renderRadar  === 'function') { renderRadar(); initRadarHover(); }
    }
    if (page === 'earnings'     && typeof renderDailyBar === 'function') renderDailyBar();
    if (page === 'analytics') {
      if (typeof renderWoW       === 'function') renderWoW();
      if (typeof buildDOWChart   === 'function') buildDOWChart(allData, datesSorted);
    }
    if (page === 'archive' && typeof buildArchivePage === 'function') buildArchivePage();
    if (page === 'performance') {
      if (typeof renderTrend === 'function') renderTrend();
      if (typeof renderTB    === 'function') renderTB();
      if (typeof renderWoW       === 'function') renderWoW();
      if (typeof buildDOWChart   === 'function') buildDOWChart(allData, datesSorted);
    }
    if (page === 'editor' && typeof nePopulate === 'function') nePopulate();
  }, 80);
}

// Copy donation address to clipboard
function copyDonateAddr(el) {
  if (!el) return;
  var addr = el.textContent.trim();
  navigator.clipboard.writeText(addr).then(function() {
    el.style.borderColor = '#10b981';
    showToast('📋', 'Copied!', 'Address copied to clipboard', '#10b981');
    setTimeout(function() { el.style.borderColor = ''; }, 2000);
  }).catch(function() {
    // Fallback: select the text
    var range = document.createRange();
    range.selectNodeContents(el);
    var sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });
}

// After buildDashboard, stay on overview or switch to it
function afterBuildNav() {
  showPage('overview');
  // Dynamically adjust dashboard padding to match actual topBar height
  syncTopBarPadding();
  // Pre-populate names editor so data is ready when user clicks the tab
  if (typeof nePopulate === 'function') nePopulate();
}

function syncTopBarPadding() {
  const bar = document.getElementById('topBar');
  const dash = document.getElementById('dashboard');
  if (bar && dash) {
    const h = bar.offsetHeight;
    dash.style.paddingTop = (h + 12) + 'px';
  }
}


// Default to LIGHT mode (matches upload screen). Switch to dark only if explicitly saved.
(function() {
  let saved = null;
  try { saved = localStorage.getItem('unity_theme'); } catch(e) {}
  const startLight = saved !== 'dark'; // light unless user explicitly picked dark
  if (startLight) {
    document.body.classList.add('light');
    const btn = document.getElementById('themeBtn');
    if (btn) btn.textContent = '🌙 Dark';
  }
})();


/* ── 8. KPI SPARKLINES ── */
function buildSparkline(values, color, width, height) {
  if (!values || values.length < 2) return '';
  const canvas = document.createElement('canvas');
  canvas.width = width * window.devicePixelRatio;
  canvas.height = height * window.devicePixelRatio;
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
  const max = Math.max(...values);
  const min = Math.min(...values);
  const range = max - min || 1;
  const pad = 2;
  const W = width - pad*2, H = height - pad*2;
  const pts = values.map((v,i) => [
    pad + (i/(values.length-1)) * W,
    pad + H - ((v-min)/range) * H
  ]);
  // fill gradient
  const grad = ctx.createLinearGradient(0, 0, 0, height);
  grad.addColorStop(0, color + '40');
  grad.addColorStop(1, color + '05');
  ctx.beginPath();
  ctx.moveTo(pts[0][0], H+pad);
  pts.forEach(([x,y]) => ctx.lineTo(x,y));
  ctx.lineTo(pts[pts.length-1][0], H+pad);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();
  // line
  ctx.beginPath();
  pts.forEach(([x,y],i) => i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y));
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.lineJoin = 'round';
  ctx.stroke();
  // last dot
  const [lx,ly] = pts[pts.length-1];
  ctx.beginPath();
  ctx.arc(lx, ly, 2.5, 0, Math.PI*2);
  ctx.fillStyle = color;
  ctx.fill();
  return canvas.outerHTML;
}

function injectSparklines(trendData) {
  // Add sparklines to KPI cards after they're built
  const dailyTotals = trendData.map(t => t.total);
  const last14 = dailyTotals.slice(-14);
  const kcs = document.querySelectorAll('.kc');
  if (kcs.length >= 1) {
    const wrap = document.createElement('div');
    wrap.className = 'sparkline-wrap';
    wrap.style.marginTop = '.4rem';
    wrap.innerHTML = buildSparkline(last14, '#3b82f6', 100, 28);
    kcs[0].appendChild(wrap);
  }
  if (kcs.length >= 3) {
    const wrap = document.createElement('div');
    wrap.className = 'sparkline-wrap';
    wrap.style.marginTop = '.4rem';
    const todayVals = trendData.slice(-14).map(t => t.total);
    wrap.innerHTML = buildSparkline(todayVals, '#10b981', 100, 28);
    kcs[2].appendChild(wrap);
  }
}

/* ── 9. KEYBOARD SHORTCUTS ── */
/* ── 10. EASTER EGG 🥚 ── */
/* ═══════════════════════════════════════════════════════
   FEATURE: OVERVIEW SEARCH / FILTER
═══════════════════════════════════════════════════════ */
function initOverviewFilter() {
  const bar = document.getElementById('overviewFilter');
  if (bar) bar.style.display = 'flex';
  // Populate node dropdown
  const nodeSel = document.getElementById('overviewNodeFilter');
  if (nodeSel && typeof nodeMap !== 'undefined') {
    nodeSel.innerHTML = '<option value="all">All Nodes</option>';
    Object.keys(nodeMap).forEach((nid, i) => {
      nodeSel.innerHTML += `<option value="${i+1}">${sanitizeText(nodeMap[nid].name)}</option>`;
    });
  }
  // Populate group dropdown
  const grpSel = document.getElementById('overviewGroupFilter');
  if (grpSel && typeof GC !== 'undefined') {
    grpSel.innerHTML = '<option value="all">All Groups</option>';
    Object.keys(GC).filter(g => g !== 'Unknown').sort().forEach(g => {
      grpSel.innerHTML += `<option value="${sanitizeText(g)}">${sanitizeText(g)}</option>`;
    });
  }
}

function applyOverviewFilter() {
  const q = (document.getElementById('overviewSearch')?.value || '').trim().toLowerCase();
  const nodeF = document.getElementById('overviewNodeFilter')?.value || 'all';
  const grpF = document.getElementById('overviewGroupFilter')?.value || 'all';
  if (!q && nodeF === 'all' && grpF === 'all') { clearOverviewFilter(); return; }

  const filtered = leaseData.filter(l => {
    if (nodeF !== 'all' && l.node !== parseInt(nodeF, 10)) return false;
    if (grpF !== 'all' && l.group !== grpF) return false;
    if (q && !(l.name.toLowerCase().includes(q) || l.last4.toLowerCase().includes(q) || l.group.toLowerCase().includes(q))) return false;
    return true;
  });

  const ids = new Set(filtered.map(l => l.last4));
  const total = filtered.reduce((s, l) => s + l.alltime, 0);
  const todayT = filtered.reduce((s, l) => s + l.today, 0);
  const activeT = filtered.filter(l => l.today > 0).length;
  const avg = datesSorted.length > 0 ? total / datesSorted.length : 0;
  const stat = document.getElementById('overviewFilterStatus');
  if (stat) stat.textContent = `${filtered.length} of ${leaseData.length} leases · $${total.toFixed(4)} total · $${todayT.toFixed(4)} today`;

  // Update KPI cards to reflect filtered data
  const kpiMap = {
    'kpiAllTime': '$' + total.toFixed(4),
    'kpiToday': '$' + todayT.toFixed(4),
    'kpiAvg': '$' + avg.toFixed(4),
    'kpiActive': activeT + '/' + filtered.length
  };
  Object.entries(kpiMap).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) { el.textContent = val; el.style.color = '#3b82f6'; }
  });

  // Highlight matching group cards, dim others
  document.querySelectorAll('.gc').forEach(gc => {
    const label = gc.querySelector('.gc-label')?.textContent || '';
    const hasMatch = filtered.some(l => l.group === label);
    gc.style.opacity = hasMatch ? '1' : '0.2';
    gc.style.transform = hasMatch ? '' : 'scale(0.97)';
  });
}

function clearOverviewFilter() {
  const s = document.getElementById('overviewSearch'); if (s) s.value = '';
  const n = document.getElementById('overviewNodeFilter'); if (n) n.value = 'all';
  const g = document.getElementById('overviewGroupFilter'); if (g) g.value = 'all';
  const st = document.getElementById('overviewFilterStatus'); if (st) st.textContent = '';
  document.querySelectorAll('.gc').forEach(gc => { gc.style.opacity = '1'; gc.style.transform = ''; });
  // Restore original KPI values
  const kpiEls = ['kpiAllTime', 'kpiToday', 'kpiAvg', 'kpiActive'];
  kpiEls.forEach(id => { const el = document.getElementById(id); if (el) el.style.color = ''; });
  if (typeof rebuildWithCurrentData === 'function') rebuildWithCurrentData();
}

/* ═══════════════════════════════════════════════════════
   FEATURE: SILENT LEASE ALERTS
═══════════════════════════════════════════════════════ */
function checkSilentLeases() {
  if (!leaseData || !leaseData.length || !datesSorted || !datesSorted.length) return;
  const today = datesSorted[datesSorted.length - 1];
  const silentDays = 2; // leases silent for 2+ days
  const silent = [];

  leaseData.forEach(l => {
    // Find last earning date for this lease
    let lastDate = null;
    for (let i = datesSorted.length - 1; i >= 0; i--) {
      const dayTxns = byDate[datesSorted[i]] || [];
      if (dayTxns.some(r => r.licenseId.slice(-4) === l.last4)) { lastDate = datesSorted[i]; break; }
    }
    if (lastDate && lastDate < today) {
      const gap = Math.round((new Date(today) - new Date(lastDate)) / 86400000);
      if (gap >= silentDays) silent.push({ name: l.name, group: l.group, node: l.node, last4: l.last4, lastDate, gap });
    }
  });

  const banner = document.getElementById('silentLeaseBanner');
  if (!banner) return;
  if (silent.length === 0) { banner.style.display = 'none'; return; }

  silent.sort((a, b) => b.gap - a.gap);
  const title = document.getElementById('silentLeaseTitle');
  if (title) title.textContent = `${silent.length} Silent Lease${silent.length !== 1 ? 's' : ''} Detected`;

  const list = document.getElementById('silentLeaseList');
  if (list) list.innerHTML = silent.slice(0, 10).map(s =>
    `<span style="display:inline-flex;align-items:center;gap:.2rem;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:.15rem .4rem;margin:.1rem .15rem .1rem 0">` +
    `<strong>${sanitizeText(s.name)}</strong> <span style="color:var(--muted)">·</span> ` +
    `<span style="color:#ef4444;font-weight:700">${s.gap}d silent</span> <span style="color:var(--muted)">· last ${s.lastDate}</span></span>`
  ).join('') + (silent.length > 10 ? `<div style="margin-top:.3rem;color:var(--muted)">+ ${silent.length - 10} more</div>` : '');
  banner.style.display = '';
}

function checkExpiringLeases() {
  const banner = document.getElementById('expiryAlertBanner');
  if (!banner || !neLeases || !neLeases.length) return;

  const now = new Date();
  const todayStr = now.toISOString().slice(0, 10);
  const expiring = [];

  neLeases.forEach(l => {
    if (!l.expiry) return;
    const diff = Math.round((new Date(l.expiry + 'T00:00:00') - now) / 86400000);
    if (diff <= 30) {
      expiring.push({ name: l.name, hex: l.hex, expiry: l.expiry, days: diff });
    }
  });

  if (expiring.length === 0) { banner.style.display = 'none'; return; }

  expiring.sort((a, b) => a.days - b.days);

  const expired = expiring.filter(e => e.days < 0);
  const urgent = expiring.filter(e => e.days >= 0 && e.days <= 7);
  const soon = expiring.filter(e => e.days > 7 && e.days <= 30);

  const title = document.getElementById('expiryAlertTitle');
  if (title) {
    const parts = [];
    if (expired.length) parts.push(`${expired.length} expired`);
    if (urgent.length) parts.push(`${urgent.length} within 7 days`);
    if (soon.length) parts.push(`${soon.length} within 30 days`);
    title.textContent = `Lease Expirations — ${parts.join(' · ')}`;
  }

  const list = document.getElementById('expiryAlertList');
  if (list) list.innerHTML = expiring.slice(0, 12).map(e => {
    let col, label;
    if (e.days < 0) { col = '#ef4444'; label = `expired ${Math.abs(e.days)}d ago`; }
    else if (e.days === 0) { col = '#ef4444'; label = 'expires today!'; }
    else if (e.days <= 7) { col = '#f59e0b'; label = `${e.days}d left`; }
    else { col = '#3b82f6'; label = `${e.days}d left`; }
    return `<span style="display:inline-flex;align-items:center;gap:.2rem;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:.15rem .4rem;margin:.1rem .15rem .1rem 0">` +
      `<strong>${sanitizeText(e.name)}</strong> <span style="color:var(--muted)">·</span> ` +
      `<span style="color:${col};font-weight:700">${label}</span> <span style="color:var(--muted)">· ${e.expiry}</span></span>`;
  }).join('') + (expiring.length > 12 ? `<div style="margin-top:.3rem;color:var(--muted)">+ ${expiring.length - 12} more</div>` : '');
  banner.style.display = '';
}

/* ═══════════════════════════════════════════════════════
   FEATURE: PORTFOLIO HEALTH SCORE
═══════════════════════════════════════════════════════ */
function buildHealthScore() {
  const el = document.getElementById('healthScoreContainer');
  if (!el || !datesSorted || datesSorted.length < 3 || !leaseData || !leaseData.length) return;

  const today = datesSorted[datesSorted.length - 1];
  const totalLeases = leaseData.length;

  // === METRIC 1: Participation Rate (active today / total) ===
  const activeToday = leaseData.filter(l => l.today > 0).length;
  const participationPct = totalLeases > 0 ? (activeToday / totalLeases) * 100 : 0;
  const m1 = Math.min(participationPct / 90 * 100, 100); // 90%+ = perfect

  // === METRIC 2: Earnings Trend (7d avg vs 14d avg) ===
  const last7 = datesSorted.slice(-7);
  const last14 = datesSorted.slice(-14, -7);
  const avg7 = last7.reduce((s, d) => {
    let t = 0; (byDate[d]||[]).forEach(r => { t += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); }); return s + t;
  }, 0) / Math.max(last7.length, 1);
  const avg14 = last14.length > 0 ? last14.reduce((s, d) => {
    let t = 0; (byDate[d]||[]).forEach(r => { t += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); }); return s + t;
  }, 0) / last14.length : avg7;
  const trendPct = avg14 > 0 ? ((avg7 - avg14) / avg14) * 100 : 0;
  const m2 = Math.min(Math.max(50 + trendPct * 2, 0), 100); // flat=50, +25%=100

  // === METRIC 3: Consistency (std dev of daily earnings / mean) ===
  const dailyVals = datesSorted.slice(-14).map(d => {
    let t = 0; (byDate[d]||[]).forEach(r => { t += adjEarn(r.amountMicros,(r.licenseId||'').slice(-4),(r.completedAt||'').slice(0,10)); }); return t;
  });
  const mean = dailyVals.reduce((s,v) => s+v, 0) / Math.max(dailyVals.length, 1);
  const variance = dailyVals.reduce((s,v) => s + (v - mean) ** 2, 0) / Math.max(dailyVals.length, 1);
  const cv = mean > 0 ? Math.sqrt(variance) / mean : 1; // coefficient of variation
  const m3 = Math.min(Math.max((1 - cv) * 100, 0), 100); // lower cv = more consistent

  // === METRIC 4: Silent Lease Ratio (fewer silent = better) ===
  let silentCount = 0;
  leaseData.forEach(l => {
    let lastDate = null;
    for (let i = datesSorted.length - 1; i >= 0; i--) {
      if ((byDate[datesSorted[i]]||[]).some(r => r.licenseId.slice(-4) === l.last4)) { lastDate = datesSorted[i]; break; }
    }
    if (lastDate && lastDate < today) {
      const gap = Math.round((new Date(today) - new Date(lastDate)) / 86400000);
      if (gap >= 2) silentCount++;
    }
  });
  const silentRatio = totalLeases > 0 ? silentCount / totalLeases : 0;
  const m4 = Math.max((1 - silentRatio * 3) * 100, 0); // >33% silent = 0

  // === METRIC 5: Data Freshness (how recent is latest data) ===
  const daysOld = Math.round((new Date() - new Date(today + 'T23:59:59')) / 86400000);
  const m5 = Math.max(100 - daysOld * 20, 0); // 5+ days old = 0

  // === METRIC 6: Diversification (how spread across groups) ===
  const groups = {};
  leaseData.forEach(l => { groups[l.group] = (groups[l.group]||0) + l.alltime; });
  const groupVals = Object.values(groups);
  const groupTotal = groupVals.reduce((s,v) => s+v, 0) || 1;
  // Herfindahl index (lower = more diversified)
  const hhi = groupVals.reduce((s,v) => s + (v/groupTotal)**2, 0);
  const idealHHI = groupVals.length > 0 ? 1 / groupVals.length : 1;
  const m6 = groupVals.length <= 1 ? 50 : Math.min(Math.max((1 - (hhi - idealHHI)) * 100, 20), 100);

  // === COMPOSITE SCORE ===
  const weights = { participation: 25, trend: 20, consistency: 15, silent: 20, freshness: 10, diversity: 10 };
  const score = Math.round(
    (m1 * weights.participation + m2 * weights.trend + m3 * weights.consistency +
     m4 * weights.silent + m5 * weights.freshness + m6 * weights.diversity) / 100
  );

  // Grade
  let grade, gradeCol;
  if (score >= 90) { grade = 'A+'; gradeCol = '#10b981'; }
  else if (score >= 80) { grade = 'A'; gradeCol = '#10b981'; }
  else if (score >= 70) { grade = 'B'; gradeCol = '#3b82f6'; }
  else if (score >= 60) { grade = 'C'; gradeCol = '#f59e0b'; }
  else if (score >= 50) { grade = 'D'; gradeCol = '#f97316'; }
  else { grade = 'F'; gradeCol = '#ef4444'; }

  // Animated SVG gauge
  const r = 52, cx = 65, cy = 62, strokeW = 10;
  const circ = 2 * Math.PI * r;
  const arc = circ * 0.75; // 270 degrees
  const filled = arc * (score / 100);

  const metrics = [
    { lbl: 'Participation', val: m1, icon: '📡', tip: `${activeToday}/${totalLeases} active today` },
    { lbl: 'Trend', val: m2, icon: '📈', tip: `${trendPct >= 0 ? '+' : ''}${trendPct.toFixed(1)}% vs prior week` },
    { lbl: 'Consistency', val: m3, icon: '⚖️', tip: `CV: ${(cv*100).toFixed(0)}% variance` },
    { lbl: 'Uptime', val: m4, icon: '🔇', tip: `${silentCount} silent lease${silentCount !== 1 ? 's' : ''}` },
    { lbl: 'Freshness', val: m5, icon: '🕐', tip: `${daysOld}d since last data` },
    { lbl: 'Diversity', val: m6, icon: '🎯', tip: `${groupVals.length} group${groupVals.length !== 1 ? 's' : ''}` }
  ];

  el.innerHTML = `
    <div style="position:relative;width:130px;height:110px;flex-shrink:0">
      <svg viewBox="0 0 130 120" style="width:130px;height:110px">
        <path d="M ${cx + r * Math.cos(Math.PI * 0.75)} ${cy + r * Math.sin(Math.PI * 0.75)}
                 A ${r} ${r} 0 1 1 ${cx + r * Math.cos(Math.PI * 0.25)} ${cy + r * Math.sin(Math.PI * 0.25)}"
              fill="none" stroke="var(--border)" stroke-width="${strokeW}" stroke-linecap="round"/>
        <path d="M ${cx + r * Math.cos(Math.PI * 0.75)} ${cy + r * Math.sin(Math.PI * 0.75)}
                 A ${r} ${r} 0 1 1 ${cx + r * Math.cos(Math.PI * 0.25)} ${cy + r * Math.sin(Math.PI * 0.25)}"
              fill="none" stroke="${gradeCol}" stroke-width="${strokeW}" stroke-linecap="round"
              stroke-dasharray="${arc}" stroke-dashoffset="${arc - filled}"
              style="transition:stroke-dashoffset 1.2s ease-out"/>
        <text x="${cx}" y="${cy - 2}" text-anchor="middle" font-size="26" font-weight="900" fill="${gradeCol}" font-family="var(--font-heading),sans-serif">${score}</text>
        <text x="${cx}" y="${cy + 14}" text-anchor="middle" font-size="12" font-weight="700" fill="var(--muted)">/ 100</text>
      </svg>
      <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:.65rem;font-weight:800;color:${gradeCol};letter-spacing:.05em">${grade}</div>
    </div>
    <div style="flex:1;min-width:200px;display:grid;grid-template-columns:1fr 1fr;gap:.35rem .8rem">
      ${metrics.map(m => {
        const barCol = m.val >= 70 ? '#10b981' : m.val >= 40 ? '#f59e0b' : '#ef4444';
        return `<div style="display:flex;align-items:center;gap:.4rem" title="${m.tip}">
          <span style="font-size:.72rem">${m.icon}</span>
          <div style="flex:1;min-width:0">
            <div style="display:flex;justify-content:space-between;font-size:.58rem;color:var(--muted);margin-bottom:.1rem">
              <span>${m.lbl}</span><strong style="color:var(--text)">${Math.round(m.val)}</strong>
            </div>
            <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
              <div style="height:100%;width:${m.val}%;background:${barCol};border-radius:2px;transition:width 1s ease-out"></div>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

/* ═══════════════════════════════════════════════════════
   FEATURE: COMPARE PERIODS
═══════════════════════════════════════════════════════ */
function cpPreset(type) {
  if (!datesSorted || !datesSorted.length) return;
  const last = datesSorted[datesSorted.length - 1];
  const d = new Date(last + 'T12:00:00');

  if (type === 'week') {
    const bEnd = new Date(d); bEnd.setDate(d.getDate());
    const bStart = new Date(d); bStart.setDate(d.getDate() - 6);
    const aEnd = new Date(bStart); aEnd.setDate(bStart.getDate() - 1);
    const aStart = new Date(aEnd); aStart.setDate(aEnd.getDate() - 6);
    document.getElementById('cpAStart').value = aStart.toISOString().slice(0, 10);
    document.getElementById('cpAEnd').value = aEnd.toISOString().slice(0, 10);
    document.getElementById('cpBStart').value = bStart.toISOString().slice(0, 10);
    document.getElementById('cpBEnd').value = bEnd.toISOString().slice(0, 10);
  } else if (type === 'month') {
    const bStart = new Date(d.getFullYear(), d.getMonth(), 1);
    const aEnd = new Date(bStart); aEnd.setDate(aEnd.getDate() - 1);
    const aStart = new Date(aEnd.getFullYear(), aEnd.getMonth(), 1);
    document.getElementById('cpAStart').value = aStart.toISOString().slice(0, 10);
    document.getElementById('cpAEnd').value = aEnd.toISOString().slice(0, 10);
    document.getElementById('cpBStart').value = bStart.toISOString().slice(0, 10);
    document.getElementById('cpBEnd').value = d.toISOString().slice(0, 10);
  }
}

function runComparePeriods() {
  const aS = document.getElementById('cpAStart')?.value;
  const aE = document.getElementById('cpAEnd')?.value;
  const bS = document.getElementById('cpBStart')?.value;
  const bE = document.getElementById('cpBEnd')?.value;
  const el = document.getElementById('comparePeriodResult');
  if (!aS || !aE || !bS || !bE || !el) { if (el) el.innerHTML = '<div style="color:#ef4444;font-size:.72rem">Please fill in all four dates.</div>'; return; }

  function periodStats(start, end) {
    const days = datesSorted.filter(d => d >= start && d <= end);
    if (!days.length) return null;
    let total = 0, txns = 0, activeSet = new Set();
    days.forEach(d => {
      (byDate[d] || []).forEach(r => {
        total += adjEarn(r.amountMicros, (r.licenseId || '').slice(-4), (r.completedAt || '').slice(0, 10));
        txns++;
        activeSet.add(r.licenseId);
      });
    });
    return { days: days.length, total, txns, active: activeSet.size, avg: total / days.length, perLease: activeSet.size > 0 ? total / activeSet.size : 0 };
  }

  const a = periodStats(aS, aE);
  const b = periodStats(bS, bE);
  if (!a || !b) { el.innerHTML = '<div style="color:#ef4444;font-size:.72rem">No data found for one or both periods.</div>'; return; }

  function delta(bv, av) { return av > 0 ? ((bv - av) / av * 100) : 0; }
  function fmtD(v) { const s = v >= 0 ? '+' : ''; return `<span style="color:${v >= 0 ? '#10b981' : '#ef4444'};font-weight:700">${s}${v.toFixed(1)}%</span>`; }

  const metrics = [
    { lbl: 'Total Earned', a: '$' + a.total.toFixed(4), b: '$' + b.total.toFixed(4), d: delta(b.total, a.total) },
    { lbl: 'Daily Average', a: '$' + a.avg.toFixed(4), b: '$' + b.avg.toFixed(4), d: delta(b.avg, a.avg) },
    { lbl: 'Per Lease', a: '$' + a.perLease.toFixed(4), b: '$' + b.perLease.toFixed(4), d: delta(b.perLease, a.perLease) },
    { lbl: 'Transactions', a: a.txns.toLocaleString(), b: b.txns.toLocaleString(), d: delta(b.txns, a.txns) },
    { lbl: 'Active Leases', a: String(a.active), b: String(b.active), d: delta(b.active, a.active) },
    { lbl: 'Days', a: String(a.days), b: String(b.days), d: delta(b.days, a.days) },
  ];

  const dayDiff = Math.abs(a.days - b.days);
  const unequalNote = dayDiff > 0 ? `<div style="font-size:.58rem;color:var(--muted);margin-top:.4rem;font-style:italic">⚠️ Periods have different lengths (${a.days} vs ${b.days} days) — Daily Average is the fairest comparison.</div>` : '';

  el.innerHTML = `<div style="display:grid;grid-template-columns:1fr auto auto auto;gap:.3rem .8rem;font-size:.68rem;align-items:center">` +
    `<div style="font-weight:700;color:var(--muted)">Metric</div><div style="font-weight:700;color:#ec4899;text-align:right">Period A</div><div style="font-weight:700;color:#8b5cf6;text-align:right">Period B</div><div style="font-weight:700;color:var(--muted);text-align:right">Change</div>` +
    metrics.map(m => `<div>${m.lbl}</div><div style="text-align:right;font-family:var(--font-mono),monospace">${m.a}</div><div style="text-align:right;font-family:var(--font-mono),monospace">${m.b}</div><div style="text-align:right">${fmtD(m.d)}</div>`).join('') +
    `</div>` + unequalNote;
}

/* ═══════════════════════════════════════════════════════
   FEATURE: NODE HEALTH DASHBOARD
═══════════════════════════════════════════════════════ */
function buildNodeHealth() {
  const el = document.getElementById('nodeHealthContent');
  if (!el || !datesSorted || !datesSorted.length) return;
  const nids = Object.keys(nodeMap);
  if (nids.length < 1) { el.innerHTML = '<div style="color:var(--muted);font-size:.72rem">Need data to build node health view.</div>'; return; }

  let html = '';
  nids.forEach((nid, idx) => {
    const nm = nodeMap[nid];
    const col = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'][idx % 6];
    const leases = leaseData.filter(l => l.node === idx + 1);
    const totalEarn = nm.earnings || 0;
    const leaseCount = nm.licenses ? nm.licenses.size : leases.length;
    const perLease = leaseCount > 0 ? totalEarn / leaseCount : 0;

    // Uptime: days this node had any earnings
    let activeDays = 0;
    datesSorted.forEach(d => {
      const hasTxn = (byDate[d] || []).some(r => {
        const l4 = r.licenseId.slice(-4);
        const lInfo = leaseData.find(l => l.last4 === l4);
        return lInfo && lInfo.node === idx + 1;
      });
      if (hasTxn) activeDays++;
    });
    const uptimePct = datesSorted.length > 0 ? (activeDays / datesSorted.length * 100) : 0;

    // Bottom 3 leases on this node
    const bottom3 = [...leases].sort((a, b) => a.alltime - b.alltime).slice(0, 3);

    html += `<div class="inner-card">
      <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
        <div style="width:10px;height:10px;border-radius:3px;background:${col}"></div>
        <span style="font-size:.78rem;font-weight:800;color:${col}">${sanitizeText(nm.name)}</span>
        <span style="font-size:.58rem;color:var(--muted)">${leaseCount} leases</span>
        <span style="margin-left:auto;font-size:.65rem;font-weight:700;color:${uptimePct >= 95 ? '#10b981' : uptimePct >= 80 ? '#f59e0b' : '#ef4444'}">${uptimePct.toFixed(1)}% uptime</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-bottom:.4rem">
        <div class="inner-panel"><div class="sec-lbl">Total Earned</div><div style="font-size:.82rem;font-weight:800;font-family:var(--font-mono),monospace;color:${col}">$${totalEarn.toFixed(4)}</div></div>
        <div class="inner-panel"><div class="sec-lbl">Per Lease</div><div style="font-size:.82rem;font-weight:800;font-family:var(--font-mono),monospace;color:${col}">$${perLease.toFixed(4)}</div></div>
        <div class="inner-panel"><div class="sec-lbl">Active Days</div><div style="font-size:.82rem;font-weight:800;font-family:var(--font-mono),monospace">${activeDays}/${datesSorted.length}</div></div>
        <div class="inner-panel"><div class="sec-lbl">Uptime</div><div style="font-size:.82rem;font-weight:800;font-family:var(--font-mono),monospace;color:${uptimePct >= 95 ? '#10b981' : uptimePct >= 80 ? '#f59e0b' : '#ef4444'}">${uptimePct.toFixed(1)}%</div></div>
      </div>
      ${bottom3.length ? `<div style="font-size:.58rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:.2rem">Lowest Earners</div>
      <div style="display:flex;gap:.3rem;flex-wrap:wrap">${bottom3.map(l =>
        `<span style="font-size:.6rem;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:.12rem .35rem">${sanitizeText(l.name)} <span style="color:${col};font-weight:700;font-family:var(--font-mono),monospace">$${l.alltime.toFixed(4)}</span></span>`
      ).join('')}</div>` : ''}
    </div>`;
  });

  el.innerHTML = html;
}
function generateShareSnapshot() {
  if (!leaseData || !leaseData.length) { showToast('⚠️', 'No Data', 'Load data first', '#f59e0b'); return; }

  const today = datesSorted[datesSorted.length - 1];
  const first = datesSorted[0];
  const totalDays = datesSorted.length;
  const allTotal = leaseData.reduce((s, l) => s + l.alltime, 0);
  const todayTotal = leaseData.reduce((s, l) => s + l.today, 0);
  const avg = allTotal / totalDays;
  const activeToday = leaseData.filter(l => l.today > 0).length;
  const totalLeases = leaseData.length;
  const nodeCount = Object.keys(nodeMap).length;
  const groupCount = Object.keys(GC).filter(g => g !== 'Unknown').length;
  const last7 = datesSorted.slice(-7).reduce((s, d) => s + (byDate[d] || []).reduce((ss, r) => ss + adjEarn(r.amountMicros, (r.licenseId || '').slice(-4), (r.completedAt || '').slice(0, 10)), 0), 0);

  const snapshot = `📊 Unity Node Stats · ${today}
━━━━━━━━━━━━━━━━━━━
💰 All-Time:  $${allTotal.toFixed(2)}
📅 Today:     $${todayTotal.toFixed(4)}
📈 7-Day:     $${last7.toFixed(4)}
📊 Daily Avg: $${avg.toFixed(4)}
━━━━━━━━━━━━━━━━━━━
🖥️ Nodes: ${nodeCount} · Groups: ${groupCount}
📋 Leases: ${activeToday}/${totalLeases} active today
📆 Tracking: ${totalDays} days (${first} → ${today})
━━━━━━━━━━━━━━━━━━━
Generated by dataNerd Dashboard v${DASHBOARD_VERSION}`;

  navigator.clipboard.writeText(snapshot)
    .then(() => showToast('📸', 'Stats Copied!', 'Shareable snapshot is on your clipboard', '#10b981'))
    .catch(() => {
      // Fallback: prompt with text
      prompt('Copy your stats snapshot:', snapshot);
      showToast('📸', 'Snapshot Ready', 'Copy the text above', '#3b82f6');
    });
}

/* ── HOOK INTO buildDashboard TO TRIGGER EXTRAS ── */
let _buildRunning = false;
const _origBuildDashboard = buildDashboard;
window.buildDashboard = function() {
  if (_buildRunning) return;
  _buildRunning = true;
  const btn = document.getElementById('loadBtn');
  if (btn) btn.disabled = true;
  _origBuildDashboard();
  // give the dashboard time to render then run extras
  setTimeout(() => {
    const allTotalEl = document.querySelector('.kc-val');
    const allTotal   = parseFloat(document.querySelector('#kpiRow .kc:first-child .kc-val')?.textContent?.replace(/[^0-9.]/g,'') || 0);
    const activeEl   = document.querySelector('#kpiRow .kc:last-child .kc-val');
    const activeToday = parseInt(activeEl?.textContent || 0,10);
    const totalKnown = window._totalKnownLeases || 1;
    const peakActive = Math.max(...(window._datesSorted||datesSorted||[]).map(d => new Set((window._byDate||byDate)[d].map(r=>r.licenseId)).size));

    // Animated counters
    document.querySelectorAll('#kpiRow .kc, #kpiRow2 .kc').forEach((el, i) => {
      const valEl = el.querySelector('.kc-val');
      if (!valEl) return;
      const text = valEl.textContent;
      const num  = parseFloat(text.replace(/[^0-9.\-]/g,''));
      if (!isNaN(num) && num > 0) {
        const prefix = text.startsWith('$') ? '$' : text.startsWith('+') ? '+' : text.startsWith('-') ? '-' : '';
        const suffix = text.endsWith('%') ? '%' : '';
        const dec    = text.includes('.') ? (text.split('.')[1]?.replace('%','').length || 2) : 0;
        setTimeout(() => animateCounter(valEl, 0, num, prefix, suffix, Math.min(dec,4), 900), i * 80);
      }
    });

    // Sparklines
    if (typeof trendData !== 'undefined') injectSparklines(trendData);

    // Ticker
    if (typeof leaseData !== 'undefined') buildTicker(leaseData);

    // Milestone celebrations disabled — uncomment to re-enable

    // Welcome toast
    const txnCount = typeof allData !== 'undefined' ? allData.length : 0;
    showToast('📊', 'Dashboard built!', `${txnCount.toLocaleString()} transactions loaded`, '#3b82f6');

    // Pre-populate names editor with lease data

    // Init card controls after all sections rendered
    loadCardState();
    setTimeout(initCardControls, 50);

    // Sync version badges from DASHBOARD_VERSION constant
    ['verBadge1','verBadge2'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = 'v' + DASHBOARD_VERSION; });

    // ── NEW FEATURES ──
    try { initOverviewFilter(); } catch(e) { console.error('[OverviewFilter]', e); }
    try { checkSilentLeases(); } catch(e) { console.error('[SilentLeases]', e); }
    try { checkExpiringLeases(); } catch(e) { console.error('[ExpiringLeases]', e); }
    try { buildHealthScore(); } catch(e) { console.error('[HealthScore]', e); }
    if (dashboardMode === 'easy') {
      try { 
        var ec = document.getElementById('easyModeCharts');
        if (ec) ec.style.display = '';
        setTimeout(renderEasyCharts, 1000);
      } catch(e) { console.error('[EasyCharts]', e); }
    }
    try { buildNodeHealth(); } catch(e) { console.error('[NodeHealth]', e); }
    try { buildNodeMap(); } catch(e) { console.error('[NodeMap]', e); }
    try { buildComparison(); } catch(e) { console.error('[Comparison]', e); }

    // Show tour on first use
    try { if (!localStorage.getItem('dnd_tourDone')) { setTimeout(startTour, 1200); } } catch(e) {}

    // Show nav bar + navigate to overview tab
    setTimeout(() => afterBuildNav(), 60);

    _buildRunning = false;
  }, 400);
};

/* ── ALSO PATCH resetDashboard to hide ticker ── */
const _origReset = resetDashboard;
window.resetDashboard = function() {
  _buildRunning = false;
  const btn = document.getElementById('loadBtn');
  if (btn) btn.disabled = false;
  _origReset();
  document.getElementById('earningsTicker').style.display = 'none';


};

/* ═══ NAMES EDITOR ═══ */
var neLeases=[],neGroups=[],neNL=1,neNG=1,neDrag=null;
var neSelected = new Set(); // bulk selection tracking
var neCollapsed = new Set(); // collapsed group tracking
var NE_C=['#ef4444','#f59e0b','#3b82f6','#10b981','#8b5cf6','#ec4899','#14b8a6','#f97316','#a855f7','#06b6d4'];

var neHasChanges=false;
function neSyncToMap(){
  // Build fresh dynamicLeaseMap from editor state
  var map={};
  var groupColors={};
  var oldMap = window._activeLeaseMap || {};
  neGroups.forEach(function(g){groupColors[g.name]=g.color;});
  neLeases.forEach(function(l){
    var grp=null;
    if(l.gid){var g=neGroups.find(function(x){return x.id===l.gid;});if(g)grp=g.name;}
    var entry={name:l.name,group:grp||'Unassigned',node:l.node};
    // Preserve individual split settings
    var old = oldMap[l.hex];
    if (old && old.splitHistory && old.splitHistory.length > 0) {
      entry.splitHistory = old.splitHistory;
      entry.split = old.split;
      entry.splitLocked = true;
    } else if (old && old.splitLocked && typeof old.split === 'number') {
      entry.split = old.split;
      entry.splitLocked = true;
    }
    map[l.hex]=entry;
  });
  map.__groupColors=groupColors;
  dynamicLeaseMap=map;
  if(typeof window!=='undefined')window._activeLeaseMap=map;
}
/* ── SPLIT UI RENDERING ── */

/**
 * Generate a UNO/ULO split slider bar.
 * Purple (left) = ULO (lease owner %), Blue (right) = UNO (node owner %)
 * Slide right = more to you (blue grows). Slide left = more to lease owner (purple grows).
 * @param {number} unoVal - UNO % (what you keep, 0-100)
 * @param {string} onchange - JS code to run on change
 */
function splitSliderHTML(unoVal, onchange) {
  var uloVal = 100 - unoVal;
  var grad = 'linear-gradient(90deg, #3b82f6 0%, #3b82f6 ' + unoVal + '%, rgba(139,92,246,.25) ' + unoVal + '%, rgba(139,92,246,.25) 100%)';
  return '<div class="split-slider-wrap">' +
    '<div class="split-slider-labels"><span class="uno-lbl">Node Op: ' + unoVal + '%</span><span class="ulo-lbl">Lease Op: ' + uloVal + '%</span></div>' +
    '<div class="split-slider-track"><input type="range" min="0" max="100" step="1" value="' + unoVal + '" style="background:' + grad + '" oninput="' + onchange + ';updateSplitBar(this)"></div>' +
    '</div>';
}

function renderSplitControls() {
  // Group sliders are rendered inline in the group headers by neRender — nothing to do here
}

/**
 * Update the visual gradient and labels when a split slider moves.
 * Slide right = more Node Op (blue fill grows left to right).
 */
function updateSplitBar(input) {
  var unoVal = +input.value;
  var uloVal = 100 - unoVal;
  input.style.background = 'linear-gradient(90deg, #3b82f6 0%, #3b82f6 ' + unoVal + '%, rgba(139,92,246,.25) ' + unoVal + '%, rgba(139,92,246,.25) 100%)';
  var wrap = input.closest('.split-slider-wrap');
  if (wrap) {
    var labels = wrap.querySelector('.split-slider-labels');
    if (labels) {
      labels.children[0].textContent = 'Node Op: ' + unoVal + '%';
      labels.children[1].textContent = 'Lease Op: ' + uloVal + '%';
    }
  }
}

/**
 * Get the effective split label for a lease (for display in editor).
 * Shows the latest/current period if splitHistory exists.
 */
function getSplitLabel(lease) {
  const lMap = window._activeLeaseMap || LEASE_MAP;
  const info = lMap[lease.hex];

  // Has split history
  if (info && info.splitHistory && info.splitHistory.length > 0) {
    var latest = info.splitHistory[info.splitHistory.length - 1];
    var periods = info.splitHistory.length;
    return { val: latest.uno, src: periods + ' period' + (periods > 1 ? 's' : ''), col: '#ef4444', locked: true };
  }

  // Individual locked (legacy)
  if (info && info.splitLocked && typeof info.split === 'number') return { val: info.split, src: 'locked', col: '#ef4444', locked: true };

  // Group
  const gName = neGroups.find(g => g.id === lease.gid)?.name;
  if (gName && typeof splitGroups[gName] === 'number') return { val: splitGroups[gName], src: 'group', col: '#10b981', locked: false };

  // Default 50%
  return { val: 50, src: 'default', col: '#6b7280', locked: false };
}

function neRender(){
  neSyncToMap();
  // Bulk selection bar
  var bulkBar = document.getElementById('neBulkBar');
  if(bulkBar){
    if(neSelected.size > 0){
      var opts = '<option value="">Move '+neSelected.size+' selected to…</option>';
      neGroups.forEach(function(g){ opts += '<option value="'+g.id+'">'+g.name.replace(/</g,'&lt;')+'</option>'; });
      opts += '<option value="__unassign">↩ Unassign</option>';
      bulkBar.innerHTML = '<div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">'
        + '<span style="font-weight:700;color:var(--primary)">'+neSelected.size+' selected</span>'
        + '<select onchange="neBulkMove(this.value)" style="padding:.25rem .4rem;font-size:.62rem;border:1px solid var(--border);border-radius:5px;background:var(--surface2);color:var(--text);cursor:pointer">'+opts+'</select>'
        + '<button class="cbtn" style="padding:.2rem .5rem;font-size:.58rem" onclick="neSelectAll()">Select All</button>'
        + '<button class="cbtn" style="padding:.2rem .5rem;font-size:.58rem" onclick="neClearSel()">Clear</button>'
        + '</div>';
      bulkBar.style.display = '';
    } else {
      bulkBar.innerHTML = '';
      bulkBar.style.display = 'none';
    }
  }
  // Search filter
  var searchBox = document.getElementById('neSearchBox');
  var neSearchTerm = searchBox ? searchBox.value.trim().toLowerCase() : '';
  // Unassigned list
  var list=document.getElementById('neUnassignedList');
  if(list){var ua=neLeases.filter(function(l){return !l.gid;});if(neSearchTerm){ua=ua.filter(function(l){return l.hex.indexOf(neSearchTerm)!==-1||l.name.toLowerCase().indexOf(neSearchTerm)!==-1;});}list.innerHTML='';ua.forEach(function(l){list.appendChild(nePill(l,true));});var c=document.getElementById('neUnassignedCount');if(c)c.textContent=ua.length;}
  // Groups
  var con=document.getElementById('neGroupsContainer');
  if(con){con.innerHTML='';neGroups.forEach(function(g){
    var gl=neLeases.filter(function(l){return l.gid===g.id;});
    var glFiltered=neSearchTerm?gl.filter(function(l){return l.hex.indexOf(neSearchTerm)!==-1||l.name.toLowerCase().indexOf(neSearchTerm)!==-1;}):gl;
    var card=document.createElement('div');card.className='ne-gc';
    var gSplit = getGroupSplit(g.name); // UNO % stored
    // Sanitize group name for HTML contexts
    var safeGName = sanitizeText(g.name);
    // Validate color is a proper hex value
    var safeColor = /^#[0-9a-fA-F]{3,6}$/.test(g.color) ? g.color : '#888888';
    // Escape group name for JS string context (prevent injection via onchange)
    var escapedGName = g.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/</g,'\\x3c').replace(/>/g,'\\x3e');
    var sliderOnchange = "splitGroups['" + escapedGName + "']=+this.value;neHasChanges=true";
    var splitSlider = '<div style="margin-left:auto;flex-shrink:0">' + splitSliderHTML(gSplit, sliderOnchange) + '</div>';
    var isCollapsed = neCollapsed.has(g.id);
    var collapseIcon = isCollapsed ? '▶' : '▼';
    card.innerHTML='<div class="ne-gc-head"><button style="background:none;border:none;cursor:pointer;font-size:.7rem;color:var(--muted);padding:.1rem .25rem;flex-shrink:0;line-height:1" onclick="neToggleCollapse('+g.id+')" title="'+(isCollapsed?'Expand':'Collapse')+'">'+collapseIcon+'</button><div class="ne-gc-swatch" style="background:'+safeColor+'"><input type="color" value="'+safeColor+'" onchange="neCC('+g.id+',this.value)"></div><input class="ne-gc-name" value="'+g.name.replace(/"/g,'&quot;').replace(/</g,'&lt;')+'" onchange="neCN('+g.id+',this.value)"><span class="ne-gc-cnt">'+gl.length+'</span>'+splitSlider+'<button class="cbtn" style="padding:.18rem .4rem;font-size:.58rem" onclick="neMO('+g.id+')">⤴</button><button class="cbtn" style="padding:.18rem .4rem;font-size:.58rem;color:#ef4444" onclick="neDG('+g.id+')">✕</button></div><div class="ne-gc-body '+(!gl.length?'empty':'')+'" data-gid="'+g.id+'" style="'+(isCollapsed?'display:none':'')+'"></div>';
    var body=card.querySelector('.ne-gc-body');
    body.addEventListener('dragover',function(e){e.preventDefault();card.classList.add('drag-over');});
    body.addEventListener('dragleave',function(e){if(!body.contains(e.relatedTarget))card.classList.remove('drag-over');});
    body.addEventListener('drop',function(e){e.preventDefault();card.classList.remove('drag-over');if(neDrag!==null){var l=neLeases.find(function(x){return x.id===neDrag;});if(l){l.gid=g.id;neHasChanges=true;neRender();}}});
    glFiltered.forEach(function(l){body.appendChild(nePill(l,false));});
    con.appendChild(card);
  });}
  // Preview
  var pre=document.getElementById('nePreview');if(pre)pre.textContent=neOutput();
  // Stats
  var a=neLeases.filter(function(l){return l.gid;}),u=neLeases.filter(function(l){return !l.gid;});
  var s=function(id,v){var e=document.getElementById(id);if(e)e.textContent=v;};
  s('neSGroups',neGroups.length);s('neSTotal',neLeases.length);s('neSAssigned',a.length);s('neSUnassigned',u.length);
  renderSplitControls();
}

function nePill(lease,isUA){
  var p=document.createElement('div');p.className='ne-pill'+(neSelected.has(lease.id)?' ne-selected':'');p.draggable=true;
  // Group color accent
  var grpColor = '#888888';
  if (lease.gid) { var grp = neGroups.find(function(x){ return x.id === lease.gid; }); if (grp && grp.color) grpColor = grp.color; }
  p.style.borderLeft = '3px solid ' + grpColor;
  p.style.background = grpColor + '08';
  var nodeLabel = 'N'+lease.node;
  var nodeColor = lease.node >= 2 ? '#8b5cf6' : 'var(--muted)';
  var selCheck = '<span class="ne-sel-box" onclick="event.stopPropagation();neToggleSel('+lease.id+')" title="Click to select">'+(neSelected.has(lease.id)?'☑':'☐')+'</span>';
  var sl = getSplitLabel(lease);
  var lockIcon = sl.locked ? '🔒' : '';
  var unoW = sl.val;
  var uloW = 100 - unoW;
  var barGrad = 'linear-gradient(90deg,#3b82f6 0%,#3b82f6 '+unoW+'%,rgba(139,92,246,.25) '+unoW+'%,rgba(139,92,246,.25) 100%)';
  var splitBadge = '<span style="display:inline-flex;align-items:center;gap:.2rem;font-size:.58rem;font-weight:600;color:'+sl.col+';background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:.1rem .3rem;flex-shrink:0;cursor:pointer" onclick="event.stopPropagation();neEditSplit('+lease.id+')" title="Node Op: '+unoW+'% · Lease Op: '+uloW+'% ('+sl.src+') · Click to edit">'+lockIcon+'<span style="display:inline-block;width:26px;height:5px;border-radius:2px;background:'+barGrad+'"></span><span style="color:#3b82f6">'+unoW+'</span>/<span style="color:#8b5cf6">'+uloW+'</span></span>';
  // Expiry flag
  var expiryBadge = '';
  if (lease.expiry) {
    var today = new Date(); today.setHours(0,0,0,0);
    var expD = new Date(lease.expiry + 'T00:00:00'); 
    var daysLeft = Math.ceil((expD - today) / 86400000);
    if (daysLeft <= 0) {
      expiryBadge = '<span style="font-size:.75rem;cursor:help;flex-shrink:0" title="Lease EXPIRED on '+lease.expiry+'">🚫</span>';
    } else if (daysLeft <= 5) {
      expiryBadge = '<span style="font-size:.75rem;cursor:help;flex-shrink:0" title="Lease expires in '+daysLeft+' day'+(daysLeft!==1?'s':'')+' ('+lease.expiry+')">🚩</span>';
    } else if (daysLeft <= 14) {
      expiryBadge = '<span style="font-size:.75rem;cursor:help;flex-shrink:0" title="Lease expires in '+daysLeft+' days ('+lease.expiry+')">⚠️</span>';
    } else {
      expiryBadge = '<span style="font-size:.65rem;color:var(--muted);cursor:help;flex-shrink:0" title="Expires '+lease.expiry+' ('+daysLeft+' days)">📅</span>';
    }
  }
  var expiryBtn = '<span style="font-size:.6rem;color:var(--muted);cursor:pointer;flex-shrink:0;padding:.1rem .3rem;border:1px solid var(--border);border-radius:4px;background:var(--surface2)" onclick="event.stopPropagation();neEditExpiry('+lease.id+')" title="'+(lease.expiry ? 'Expires: '+lease.expiry+' · Click to change' : 'Set lease expiry date')+'">'+(lease.expiry ? '📅'+lease.expiry : '📅 exp')+'</span>';
  p.innerHTML=selCheck+'<span class="ne-hex">'+lease.hex+'</span><span class="ne-name" onclick="neEdit(this,'+lease.id+')" style="cursor:pointer" title="Click to rename">'+lease.name.replace(/</g,'&lt;')+'</span>'+expiryBadge+'<span style="font-size:.62rem;font-weight:700;color:'+nodeColor+';background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:.1rem .35rem;flex-shrink:0" title="Auto-detected from earnings data">'+nodeLabel+'</span>'+splitBadge+expiryBtn+(isUA?'':'<button class="ne-rm" onclick="event.stopPropagation();neUA('+lease.id+')">⤴</button>');
  p.addEventListener('dragstart',function(e){neDrag=lease.id;p.classList.add('dragging');e.dataTransfer.effectAllowed='move';});
  p.addEventListener('dragend',function(){p.classList.remove('dragging');neDrag=null;});
  return p;
}

function neToggleSel(lid){
  if(neSelected.has(lid)) neSelected.delete(lid); else neSelected.add(lid);
  neRender();
}
function neSelectAll(){
  neLeases.forEach(function(l){ neSelected.add(l.id); });
  neRender();
}
function neClearSel(){
  neSelected.clear();
  neRender();
}
function neBulkMove(val){
  if(!val || !neSelected.size) return;
  if(val === '__unassign'){
    neLeases.forEach(function(l){ if(neSelected.has(l.id)) l.gid = null; });
  } else {
    var gid = parseInt(val,10);
    neLeases.forEach(function(l){ if(neSelected.has(l.id)) l.gid = gid; });
  }
  neSelected.clear();
  neHasChanges = true;
  neRender();
}

function neOutput(){
  var lines=['# dataNerds Unity — Lease Names',''];

  // Export split settings (group splits)
  var hasGroupSplits = Object.keys(splitGroups).length > 0;
  if (hasGroupSplits) {
    lines.push('# Split Settings');
    Object.keys(splitGroups).forEach(function(g) {
      lines.push('split:group:' + g + '  ' + splitGroups[g]);
    });
    lines.push('');
  }

  // Export node names and order
  var nodeIds = Object.keys(nodeMap);
  if (nodeIds.length > 0) {
    lines.push('# Nodes');
    nodeIds.forEach(function(nid, idx) {
      lines.push('nodename:' + nid + '  ' + nodeMap[nid].name + '  n' + (idx + 1));
    });
    lines.push('');
  }

  neGroups.forEach(function(g){
    var gl = neLeases.filter(function(l){ return l.gid === g.id; });
    if (!gl.length) return;
    lines.push('# ' + g.name + ' — ' + g.color);
    gl.forEach(function(l){
      var lMap = window._activeLeaseMap || LEASE_MAP;
      var info = lMap[l.hex];
      var splitStr = '';
      if (info && info.splitHistory && info.splitHistory.length > 0) {
        // Export as: sh:2026-01-01=50,2026-02-01=30
        splitStr = '  sh:' + info.splitHistory.map(function(h){ return h.from + '=' + h.uno; }).join(',');
      } else if (info && info.splitLocked && typeof info.split === 'number') {
        splitStr = '  s' + info.split;
      }
      var expiryStr = l.expiry ? '  exp:' + l.expiry : ''; lines.push(l.name + '  ' + l.hex + '  n' + l.node + splitStr + expiryStr);
    });
    lines.push('');
  });
  var ua = neLeases.filter(function(l){ return !l.gid; });
  if (ua.length) {
    lines.push('# Unassigned');
    ua.forEach(function(l){
      var lMap = window._activeLeaseMap || LEASE_MAP;
      var info = lMap[l.hex];
      var splitStr = '';
      if (info && info.splitHistory && info.splitHistory.length > 0) {
        splitStr = '  sh:' + info.splitHistory.map(function(h){ return h.from + '=' + h.uno; }).join(',');
      } else if (info && info.splitLocked && typeof info.split === 'number') {
        splitStr = '  s' + info.split;
      }
      var expiryStr = l.expiry ? '  exp:' + l.expiry : ''; lines.push(l.name + '  ' + l.hex + '  n' + l.node + splitStr + expiryStr);
    });
  }
  // Export notes
  if(notesData && Object.keys(notesData).length > 0){
    lines.push('');lines.push('# Notes');
    Object.keys(notesData).sort().forEach(function(date){
      lines.push('note:'+date+'  '+notesData[date].replace(/\n/g,' '));
    });
  }
  // Export settings (goal, alerts)
  var settingsLines = [];
  try {
    var goalVal = document.getElementById('goalInput')?.value;
    if (goalVal && parseFloat(goalVal) > 0) settingsLines.push('setting:monthlyGoal  ' + goalVal);
    var alertLease = document.getElementById('alertLeaseMin')?.value;
    if (alertLease && parseFloat(alertLease) > 0) settingsLines.push('setting:alertLeaseMin  ' + alertLease);
    var alertDay = document.getElementById('alertDayMin')?.value;
    if (alertDay && parseFloat(alertDay) > 0) settingsLines.push('setting:alertDayMin  ' + alertDay);
    if (favLeases.size > 0) settingsLines.push('setting:favorites  ' + [...favLeases].join(','));
  } catch(e) {}
  if (settingsLines.length > 0) {
    lines.push('');lines.push('# Settings');
    settingsLines.forEach(function(s) { lines.push(s); });
  }
  return lines.join('\n');
}

function neAddGroup() {
  const id = neNG++;
  neGroups.unshift({ id: id, name: 'Group ' + id, color: NE_C[(neGroups.length) % NE_C.length] });
  neHasChanges = true;
  neRender();
  setTimeout(() => {
    const first = document.querySelector('.ne-gc');
    if (first) first.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 50);
}

function neToggleCollapse(gid) {
  if (neCollapsed.has(gid)) neCollapsed.delete(gid);
  else neCollapsed.add(gid);
  neRender();
}

function neCollapseAll() {
  neGroups.forEach(g => neCollapsed.add(g.id));
  neRender();
}

function neExpandAll() {
  neCollapsed.clear();
  neRender();
}

function neDG(gid) {
  neLeases.forEach(function(l) { if (l.gid === gid) l.gid = null; });
  neGroups = neGroups.filter(function(g) { return g.id !== gid; });
  neHasChanges = true;
  neRender();
}

function neCC(gid, c) {
  const g = neGroups.find(function(x) { return x.id === gid; });
  if (g) { g.color = c; neHasChanges = true; neRender(); }
}

function neCN(gid, n) {
  const g = neGroups.find(function(x) { return x.id === gid; });
  if (g) { g.name = n || 'Unnamed'; neHasChanges = true; neRender(); }
}

function neMO(gid) {
  neLeases.forEach(function(l) { if (l.gid === gid) l.gid = null; });
  neRender();
}


function neUA(lid) {
  const l = neLeases.find(function(x) { return x.id === lid; });
  if (l) { l.gid = null; neHasChanges = true; neRender(); }
}


function applyNodeNamesFromFile() {
  if (!dynamicLeaseMap || !dynamicLeaseMap.__nodeNames) return;
  const saved = dynamicLeaseMap.__nodeNames;
  const savedIds = Object.keys(saved);
  if (!savedIds.length) return;

  // If nodeMap is empty (e.g. archive without nodeId), create entries from naming file
  if (!Object.keys(nodeMap).length && savedIds.length) {
    // Sort by saved order
    savedIds.sort((a, b) => (saved[a].order || 99) - (saved[b].order || 99));
    savedIds.forEach(nid => {
      nodeMap[nid] = {
        id: nid,
        name: saved[nid].name || 'Node ' + (Object.keys(nodeMap).length + 1),
        leaseCount: 0,
        earnings: 0
      };
    });

    // Build license→node mapping from naming file lease assignments
    if (typeof neLeases !== 'undefined' && neLeases.length) {
      const nodeIds = Object.keys(nodeMap);
      neLeases.forEach(l => {
        const nodeIdx = (l.node || 1) - 1;
        if (nodeIds[nodeIdx] && nodeMap[nodeIds[nodeIdx]]) {
          nodeMap[nodeIds[nodeIdx]].leaseCount = (nodeMap[nodeIds[nodeIdx]].leaseCount || 0) + 1;
        }
      });
    }

    // Calculate earnings per node from allData using naming file assignments
    if (allData && allData.length && typeof neLeases !== 'undefined') {
      const nodeIds = Object.keys(nodeMap);
      allData.forEach(r => {
        const last4 = (r.licenseId || '').slice(-4);
        const lease = neLeases.find(l => l.hex === last4);
        if (lease) {
          const nodeIdx = (lease.node || 1) - 1;
          if (nodeIds[nodeIdx] && nodeMap[nodeIds[nodeIdx]]) {
            nodeMap[nodeIds[nodeIdx]].earnings += (r.amountMicros || 0) / 1e6;
          }
        }
      });
    }
    return;
  }

  const currentIds = Object.keys(nodeMap);
  if (!currentIds.length) return;

  // Apply saved names to matching nodes
  currentIds.forEach(nid => {
    if (saved[nid] && saved[nid].name) {
      nodeMap[nid].name = saved[nid].name;
    }
  });

  // Reorder nodeMap based on saved order
  const sortedIds = currentIds.slice().sort(function(a, b) {
    const orderA = saved[a] ? saved[a].order : 999;
    const orderB = saved[b] ? saved[b].order : 999;
    return orderA - orderB;
  });

  // Rebuild nodeMap in new order
  const reordered = {};
  sortedIds.forEach(function(nid) { reordered[nid] = nodeMap[nid]; });
  // Add any nodes not in saved data at the end
  currentIds.forEach(function(nid) { if (!reordered[nid]) reordered[nid] = nodeMap[nid]; });
  nodeMap = reordered;

  // Rebuild _licenseNodeMap (unchanged, just ensure it's fresh)
  // Update lease node numbers based on new order
  if (typeof neLeases !== 'undefined' && neLeases.length && window._licenseNodeMap) {
    const nodeIds = Object.keys(nodeMap);
    const nodeNumMap = {};
    nodeIds.forEach(function(nid, i) { nodeNumMap[nid] = i + 1; });
    neLeases.forEach(function(lease) {
      const nid = window._licenseNodeMap[lease.hex];
      if (nid && nodeNumMap[nid]) lease.node = nodeNumMap[nid];
    });
  }
}

function moveNodeUp(nid) {
  const ids = Object.keys(nodeMap);
  const idx = ids.indexOf(nid);
  if (idx <= 0) return;
  // Swap with previous
  const temp = ids[idx - 1];
  ids[idx - 1] = ids[idx];
  ids[idx] = temp;
  // Rebuild nodeMap in new order
  const reordered = {};
  ids.forEach(function(id) { reordered[id] = nodeMap[id]; });
  nodeMap = reordered;
  // Reassign all lease node numbers
  reassignLeaseNodes();
  renderNodeNames();
  neHasChanges = true;
}

function moveNodeDown(nid) {
  const ids = Object.keys(nodeMap);
  const idx = ids.indexOf(nid);
  if (idx < 0 || idx >= ids.length - 1) return;
  // Swap with next
  const temp = ids[idx + 1];
  ids[idx + 1] = ids[idx];
  ids[idx] = temp;
  // Rebuild nodeMap in new order
  const reordered = {};
  ids.forEach(function(id) { reordered[id] = nodeMap[id]; });
  nodeMap = reordered;
  // Reassign all lease node numbers
  reassignLeaseNodes();
  renderNodeNames();
  neHasChanges = true;
}

function reassignLeaseNodes() {
  if (!window._licenseNodeMap || !neLeases) return;
  const nodeIds = Object.keys(nodeMap);
  const nodeNumMap = {};
  nodeIds.forEach(function(nid, i) { nodeNumMap[nid] = i + 1; });
  neLeases.forEach(function(lease) {
    const nid = window._licenseNodeMap[lease.hex];
    if (nid && nodeNumMap[nid]) lease.node = nodeNumMap[nid];
  });
  if (typeof neRender === 'function') neRender();
}

function renderNodeNames() {
  const container = document.getElementById('nodeNamesContainer');
  if (!container) return;
  const nodes = Object.entries(nodeMap);
  if (!nodes.length) {
    container.innerHTML = '<div style="color:var(--muted);font-size:.78rem">No nodes found in loaded data.</div>';
    return;
  }

  // Build node→licenses map from allData
  const nodeLicenses = {};
  allData.forEach(r => {
    if (!r.nodeId) return;
    if (!nodeLicenses[r.nodeId]) nodeLicenses[r.nodeId] = new Set();
    nodeLicenses[r.nodeId].add(r.licenseId);
  });

  const totalNodes = nodes.length;
  let html = '<div style="display:flex;flex-direction:column;gap:.6rem">';
  nodes.forEach(([nid, info], idx) => {
    const nodeNum = idx + 1;
    const shortId = nid.slice(0, 10) + '…' + nid.slice(-6);
    const licenses = nodeLicenses[nid] ? Array.from(nodeLicenses[nid]).sort() : [];

    html += `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:.85rem 1.1rem">
      <div style="display:flex;align-items:center;gap:.8rem;flex-wrap:wrap">
        <button class="node-collapse-btn" onclick="var b=this.closest('div').parentElement.querySelector('.node-card-body');if(b.style.display==='none'){b.style.display='';this.textContent='▼'}else{b.style.display='none';this.textContent='▶'}" style="background:none;border:none;cursor:pointer;font-size:.7rem;color:var(--muted);padding:.1rem .25rem;flex-shrink:0;line-height:1">▼</button>
        <div style="flex-shrink:0;display:flex;flex-direction:column;gap:.25rem;align-items:center">
          <div style="width:38px;height:38px;border-radius:9px;background:linear-gradient(135deg,#f59e0b,#d97706);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.85rem">N${nodeNum}</div>
          <div style="display:flex;gap:.2rem">
            <button onclick="moveNodeUp('${nid}')" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.15rem .3rem;font-size:.65rem;cursor:pointer;color:var(--text);opacity:${idx === 0 ? '.3' : '1'}" ${idx === 0 ? 'disabled' : ''} title="Move up">▲</button>
            <button onclick="moveNodeDown('${nid}')" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:.15rem .3rem;font-size:.65rem;cursor:pointer;color:var(--text);opacity:${idx === totalNodes - 1 ? '.3' : '1'}" ${idx === totalNodes - 1 ? 'disabled' : ''} title="Move down">▼</button>
          </div>
        </div>
        <div style="flex:1;min-width:160px">
          <input type="text" value="${info.name.replace(/"/g, '&quot;')}" onchange="saveNodeName('${nid}', this.value)" style="background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:.4rem .65rem;font-size:.88rem;font-weight:700;color:var(--text);width:100%;max-width:250px;outline:none" spellcheck="false" placeholder="Name this node">
        </div>
        <div style="display:flex;gap:1.2rem;font-size:.78rem;color:var(--muted);flex-wrap:wrap">
          <span>🔑 <strong style="color:var(--text)">${info.leaseCount}</strong> licenses</span>
          <span>💰 <strong style="color:var(--text)">$${info.earnings.toFixed(2)}</strong> total</span>
        </div>
        <div style="font-family:var(--font-mono);font-size:.62rem;color:var(--muted);word-break:break-all" title="${nid}">${shortId}</div>
      </div>
      <div class="node-card-body" style="margin-top:.35rem">
        <details>
          <summary style="font-size:.72rem;color:var(--muted);cursor:pointer;font-weight:600">Show ${licenses.length} licenses on this node</summary>
          <div style="display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.4rem;max-height:200px;overflow-y:auto;padding:.25rem 0">
            ${licenses.map(lid => {
              const last4 = lid.slice(-4);
              const leaseName = typeof getLeaseName === 'function' ? getLeaseName(last4) : last4;
              return `<span style="background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:.2rem .5rem;font-size:.68rem;font-family:var(--font-mono);color:var(--text2)" title="${lid}">${leaseName} <span style="color:var(--muted)">${last4}</span></span>`;
            }).join('')}
          </div>
        </details>
      </div>
    </div>`;
  });

  html += '</div>';
  container.innerHTML = html;
}

function saveNodeName(nodeId, name) {
  if (nodeMap[nodeId]) {
    nodeMap[nodeId].name = name;
    neHasChanges = true;
  }
}

function neEditSplit(lid) {
  var l = neLeases.find(function(x){ return x.id === lid; });
  if (!l) return;
  var lMap = window._activeLeaseMap || LEASE_MAP;
  var info = lMap[l.hex];
  var gName = neGroups.find(g => g.id === l.gid)?.name || 'Unassigned';
  var groupVal = getGroupSplit(gName);
  var hist = (info && info.splitHistory) ? info.splitHistory : [];

  // Build the prompt showing current history
  var msg = l.name + ' — Split History\n';
  msg += 'Group default (' + gName + '): Node Op ' + groupVal + '% / Lease Op ' + (100-groupVal) + '%\n\n';

  if (hist.length > 0) {
    msg += 'Current periods:\n';
    hist.forEach(function(h, i) {
      msg += '  ' + (i+1) + '. From ' + h.from + ': Node Op ' + h.uno + '% / Lease Op ' + (100-h.uno) + '%\n';
    });
    msg += '\n';
  } else {
    msg += 'No individual periods set (follows group)\n\n';
  }

  msg += 'Options:\n';
  msg += '  • Enter "add" to add a new split period\n';
  msg += '  • Enter a number (1-' + hist.length + ') to remove that period\n';
  msg += '  • Enter "clear" to remove all and follow group\n';
  msg += '  • Cancel to keep as-is';

  var val = prompt(msg);
  if (val === null) return;
  val = val.trim().toLowerCase();

  if (val === 'clear') {
    if (info) {
      delete info.splitHistory;
      delete info.split;
      delete info.splitLocked;
    }
    neHasChanges = true;
    neRender();
    showToast('🔓', 'Cleared', l.name + ' now follows group', '#10b981');
    return;
  }

  if (val === 'add') {
    var today = new Date().toISOString().slice(0,10);
    var fromDate = prompt(l.name + ' — New split period\n\nStart date (YYYY-MM-DD):\n(Earnings on or after this date will use this split)', today);
    if (!fromDate) return;
    // Validate date format
    if (!/^\d{4}-\d{2}-\d{2}$/.test(fromDate.trim())) {
      showToast('⚠️', 'Invalid Date', 'Use YYYY-MM-DD format', '#f59e0b');
      return;
    }
    fromDate = fromDate.trim();

    var uloStr = prompt(l.name + ' — Starting ' + fromDate + '\n\nWhat % does the Lease Operator get? (0-99)\n(You keep the rest)');
    if (uloStr === null) return;
    var ulo = parseInt(uloStr,10);
    if (isNaN(ulo) || ulo < 0 || ulo > 99) {
      showToast('⚠️', 'Invalid', 'Enter 0-99', '#f59e0b');
      return;
    }

    var unoVal = 100 - ulo;
    if (!lMap[l.hex]) lMap[l.hex] = { name: l.name, group: gName, node: l.node };
    if (!lMap[l.hex].splitHistory) lMap[l.hex].splitHistory = [];

    // Check if period with same date exists — replace it
    var existing = lMap[l.hex].splitHistory.findIndex(function(h) { return h.from === fromDate; });
    if (existing >= 0) {
      lMap[l.hex].splitHistory[existing].uno = unoVal;
    } else {
      lMap[l.hex].splitHistory.push({ from: fromDate, uno: unoVal });
    }

    // Sort by date ascending
    lMap[l.hex].splitHistory.sort(function(a, b) { return a.from.localeCompare(b.from); });

    // Also set legacy fields for backward compat (latest period)
    var latest = lMap[l.hex].splitHistory[lMap[l.hex].splitHistory.length - 1];
    lMap[l.hex].split = latest.uno;
    lMap[l.hex].splitLocked = true;

    neHasChanges = true;
    neRender();
    showToast('🔒', 'Split Added', l.name + ': Node Op ' + unoVal + '% from ' + fromDate, '#3b82f6');
    return;
  }

  // Number = remove that period
  var removeIdx = parseInt(val,10);
  if (!isNaN(removeIdx) && removeIdx >= 1 && removeIdx <= hist.length) {
    var removed = hist[removeIdx - 1];
    hist.splice(removeIdx - 1, 1);
    if (info) {
      if (hist.length === 0) {
        delete info.splitHistory;
        delete info.split;
        delete info.splitLocked;
      } else {
        info.splitHistory = hist;
        var latest2 = hist[hist.length - 1];
        info.split = latest2.uno;
        info.splitLocked = true;
      }
    }
    neHasChanges = true;
    neRender();
    showToast('🗑️', 'Removed', 'Removed period from ' + removed.from, '#ef4444');
    return;
  }
}

function neEditExpiry(lid) {
  var l = neLeases.find(function(x) { return x.id === lid; });
  if (!l) return;
  var current = l.expiry || '';
  var input = prompt('Set lease expiry date for ' + l.name + '\\n\\nFormat: YYYY-MM-DD\\nLeave empty to clear.', current);
  if (input === null) return; // cancelled
  input = input.trim();
  if (input === '') { l.expiry = null; neHasChanges = true; neRender(); return; }
  if (!/^\d{4}-\d{2}-\d{2}$/.test(input)) { alert('Invalid date format. Use YYYY-MM-DD (e.g. 2026-06-15)'); return; }
  l.expiry = input;
  neHasChanges = true;
  neRender();
}

function neEdit(span, lid) {
  const l = neLeases.find(function(x) { return x.id === lid; });
  if (!l) return;
  const inp = document.createElement('input');
  inp.className = 'ne-input';
  inp.style.cssText = 'width:100%;padding:.15rem .3rem;font-size:.64rem';
  inp.value = l.name;
  span.replaceWith(inp);
  inp.focus();
  inp.select();
  inp.addEventListener('blur', function() {
    const nv = inp.value.trim().replace(/\s+/g, '-') || l.hex;
    if (nv !== l.name) { l.name = nv; neHasChanges = true; }
    neRender();
  });
  inp.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') inp.blur();
    if (e.key === 'Escape') neRender();
  });
}
function neAddManual() {
  const hexEl = document.getElementById('neAddHex');
  const nameEl = document.getElementById('neAddName');
  const hex = hexEl.value.trim().toLowerCase();
  const name = nameEl.value.trim() || hex;
  if (!/^[0-9a-f]{4}$/.test(hex)) { showToast('⚠️', 'Invalid', '4 hex chars', '#f59e0b'); return; }
  if (neLeases.find(function(l) { return l.hex === hex; })) { showToast('⚠️', 'Exists', hex, '#f59e0b'); return; }
  neLeases.push({ id: neNL++, name: name, hex: hex, node: 1, gid: null, expiry: null });
  nameEl.value = '';
  hexEl.value = '';
  neRender();
}
function neShowImportModal() {
  const m = document.getElementById('neImportModal');
  if (m) m.classList.add('on');
}

function neCloseImport() {
  const m = document.getElementById('neImportModal');
  if (m) m.classList.remove('on');
}

function neLoadFile(input) {
  if (!input.files[0]) return;
  const r = new FileReader();
  r.onerror = function() { console.warn('[NamesEditor] Failed to read file'); };
  r.onload = function(e) { document.getElementById('neImportText').value = e.target.result; };
  r.readAsText(input.files[0]);
}
function neDoImport() {
  const text = document.getElementById('neImportText').value;
  if (!text.trim()) return;

  neLeases = []; neGroups = []; neNL = 1; neNG = 1; notesData = {};
  const gMap = {};
  let curGid = null;

  text.split(/\r?\n/).forEach(function(line) {
    const s = line.trim();

    // Node name line: "nodename:NODEID  Name  n#"
    const nodeM = s.match(/^nodename:(\S+)\s+(.+?)\s+(n\d{1,2})\s*$/i);
    if (nodeM) {
      const nid = nodeM[1];
      if (nodeMap[nid]) nodeMap[nid].name = nodeM[2].trim();
      return;
    }

    // Note line: "note:key  text"
    const noteM = s.match(/^note:([\w:\-]+)\s+(.+)$/i);
    if (noteM) { notesData[noteM[1]] = noteM[2].trim(); return; }

    // Settings line: "setting:key  value"
    const setM = s.match(/^setting:(\w+)\s+(.+)$/i);
    if (setM) {
      try {
        if (setM[1] === 'monthlyGoal') { var gi = document.getElementById('goalInput'); if (gi) gi.value = setM[2].trim(); }
        if (setM[1] === 'alertLeaseMin') { var ali = document.getElementById('alertLeaseMin'); if (ali) ali.value = setM[2].trim(); }
        if (setM[1] === 'alertDayMin') { var adi = document.getElementById('alertDayMin'); if (adi) adi.value = setM[2].trim(); }
        if (setM[1] === 'favorites') { try { favLeases = new Set(setM[2].trim().split(',').filter(function(x){return /^[0-9a-f]{4}$/.test(x);})); saveFavorites(); } catch(e){} }
      } catch(e) {}
      return;
    }
    const gd = s.match(/^#\s*([\w][\w\s\-\.&]+?)(?:\s*[\u2014\u2013\u2015\-]{1,2}\s*(?:#([0-9a-fA-F]{3,6}))?)?$/);
    if (gd) {
      const c = gd[1].trim();
      const col = gd[2] ? '#' + gd[2] : null;
      if (!/^format|^note|^dataNerds|^Generated|^Lease Names|^SIG|^Nodes$/i.test(c) && c.length >= 2 && c.length <= 40) {
        if (!gMap[c]) {
          const id = neNG++;
          neGroups.push({ id: id, name: c, color: col || NE_C[Object.keys(gMap).length % NE_C.length] });
          gMap[c] = id;
        }
        curGid = gMap[c];
      }
      return;
    }

    // Lease line: "Name  hex  node  [split]  [expiry]"
    var rm = s.match(/^([A-Za-z0-9][A-Za-z0-9_\-\.]*)?\s+([0-9a-fA-F]{4})\s+(y|n\d{1,2})(?:\s+(?:s\d{1,3}|sh:[^\s]+))?(?:\s+exp:\d{4}-\d{2}-\d{2})?\s*$/i);
    if (!rm) rm = s.match(/^([A-Za-z0-9][A-Za-z0-9_\-\.]*)?\s*([0-9a-fA-F]{4})\s*(y|n\d{1,2})?\s*$/i);
    if (!rm) return;

    const nm = (rm[1] || rm[2]).trim();
    const hex = rm[2].toLowerCase();
    let node = 1;
    const f = (rm[3] || '').toLowerCase();
    if (f === 'n1') node = 1;
    else if (f === 'y' || f === 'n2') node = 2;
    else if (f === 'n3') node = 3;
    else if (f === 'n4') node = 4;
    else if (f === 'n5') node = 5;
    else if (f === 'n6') node = 6;

    if (!neLeases.find(function(l) { return l.hex === hex; })) {
      neLeases.push({ id: neNL++, name: nm, hex: hex, node: node, gid: curGid, expiry: null });
    }
  });

  syncNotesToMap();
  neRender();
  neCloseImport();
  const nc = Object.keys(notesData).length;
  showToast('✅', 'Imported', neLeases.length + ' leases' + (nc ? ' + ' + nc + ' notes' : ''), '#10b981');
}
function neExportFile() {
  // Save split settings into dynamicLeaseMap before export
  saveSplitSettings(dynamicLeaseMap);
  const output = neOutput();
  const blob = new Blob([output], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Naming_File_UnityNodes_' + new Date().toISOString().slice(0,10) + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  neHasChanges = false;
  showToast('💾', 'Naming File Saved', 'Naming_File_UnityNodes → Downloads', '#8b5cf6');
  neHasUnsavedNotes = false;
  hideUnsavedBanner();
  showToast('💾', 'Exported', 'Unity Lease_Node_Group_Names.txt — upload this file next time to keep your names & notes', '#10b981');
}
function nePopulate(){
  if(neLeases.length>0)return;
  var seen={};
  // Build nodeId→nodeNumber map
  var nodeIds = Object.keys(nodeMap || {});
  var nodeNumMap = {};
  nodeIds.forEach(function(nid, i){ nodeNumMap[nid] = i + 1; });
  var licNodeMap = window._licenseNodeMap || {};

  // Helper: get node number for a last4 hex
  function getAutoNode(hex) {
    var nid = licNodeMap[hex];
    if (nid && nodeNumMap[nid]) return nodeNumMap[nid];
    return 1;
  }

  // From naming file
  if(dynamicLeaseMap){
    var keys=Object.keys(dynamicLeaseMap).filter(function(k){return k.charAt(0)!=='_';});
    if(keys.length>0){
      var colors=dynamicLeaseMap.__groupColors||{};
      var gMap={};
      keys.forEach(function(hex){
        var info=dynamicLeaseMap[hex];
        var gName=info.group||'Unassigned';
        if(gName!=='Unassigned'&&!gMap[gName]){
          var id=neNG++;
          neGroups.push({id:id,name:gName,color:colors[gName]||NE_C[Object.keys(gMap).length%NE_C.length]});
          gMap[gName]=id;
        }
        // Naming file node takes priority; only use auto-detect if naming file has no node
        var namingNode = info.node || 0;
        var autoNode = namingNode > 0 ? namingNode : getAutoNode(hex);
        var node = autoNode || 1;
        neLeases.push({id:neNL++,name:info.name||hex,hex:hex,node:node,gid:gMap[gName]||null,expiry:info.expiry||null});
        seen[hex]=true;
      });
    }
  }
  // From earnings data (leases not in naming file)
  if(allData&&allData.length>0){
    allData.forEach(function(r){
      if(r.licenseId){
        var h=r.licenseId.slice(-4).toLowerCase();
        if(/^[0-9a-f]{4}$/.test(h)&&!seen[h]){
          neLeases.push({id:neNL++,name:h,hex:h,node:getAutoNode(h),gid:null,expiry:null});
          seen[h]=true;
        }
      }
    });
  }
  neRender();
}
// Left panel drop target
(function(){var lp=document.getElementById('neLeftPanel');if(!lp)return;lp.addEventListener('dragover',function(e){e.preventDefault();});lp.addEventListener('drop',function(e){e.preventDefault();if(neDrag!==null){var l=neLeases.find(function(x){return x.id===neDrag;});if(l){l.gid=null;neHasChanges=true;neRender();}}});})();

// Warn before closing if names were edited but not exported
window.addEventListener('beforeunload',function(e){
  if(neHasChanges || neHasUnsavedNotes){e.preventDefault();e.returnValue='';}
});

// Also prompt when navigating away from editor tab with unsaved changes
var _origShowPage=showPage;
showPage=function(page){
  if(neHasChanges&&typeof _currentPage!=='undefined'&&_currentPage==='editor'&&page!=='editor'){
    if(!confirm('You have unsaved name changes!\n\nClick OK to leave (changes still apply this session)\nor Cancel to go back and Export your naming file.')){return;}
  }
  _origShowPage(page);
};

/* ═══════════════════════════════════════════════════════
   FILE INTEGRITY VERIFICATION
   Uses SubtleCrypto (built-in browser API — no external calls).
   User pastes the known SHA-256 hash and clicks Verify.
   Tries fetch first (works on http), falls back to a file
   picker for local file:// usage.
═══════════════════════════════════════════════════════ */
async function computeHashFromBytes(buf) {
  var hashBuf = await crypto.subtle.digest('SHA-256', buf);
  return Array.from(new Uint8Array(hashBuf)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
}

async function verifyFileIntegrity() {
  var badge = document.getElementById('integrityBadge');
  var icon  = document.getElementById('integrityIcon');
  var txt   = document.getElementById('integrityText');
  var input = document.getElementById('hashInput');
  if (!badge || !input) return;

  var userHash = (input.value || '').trim().toLowerCase();
  if (!userHash) {
    badge.style.background  = 'rgba(245,158,11,.1)';
    badge.style.borderColor = 'rgba(245,158,11,.3)';
    icon.textContent = '⚠️';
    txt.textContent  = 'Please paste a SHA-256 hash first';
    txt.style.color  = '#d97706';
    return;
  }

  if (!/^[0-9a-f]{64}$/.test(userHash)) {
    badge.style.background  = 'rgba(239,68,68,.1)';
    badge.style.borderColor = 'rgba(239,68,68,.4)';
    icon.textContent = '❌';
    txt.textContent  = 'Invalid hash — must be 64 hex characters';
    txt.style.color  = '#dc2626';
    return;
  }

  icon.textContent = '⏳';
  txt.textContent  = 'Computing file hash…';
  txt.style.color  = '#6a8898';
  badge.style.background  = 'rgba(0,0,0,.03)';
  badge.style.borderColor = 'rgba(0,0,0,.08)';

  // Try fetch first (works on http/https)
  try {
    var resp = await fetch(window.location.href);
    if (resp.ok) {
      var buf = await resp.arrayBuffer();
      var fileHash = await computeHashFromBytes(buf);
      showHashResult(fileHash, userHash, badge, icon, txt);
      return;
    }
  } catch(e) { /* fetch failed — likely file:// */ }

  // Fallback for local files: prompt user to select the HTML file
  badge.style.background  = 'rgba(59,130,246,.08)';
  badge.style.borderColor = 'rgba(59,130,246,.2)';
  icon.textContent = '📂';
  txt.innerHTML = '<strong>One more step needed!</strong><br>' +
    '1. Click the blue <strong>"Choose File"</strong> button below<br>' +
    '2. Find this same dashboard file on your computer (the .html file you opened)<br>' +
    '3. Select it and click Open — verification will complete automatically<br><br>' +
    '<label style="display:inline-block;background:#3b82f6;color:#fff;padding:.35rem .8rem;border-radius:6px;cursor:pointer;font-weight:700;font-size:.62rem">' +
    '📂 Choose File <input type="file" accept=".html,.htm" style="display:none" id="hashFileInput">' +
    '</label>';
  txt.style.color = '#1e3a5f';

  var fi = document.getElementById('hashFileInput');
  fi.onchange = async function() {
    if (!fi.files[0]) return;
    icon.textContent = '⏳';
    txt.textContent = 'Computing…';
    var buf = await fi.files[0].arrayBuffer();
    var fileHash = await computeHashFromBytes(buf);
    showHashResult(fileHash, userHash, badge, icon, txt);
  };
}

function showHashResult(fileHash, userHash, badge, icon, txt) {
  if (fileHash === userHash) {
    badge.style.background  = 'rgba(16,185,129,.1)';
    badge.style.borderColor = 'rgba(16,185,129,.3)';
    icon.textContent = '✅';
    txt.innerHTML   = '<strong>Verified</strong> — file hash matches. This is an unmodified release.';
    txt.style.color = '#059669';
  } else {
    badge.style.background  = 'rgba(239,68,68,.1)';
    badge.style.borderColor = 'rgba(239,68,68,.4)';
    icon.textContent = '⚠️';
    txt.innerHTML   = '<strong>Hash mismatch</strong> — file does not match.<br><span style="font-size:.5rem;word-break:break-all;color:#6b7280">Computed: ' + fileHash + '</span>';
    txt.style.color = '#dc2626';
  }
}
</script>

<!-- ══════════════════════════════════════════════
     LEASE DETAIL PAGE
══════════════════════════════════════════════ -->
<!-- Restore tray -->
<div id="restoreTray" style="display:none"></div>
<!-- Note Modal -->
<div id="noteModal">
  <div class="note-modal-inner">
    <div class="note-modal-title" id="noteModalTitle">📝 Note</div>
    <textarea class="note-textarea" id="noteText" placeholder="Add a note for this day… e.g. 'Added 5 new leases', 'Node 2 went offline'"></textarea>
    <div class="note-btns">
      <button class="note-btn del" onclick="deleteNote()">🗑 Delete</button>
      <button class="note-btn cancel" onclick="closeNoteModal()">Cancel</button>
      <button class="note-btn save" onclick="saveNoteFromModal()">💾 Save</button>
    </div>
  </div>
</div>

<div id="leaseNotePopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:999999;display:none;align-items:center;justify-content:center" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--surface,#fff);border:1px solid var(--border,#ddd);border-radius:14px;padding:1.2rem 1.5rem;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.25);position:relative">
    <button onclick="document.getElementById('leaseNotePopup').style.display='none'" style="position:absolute;top:.6rem;right:.7rem;background:none;border:none;font-size:1.1rem;cursor:pointer;color:var(--muted,#999);padding:.2rem .4rem;border-radius:4px" title="Close">✕</button>
    <div style="font-family:var(--font-heading),sans-serif;font-size:.85rem;font-weight:700;margin-bottom:.5rem;padding-right:1.5rem" id="leaseNotePopupTitle">📝 Lease Note</div>
    <div id="leaseNotePopupBody" style="font-size:.75rem;line-height:1.65;color:var(--text2,#444);white-space:pre-wrap;max-height:300px;overflow-y:auto;padding:.5rem .65rem;background:var(--surface2,#f5f5f5);border-radius:8px;border:1px solid var(--border,#e0e0e0)"></div>
  </div>
</div>

<div id="leaseDetail" style="display:none">
  <div class="ld-header">
    <button class="ld-back" onclick="closeLeasePage()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Back to Dashboard
    </button>
    <div class="ld-title-block">
      <div class="ld-name" id="ld-name">—</div>
      <div class="ld-meta" id="ld-meta">—</div>
    </div>
    <div class="ld-badges" id="ld-badges"></div>
  </div>

  <div class="ld-body">

    <!-- Lease Notes - top of page for visibility -->
    <div class="sc adv-only" style="margin-bottom:.9rem">
      <div class="sc-title">📝 Lease Notes</div>
      <div class="sc-sub">Add personal notes for this lease — saved when you export your naming file</div>
      <div id="ld-notes"></div>
    </div>

    <!-- Earning trend - full width -->
    <div class="sc" style="margin-bottom:.9rem">
      <div class="sc-title">Daily Earnings Trend</div>
      <div class="sc-sub" id="ld-trend-sub">All days in dataset</div>
      <canvas id="ldTrendCanvas" style="width:100%;display:block" height="200"></canvas>
      <div id="ldUptimeRow" style="margin-top:.6rem"></div>
    </div>

    <!-- KPI strip -->
    <div class="ld-kpi-strip" id="ld-kpis"></div>

    <!-- Activity calendar -->
    <div class="sc" style="margin-bottom:.9rem">
      <div class="sc-title">Activity Calendar</div>
      <div class="sc-sub">Each square is one day — green = active, red = inactive, brighter = higher earnings</div>
      <div id="ld-activity-cal"></div>
    </div>

    <!-- Stats deep dive -->
    <div class="ld-two-col" style="margin-top:.9rem">
      <div class="sc" style="margin-bottom:0">
        <div class="sc-title">Performance Breakdown</div>
        <div class="sc-sub">Key stats for this lease across the full dataset</div>
        <div id="ld-stats"></div>
      </div>
      <div class="sc" style="margin-bottom:0">
        <div class="sc-title">Day of Week Pattern</div>
        <div class="sc-sub">Does this lease earn more on certain days?</div>
        <div id="ld-dow"></div>
      </div>
    </div>

    <!-- Best / worst days -->
    <div class="ld-two-col" style="margin-top:.9rem">
      <div class="sc" style="margin-bottom:0">
        <div class="sc-title">🏆 Best Days</div>
        <div class="sc-sub">Highest earning days for this lease</div>
        <div id="ld-best"></div>
      </div>
      <div class="sc" style="margin-bottom:0">
        <div class="sc-title">⬇ Worst Days</div>
        <div class="sc-sub">Lowest earning days (when active)</div>
        <div id="ld-worst"></div>
      </div>
    </div>

    <!-- Full transaction log -->
    <div class="sc" style="margin-top:.9rem">
      <div class="sc-title">Full Transaction Log</div>
      <div class="sc-sub" id="ld-txn-sub">Every reward recorded for this lease</div>
      <div style="overflow-x:auto">
        <table class="lease-table" id="ldTxnTable">
          <thead><tr>
            <th>#</th><th>Date</th><th>Time</th><th>Amount</th><th>vs Avg</th><th>Running Total</th>
          </tr></thead>
          <tbody id="ldTxnBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>


<!-- ═══ ALL TOOLTIPS — direct body children, no stacking context traps ═══ -->
<div class="htip" id="htip">
  <div class="htip-name" id="htip-name"></div>
  <div class="htip-row"><span id="htip-grp"></span><span id="htip-val"></span></div>
</div>
<div id="dailyBarTip2" style="display:none;position:fixed;background:#ffffff;color:#1a2c38;border:1px solid rgba(26,44,56,.15);border-left:3px solid var(--primary);border-radius:10px;padding:.6rem .9rem;font-size:.72rem;pointer-events:none;z-index:999999;box-shadow:0 4px 20px rgba(0,0,0,.18)"></div>
<div id="hourTip2" style="display:none;position:fixed;background:#ffffff;color:#1a2c38;border:1px solid rgba(26,44,56,.15);border-left:3px solid #8b5cf6;border-radius:10px;padding:.6rem .9rem;font-size:.72rem;pointer-events:none;z-index:999999;box-shadow:0 4px 20px rgba(0,0,0,.18)"></div>
<div id="hmTip" class="hm-tip"></div>

<!-- Onboarding Tour -->
<div id="onboardOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999998;transition:opacity .3s">
  <div id="onboardCard" style="position:fixed;background:var(--surface,#fff);border:1px solid var(--border,#ddd);border-radius:16px;padding:1.4rem 1.6rem;max-width:360px;width:85%;box-shadow:0 12px 48px rgba(0,0,0,.35);z-index:999999;transition:all .3s ease">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem">
      <span id="onboardStep" style="font-size:.55rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.1em">Step 1 of 6</span>
      <button onclick="endTour()" style="background:none;border:none;font-size:.9rem;cursor:pointer;color:var(--muted);padding:.1rem .3rem">✕</button>
    </div>
    <div id="onboardIcon" style="font-size:1.8rem;margin-bottom:.4rem">📊</div>
    <div id="onboardTitle" style="font-family:var(--font-heading),sans-serif;font-size:.9rem;font-weight:700;margin-bottom:.35rem"></div>
    <div id="onboardBody" style="font-size:.72rem;line-height:1.6;color:var(--text2);margin-bottom:.9rem"></div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end">
      <button id="onboardPrev" class="cbtn" style="padding:.3rem .7rem;font-size:.62rem" onclick="tourStep(-1)">← Back</button>
      <button id="onboardNext" class="cbtn on" style="padding:.3rem .7rem;font-size:.62rem" onclick="tourStep(1)">Next →</button>
    </div>
    <div id="onboardDots" style="display:flex;justify-content:center;gap:5px;margin-top:.7rem"></div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════
     ARCHIVE MODAL
═══════════════════════════════════════════════ -->

</body>
</html>
